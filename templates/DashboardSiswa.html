<!DOCTYPE html>
<html lang="id">
    
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Siswa - Tes Diagnostik</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body {
      padding-top: 60px;
      background-color: #f8f9fa;
    }
    .navbar {
      background-color: #0d6efd;
    }
    .navbar-brand {
      font-weight: bold;
    }
    .user-info {
      color: white;
      margin-right: 15px;
    }
    .teacher-card {
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      height: 100%;
    }
    .teacher-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    .card-header {
      border-top-left-radius: 8px !important;
      border-top-right-radius: 8px !important;
    }
    .badge-corner {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .teacher-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background-color: #e9ecef;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #6c757d;
    }
    .collection-item {
      padding: 8px 12px;
      margin-bottom: 5px;
      border-radius: 4px;
      background-color: #f8f9fa;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid #dee2e6;
      display: block;
      text-decoration: none;
      color: #212529;
    }
    .collection-item:hover {
      background-color: #e9ecef;
      transform: translateY(-2px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    .collection-item .badge {
      float: right;
    }
    .section-title {
      position: relative;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .section-title:after {
      content: '';
      display: block;
      width: 50px;
      height: 3px;
      background-color: #0d6efd;
      position: absolute;
      bottom: 0;
      left: 0;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    .loading-spinner {
      display: inline-block;
      width: 2rem;
      height: 2rem;
      vertical-align: text-bottom;
      border: 0.25em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border .75s linear infinite;
    }
    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }
    /* Modal styling */
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
    .test-collection-container {
      max-height: 250px;
      overflow-y: auto;
      padding-right: 5px;
      margin-bottom: 10px;
    }
    .test-collection-container::-webkit-scrollbar {
      width: 5px;
    }
    .test-collection-container::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.2);
      border-radius: 10px;
    }
    .test-collection-container::-webkit-scrollbar-track {
      background-color: rgba(0,0,0,0.05);
    }
    /* Styling for test items in modal */
    .test-item {
      padding: 12px 15px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .test-item:hover {
      background-color: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .test-item-title {
      font-weight: 500;
      margin-bottom: 5px;
    }
    .test-item-info {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .test-item-actions {
      display: flex;
      gap: 8px;
    }
    /* Result styling */
    .result-item {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #0d6efd;
      background-color: #f8f9fa;
    }
    .result-question {
      font-weight: 500;
      margin-bottom: 10px;
    }
    .result-answer {
      margin-bottom: 5px;
    }
    .result-correct {
      border-left-color: #28a745;
    }
    .result-incorrect {
      border-left-color: #dc3545;
    }
    .result-stats {
      display: flex;
      gap: 15px;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .result-stat-item {
      flex: 1;
      text-align: center;
    }
    .result-stat-value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .result-stat-label {
      font-size: 0.9rem;
      color: #6c757d;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/dashboard">Sistem Tes Diagnostik</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="/dashboard">Dashboard</a>
          </li>
          <!-- <li class="nav-item">
            <a class="nav-link" href="/result">Hasil Saya</a>
          </li> -->
        </ul>
        <div class="d-flex align-items-center">
          <span class="user-info">
            <i class="bi bi-person-circle"></i> {{ current_user.nama }} ({{ current_user.kelas }})
          </span>
          <a href="/logout" class="btn btn-outline-light ms-2">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h1 class="text-center mb-4">Dashboard Siswa</h1>
    
    <!-- Card untuk informasi siswa -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-2 text-center mb-3 mb-md-0">
            <div class="teacher-avatar">
              <i class="bi bi-person"></i>
            </div>
          </div>
          <div class="col-md-10">
            <h4 id="siswa-nama">{{ current_user.nama }}</h4>
            <p class="text-muted mb-0" id="siswa-kelas">Kelas: {{ current_user.kelas }}</p>
            <p class="text-muted mb-0" id="siswa-email">Email: {{ current_user.email }}</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Status Message Area -->
    <div id="statusMessage" class="mb-3"></div>
    
    <!-- Statistik Siswa -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Statistik Tes</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-3 mb-md-0">
            <div class="card h-100 text-center">
              <div class="card-body">
                <h5 class="card-title text-muted">Total Tes</h5>
                <h2 id="total-tes" class="mb-0 text-primary">
                  <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </h2>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3 mb-md-0">
            <div class="card h-100 text-center">
              <div class="card-body">
                <h5 class="card-title text-muted">Tes Selesai</h5>
                <h2 id="tes-selesai" class="mb-0 text-success">
                  <div class="spinner-border spinner-border-sm text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </h2>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3 mb-md-0">
            <div class="card h-100 text-center">
              <div class="card-body">
                <h5 class="card-title text-muted">Jawaban Benar</h5>
                <h2 id="jawaban-benar" class="mb-0 text-success">
                  <div class="spinner-border spinner-border-sm text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </h2>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100 text-center">
              <div class="card-body">
                <h5 class="card-title text-muted">Jawaban Salah</h5>
                <h2 id="jawaban-salah" class="mb-0 text-danger">
                  <div class="spinner-border spinner-border-sm text-danger" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Daftar Guru dan Tes yang Tersedia -->
    <h3 class="section-title"><i class="bi bi-journal-text"></i> Tes Tersedia</h3>
    
    <div class="mb-4">
      <!-- Pencarian -->
      <div class="row mb-3">
        <div class="col-md-6 offset-md-3">
          <div class="input-group">
            <input type="text" id="search-input" class="form-control" placeholder="Cari guru atau tes...">
            <button class="btn btn-outline-primary" type="button" id="search-button">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div id="teachers-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <!-- Loading state -->
        <div class="col-12 text-center py-5">
          <div class="loading-spinner text-primary"></div>
          <p class="mt-3">Memuat data guru dan tes...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal untuk Lihat Semua Tes -->
  <div class="modal fade" id="tesModal" tabindex="-1" aria-labelledby="tesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tesModalLabel">Daftar Tes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="tesModalBody">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h6 class="mb-0" id="tesModalTeacherName">Nama Guru</h6>
              <small class="text-muted" id="tesModalTeacherEmail">Email Guru</small>
            </div>
            <input type="text" class="form-control w-50" id="tesModalSearch" placeholder="Cari tes...">
          </div>
          <div id="tesModalContent">
            <!-- Test items will be loaded here -->
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Memuat daftar tes...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal untuk Hasil Tes -->
  <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resultModalLabel">Hasil Tes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="resultModalBody">
          <div id="resultModalLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Memuat hasil tes...</p>
          </div>
          
          <div id="resultModalContent" style="display: none;">
            <h6 id="resultModalTestName" class="mb-3">Nama Tes</h6>
            
            <div class="result-stats mb-4">
              <div class="result-stat-item">
                <div class="result-stat-value text-success" id="resultCorrect">0</div>
                <div class="result-stat-label">Jawaban Benar</div>
              </div>
              <div class="result-stat-item">
                <div class="result-stat-value text-danger" id="resultIncorrect">0</div>
                <div class="result-stat-label">Jawaban Salah</div>
              </div>
              <div class="result-stat-item">
                <div class="result-stat-value text-primary" id="resultAccuracy">0%</div>
                <div class="result-stat-label">Akurasi</div>
              </div>
            </div>
            
            <h6 class="mb-3">Riwayat Jawaban</h6>
            <div id="resultItems">
              <!-- Result items will be loaded here -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const collectionId = urlParams.get('collection_id');

    if (!collectionId) {
        console.log("ID koleksi tidak ditemukan dalam URL");
    }

    // Data user dari Flask template
    const userId = "{{ current_user.id }}";
    
    // Variable untuk menyimpan data guru dan tes
    let teachersData = [];
    
    // Inisialisasi modal references
    let tesModal;
    let resultModal;
    
    // Inisialisasi dashboard
    async function initDashboard() {
      try {
        // Initialize modals
        tesModal = new bootstrap.Modal(document.getElementById('tesModal'));
        resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        
        // Add search functionality to test modal
        document.getElementById('tesModalSearch').addEventListener('input', filterTestsInModal);
        
        // Show loading state
        document.getElementById('statusMessage').innerHTML = `
          <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
            Memuat data dashboard...
          </div>
        `;
        
        // Ambil statistik siswa
        await fetchStatistics();
        
        // Ambil data guru dan tes
        await fetchTeachers();
        
        // Setup pencarian
        document.getElementById('search-input').addEventListener('input', handleSearch);
        document.getElementById('search-button').addEventListener('click', handleSearch);
        
        // Hide loading message
        document.getElementById('statusMessage').innerHTML = '';
        
        console.log("Dashboard berhasil diinisialisasi");
      } catch (error) {
        console.error("Error menginisialisasi dashboard:", error);
        document.getElementById('statusMessage').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Gagal memuat data dashboard. 
            <button class="btn btn-sm btn-outline-danger mt-2" onclick="initDashboard()">
              <i class="bi bi-arrow-clockwise"></i> Coba Lagi
            </button>
          </div>
        `;
      }
    }
    
    // Mengambil statistik siswa dari API dengan better error handling
    // Fungsi untuk mengambil statistik siswa dari API dengan better error handling
async function fetchStatistics() {
  try {
    console.log("Mengambil statistik siswa...");
    
    // Tambahkan parameter collection_id jika tersedia
    let url = `/get_summary?user_id=${userId}`;
    if (collectionId) {
      url += `&collection_id=${collectionId}`;
    }
    
    const response = await fetch(url);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Error server: ${response.status} - ${errorText}`);
    }
    
    const data = await response.json();
    console.log("Data statistik:", data);
    
    // Validasi data untuk memastikan nilai yang valid
    const correct = data.correct || 0;
    const incorrect = data.incorrect || 0;
    const total_tests = data.total_tests || 0;
    const completed_tests = data.completed_tests || 0;
    
    // Update UI dengan data statistik
    document.getElementById("total-tes").textContent = total_tests;
    document.getElementById("tes-selesai").textContent = completed_tests;
    document.getElementById("jawaban-benar").textContent = correct;
    document.getElementById("jawaban-salah").textContent = incorrect;
    
    console.log("Statistik berhasil dimuat");
    
    // Kembalikan data untuk digunakan fungsi lain jika perlu
    return {
      correct,
      incorrect,
      total_tests,
      completed_tests
    };
  } catch (error) {
    console.error("Error mengambil statistik:", error);
    
    // Tampilkan pesan error dan tetapkan nilai default ke 0
    document.getElementById("total-tes").textContent = 0;
    document.getElementById("tes-selesai").textContent = 0;
    document.getElementById("jawaban-benar").textContent = 0;
    document.getElementById("jawaban-salah").textContent = 0;
    
    throw error; // Re-throw to be caught by the main function
  }
}
    
    // Improved teacher collections fetching with better error handling
    async function fetchTeachers() {
      try {
        console.log("Mengambil data guru dan tes...");
        const container = document.getElementById('teachers-container');
        
        // Show loading state
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <div class="loading-spinner text-primary"></div>
            <p class="mt-3">Memuat data guru dan tes...</p>
          </div>
        `;
        
        // Try primary API first
        try {
          const response = await fetch('/api/siswa/collections');
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`Server error: ${response.status}`, errorText);
            throw new Error(`Error server: ${response.status}`);
          }
          
          // Try to parse as JSON and handle HTML response gracefully
          const responseText = await response.text();
          let result;
          try {
            result = JSON.parse(responseText);
          } catch (e) {
            console.error("Failed to parse response as JSON:", responseText.substring(0, 100));
            throw new Error("Invalid JSON response from server");
          }
          
          if (result.success) {
            teachersData = result.teachers || [];
            renderTeachers(teachersData);
            console.log(`Berhasil memuat ${teachersData.length} guru dan tes`);
            return;
          } else {
            throw new Error(result.message || "Gagal memuat data guru dan tes");
          }
        } catch (apiError) {
          console.error("Error API /api/siswa/collections:", apiError);
          
          // Improve error message in UI
          container.innerHTML = `
            <div class="col-12">
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> Gagal memuat data guru dan tes
                <p>${apiError.message}</p>
                <button class="btn btn-primary mt-2" onclick="fetchTeachers()">
                  <i class="bi bi-arrow-clockwise"></i> Coba Lagi
                </button>
              </div>
            </div>
          `;
          
          throw apiError; // Re-throw to be caught by the main function
        }
      } catch (error) {
        console.error("Error mengambil data guru:", error);
        throw error;
      }
    }
    
    // Render daftar guru dan tes
    function renderTeachers(teachers) {
      const container = document.getElementById('teachers-container');
      
      if (!teachers || teachers.length === 0) {
        container.innerHTML = `
          <div class="col-12">
            <div class="card">
              <div class="card-body empty-state">
                <i class="bi bi-inbox"></i>
                <h5>Belum Ada Tes Tersedia</h5>
                <p class="text-muted">Guru belum membagikan tes apa pun kepada Anda.</p>
              </div>
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = teachers.map(teacher => {
        const collections = teacher.collections || [];
        const collectionsHtml = collections.map(collection => `
          <div class="collection-item" data-id="${collection.id}" onclick="startTest(${collection.id})">
            <strong>${collection.name}</strong>
            ${collection.is_new ? '<span class="badge bg-primary">New</span>' : ''}
          </div>
        `).join('');
        
        // Pilih warna acak untuk header kartu
        const colors = ['primary', 'success', 'info', 'warning', 'danger'];
        const colorIndex = teacher.id % colors.length;
        const headerColor = colors[colorIndex];
        
        return `
          <div class="col">
            <div class="card teacher-card">
              <div class="card-header bg-${headerColor} text-white">
                <h5 class="mb-0">${teacher.nama}</h5>
                <span class="badge bg-light text-dark badge-corner">${collections.length} Tes</span>
              </div>
              <div class="card-body">
                <div class="text-center mb-3">
                  <div class="teacher-avatar">
                    <i class="bi bi-person"></i>
                  </div>
                  <p class="text-muted mt-2 mb-0">${teacher.email}</p>
                </div>
                
                <h6 class="mb-2">Tes Tersedia:</h6>
                <div class="test-collection-container">
                  ${collectionsHtml || '<p class="text-muted">Tidak ada tes tersedia</p>'}
                </div>
              </div>
              <div class="card-footer">
                <div class="d-grid">
                  <button class="btn btn-outline-${headerColor}" onclick="viewAllTests(${teacher.id}, '${teacher.nama}', '${teacher.email}')">
                    <i class="bi bi-list-check"></i> Lihat Semua Tes
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Add click event listeners to make sure tests are clickable
      document.querySelectorAll('.collection-item').forEach(item => {
        const collectionId = item.getAttribute('data-id');
        item.addEventListener('click', () => startTest(collectionId));
      });
    }
    
    // Fungsi pencarian
    function handleSearch() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      
      if (!teachersData || teachersData.length === 0) {
        return;
      }
      
      // Filter guru dan tes berdasarkan kata kunci
      const filteredTeachers = teachersData.map(teacher => {
        // Cek apakah guru cocok dengan kata kunci
        const teacherMatch = teacher.nama.toLowerCase().includes(searchTerm) || 
                           teacher.email.toLowerCase().includes(searchTerm);
        
        // Filter collections yang cocok dengan kata kunci
        const filteredCollections = (teacher.collections || []).filter(collection => 
          collection.name.toLowerCase().includes(searchTerm)
        );
        
        // Jika guru cocok, tampilkan semua collections
        // Jika tidak, tampilkan hanya collections yang cocok
        if (teacherMatch) {
          return teacher;
        } else if (filteredCollections.length > 0) {
          return {
            ...teacher,
            collections: filteredCollections
          };
        } else {
          return null;
        }
      }).filter(Boolean); // Hapus null
      
      renderTeachers(filteredTeachers);
      
      console.log(`Pencarian dengan kata kunci "${searchTerm}": ${filteredTeachers.length} hasil`);
    }
    
    // Filter tests in modal
    function filterTestsInModal() {
      const searchTerm = document.getElementById('tesModalSearch').value.toLowerCase();
      const testItems = document.querySelectorAll('.test-item');
      
      testItems.forEach(item => {
        const testName = item.querySelector('.test-item-title').textContent.toLowerCase();
        if (testName.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }
    
    // Mulai mengerjakan tes
    function startTest(collectionId) {
  if (!collectionId) {
    showError("ID koleksi tidak valid");
    return;
  }
  
  console.log(`Memulai tes dengan ID: ${collectionId}`);
  
  // Cek apakah tes sudah selesai sebelum memulai
  checkTestCompletionStatus(collectionId).then(isCompleted => {
    if (!isCompleted) {
      // Tampilkan indikator loading
      document.getElementById('statusMessage').innerHTML = `
        <div class="alert alert-info">
          <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
          Mempersiapkan tes...
        </div>
      `;
      
      // Jika belum selesai, lanjutkan ke halaman QnA
      window.location.href = `/qna?collection_id=${collectionId}`;
    }
    // Jika sudah selesai, fungsi showTestResultPopup sudah dipanggil
  });
}
    
    // Lihat semua tes dari guru tertentu (updated to use modal)
    // Perbaikan pada fungsi viewAllTests - tambahkan pembaruan status
async function viewAllTests(teacherId, teacherName, teacherEmail) {
  console.log(`Melihat semua tes dari guru dengan ID: ${teacherId}`);
  
  // Set teacher info in modal
  document.getElementById('tesModalTeacherName').textContent = teacherName || 'Nama Guru';
  document.getElementById('tesModalTeacherEmail').textContent = teacherEmail || 'Email Guru';
  
  // Show loading in modal
  document.getElementById('tesModalContent').innerHTML = `
    <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Memuat daftar tes...</p>
    </div>
  `;
  
  // Show modal
  tesModal.show();
  
  try {
    // Find teacher in teachersData
    const teacher = teachersData.find(t => t.id === teacherId);
    if (!teacher) {
      throw new Error("Data guru tidak ditemukan");
    }
    
    // Get test collections
    const collections = teacher.collections || [];
    
    // PERBAIKAN: Periksa status tes ke server untuk setiap koleksi
    const tesResults = await fetchUpdatedTestResults(collections);
    
    // Render test items
    const tesModalContent = document.getElementById('tesModalContent');
    
    if (collections.length === 0) {
      tesModalContent.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <h5>Belum Ada Tes Tersedia</h5>
          <p class="text-muted">Guru belum membagikan tes apa pun kepada Anda.</p>
        </div>
      `;
      return;
    }
    
    tesModalContent.innerHTML = collections.map(collection => {
      // Check if this collection has results
      const result = tesResults.find(r => r.collection_id === collection.id);
      const isCompleted = result && [5, 6, 7].includes(result.current_level);
      const statusBadge = isCompleted 
        ? '<span class="badge bg-success">Selesai</span>' 
        : result 
          ? '<span class="badge bg-warning text-dark">Sedang Berlangsung</span>'
          : '<span class="badge bg-secondary">Belum Dikerjakan</span>';
          
      return `
        <div class="test-item">
          <div>
            <div class="test-item-title">${collection.name}</div>
            <div class="test-item-info">
              ${statusBadge}
              ${result ? `<small class="ms-2">level: ${result.current_level}</small>` : ''}
            </div>
          </div>
          <div class="test-item-actions">
            ${isCompleted ? 
              `<button class="btn btn-sm btn-outline-primary" onclick="viewTestResult(${collection.id}, '${collection.name}')">
                <i class="bi bi-card-checklist"></i> Lihat Hasil
              </button>` : ''
            }
            <button class="btn btn-sm btn-primary" onclick="startTest(${collection.id})">
  <i class="bi bi-play-fill"></i> Mulai Tes
</button>
          </div>
        </div>
      `;
    }).join('');
    
  } catch (error) {
    console.error("Error loading tests:", error);
    document.getElementById('tesModalContent').innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> Gagal memuat daftar tes: ${error.message}
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="viewAllTests(${teacherId}, '${teacherName}', '${teacherEmail}')">
          <i class="bi bi-arrow-clockwise"></i> Coba Lagi
        </button>
      </div>
    `;
  }
}
async function fetchUpdatedTestResults(collections) {
  try {
    // Buat array untuk menyimpan hasil yang diperbarui
    let updatedResults = [];
    
    // Cek status masing-masing koleksi
    for (const collection of collections) {
      try {
        const response = await fetch(`/api/siswa/test_status?collection_id=${collection.id}&user_id=${userId}`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.success) {
            // Tambahkan ke hasil yang diperbarui
            updatedResults.push({
              collection_id: collection.id,
              current_level: data.current_level || 1,
              is_completed: data.is_completed || false,
              correct: data.correct || 0,
              incorrect: data.incorrect || 0
            });
            
            // Perbarui localStorage jika tes sudah selesai
            if (data.is_completed || (data.current_level && [5, 6, 7].includes(parseInt(data.current_level)))) {
              localStorage.setItem(`test_completed_${collection.id}`, 'true');
            }
          }
        }
      } catch (err) {
        console.error(`Error checking status for collection ${collection.id}:`, err);
      }
    }
    
    // Jika tidak ada hasil yang diperbarui, gunakan fallback ke fetchTestResults
    if (updatedResults.length === 0) {
      const fallbackResults = await fetchTestResults();
      return fallbackResults;
    }
    
    return updatedResults;
  } catch (error) {
    console.error("Error fetching updated test results:", error);
    return [];
  }
}
    
   // Perbaikan fungsi fetchTestResults
async function fetchTestResults() {
  try {
    // Mendapatkan semua hasil tes untuk siswa ini
    let results = [];
    
    // Jika ada collectionId spesifik dari URL, gunakan itu saja
    if (collectionId) {
      console.log(`Fetching test results for collection: ${collectionId}`);
      
      // Tambahkan timestamp untuk mencegah caching
      const timestamp = new Date().getTime();
      const response = await fetch(`/api/siswa/results/${collectionId}?user_id=${userId}&t=${timestamp}`);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Error server: ${response.status} - ${errorText}`);
      }
      
      const data = await response.json();
      console.log("Data results untuk koleksi spesifik:", data);
      
      // Format data menjadi array (karena endpoint ini mengembalikan objek tunggal)
      if (data.success) {
        results = [{
          collection_id: parseInt(collectionId),
          correct: parseInt(data.correct || 0),
          incorrect: parseInt(data.incorrect || 0),
          current_level: parseInt(data.current_level || 1)
        }];
      }
    } else {
      // Jika tidak ada collectionId spesifik, coba dapatkan dari status siswa
      console.log("Fetching global test results");
      
      const response = await fetch(`/get_summary?user_id=${userId}&t=${new Date().getTime()}`);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Error server: ${response.status} - ${errorText}`);
      }
      
      // Ubah format data untuk kompatibilitas
      const data = await response.json();
      console.log("Data results global:", data);
      
      if (data.status === "success" || data.correct !== undefined) {
        // Konversi data statistik global menjadi format yang diharapkan
        const collectionsData = teachersData?.flatMap(teacher => 
          (teacher.collections || []).map(collection => ({
            collection_id: collection.id,
            current_level: data.current_level || 1,
            correct: parseInt(data.correct || 0),
            incorrect: parseInt(data.incorrect || 0),
            is_completed: data.current_level ? [5, 6, 7].includes(parseInt(data.current_level)) : false
          }))
        ) || [];
        
        results = collectionsData.length > 0 ? collectionsData : [{
          // Fallback data jika tidak ada koleksi
          collection_id: null,
          current_level: data.current_level || 1,
          correct: parseInt(data.correct || 0),
          incorrect: parseInt(data.incorrect || 0)
        }];
      }
    }
    
    console.log("Hasil akhir fetchTestResults:", results);
    return results;
  } catch (error) {
    console.error("Error fetching test results:", error);
    return [];
  }
}
    
    // View test result in modal
 // Perbaikan pada fungsi viewTestResult
async function viewTestResult(collectionId, collectionName) {
  console.log(`Melihat hasil tes dengan ID: ${collectionId}`);
  
  // Reset and show the result modal
  document.getElementById('resultModalTestName').textContent = collectionName || 'Hasil Tes';
  document.getElementById('resultModalLoading').style.display = 'block';
  document.getElementById('resultModalContent').style.display = 'none';
  resultModal.show();
  
  try {
    // Refresh data terlebih dahulu untuk memastikan konsistensi
    await fixStatisticsInconsistency();
    
    // Fetch detailed test results - tambahkan waktu untuk mencegah cache
    const timestamp = new Date().getTime();
    const response = await fetch(`/api/siswa/results/${collectionId}?user_id=${userId}&t=${timestamp}`);
    
    if (!response.ok) {
      throw new Error(`Error server: ${response.status}`);
    }
    
    const data = await response.json();
    console.log("Data hasil tes:", data); // Tambahkan log untuk debug
    
    // Hide loading and show content
    document.getElementById('resultModalLoading').style.display = 'none';
    document.getElementById('resultModalContent').style.display = 'block';
    
    // Update statistics
    const correct = parseInt(data.correct || 0);
    const incorrect = parseInt(data.incorrect || 0);
    const total = correct + incorrect;
    const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
    
    document.getElementById('resultCorrect').textContent = correct;
    document.getElementById('resultIncorrect').textContent = incorrect;
    document.getElementById('resultAccuracy').textContent = `${accuracy}%`;
    
    // Render answer history
    const resultItems = document.getElementById('resultItems');
    
    // PERBAIKAN: Cek apakah ada jawaban yang benar/salah tapi tidak ada dalam answers
    if ((!data.answers || data.answers.length === 0) && (correct > 0 || incorrect > 0)) {
      // Kondisi abnormal: ada statistik tapi tidak ada detail jawaban
      resultItems.innerHTML = `
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i>
          <h5>Data Tidak Lengkap</h5>
          <p>Sistem mendeteksi bahwa Anda telah menjawab pertanyaan, tetapi detail jawaban tidak tersedia.</p>
          <button class="btn btn-sm btn-primary mt-2" onclick="forceReloadAnswers(${collectionId})">
            <i class="bi bi-arrow-clockwise"></i> Muat Ulang Data
          </button>
        </div>
      `;
      return;
    } else if (!data.answers || data.answers.length === 0) {
      resultItems.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <h5>Tidak Ada Riwayat Jawaban</h5>
          <p class="text-muted">Anda belum menjawab pertanyaan apa pun dalam tes ini.</p>
        </div>
      `;
      return;
    }
    
    resultItems.innerHTML = data.answers.map(answer => `
      <div class="result-item ${answer.is_correct ? 'result-correct' : 'result-incorrect'}">
        <div class="result-question">${answer.question}</div>
        <div class="result-answer">
          <strong>Jawaban Anda:</strong> ${answer.user_answer}
          <span class="badge ${answer.is_correct ? 'bg-success' : 'bg-danger'} float-end">
            ${answer.is_correct ? 'Benar' : 'Salah'}
          </span>
        </div>
        ${answer.explanation ? `
          <div class="result-explanation mt-2">
            <strong>Penjelasan:</strong> ${answer.explanation}
          </div>
        ` : ''}
      </div>
    `).join('');
    
  } catch (error) {
    console.error("Error loading test result:", error);
    document.getElementById('resultModalLoading').style.display = 'none';
    document.getElementById('resultModalContent').style.display = 'block';
    document.getElementById('resultItems').innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> Gagal memuat hasil tes: ${error.message}
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="viewTestResult(${collectionId}, '${collectionName}')">
          <i class="bi bi-arrow-clockwise"></i> Coba Lagi
        </button>
      </div>
    `;
  }
}
// Fungsi untuk memperbaiki inkonsistensi data statistik
async function fixStatisticsInconsistency() {
  try {
    if (!collectionId || !userId) return false;
    
    console.log(`Memperbaiki inkonsistensi data untuk koleksi: ${collectionId}`);
    
    // Panggil endpoint khusus untuk menyegarkan data jawaban
    const response = await fetch(`/api/siswa/refresh_answers/${collectionId}?user_id=${userId}&force=true`);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error(`Error memperbaiki data: ${errorText}`);
      return false;
    }
    
    const result = await response.json();
    console.log("Hasil perbaikan data:", result);
    
    if (result.success) {
      console.log("Data berhasil diperbaiki");
      // Perbarui statistik setelah perbaikan
      await updateStats();
      return true;
    } else {
      console.error("Gagal memperbaiki data:", result.message);
      return false;
    }
  } catch (error) {
    console.error("Error memperbaiki inkonsistensi:", error);
    return false;
  }
}

// Tambahkan fungsi untuk muat ulang jawaban dengan force refresh
function forceReloadAnswers(collectionId) {
  // Tampilkan indikator loading
  Swal.fire({
    title: 'Menyegarkan Data',
    html: '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"></div></div><p class="mt-2">Mohon tunggu...</p>',
    showConfirmButton: false,
    allowOutsideClick: false
  });
  
  // Panggil endpoint khusus untuk menyegarkan data jawaban
  fetch(`/api/siswa/refresh_answers/${collectionId}?user_id=${userId}&force=true`)
    .then(response => {
      if (!response.ok) throw new Error(`Error server: ${response.status}`);
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // Jika berhasil, perbarui statistik
        updateStats().then(() => {
          // Lalu muat ulang hasil tes
          Swal.close();
          Swal.fire({
            title: 'Berhasil',
            text: 'Data jawaban berhasil disegarkan',
            icon: 'success',
            timer: 1500,
            timerProgressBar: true
          }).then(() => {
            // Muat ulang hasil tes
            if (typeof viewTestResult === 'function') {
              viewTestResult(collectionId, document.getElementById('resultModalTestName')?.textContent || 'Hasil Tes');
            } else {
              // Fallback jika fungsi viewTestResult tidak tersedia
              window.location.reload();
            }
          });
        });
      } else {
        Swal.fire({
          title: 'Gagal',
          text: `Gagal menyegarkan data jawaban: ${data.message}`,
          icon: 'error',
          confirmButtonText: 'Tutup'
        });
      }
    })
    .catch(error => {
      console.error("Error refreshing answers:", error);
      Swal.fire({
        title: 'Error',
        text: `Gagal menyegarkan data jawaban: ${error.message}`,
        icon: 'error',
        confirmButtonText: 'Tutup'
      });
    });
}
    
    // Tampilkan pesan error
    function showError(message) {
      // Buat alert error
      const alert = document.createElement('div');
      alert.className = 'alert alert-danger alert-dismissible fade show';
      alert.role = 'alert';
      alert.innerHTML = `
        <i class="bi bi-exclamation-triangle-fill"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      // Tampilkan di bagian atas container
      document.querySelector('.container').prepend(alert);
      
      // Otomatis hilangkan setelah 5 detik
      setTimeout(() => {
        alert.classList.add('fade');
        setTimeout(() => alert.remove(), 500);
      }, 5000);
    }
    
    // Tampilkan pesan sukses
    function showSuccess(message) {
      // Buat alert success
      const alert = document.createElement('div');
      alert.className = 'alert alert-success alert-dismissible fade show';
      alert.role = 'alert';
      alert.innerHTML = `
        <i class="bi bi-check-circle-fill"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      // Tampilkan di bagian atas container
      document.querySelector('.container').prepend(alert);
      
      // Otomatis hilangkan setelah 5 detik
      setTimeout(() => {
        alert.classList.add('fade');
        setTimeout(() => alert.remove(), 500);
      }, 5000);
    }
    
    // Inisialisasi saat halaman dimuat
    window.addEventListener('DOMContentLoaded', initDashboard);

    async function checkTestCompletionStatus(collectionId) {
  if (!collectionId) {
    console.error("Collection ID tidak valid");
    return false;
  }
  
  try {
    console.log(`Memeriksa status penyelesaian untuk koleksi: ${collectionId}`);
    
    // Verifikasi dengan server terlebih dahulu (memastikan data terbaru)
    // Tambahkan timestamp untuk mencegah caching
    const response = await fetch(`/api/siswa/test_status?collection_id=${collectionId}&user_id=${userId}&t=${new Date().getTime()}`);
    
    if (!response.ok) {
      throw new Error(`Error server: ${response.status}`);
    }
    
    const data = await response.json();
    console.log("Data status tes:", data);
    
    // Tentukan status berdasarkan current_level dan pastikan tipe data benar
    const currentlevel = parseInt(data.current_level || 0);
    const isCompleted = data.is_completed === true || 
        (currentlevel > 0 && [5, 6, 7].includes(currentlevel));
    
    console.log(`Status tes: ${isCompleted ? 'Selesai' : 'Belum selesai'}, level: ${currentlevel}`);
    
    // Selalu perbarui localStorage berdasarkan status terbaru
    if (isCompleted) {
      localStorage.setItem(`test_completed_${collectionId}`, 'true');
      showTestResultPopup(collectionId);
      return true;
    } else {
      // Jika tidak selesai, pastikan localStorage juga tidak menandai selesai
      localStorage.removeItem(`test_completed_${collectionId}`);
    }
    
    return false;
  } catch (error) {
    console.error("Error memeriksa status penyelesaian tes:", error);
    
    // Fallback ke localStorage jika server error
    const isCompletedInStorage = localStorage.getItem(`test_completed_${collectionId}`) === 'true';
    if (isCompletedInStorage) {
      showTestResultPopup(collectionId);
      return true;
    }
    
    return false;
  }
}

// Fungsi untuk menampilkan popup hasil tes - tambahkan setelah checkTestCompletionStatus
function showTestResultPopup(collectionId) {
  // Tampilkan loading di modal terlebih dahulu
  Swal.fire({
    title: 'Memuat Hasil Tes',
    html: '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Mengambil hasil tes...</p></div>',
    showConfirmButton: false,
    allowOutsideClick: false
  });
  
  // Ambil hasil tes
  fetch(`/api/siswa/results/${collectionId}?user_id=${userId}`)
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      // Hitung statistik
      const correct = data.correct || 0;
      const incorrect = data.incorrect || 0;
      const total = correct + incorrect;
      const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
      
      // Buat konten untuk modal
      let modalContent = `
        <div class="result-stats mb-3">
          <div class="d-flex justify-content-between">
            <div class="text-center p-3 border rounded bg-light">
              <h4 class="text-success">${correct}</h4>
              <div>Jawaban Benar</div>
            </div>
            <div class="text-center p-3 border rounded bg-light">
              <h4 class="text-danger">${incorrect}</h4>
              <div>Jawaban Salah</div>
            </div>
            <div class="text-center p-3 border rounded bg-light">
              <h4 class="text-primary">${accuracy}%</h4>
              <div>Akurasi</div>
            </div>
          </div>
        </div>
        <p>Anda telah menyelesaikan tes ini. Untuk melihat detail hasil, klik tombol di bawah.</p>
      `;
      
      // Tampilkan modal dengan hasil
      Swal.fire({
        title: 'Hasil Tes',
        html: modalContent,
        icon: 'info',
        confirmButtonText: 'Lihat Detail Hasil',
        showCancelButton: true,
        cancelButtonText: 'Tutup'
      }).then((result) => {
        if (result.isConfirmed) {
          // Redirect ke halaman hasil detail
          window.location.href = `/result?collection_id=${collectionId}`;
        }
      });
    })
    .catch(error => {
      console.error("Error mengambil hasil tes:", error);
      Swal.fire({
        title: 'Error',
        text: 'Gagal memuat hasil tes: ' + error.message,
        icon: 'error',
        confirmButtonText: 'Tutup'
      });
    });
}
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hasil Tes Diagnostik</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 60px;
    }
    .navbar {
      background-color: #0d6efd;
    }
    .navbar-brand {
      font-weight: bold;
    }
    .user-info {
      color: white;
      margin-right: 15px;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      overflow: hidden;
      margin-bottom: 25px;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .card-header {
      border-bottom: none;
      padding: 15px 20px;
      font-weight: bold;
    }
    .summary-card {
      background: linear-gradient(to right, #4e54c8, #8f94fb);
      color: white;
    }
    .summary-card .card-header {
      background: rgba(0,0,0,0.1);
    }
    .benar { color: #198754; font-weight: bold; }
    .salah { color: #dc3545; font-weight: bold; }
    .chart-container {
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      padding: 15px;
      height: 300px;
      position: relative;
    }
    .chart-explanation {
      color: #212529; /* Warna teks gelap/hitam */
      background-color: #f8f9fa; /* Background light gray */
      border-radius: 5px;
      padding: 10px;
      margin-top: 15px;
      font-size: 0.9rem;
      border-left: 4px solid #0d6efd; /* Border biru di sisi kiri */
    }
    .answer-card {
      transition: all 0.3s ease;
      border-left: 5px solid #6c757d;
      background-color: white;
    }
    .answer-card.correct {
      border-left-color: #198754;
    }
    .answer-card.incorrect {
      border-left-color: #dc3545;
    }
    .answer-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .level-badge {
      position: absolute;
      top: 15px;
      right: 15px;
    }
    .stat-card {
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      background: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6c757d;
    }
    .stat-explanation {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 5px;
    }
    .clickable {
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }
    .clickable:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    .clickable.benar:hover {
      border-color: #198754;
    }
    .clickable.salah:hover {
      border-color: #dc3545;
    }
    .btn {
      border-radius: 50px;
      padding: 10px 25px;
      font-weight: 600;
      letter-spacing: 0.5px;
      transition: all 0.3s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .btn-icon {
      margin-right: 8px;
    }
    .progress-container {
      margin: 20px 0;
    }
    .progress {
      height: 25px;
      border-radius: 50px;
      background-color: #e9ecef;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .progress-explanation {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
    }
    .badge {
      font-size: 85%;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px;
    }
    .explanation-text {
      background-color: #f8f9fa;
      border-left: 4px solid #17a2b8;
      padding: 15px;
      border-radius: 0 8px 8px 0;
    }
    .answer-question {
      font-weight: 500;
      line-height: 1.5;
    }
    .answer-response {
      background-color: #f8f9fa;
      padding: 8px 15px;
      border-radius: 8px;
      margin-top: 8px;
      display: inline-block;
    }
    .level-path {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .level-step {
      width: 14%;
      display: inline-block;
      text-align: center;
      position: relative;
    }
    .level-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 50%;
      right: -10px;
      width: 20px;
      height: 2px;
      background-color: #dee2e6;
    }
    .level-icon {
      width: 40px;
      height: 40px;
      line-height: 40px;
      background-color: #e9ecef;
      border-radius: 50%;
      margin: 0 auto 8px;
    }
    .level-icon.active {
      background-color: #0d6efd;
      color: white;
    }
    .level-icon.completed {
      background-color: #198754;
      color: white;
    }
    .level-explanation {
      background-color: rgba(13, 110, 253, 0.1);
      border-radius: 10px;
      padding: 10px 15px;
      margin-top: 15px;
      font-size: 0.9rem;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .error-container {
      padding: 20px;
      border-radius: 10px;
      background-color: #f8d7da;
      border-left: 5px solid #dc3545;
      margin-bottom: 20px;
    }
    .refresh-button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      margin-top: 10px;
    }
    .level-number-display {
    font-size: 28px;
    font-weight: bold;
    color: #212529; /* Dark text color */
    background-color: #f8f9fa; /* Light background */
    border: 2px solid #0d6efd; /* Blue border */
    border-radius: 12px;
    padding: 8px 16px;
    display: inline-block;
    margin-bottom: 15px;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    .level-top-display {
    font-size: 42px;
    font-weight: bold;
    color: #198754; /* Green color for better visibility */
    margin: 20px auto;
    text-align: center;
    display: block;
  }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/DashboardSiswa">Sistem Tes Diagnostik</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="/DashboardSiswa">Dashboard</a>
          </li>
          <!-- <li class="nav-item">
            <a class="nav-link active" href="/result">Hasil Saya</a>
          </li> -->
        </ul>
        <div class="d-flex align-items-center">
          <span class="user-info">
            <i class="bi bi-person-circle"></i> {{ current_user.nama }} ({{ current_user.kelas }})
          </span>
          <a href="/logout" class="btn btn-outline-light ms-2">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container mt-4">
    <!-- Breadcrumb navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/DashboardSiswa">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Hasil Tes</li>
      </ol>
    </nav>

    <h1 class="mb-4 text-center">Hasil Tes Diagnostik</h1>
    
    <!-- Error container (hidden by default) -->
    <div class="error-container" id="errorContainer" style="display: none;">
      <h5><i class="bi bi-exclamation-triangle me-2"></i>Terjadi Masalah dengan Data</h5>
      <p id="errorMessage">Terdapat ketidaksesuaian data pada hasil tes Anda.</p>
      <button class="refresh-button" id="refreshDataButton">
        <i class="bi bi-arrow-clockwise me-2"></i>Perbaiki Data
      </button>
    </div>
    
    <!-- Path visualization with explanation -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Alur Progres Tes</h5>
      </div>
      <div class="card-body">
        <div class="level-path d-none d-md-block">
          <div class="level-step">
            <div class="level-icon completed">1</div>
            <div class="level-label">level 1</div>
          </div>
          <div class="level-step">
            <div class="level-icon completed">2</div>
            <div class="level-label">level 2</div>
          </div>
          <div class="level-step">
            <div class="level-icon" id="level3">3</div>
            <div class="level-label">level 3</div>
          </div>
          <div class="level-step">
            <div class="level-icon" id="level4">4</div>
            <div class="level-label">level 4</div>
          </div>
          <div class="level-step">
            <div class="level-icon" id="level5">5</div>
            <div class="level-label">level 5</div>
          </div>
          <div class="level-step">
            <div class="level-icon" id="level6">6</div>
            <div class="level-label">level 6</div>
          </div>
          <div class="level-step">
            <div class="level-icon" id="level7">7</div>
            <div class="level-label">level 7</div>
          </div>
        </div>
        <div class="level-explanation">
          <p><i class="bi bi-info-circle me-2"></i><strong>Anda telah mencapai level <span id="current-level-text">{{ current_level }}</span></strong></p>
          <p class="mb-0">Diagram di atas menunjukkan progress Anda dalam tes diagnostik. level berwarna hijau menandakan level yang telah Anda lewati, sedangkan level biru adalah level terakhir yang Anda capai. Sistem tes diagnostik menggunakan alur adaptif berdasarkan jawaban Anda untuk menentukan jalur tes.</p>
        </div>
      </div>
    </div>
    
    <!-- Card untuk ringkasan hasil -->
    <div class="card summary-card mb-4">
      <div class="card-header">
        <h3><i class="bi bi-clipboard-data me-2"></i>Ringkasan Hasil</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <div class="stat-card mb-3 clickable" onclick="showAnswersModal('correct')">
              <div class="stat-label">Jawaban Benar</div>
              <div class="stat-value benar" id="correct-value">{{ correct }}</div>
              <div class="small">Soal dijawab dengan tepat</div>
              <div class="stat-explanation"><i class="bi bi-hand-index-thumb"></i> Klik untuk melihat detail jawaban benar</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card mb-3 clickable" onclick="showAnswersModal('incorrect')">
              <div class="stat-label">Jawaban Salah</div>
              <div class="stat-value salah" id="incorrect-value">{{ incorrect }}</div>
              <div class="small">Soal dijawab dengan salah</div>
              <div class="stat-explanation"><i class="bi bi-hand-index-thumb"></i> Klik untuk melihat detail jawaban salah</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card mb-3">
              <div class="stat-label">Akurasi</div>
              <div class="stat-value text-primary" id="accuracy-value">{{ accuracy }}%</div>
              <div class="small">Tingkat ketepatan jawaban</div>
              <div class="stat-explanation">Persentase jawaban benar dari total soal</div>
            </div>
          </div>
        </div>
        
        <div class="row mt-3">
          <div class="col-md-7">
            <div class="card h-100">
              <div class="card-body">
                <p>
                  <strong>level Terakhir yang Dicapai:</strong> 
                  <span class="badge bg-light text-dark border border-primary" 
                        style="font-size: 16px; font-weight: bold; padding: 6px 12px;" 
                        id="current-level-badge">{{ current_level }}</span>
                </p>
                <!-- Progress bar with explanation -->
                <div class="progress-container">
                  <label><strong>Performa Jawaban:</strong></label>
                  <div class="progress">
                    <div id="correct-progress" class="progress-bar bg-success" role="progressbar" 
                        aria-valuemin="0" aria-valuemax="100">
                      <span id="correct-percent">0%</span>
                    </div>
                    <div id="incorrect-progress" class="progress-bar bg-danger" role="progressbar" 
                        aria-valuemin="0" aria-valuemax="100">
                      <span id="incorrect-percent">0%</span>
                    </div>
                  </div>
                  <div class="progress-explanation">
                    <i class="bi bi-info-circle me-1"></i> Diagram di atas menunjukkan perbandingan jawaban benar (hijau) dan salah (merah) dari semua soal yang telah Anda kerjakan.
                  </div>
                </div>
                
                <!-- Badges for additional information -->
                <div class="mt-4">
                  <p><strong>Statistik Lanjutan:</strong></p>
                  <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-info" id="total-questions">Total Soal: {{ correct + incorrect }}</span>
                    <span class="badge bg-secondary" id="collection-name">Koleksi: {{ collection_name if collection_name else 'N/A' }}</span>
                    
                  </div>
                </div>
                
                <!-- Action buttons -->
                <!-- Cari bagian dengan tombol "Export ke Excel" dan tambahkan tombol PDF di sebelahnya -->
<div class="mt-4">
  <a href="/DashboardSiswa" class="btn btn-outline-primary">
    <i class="bi bi-grid btn-icon"></i>Kembali ke Dashboard
  </a>
  <button id="exportPdfBtn" class="btn btn-danger">
    <i class="bi bi-file-pdf btn-icon"></i>Export ke PDF
  </button>
</div>
              </div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="card h-100">
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="resultChart"></canvas>
                </div>
                <div class="chart-explanation">
                  <strong>Diagram Donat:</strong> Diagram ini menunjukkan perbandingan persentase jawaban benar (hijau) dan jawaban salah (merah) dari keseluruhan tes yang telah Anda kerjakan. Visualisasi berbentuk donat ini memudahkan Anda untuk melihat proporsi jawaban secara visual.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Recommendasi -->
    <div class="card mb-5">
      <div class="card-header bg-white">
        <h3><i class="bi bi-lightbulb me-2"></i>Rekomendasi</h3>
      </div>
      <div class="card-body">
        <div class="alert alert-primary">
          <h5><i class="bi bi-mortarboard me-2"></i>Saran Pembelajaran</h5>
          <p>Berdasarkan hasil tes diagnostik Anda, berikut beberapa rekomendasi untuk meningkatkan pemahaman:</p>
          <ul id="recommendation-list">
            <li>Sedang memuat rekomendasi...</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal untuk menampilkan jawaban -->
  <div class="modal fade" id="answersModal" tabindex="-1" aria-labelledby="answersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="answersModalLabel">Riwayat Jawaban</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="answersModalBody">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Memuat data jawaban...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Parse user_id and collection_id from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id') || '{{ current_user.id }}';
    const collectionId = urlParams.get('collection_id') || '';
    let hasDataError = false; // Flag untuk menandai adanya kesalahan data
    let allAnswers = []; // Variable untuk menyimpan semua jawaban
    let questionlevelMap = {}; // Map untuk menyimpan ID soal -> level
    
    // Setup chart and visualizations
    document.addEventListener('DOMContentLoaded', function() {
      // Inisialisasi
      fetchQuestionData().then(() => {
        initResultPage();
      });
      
      // Setup refresh button
      const refreshButton = document.getElementById('refreshDataButton');
      if (refreshButton) {
        refreshButton.addEventListener('click', async function() {
          await forceRefreshData();
        });
      }
    });
    
    // Fungsi untuk mengambil data soal dan level dari server
    async function fetchQuestionData() {
      try {
        // Ambil data soal untuk membangun peta level
        console.log("Mengambil data soal dari database...");
        const response = await fetch('/api/get_questions');
        
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.success && Array.isArray(data.data)) {
          // Buat peta ID soal -> level
          data.data.forEach(question => {
            questionlevelMap[question.id] = question.level;
          });
          console.log("Peta soal ke level berhasil dibuat", questionlevelMap);
        } else {
          console.warn("Gagal membuat peta soal ke level");
        }
      } catch (error) {
        console.error("Error mengambil data soal:", error);
      }
    }
    
    async function initResultPage() {
      try {
        // Tampilkan loading overlay
        showLoading(true);
        
        // Cek dan perbaiki inkonsistensi data (jika ada)
        await fixStatisticsInconsistency();
        
        // Ambil data hasil tes
        const testData = await fetchTestResultData();
        
        // Render visualisasi dan statistik
        renderResultPage(testData);
        
        // Ambil riwayat jawaban (untuk digunakan di pop-up)
        await fetchAndCacheAnswerHistory();
        
        // Sembunyikan loading overlay
        showLoading(false);
      } catch (error) {
        console.error("Error initializing result page:", error);
        showLoading(false);
        showError("Terjadi kesalahan saat memuat hasil tes. Silakan coba lagi.");
      }
    }
    
    // Fungsi untuk menampilkan/menyembunyikan loading overlay
    function showLoading(show) {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
      }
    }
    
    // Fungsi untuk menampilkan pesan error
    function showError(message) {
      const errorContainer = document.getElementById('errorContainer');
      const errorMessage = document.getElementById('errorMessage');
      
      if (errorContainer && errorMessage) {
        errorMessage.textContent = message;
        errorContainer.style.display = 'block';
      } else {
        // Fallback if elements don't exist
        alert(message);
      }
    }
    
    // Fungsi untuk memperbaiki inkonsistensi data statistik
    async function fixStatisticsInconsistency() {
      try {
        if (!collectionId || !userId) return false;
        
        console.log(`Memeriksa konsistensi data untuk koleksi: ${collectionId}`);
        
        // Panggil endpoint khusus untuk menyegarkan data jawaban
        const response = await fetch(`/api/siswa/refresh_answers/${collectionId}?user_id=${userId}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error(`Error memeriksa data: ${errorText}`);
          return false;
        }
        
        const result = await response.json();
        console.log("Hasil pemeriksaan data:", result);
        
        // Jika ada perubahan, tandai ada masalah data
        if (result.changes) {
          hasDataError = true;
          const oldCorrect = result.changes.old_correct || 0;
          const newCorrect = result.changes.new_correct || 0;
          const oldIncorrect = result.changes.old_incorrect || 0;
          const newIncorrect = result.changes.new_incorrect || 0;
          
          // Tampilkan pesan error jika ada perbedaan data
          if (oldCorrect !== newCorrect || oldIncorrect !== newIncorrect) {
            showError(`Terdapat perbedaan data. Data awal: Benar=${oldCorrect}, Salah=${oldIncorrect}. Data terkoreksi: Benar=${newCorrect}, Salah=${newIncorrect}.`);
          }
        }
        
        return result.success || false;
      } catch (error) {
        console.error("Error memperbaiki inkonsistensi:", error);
        return false;
      }
    }
    
    // Fungsi untuk memaksa refresh data
    async function forceRefreshData() {
      try {
        showLoading(true);
        
        const response = await fetch(`/api/siswa/refresh_answers/${collectionId}?user_id=${userId}&force=true`);
        
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          // Reload halaman untuk menampilkan data yang sudah diperbaiki
          window.location.reload();
        } else {
          throw new Error(result.message || "Gagal memperbaiki data");
        }
      } catch (error) {
        console.error("Error refreshing data:", error);
        showLoading(false);
        showError(`Gagal memperbaiki data: ${error.message}`);
      }
    }
    
    // Fungsi untuk mengambil data hasil tes
    async function fetchTestResultData() {
      try {
        // Tambahkan timestamp untuk menghindari cache
        const timestamp = new Date().getTime();
        let url = `/api/siswa/results/${collectionId}?user_id=${userId}&t=${timestamp}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Data hasil tes:", data);
        
        if (!data.success && data.message) {
          throw new Error(data.message);
        }
        
        return data;
      } catch (error) {
        console.error("Error fetching test data:", error);
        throw error;
      }
    }
    
    // Fungsi untuk mengambil data siswa_answers langsung dari database
    async function fetchSiswaAnswers() {
      try {
        if (!collectionId || !userId) return null;
        
        // Fetch data siswa_answers langsung dari database
        const timestamp = new Date().getTime();
        const url = `/api/siswa_answers?user_id=${userId}&collection_id=${collectionId}&t=${timestamp}`;
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const data = await response.json();
        return data.siswa_answers || [];
      } catch (error) {
        console.error("Error fetching siswa_answers:", error);
        return null;
      }
    }
    
    // Fungsi untuk mengambil dan menyimpan riwayat jawaban (tanpa menampilkannya)
    async function fetchAndCacheAnswerHistory() {
      try {
        // Hanya ambil data, tapi tidak perlu menampilkan
        const timestamp = new Date().getTime();
        const url = `/api/siswa/results/${collectionId}?user_id=${userId}&t=${timestamp}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Riwayat jawaban disimpan:", data.answers);
        
        // Simpan semua jawaban untuk digunakan nanti
        allAnswers = data.answers || [];
        
        // Tambahkan informasi level ke jawaban jika tidak ada
        await enrichAnswersWithlevels(allAnswers);
      } catch (error) {
        console.error("Error fetching answer history:", error);
      }
    }
    
    // Fungsi untuk memperkaya data jawaban dengan informasi level
    async function enrichAnswersWithlevels(answers) {
      if (!answers || answers.length === 0) return;
      
      try {
        // Jika questionlevelMap belum ada, coba ambil data soal dulu
        if (Object.keys(questionlevelMap).length === 0) {
          await fetchQuestionData();
        }
        
        // Jika masih belum ada, coba ambil data siswa_answers langsung dari database
        if (Object.keys(questionlevelMap).length === 0) {
          const siswaAnswers = await fetchSiswaAnswers();
          if (siswaAnswers && siswaAnswers.length > 0) {
            siswaAnswers.forEach(answer => {
              if (answer.level && answer.question_id) {
                questionlevelMap[answer.question_id] = answer.level;
              }
            });
          }
        }
        
        // Tambahkan informasi level ke jawaban
        answers.forEach(answer => {
          if (!answer.level && answer.question_id && questionlevelMap[answer.question_id]) {
            answer.level = questionlevelMap[answer.question_id];
          }
        });
      } catch (error) {
        console.error("Error enriching answers with levels:", error);
      }
    }
    
    // Fungsi untuk menampilkan modal jawaban
    function showAnswersModal(type) {
      // Set judul modal
      const modalTitle = document.getElementById('answersModalLabel');
      modalTitle.textContent = type === 'correct' ? 'Jawaban Benar' : 'Jawaban Salah';
      
      // Tampilkan loading
      const modalBody = document.getElementById('answersModalBody');
      modalBody.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Memuat data jawaban...</p>
        </div>
      `;
      
      // Tampilkan modal
      const answersModal = new bootstrap.Modal(document.getElementById('answersModal'));
      answersModal.show();
      
      // Filter jawaban berdasarkan tipe (benar/salah)
      if (allAnswers.length > 0) {
        // Jika data jawaban sudah tersedia, gunakan data yang ada
        renderFilteredAnswers(type);
      } else {
        // Jika belum, ambil data jawaban dari API
        fetchAndRenderFilteredAnswers(type);
      }
    }
    
    // Fungsi untuk mengambil dan menampilkan jawaban yang difilter
    async function fetchAndRenderFilteredAnswers(type) {
      try {
        const timestamp = new Date().getTime();
        const url = `/api/siswa/results/${collectionId}?user_id=${userId}&t=${timestamp}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Detail struktur data jawaban:", data);
        
        if (data.answers && data.answers.length > 0) {
          console.log("Contoh objek jawaban pertama:", data.answers[0]);
        } else {
          console.log("Tidak ada jawaban dalam data");
        }
        
        // Simpan semua jawaban untuk digunakan nanti
        allAnswers = data.answers || [];
        
        // Tambahkan informasi level ke jawaban jika tidak ada
        await enrichAnswersWithlevels(allAnswers);
        
        // Render jawaban yang difilter
        renderFilteredAnswers(type);
        
      } catch (error) {
        console.error("Error fetching answers:", error);
        const modalBody = document.getElementById('answersModalBody');
        modalBody.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>Gagal memuat data jawaban: ${error.message}
          </div>
        `;
      }
    }
    
   // Fungsi untuk menampilkan jawaban yang difilter (dengan jawaban benar untuk jawaban salah)
function renderFilteredAnswers(type) {
  const modalBody = document.getElementById('answersModalBody');
  
  // Filter jawaban berdasarkan tipe
  const isCorrect = type === 'correct';
  const filteredAnswers = allAnswers.filter(answer => answer.is_correct === isCorrect);
  
  if (filteredAnswers.length === 0) {
    modalBody.innerHTML = `
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>Tidak ada jawaban ${isCorrect ? 'benar' : 'salah'} yang tersedia.
      </div>
    `;
    return;
  }
  
  // Render jawaban
  let answersHTML = '';
  
  filteredAnswers.forEach((answer, index) => {
    // Cek apakah ada jawaban benar yang tersedia (untuk jawaban salah)
    const correctAnswer = answer.jawaban_benar || answer.correct_answer || '';
    
    answersHTML += `
      <div class="card answer-card mb-3 ${isCorrect ? 'correct' : 'incorrect'}">
        <div class="card-body">
          <h5 class="card-title">Pertanyaan:</h5>
          <p class="answer-question">${answer.question || 'Tidak tersedia'}</p>
          
          <h5 class="card-title mt-3">Jawaban Anda:</h5>
          <div class="answer-response ${isCorrect ? 'bg-success text-white' : 'bg-danger text-white'}">
            ${answer.user_answer || 'Tidak tersedia'}
          </div>
          
          ${!isCorrect && correctAnswer ? `
            <h5 class="card-title mt-3">Jawaban Benar:</h5>
            <div class="answer-response bg-info text-white">
              ${correctAnswer}
            </div>
          ` : ''}
          
          ${answer.explanation ? `
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-info w-100" type="button" data-bs-toggle="collapse" data-bs-target="#modalExplanation${index}">
                <i class="bi bi-lightbulb me-1"></i>Lihat Penjelasan
              </button>
              <div class="collapse mt-2" id="modalExplanation${index}">
                <div class="explanation-text">
                  ${answer.explanation}
                </div>
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  modalBody.innerHTML = answersHTML;
}
    
    // Fungsi untuk merender halaman hasil
    function renderResultPage(data) {
      const ctx = document.getElementById('resultChart').getContext('2d');
      
      // Ambil data dari response API
      const correctValue = parseInt(data.correct || 0);
      const incorrectValue = parseInt(data.incorrect || 0);
      const totalValue = correctValue + incorrectValue;
      const currentlevel = parseInt(data.current_level || 1);
      
      // Hitung akurasi
      const accuracyValue = totalValue > 0 ? Math.round((correctValue / totalValue) * 100) : 0;
      
      // Perbarui visualisasi level path
      updatelevelPath(currentlevel);
      
      // Update nilai statistik
      document.getElementById('correct-value').textContent = correctValue;
      document.getElementById('incorrect-value').textContent = incorrectValue;
      document.getElementById('accuracy-value').textContent = accuracyValue + '%';
      document.getElementById('total-questions').textContent = `Total Soal: ${totalValue}`;
      document.getElementById('current-level-badge').textContent = currentlevel;
      document.getElementById('current-level-text').textContent = currentlevel;
      
      // Hitung persentase untuk progress bar
      const correctPercent = totalValue > 0 ? Math.round((correctValue / totalValue) * 100) : 0;
      const incorrectPercent = totalValue > 0 ? 100 - correctPercent : 0;
      
      // Update progress bar
      const correctProgressBar = document.getElementById('correct-progress');
      const incorrectProgressBar = document.getElementById('incorrect-progress');
      
      correctProgressBar.style.width = correctPercent + '%';
      incorrectProgressBar.style.width = incorrectPercent + '%';
      
      document.getElementById('correct-percent').textContent = correctPercent + '%';
      document.getElementById('incorrect-percent').textContent = incorrectPercent + '%';
      
      // Konfigurasi dan render chart
      const resultChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Benar', 'Salah'],
          datasets: [{
            data: [correctValue, incorrectValue],
            backgroundColor: ['#198754', '#dc3545'],
            borderColor: ['#198754', '#dc3545'],
            borderWidth: 1,
            hoverOffset: 15
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: {
                  size: 14
                },
                padding: 15
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const percentage = Math.round((value / totalValue) * 100) || 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          },
          cutout: '65%',
          animation: {
            animateScale: true,
            animateRotate: true,
            duration: 1000
          }
        }
      });
      
      // Generate personalized recommendations
      generateRecommendations(correctValue, incorrectValue, currentlevel);
    }
    
    // Update level path visualization
    function updatelevelPath(currentlevel) {
      // Mark levels as active or completed
      for (let i = 1; i <= 7; i++) {
        const levelElement = document.getElementById(`level${i}`);
        if (levelElement) {
          if (i < currentlevel) {
            levelElement.classList.add('completed');
          } else if (i === currentlevel) {
            levelElement.classList.add('active');
          }
        }
      }
    }
    // Function to export results to Excel
function exportToExcel() {
  try {
    showLoading(true);
    
    // Construct the URL with parameters
    const exportUrl = `/api/export_result_excel?user_id=${userId}&collection_id=${collectionId}`;
    
    // Create a hidden link element
    const link = document.createElement('a');
    link.href = exportUrl;
    link.style.display = 'none';
    
    // Append to body and trigger click
    document.body.appendChild(link);
    link.click();
    
    // Clean up
    setTimeout(() => {
      document.body.removeChild(link);
      showLoading(false);
    }, 2000);
    
  } catch (error) {
    console.error("Error exporting to Excel:", error);
    showLoading(false);
    
    // Show error notification
    Swal.fire({
      icon: 'error',
      title: 'Export Gagal',
      text: 'Terjadi kesalahan saat mengexport data ke Excel.',
      confirmButtonText: 'OK'
    });
  }
}

// Add event listener to the export button
document.addEventListener('DOMContentLoaded', function() {
  const exportButton = document.getElementById('exportExcelBtn');
  if (exportButton) {
    exportButton.addEventListener('click', exportToExcel);
  }
});
    // Generate personalized recommendations
    function generateRecommendations(correct, incorrect, currentlevel) {
      const recommendationList = document.getElementById('recommendation-list');
      if (!recommendationList) return;
      
      const recommendations = [];
      const total = correct + incorrect;
      const accuracy = total > 0 ? (correct / total) * 100 : 0;
      
      // Clear existing recommendations
      recommendationList.innerHTML = '';
      
      // Add recommendations based on performance
      if (accuracy < 50) {
        recommendations.push('Fokus pada peningkatan pemahaman dasar materi');
        recommendations.push('Perbaiki konsep dasar untuk meningkatkan kemampuan');
        recommendations.push('Cari sumber belajar tambahan untuk materi yang belum dipahami');
      } else if (accuracy < 75) {
        recommendations.push('Tingkatkan pemahaman pada level menengah (3-4)');
        recommendations.push('Pelajari kembali materi yang berkaitan dengan soal yang dijawab salah');
        recommendations.push('Latih kemampuan aplikasi konsep pada konteks berbeda');
      } else {
        recommendations.push('Lanjutkan pembelajaran ke materi yang lebih kompleks');
        recommendations.push('Coba tes pada koleksi lain untuk memperluas penguasaan materi');
        recommendations.push('Bantu teman yang mungkin kesulitan dengan materi yang sudah Anda kuasai');
      }
      
      // Add level-specific recommendations
      if (currentlevel < 5) {
        recommendations.push(`Ulangi tes untuk mencapai level yang lebih tinggi (saat ini: ${currentlevel})`);
      } else {
        recommendations.push('Selamat mencapai level akhir! Coba tes lain untuk tantangan baru');
      }
      
      // Add recommendations to the list
      recommendations.forEach(rec => {
        const li = document.createElement('li');
        li.textContent = rec;
        recommendationList.appendChild(li);
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
  const exportPdfBtn = document.getElementById('exportPdfBtn');
  if (exportPdfBtn) {
    exportPdfBtn.addEventListener('click', exportToPdf);
  }
});

// Function to export to PDF
function exportToPdf() {
  try {
    showLoading(true);
    
    // Construct the URL with parameters
    const exportUrl = `/api/export_result_pdf?user_id=${userId}&collection_id=${collectionId}`;
    
    // Open in a new tab or download directly
    window.open(exportUrl, '_blank');
    
    // Hide loading after a short delay
    setTimeout(() => {
      showLoading(false);
    }, 2000);
    
  } catch (error) {
    console.error("Error exporting to PDF:", error);
    showLoading(false);
    
    // Show error notification
    Swal.fire({
      icon: 'error',
      title: 'Export Gagal',
      text: 'Terjadi kesalahan saat mengexport data ke PDF.',
      confirmButtonText: 'OK'
    });
  }
}
  </script>
</body>
</html>
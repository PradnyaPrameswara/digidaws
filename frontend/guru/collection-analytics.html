<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analisis Koleksi - DIGIDAWS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .navbar {
      background-color: #0d6efd;
    }
    .navbar-brand {
      font-weight: bold;
    }
    .stat-card {
      transition: all 0.3s ease;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .user-info {
      color: white;
      margin-right: 15px;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    .level-progress {
      height: 30px;
      margin-bottom: 15px;
      position: relative;
    }
    .level-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
    }
    .student-row {
      transition: all 0.2s;
      cursor: pointer;
    }
    .student-row:hover {
      background-color: rgba(13,110,253,0.1);
    }
    .filter-card {
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .tab-content {
      padding: 20px 0;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .badge-correct {
      background-color: #198754;
    }
    .badge-incorrect {
      background-color: #dc3545;
    }
    
    /* CSS untuk warna badge level (Sesuai Permintaan) */
    .badge-level {
      color: white;
    }
    .badge-level-1 { background-color: #1976d2; color: white; } /* Biru (Awareness) */
    .badge-level-2 { background-color: #7b1fa2; color: white; } /* Ungu (Literacy) */
    .badge-level-3 { background-color: #388e3c; color: white; } /* Hijau (Capability) */
    .badge-level-4 { background-color: #f57c00; color: white; } /* Oranye (Creativity) */
    .badge-level-5 { background-color: #d32f2f; color: white; } /* Merah (Criticism) */
    /* AKHIR CSS */

    .form-check {
      display: inline-block;
      margin-right: 15px;
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      background-color: #f8f9fa;
      transition: all 0.2s;
    }
    .form-check:hover {
      background-color: #e9ecef;
    }
    .form-check-input:checked + .form-check-label {
      font-weight: bold;
      color: #0d6efd;
    }
    #classSelectionCollapse {
      background-color: #f8f9fa;
    }
    /* CSS untuk keterangan status siswa */
    .legend-list {
      list-style: none;
      padding-left: 0;
      font-size: 0.9rem;
    }
    .legend-list li {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .legend-list li:last-child {
      margin-bottom: 0;
    }
    .legend-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
  </style>
  <style>
    /* Logo in navbar */
    .navbar-brand .brand-logo {
      height: 28px;
      width: auto;
      margin-right: 8px;
      vertical-align: middle;
    }
    .navbar-brand-disabled { pointer-events: none; cursor: default; color: #fff !important; }
    .navbar { background-color: #0d6efd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar .nav-link { color: rgba(255,255,255,0.85); padding: 0.5rem 1rem; border-radius: 0.25rem; }
    .navbar .nav-link:hover, .navbar .nav-link.active { color: #fff !important; background-color: rgba(255,255,255,0.12); }
  </style>
  
  <!-- Skrip pengambilan ID dipindahkan ke DOMContentLoaded di bawah -->
  
</head>
<!-- PERBAIKAN: Menggunakan 'collection_id' (sesuai app.py) BUKAN 'collection.id' -->
<body data-collection-id="{{ collection_id | default('null') }}">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
  <span class="navbar-brand navbar-brand-disabled" title="DIGIDAWS = DIagnostik cerdas Guru untuk Identifikasi Deteksi Awal kemampuan siswa dan Wawasan Sistematis">
    <img src="/img/logo_digidaws.png" alt="Logo DIGIDAWS" class="brand-logo">DIGIDAWS
  </span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="/guru" id="nav-dashboard">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/guru/collections" id="nav-collections">
              <i class="bi bi-journal-bookmark"></i> Koleksi Soal
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/guru/panduan" id="nav-guide">
              <i class="bi bi-question-circle"></i> Panduan
            </a>
          </li>
        </ul>
        <div class="d-flex align-items-center">
          <span class="user-info">
            <i class="bi bi-person-circle"></i> {{ current_user.nama }} (Guru)
          </span>
          <a href="/logout" class="btn btn-outline-light">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </nav>
  <script>
    // Set active nav item
    (function(){
      try {
        const path = window.location.pathname || '';
        const navDashboard = document.getElementById('nav-dashboard');
        const navCollections = document.getElementById('nav-collections');
        const navGuide = document.getElementById('nav-guide');
        [navDashboard, navCollections, navGuide].forEach(el => el && el.classList.remove('active'));
        if (path === '/guru' || path === '/guru/') {
          navDashboard && navDashboard.classList.add('active');
        } else if (path.startsWith('/guru/collections')) {
          navCollections && navCollections.classList.add('active');
        } else if (path.startsWith('/guru/panduan')) {
          navGuide && navGuide.classList.add('active');
        }
      } catch (e) {}
    })();
  </script>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container mt-4">
    <a href="/guru/collections" class="btn btn-primary mb-3">
        <i class="bi bi-arrow-left"></i> Kembali ke Koleksi
    </a>

    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <h2 id="collection-title">Analisis Koleksi</h2>
            <p class="text-muted mb-0" id="collection-description">Memuat deskripsi...</p>
          </div>
          <div class="btn-group">
            <button class="btn btn-outline-success" id="exportAllDataBtn">
              <i class="bi bi-file-earmark-excel"></i> Export Semua Data
            </button>
            <button class="btn btn-outline-primary" id="refreshDataBtn">
              <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-5">
            <div class="card stat-card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted">Total Siswa</h6>
                        <h2 class="mb-0 text-primary" id="total-students">0</h2>
                    </div>
                    <div class="border-start ps-3 ms-3">
                        <ul class="legend-list mb-0">
                            <li><span class="legend-dot" style="background-color: #198754;"></span> Sudah Mengerjakan</li>
                            <li><span class="legend-dot" style="background-color: #6c757d;"></span> Belum Mulai</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="row">
                <div class="col-md-4">
                    <div class="card stat-card h-100 bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Jawaban Benar</h6>
                            <h2 class="mb-0 text-success" id="total-correct">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card h-100 bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Jawaban Salah</h6>
                            <h2 class="mb-0 text-danger" id="total-incorrect">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card h-100 bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Akurasi Rata-rata</h6>
                            <h2 class="mb-0 text-info" id="avg-accuracy">0%</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="analyticsTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
          <i class="bi bi-pie-chart"></i> Ikhtisar
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab" aria-controls="students" aria-selected="false">
          <i class="bi bi-people"></i> Siswa
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="levels-tab" data-bs-toggle="tab" data-bs-target="#levels" type="button" role="tab" aria-controls="levels" aria-selected="false">
          <i class="bi bi-diagram-3"></i> Analisis Level
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab" aria-controls="questions" aria-selected="false">
          <i class="bi bi-question-circle"></i> Soal
        </button>
      </li>
    </ul>

    <div class="tab-content" id="analyticsTabContent">
      <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <div class="card filter-card mb-4">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-funnel"></i> Filter</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Kelas</label>
                <select class="form-select" id="overview-class-filter">
                  <option value="all" selected>Semua Kelas</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Periode</label>
                <select class="form-select" id="overview-period-filter">
                  <option value="all" selected>Semua Waktu</option>
                  <option value="week">Minggu Ini</option>
                  <option value="month">Bulan Ini</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Status</label>
                <select class="form-select" id="overview-status-filter">
                  <option value="all" selected>Semua</option>
                  <option value="answered">Sudah Mengerjakan</option>
                  <option value="not_started">Belum Mulai</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header">
                <h5 class="mb-0">Status Pengerjaan Siswa</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="answerDistributionChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Perbandingan Kelas</h5>
                  <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse"
                          data-bs-target="#classSelectionCollapse" aria-expanded="false">
                    <i class="bi bi-funnel"></i> Pilih Kelas
                  </button>
                </div>
              </div>
              <div class="collapse" id="classSelectionCollapse">
                <div class="card-body border-bottom">
                  <div class="d-flex align-items-center mb-2">
                    <h6 class="mb-0 me-2">Pilih Kelas untuk Dibandingkan:</h6>
                    <button id="selectAllClasses" class="btn btn-sm btn-outline-secondary">Pilih Semua</button>
                    <button id="deselectAllClasses" class="btn btn-sm btn-outline-secondary ms-2">Batalkan Semua</button>
                  </div>
                  <div id="classCheckboxes" class="d-flex flex-wrap gap-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="classComparisonChart"></canvas>
                </div>
                <div id="noClassSelectedMessage" class="text-center text-muted py-5" style="display: none;">
                  <i class="bi bi-exclamation-circle fs-3"></i>
                  <p class="mt-2">Silakan pilih minimal satu kelas untuk melihat perbandingan</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">Distribusi Level (MST 5 Tahap)</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-12">
                        <div class="chart-container">
                            <canvas id="levelDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <div class="tab-pane fade" id="students" role="tabpanel" aria-labelledby="students-tab">
        <div class="card filter-card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <h5 class="card-title mb-0"><i class="bi bi-funnel"></i> Filter Siswa</h5>
              <button class="btn btn-success" id="exportClassDataBtn">
                <i class="bi bi-file-earmark-excel"></i> Export Data Kelas Terfilter
              </button>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label">Kelas</label>
                <select class="form-select" id="student-class-filter">
                  <option value="all" selected>Semua Kelas</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Status</label>
                <select class="form-select" id="student-status-filter">
                  <option value="all" selected>Semua</option>
                  <option value="answered">Sudah Mengerjakan</option>
                  <option value="not_started">Belum Mulai</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Pencarian</label>
                <input type="text" class="form-control" id="student-search" placeholder="Nama siswa...">
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="mb-0">Daftar Siswa (<span id="filtered-student-count">0</span>)</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="studentsTable">
                <thead>
                  <tr>
                    <th>Nama</th>
                    <th>Kelas</th>
                    <th>Status</th>
                    <th>Level</th>
                    <th>Benar</th>
                    <th>Salah</th>
                    <th>Akurasi</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="studentsTableBody">
                  <tr>
                    <td colspan="8" class="text-center">Memuat data siswa...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="levels" role="tabpanel" aria-labelledby="levels-tab">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Persebaran Level (MST 5 Tahap)</h5>
          </div>
          <div class="card-body">
            <!-- Konten chart (sama dengan di Ikhtisar) -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="chart-container">
                  <canvas id="levelDistributionChart2"></canvas> 
                </div>
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-lg col-md-6">
                <div class="card bg-light h-100">
                  <div class="card-body text-center">
                    <h6 class="text-muted">L1 (Awareness)</h6>
                    <h3 id="level-1-percentage">0%</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg col-md-6">
                <div class="card bg-light h-100">
                  <div class="card-body text-center">
                    <h6 class="text-muted">L2 (Literacy)</h6>
                    <h3 id="level-2-percentage">0%</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg col-md-6">
                <div class="card bg-light h-100">
                  <div class="card-body text-center">
                    <h6 class="text-muted">L3 (Capability)</h6>
                    <h3 id="level-3-percentage">0%</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg col-md-6">
                <div class="card bg-light h-100">
                  <div class="card-body text-center">
                    <h6 class="text-muted">L4 (Creativity)</h6>
                    <h3 id="level-4-percentage">0%</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg col-md-6">
                <div class="card bg-light h-100">
                  <div class="card-body text-center">
                    <h6 class="text-muted">L5 (Criticism)</h6>
                    <h3 id="level-5-percentage">0%</h3>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="questions" role="tabpanel" aria-labelledby="questions-tab">
        <div class="card shadow-sm mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Analisis Soal (<span id="filtered-question-count">0</span>)</h5>
            <div>
              <select class="form-select form-select-sm" id="question-level-filter">
                 <option value="all">Semua Level (L1-L5)</option>
                 <option value="1">L1: Awareness</option>
                 <option value="2">L2: Literacy</option>
                 <option value="3">L3: Capability</option>
                 <option value="4">L4: Creativity</option>
                 <option value="5">L5: Criticism</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>No.</th> 
                    <th>Level</th>
                    <th>Soal</th>
                    <th>Kesulitan</th>
                    <th>Benar</th>
                    <th>Salah</th>
                    <th>Akurasi</th>
                  </tr>
                </thead>
                <tbody id="questionsTableBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="studentDetailModal" tabindex="-1" aria-labelledby="studentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="studentDetailModalLabel">Detail Siswa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="card mb-4">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-muted">Nama</h6>
                  <h5 id="modal-student-name">-</h5>
                </div>
                <div class="col-md-3">
                  <h6 class="text-muted">Kelas</h6>
                  <h5 id="modal-student-class">-</h5>
                </div>
                <div class="col-md-3">
                  <h6 class="text-muted">Level Tercapai</h6>
                  <!-- PERBAIKAN: Hapus bg-primary agar class dinamis bisa diterapkan -->
                  <h5><span class="badge" id="modal-student-level">-</span></h5>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Status</h6>
                  <h5 id="modal-student-status">-</h5>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Jawaban Benar</h6>
                  <h5 class="text-success" id="modal-student-correct">0</h5>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Jawaban Salah</h6>
                  <h5 class="text-danger" id="modal-student-incorrect">0</h5>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Akurasi</h6>
                  <h5 class="text-info" id="modal-student-accuracy">0%</h5>
                </div>
              </div>
            </div>
          </div>

          <h5 class="mb-3">Riwayat Jawaban</h5>
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>Level</th>
                  <th>Soal</th>
                  <th>Jawaban Siswa</th>
                  <th>Status</th>
                  <th>Waktu</th>
                </tr>
              </thead>
              <tbody id="modal-answer-history">
                <!-- Data diisi JS -->
              </tbody>
            </table>
          </div>

          <h5 class="mb-3 mt-4">Perjalanan Level (MST 5 Tahap)</h5>
            <div class="progress level-progress" style="height: 30px;">
              <div class="progress-bar bg-success" role="progressbar" style="width: 20%" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100"><span class="level-label">L1</span></div>
              <div class="progress-bar bg-info" role="progressbar" style="width: 20%" aria-valuenow="2" aria-valuemin="0" aria-valuemax="100"><span class="level-label">L2</span></div>
              <div class="progress-bar bg-warning" role="progressbar" style="width: 20%" aria-valuenow="3" aria-valuemin="0" aria-valuemax="100"><span class="level-label">L3</span></div>
              <div class="progress-bar bg-danger" role="progressbar" style="width: 20%" aria-valuenow="4" aria-valuemin="0" aria-valuemax="100"><span class="level-label">L4</span></div>
              <div class="progress-bar bg-dark" role="progressbar" style="width: 20%" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100"><span class="level-label">L5</span></div>
            </div>
          <div class="text-center mt-2 mb-4">
            <!-- PERBAIKAN: Hapus bg-primary agar class dinamis bisa diterapkan -->
            <span class="badge" id="modal-current-level-indicator">Level Tercapai: <span id="modal-current-level">-</span></span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="button" class="btn btn-success" id="modalExportBtn">
            <i class="bi bi-file-earmark-excel"></i> Export Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="exportClassModal" tabindex="-1" aria-labelledby="exportClassModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportClassModalLabel">Export Data Kelas</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="exportClassSelect" class="form-label">Pilih Kelas</label>
            <select class="form-select" id="exportClassSelect">
              <option value="">-- Pilih Kelas --</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-success" id="confirmExportClassBtn">
            <i class="bi bi-file-earmark-excel"></i> Export
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="exportAllModal" tabindex="-1" aria-labelledby="exportAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportAllModalLabel">Export Semua Data</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Pilih data yang ingin diexport:</p>

          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="exportType" id="exportTypeAll" value="all" checked>
            <label class="form-check-label" for="exportTypeAll">
              Semua Data (Semua Siswa)
            </label>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="exportType" id="exportTypeClass" value="class">
            <label class="form-check-label" for="exportTypeClass">
              Data Per Kelas
            </label>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="exportType" id="exportTypeStudent" value="individual">
            <label class="form-check-label" for="exportTypeStudent">
              Data Per Siswa
            </label>
          </div>

          <div id="classSelectionForm" class="mt-3" style="display: none;">
            <div class="mb-3">
              <label for="allExportClassSelect" class="form-label">Pilih Kelas</label>
              <select class="form-select" id="allExportClassSelect">
                <option value="">-- Pilih Kelas --</option>
                </select>
            </div>
          </div>

          <div id="studentSelectionForm" class="mt-3" style="display: none;">
            <div class="mb-3">
              <label for="allExportStudentSelect" class="form-label">Pilih Siswa</label>
              <select class="form-select" id="allExportStudentSelect">
                <option value="">-- Pilih Siswa --</option>
                </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-success" id="confirmAllExportBtn">
            <i class="bi bi-file-earmark-excel"></i> Export
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Global variables
    let collectionId = null;
    let collectionData = null; // Menyimpan data dari /api/guru/collection-recommendations-summary
    let studentsData = []; // Menyimpan array students_summary
    let questionsData = []; // Menyimpan data dari /api/collections/.../questions
    let chartInstances = {};
    let selectedClasses = {}; // Untuk menyimpan kelas yang dipilih

    // --- Definisi Label dan Warna untuk 5 Tahap MST ---
    const MST_STAGES = ['L1', 'L2', 'L3', 'L4', 'L5'];
    const MST_LABELS = [
        'L1: Awareness',
        'L2: Literacy',
        'L3: Capability',
        'L4: Creativity',
        'L5: Criticism'
    ];
    // PERBAIKAN: Warna Sesuai Permintaan (Hijau = Sudah, Abu = Belum)
    const MST_COLOR_ANSWERED = '#198754'; // HIJAU
    const MST_COLOR_NOT_STARTED = '#6c757d'; // ABU-ABU

    // --- PERBAIKAN: Definisi Warna Badge Level ---
    const LEVEL_COLORS = {
        1: 'badge-level-1',
        2: 'badge-level-2',
        3: 'badge-level-3',
        4: 'badge-level-4',
        5: 'badge-level-5',
    };
    const DEFAULT_LEVEL_COLOR = 'badge-level-1'; // Fallback
    // --- AKHIR PERBAIKAN ---


    // Initialize on document ready
    document.addEventListener('DOMContentLoaded', function() {
      // PERBAIKAN: Ambil collectionId dari data-attribute di body
      try {
        const collectionIdStr = document.body.dataset.collectionId;
        if (!collectionIdStr || collectionIdStr === 'null') {
             // Fallback jika data-attribute gagal (ambil dari URL)
             const pathSegments = window.location.pathname.split('/');
             const idFromUrl = pathSegments[pathSegments.length - 1];
             if (!/^\d+$/.test(idFromUrl)) {
                throw new Error("ID Koleksi tidak valid (bukan angka) di URL atau data-attribute.");
             }
             collectionId = parseInt(idFromUrl, 10);
             console.log("ID Koleksi diambil dari URL (Fallback):", collectionId);
        } else {
            collectionId = parseInt(collectionIdStr, 10);
            console.log("ID Koleksi diambil dari data-attribute:", collectionId);
        }
        
        if (!collectionId) {
            throw new Error("ID Koleksi tidak ditemukan.");
        }

      } catch (e) {
          console.error("Gagal mendapatkan ID Koleksi:", e);
          showError("Gagal mendapatkan ID Koleksi dari server. Halaman tidak dapat dimuat. " + e.message);
          showLoading(false);
          return;
      }
      
      // Fetch data and initialize charts
      initializeAnalytics();

      // Setup event listeners
      document.getElementById('refreshDataBtn').addEventListener('click', refreshData);
      setupFilterListeners();
      setupExportFunctionality();
    });

    // Initialize analytics
    async function initializeAnalytics() {
      showLoading(true);
      try {
        // --- PERBAIKAN: Pengambilan Data Terpusat ---
        const summaryData = await fetchSummaryData();
        
        collectionData = {
            name: summaryData.collection_name,
            description: summaryData.collection_description
        };
        // PERBAIKAN: Pastikan studentsData adalah array
        studentsData = summaryData.students_summary || []; 

        // Fetch questions data (masih diperlukan untuk tab Soal)
        await fetchQuestionsData();

        updateCollectionInfo();
        populateClassFilters();
        populateClassCheckboxes();
        initializeCharts();
        renderStudentsTable();
        renderQuestionsTable();
        
        renderlevelJourneyTable(); // (Dikosongkan)

        updateSummaryStats();
        // PERBAIKAN: Panggil fungsi yang benar
        updateLevelDistributionStats(); // Memanggil fungsi yang sudah didefinisikan

        showLoading(false);
      } catch (error) {
        showLoading(false);
        console.error("Error saat inisialisasi:", error); // Log error ke console
        showError('Gagal memuat data analisis: ' + error.message);
      }
    }

    // --- FUNGSI BARU: Fetch data rangkuman terpusat ---
    async function fetchSummaryData() {
        // PERBAIKAN: Gunakan URL Absolut
        const response = await fetch(`${window.location.origin}/api/guru/collection-recommendations-summary/${collectionId}`);
        if (!response.ok) {
            const errorText = await response.text();
            console.error("Server Error Response:", errorText);
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.message || 'Gagal mengambil data rangkuman');
        }
        console.log("Rangkuman Data Diterima:", result);
        return result;
    }

    // Fetch questions in this collection (TETAP DIPERLUKAN)
    async function fetchQuestionsData() {
        const response = await fetch(`${window.location.origin}/api/collections/${collectionId}/questions`); // Use full URL
      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();
      if (!result.success) {
        throw new Error(result.message || 'Gagal mengambil data soal');
      }

      questionsData = result.questions.map(question => ({
        ...question,
        correctCount: 0, 
        incorrectCount: 0,
        accuracy: 0
      }));
      
      await calculateQuestionStats();

      return questionsData;
    }
    
    // --- FUNGSI BARU: Menghitung statistik per soal ---
    async function calculateQuestionStats() {
        try {
            const response = await fetch(`${window.location.origin}/api/collection-analytics/answers?collection_id=${collectionId}`);
            if (!response.ok) throw new Error("Gagal mengambil data jawaban mentah");
            
            const result = await response.json();
            if (!result.success || !Array.isArray(result.answers)) {
                console.warn("Tidak dapat menghitung statistik soal, data jawaban tidak valid.");
                return;
            }
            
            const allAnswers = result.answers;
            
            questionsData.forEach(question => {
                const answersForThisQ = allAnswers.filter(a => a.question_id === question.id);
                const correct = answersForThisQ.filter(a => a.is_correct).length;
                const total = answersForThisQ.length;
                
                question.correctCount = correct;
                question.incorrectCount = total - correct;
                question.accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            });

            console.log("Statistik Soal Diperbarui:", questionsData);

        } catch (error) {
            console.error("Error menghitung statistik soal:", error);
        }
    }

    // Update collection info on the page
    function updateCollectionInfo() {
      if (collectionData) {
        document.getElementById('collection-title').textContent = `Analisis: ${collectionData.name}`;
        document.getElementById('collection-description').textContent = collectionData.description || 'Tidak ada deskripsi';
      }
    }

    // Populate class filter options
    function populateClassFilters() {
      // PERBAIKAN: Gunakan student.student_class
      const classes = [...new Set(studentsData.map(student => student.student_class))].filter(Boolean).sort(); // Sort classes

      // Populate overview class filter
      const overviewClassFilter = document.getElementById('overview-class-filter');
      overviewClassFilter.innerHTML = '<option value="all" selected>Semua Kelas</option>';

      classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        overviewClassFilter.appendChild(option.cloneNode(true));
      });

      // Populate student class filter
      const studentClassFilter = document.getElementById('student-class-filter');
      studentClassFilter.innerHTML = '<option value="all" selected>Semua Kelas</option>';

      classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        studentClassFilter.appendChild(option);
      });
    }

    // Fungsi untuk mengisi checkbox kelas
    function populateClassCheckboxes() {
      // PERBAIKAN: Gunakan student.student_class
      const classes = [...new Set(studentsData.map(student => student.student_class))].filter(Boolean).sort(); // Sort classes
      const checkboxContainer = document.getElementById('classCheckboxes');

      // Bersihkan container
      checkboxContainer.innerHTML = '';

      if (classes.length === 0) {
        checkboxContainer.innerHTML = '<p class="text-muted">Tidak ada data kelas</p>';
        return;
      }

      // Secara default semua kelas dipilih
      classes.forEach(className => {
        selectedClasses[className] = true;

        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'form-check';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input class-checkbox';
        checkbox.id = `class-${className.replace(/\s+/g, '-').replace(/\./g, '')}`; // Sanitize ID
        checkbox.value = className;
        checkbox.checked = true;

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.htmlFor = checkbox.id;
        label.textContent = className;

        checkbox.addEventListener('change', function() {
          selectedClasses[className] = this.checked;
          // PERBAIKAN: Panggil updateClassComparisonChart dengan data yang benar
          updateClassComparisonChart(studentsData);
        });

        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        checkboxContainer.appendChild(checkboxDiv);
      });

      // Event listener untuk tombol "Pilih Semua"
      document.getElementById('selectAllClasses').addEventListener('click', function() {
        document.querySelectorAll('.class-checkbox').forEach(checkbox => {
          checkbox.checked = true;
          selectedClasses[checkbox.value] = true;
        });
        updateClassComparisonChart(studentsData);
      });

      // Event listener untuk tombol "Batalkan Semua"
      document.getElementById('deselectAllClasses').addEventListener('click', function() {
        document.querySelectorAll('.class-checkbox').forEach(checkbox => {
          checkbox.checked = false;
          selectedClasses[checkbox.value] = false;
        });
        updateClassComparisonChart(studentsData);
      });
    }

    // Initialize charts
    function initializeCharts() {
        Object.values(chartInstances).forEach(chart => {
            if (chart && typeof chart.destroy === 'function') {
                chart.destroy();
            }
        });
        chartInstances = {}; // Reset instances

      initAnswerDistributionChart();
      initClassComparisonChart();
      initlevelDistributionChart();
      initlevelDistributionChart2();
    }

    // Initialize answer distribution chart
    function initAnswerDistributionChart() {
        const ctx = document.getElementById('answerDistributionChart').getContext('2d');
        const totalStudents = studentsData.length;
        
        const answeredStudents = studentsData.filter(s => s.status === 'sudah_mengerjakan' || s.status === 'sedang_mengerjakan').length;
        const notStartedStudents = studentsData.filter(s => s.status === 'belum_mengerjakan').length;

        const chartData = {
            labels: ['Sudah Mengerjakan', 'Belum Mengerjakan'],
            datasets: [{
                data: [answeredStudents, notStartedStudents],
                backgroundColor: [
                    MST_COLOR_ANSWERED, // Hijau
                    MST_COLOR_NOT_STARTED  // Abu-abu
                ],
                borderWidth: 1
            }]
        };

        document.querySelector('#answerDistributionChart').closest('.card').querySelector('.card-header h5').textContent = 'Status Pengerjaan Siswa';

        chartInstances.answerDistribution = new Chart(ctx, {
            type: 'pie',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const percentage = totalStudents > 0 ? ((value / totalStudents) * 100).toFixed(1) : 0;
                                return `${label}: ${value} siswa (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize class comparison chart
    function initClassComparisonChart() {
      const ctx = document.getElementById('classComparisonChart').getContext('2d');
      chartInstances.classComparison = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Akurasi (%)',
            data: [],
            backgroundColor: '#0d6efd',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: { display: true, text: 'Akurasi (%)' }
            },
            x: {
              title: { display: true, text: 'Kelas' }
            }
          }
        }
      });
      updateClassComparisonChart(studentsData);
    }

    // Initialize level distribution chart (MST 5 Tahap)
    function initlevelDistributionChart() {
        const ctx = document.getElementById('levelDistributionChart')?.getContext('2d');
        if (!ctx) return; 

        const stageData = calculateStageData(studentsData);

        chartInstances.levelDistribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: MST_LABELS,
                datasets: [
                    {
                        label: 'Belum Mengerjakan',
                        data: MST_STAGES.map(stage => stageData[stage].notStarted),
                        backgroundColor: MST_COLOR_NOT_STARTED, // Abu-abu
                        borderWidth: 1
                    },
                    {
                        label: 'Sudah Mengerjakan (Selesai/Berhenti)',
                        data: MST_STAGES.map(stage => stageData[stage].answered),
                        backgroundColor: MST_COLOR_ANSWERED, // Hijau
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        title: { display: true, text: 'Distribusi Level (MST 5 Tahap)' }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: { display: true, text: 'Jumlah Siswa' }
                    }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        mode: 'index', 
                        callbacks: {
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const value = context.raw || 0;
                                return `${datasetLabel}: ${value} siswa`;
                            }
                        }
                    }
                }
            }
        });
        
        chartInstances.levelDistribution.stageData = stageData;
    }
    
    // Chart kedua di tab "Analisis Level"
    function initlevelDistributionChart2() {
        const ctx = document.getElementById('levelDistributionChart2')?.getContext('2d'); 
        if (!ctx) {
            console.warn("Elemen canvas 'levelDistributionChart2' tidak ditemukan.");
            return; 
        }
        
        const stageData = calculateStageData(studentsData);

        chartInstances.levelDistribution2 = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: MST_LABELS,
                datasets: [ 
                    {
                        label: 'Belum Mengerjakan',
                        data: MST_STAGES.map(stage => stageData[stage].notStarted),
                        backgroundColor: MST_COLOR_NOT_STARTED,
                        borderWidth: 1
                    },
                    {
                        label: 'Sudah Mengerjakan (Selesai/Berhenti)',
                        data: MST_STAGES.map(stage => stageData[stage].answered),
                        backgroundColor: MST_COLOR_ANSWERED,
                        borderWidth: 1
                    }
                ]
            },
            options: { // Opsi sama dengan chart pertama
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true, title: { display: true, text: 'Distribusi Level (MST 5 Tahap)' } },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Jumlah Siswa' } }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        mode: 'index',
                        callbacks: {
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const value = context.raw || 0;
                                return `${datasetLabel}: ${value} siswa`;
                            }
                        }
                    }
                }
            }
        });
        chartInstances.levelDistribution2.stageData = stageData;
    }

    // Helper untuk menghitung data stage
    function calculateStageData(filteredStudents) {
        const stageData = {};
        MST_STAGES.forEach(stage => {
            stageData[stage] = { answered: 0, notStarted: 0 };
        });

        filteredStudents.forEach(student => {
            const currentLevel = parseInt(student.result?.current_level || 1);
            const validLevel = Math.max(1, Math.min(5, currentLevel));
            const stage = `L${validLevel}`; 

            if (stageData[stage]) {
                if (student.status === 'sudah_mengerjakan' || student.status === 'sedang_mengerjakan') {
                    stageData[stage].answered++;
                } else { // 'belum_mengerjakan' atau status error
                    stageData[stage].notStarted++; 
                }
            } else {
                console.warn(`Invalid stage derived in calculate: ${stage} for level ${currentLevel}`);
            }
        });
        console.log("Calculated Stage Data (Answered/NotStarted):", stageData);
        return stageData;
    }

    // Fungsi `renderlevelJourneyTable` (dikosongkan)
     function renderlevelJourneyTable() {
         const tableBody = document.getElementById('levelJourneyTableBody');
         if(tableBody) {
             const cardBody = tableBody.closest('.card-body');
             if(cardBody) {
                 const elementsToHide = cardBody.querySelectorAll('.table-responsive, h5.mb-3, p.text-muted');
                 elementsToHide.forEach(el => el.style.display = 'none');
             }
         }
     }


    // Update Class Comparison Chart
    function updateClassComparisonChart(filteredStudents) {
      if (!chartInstances.classComparison) return;

      const classes = {};
      filteredStudents.forEach(student => {
        const className = student.student_class;
        if (className && selectedClasses[className]) {
          if (!classes[className]) {
            classes[className] = {
              correctCount: 0,
              incorrectCount: 0,
              studentCount: 0
            };
          }
          
          classes[className].correctCount += student.result?.correct || 0;
          classes[className].incorrectCount += student.result?.incorrect || 0;
          classes[className].studentCount++;
        }
      });

      const classLabels = Object.keys(classes).sort(); 
      const classAccuracies = classLabels.map(className => {
        const classData = classes[className];
        const total = classData.correctCount + classData.incorrectCount;
        return total > 0 ? Math.round((classData.correctCount / total) * 100) : 0;
      });

      chartInstances.classComparison.data.labels = classLabels;
      chartInstances.classComparison.data.datasets[0].data = classAccuracies;
      chartInstances.classComparison.update();

      const noClassMessage = document.getElementById('noClassSelectedMessage');
      if (noClassMessage) {
        if (classLabels.length === 0) {
          noClassMessage.style.display = 'block';
          document.getElementById('classComparisonChart').style.display = 'none';
        } else {
          noClassMessage.style.display = 'none';
          document.getElementById('classComparisonChart').style.display = 'block';
        }
      }
    }

    // Render students table
    function renderStudentsTable(filteredStudents = studentsData) { 
      const tableBody = document.getElementById('studentsTableBody');
        const countElement = document.getElementById('filtered-student-count');
        countElement.textContent = filteredStudents.length;


      if (!filteredStudents || filteredStudents.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Tidak ada data siswa yang sesuai filter</td></tr>';
        return;
      }

      tableBody.innerHTML = filteredStudents.map(student => {
        const result = student.result || {}; 
        const total = (result.correct || 0) + (result.incorrect || 0);
        const accuracy = result.accuracy || 0; 
        const currentLevelRaw = parseInt(result.current_level ?? 1);
        const currentLevel = Math.max(1, Math.min(5, (isNaN(currentLevelRaw) ? 1 : currentLevelRaw)));
        // PERBAIKAN: Terapkan class warna dinamis + clamp 1..5
        const levelClass = LEVEL_COLORS[currentLevel] || DEFAULT_LEVEL_COLOR;

        let statusBadge = '';
        // PERBAIKAN: Gunakan 'student.status' DAN warnai hijau jika sudah menjawab
    if (student.status === 'sudah_mengerjakan') {
      statusBadge = `<span class="badge" style="background-color: ${MST_COLOR_ANSWERED}; color: white;">Selesai (L5)</span>`;
    } else if (student.status === 'sedang_mengerjakan') {
      // Sesuaikan wording dan clamp level ke 1..5
      statusBadge = `<span class="badge" style="background-color: ${MST_COLOR_ANSWERED}; color: white;">Berhenti di L${currentLevel}</span>`;
        } else if (student.status === 'belum_mengerjakan') {
            statusBadge = `<span class="badge" style="background-color: ${MST_COLOR_NOT_STARTED}; color: white;">Belum Mulai</span>`;
        } else {
            statusBadge = `<span class="badge bg-danger">${student.status || 'Error'}</span>`;
        }

        return `
          <tr class="student-row" data-id="${student.student_id}">
            <td>${escapeHtml(student.student_name || '-')}</td>
            <td>${escapeHtml(student.student_class || '-')}</td>
            <td>${statusBadge}</td>
            <!-- PERBAIKAN: Terapkan class warna dinamis -->
            <td><span class="badge ${levelClass}">L${currentLevel}</span></td>
            <td><span class="badge badge-correct">${result.correct || 0}</span></td>
            <td><span class="badge badge-incorrect">${result.incorrect || 0}</span></td>
            <td>${accuracy}%</td>
            <td>
              <button class="btn btn-sm btn-outline-primary view-student-btn" data-id="${student.student_id}">
                <i class="bi bi-eye"></i> Detail
              </button>
              <button class="btn btn-sm btn-outline-success export-student-btn" data-id="${student.student_id}">
                <i class="bi bi-file-earmark-excel"></i> Export
              </button>
            </td>
          </tr>
        `;
      }).join('');

      // Add event listeners for detail buttons
      document.querySelectorAll('.view-student-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const studentId = btn.getAttribute('data-id');
          showStudentDetail(studentId);
        });
      });

      // Add event listeners for export buttons
      document.querySelectorAll('.export-student-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const studentId = btn.getAttribute('data-id');
          exportStudentData(studentId);
        });
      });

      // Also add click event to rows
      document.querySelectorAll('.student-row').forEach(row => {
        row.addEventListener('click', (e) => {
          // Ignore if clicked on the button
          if (!e.target.closest('.view-student-btn') && !e.target.closest('.export-student-btn')) {
            const studentId = row.getAttribute('data-id');
            showStudentDetail(studentId);
          }
        });
      });
    }

    // Render questions table
    function renderQuestionsTable(filteredQuestions = questionsData) { 
      const tableBody = document.getElementById('questionsTableBody');
        const countElement = document.getElementById('filtered-question-count');
        countElement.textContent = filteredQuestions.length;

      if (!filteredQuestions || filteredQuestions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data soal yang sesuai filter</td></tr>';
        return;
      }

      tableBody.innerHTML = filteredQuestions.map((question, index) => {
        const questionText = question.soal.length > 50
          ? question.soal.substring(0, 50) + '...'
          : question.soal;

        let difficultyLabel = '';
        let difficultyText = question.difficulty || 'Medium'; 

        if (difficultyText === 'Easy') {
            difficultyLabel = '<span class="badge bg-success">Mudah</span>';
        } else if (difficultyText === 'Medium') {
            difficultyLabel = '<span class="badge bg-warning text-dark">Sedang</span>';
        } else {
            difficultyLabel = '<span class="badge bg-danger">Sulit</span>';
        }
        
  // PERBAIKAN: Terapkan class warna dinamis + clamp 1..5
  const levelRaw = parseInt(question.technology_level || 0);
  const levelValid = Math.max(1, Math.min(5, (isNaN(levelRaw) ? 1 : levelRaw)));
  const levelClass = `badge-level-${levelValid}`;

        return `
          <tr>
            <td>${index + 1}</td> 
            <td><span class="badge ${levelClass}">L${levelValid}</span></td>
            <td title="${escapeHtml(question.soal)}">${escapeHtml(questionText)}</td>
            <td>${difficultyLabel}</td>
            <td><span class="badge badge-correct">${question.correctCount || 0}</span></td>
            <td><span class="badge badge-incorrect">${question.incorrectCount || 0}</span></td>
            <td>${question.accuracy || 0}%</td>
          </tr>
        `;
      }).join('');
    }

    // Update summary statistics
    function updateSummaryStats() {
      // Total students
      document.getElementById('total-students').textContent = studentsData.length;

      const totalCorrect = studentsData.reduce((sum, student) => sum + (student.result?.correct || 0), 0);
      document.getElementById('total-correct').textContent = totalCorrect;

      const totalIncorrect = studentsData.reduce((sum, student) => sum + (student.result?.incorrect || 0), 0);
      document.getElementById('total-incorrect').textContent = totalIncorrect;

      // Average accuracy
      const totalAnswers = totalCorrect + totalIncorrect;
      const avgAccuracy = totalAnswers > 0 ? Math.round((totalCorrect / totalAnswers) * 100) : 0;
      document.getElementById('avg-accuracy').textContent = avgAccuracy + '%';
    }

    // --- FUNGSI INI DIPERBAIKI ---
    // Update level distribution statistics - UPDATED FOR 5 STAGES
    function updateLevelDistributionStats(filteredStudents = studentsData) {
        const levelCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        
        // PERBAIKAN: Hitung berdasarkan level siswa yang terfilter
        filteredStudents.forEach(s => {
            // PERBAIKAN: Gunakan student.result.current_level
            const level = parseInt(s.result?.current_level || 1);
            const validLevel = Math.max(1, Math.min(5, level));
            
            // Hanya hitung siswa yang sudah menjawab
            if (s.status === 'sudah_mengerjakan' || s.status === 'sedang_mengerjakan') {
                levelCounts[validLevel]++;
            }
        });

        // Hitung total siswa yang sudah menjawab (bukan total siswa)
        const totalAnsweredStudents = filteredStudents.filter(s => s.status === 'sudah_mengerjakan' || s.status === 'sedang_mengerjakan').length;
        
        const percentages = {
            1: totalAnsweredStudents > 0 ? Math.round((levelCounts[1] / totalAnsweredStudents) * 100) : 0,
            2: totalAnsweredStudents > 0 ? Math.round((levelCounts[2] / totalAnsweredStudents) * 100) : 0,
            3: totalAnsweredStudents > 0 ? Math.round((levelCounts[3] / totalAnsweredStudents) * 100) : 0,
            4: totalAnsweredStudents > 0 ? Math.round((levelCounts[4] / totalAnsweredStudents) * 100) : 0,
            5: totalAnsweredStudents > 0 ? Math.round((levelCounts[5] / totalAnsweredStudents) * 100) : 0
        };

        // Update UI (Kartu Statistik di tab Analisis Level)
        const l1 = document.getElementById('level-1-percentage');
        const l2 = document.getElementById('level-2-percentage');
        const l3 = document.getElementById('level-3-percentage');
        const l4 = document.getElementById('level-4-percentage');
        const l5 = document.getElementById('level-5-percentage');

        if(l1) l1.textContent = percentages[1] + '%';
        if(l2) l2.textContent = percentages[2] + '%';
        if(l3) l3.textContent = percentages[3] + '%';
        if(l4) l4.textContent = percentages[4] + '%';
        if(l5) l5.textContent = percentages[5] + '%';
    }
    // --- AKHIR FUNGSI YANG DIPERBAIKI ---


    // Show student detail modal
    async function showStudentDetail(studentId) {
      const student = studentsData.find(s => s.student_id == studentId);

      if (!student) {
        showError('Data siswa tidak ditemukan');
        return;
      }
      
      const modal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
      modal.show();
      
      document.getElementById('modal-student-name').textContent = student.student_name || '-';
      document.getElementById('modal-student-class').textContent = student.student_class || '-';
      
  const studentLevelRaw = parseInt(student.result?.current_level ?? 1);
  const studentLevel = Math.max(1, Math.min(5, (isNaN(studentLevelRaw) ? 1 : studentLevelRaw)));
  const levelClass = LEVEL_COLORS[studentLevel] || DEFAULT_LEVEL_COLOR;

      // PERBAIKAN: Terapkan class dinamis ke badge
      const levelBadge = document.getElementById('modal-student-level');
      levelBadge.textContent = `L${studentLevel}`; 
      levelBadge.className = `badge ${levelClass}`; 

      const indicatorBadge = document.getElementById('modal-current-level');
      indicatorBadge.textContent = `L${studentLevel}`;
      const indicatorParent = document.getElementById('modal-current-level-indicator');
      indicatorParent.className = `badge ${levelClass}`;

      document.getElementById('modalExportBtn').setAttribute('data-student-id', studentId);

      // Status
      let statusText = '';
    if (student.status === 'sudah_mengerjakan') {
      statusText = `<span class="badge" style="background-color: ${MST_COLOR_ANSWERED}; color: white;">Selesai (L5)</span>`;
    } else if (student.status === 'sedang_mengerjakan') {
      // Sesuaikan wording dan clamp level ke 1..5
      statusText = `<span class="badge" style="background-color: ${MST_COLOR_ANSWERED}; color: white;">Berhenti di L${studentLevel}</span>`;
        } else if (student.status === 'belum_mengerjakan') {
            statusText = `<span class="badge" style="background-color: ${MST_COLOR_NOT_STARTED}; color: white;">Belum Mulai</span>`;
        } else {
            statusText = `<span class="badge bg-danger">${student.status || 'Error'}</span>`;
        }
      document.getElementById('modal-student-status').innerHTML = statusText;

      // Statistics
      document.getElementById('modal-student-correct').textContent = student.result?.correct || 0;
      document.getElementById('modal-student-incorrect').textContent = student.result?.incorrect || 0;
      document.getElementById('modal-student-accuracy').textContent = `${student.result?.accuracy || 0}%`;

      // Answer history
      const historyTableBody = document.getElementById('modal-answer-history');
      historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat riwayat jawaban...</td></tr>';

      try {
          const response = await fetch(`${window.location.origin}/api/siswa/results/${collectionId}?user_id=${studentId}`);
          if (!response.ok) throw new Error("Gagal mengambil detail jawaban");
          const data = await response.json();
          
          const answerHistory = data.answers || [];
          
          answerHistory.sort((a, b) => {
              const dateA = a.answered_at ? new Date(a.answered_at) : 0;
              const dateB = b.answered_at ? new Date(b.answered_at) : 0;
              return dateB - dateA; // Terbaru di atas
          });

          if (answerHistory.length === 0) {
            historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada riwayat jawaban</td></tr>';
          } else {
            historyTableBody.innerHTML = answerHistory.map(answer => {
              const questionText = answer.question.length > 30
                ? answer.question.substring(0, 30) + '...'
                : answer.question;

              // Format date
              const answerDateStr = answer.answered_at;
              let formattedDate = 'N/A';
              if (answerDateStr) {
                   try {
                        const answerDate = new Date(answerDateStr);
                        formattedDate = answerDate.toLocaleDateString('id-ID', {
                            year: 'numeric', month: 'short', day: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                   } catch (e) { console.error("Error formatting date:", answerDateStr, e); }
              }

              // PERBAIKAN: Tampilkan Stage (L1-L5) dari data jawaban
              const level = answer.stage || 0;
              const levelClass = LEVEL_COLORS[level] || DEFAULT_LEVEL_COLOR;

              return `
                <tr>
                  <td><span class="badge ${levelClass}">L${level > 0 ? level : '?'}</span></td>
                  <td title="${escapeHtml(answer.question)}">${escapeHtml(questionText)}</td>
                  <td>${escapeHtml(answer.user_answer)}</td>
                  <td>${answer.is_correct ?
                    '<span class="badge bg-success">Benar</span>' :
                    '<span class="badge bg-danger">Salah</span>'}</td>
                  <td>${formattedDate}</td>
                </tr>
              `;
            }).join('');
          }
      } catch (error) {
          console.error("Gagal fetch detail jawaban:", error);
          historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat riwayat jawaban</td></tr>';
      }
    }

    // Setup filter event listeners
    function setupFilterListeners() {
      // Class filters
      document.getElementById('overview-class-filter').addEventListener('change', applyOverviewFilters);
      document.getElementById('overview-period-filter').addEventListener('change', applyOverviewFilters);
      document.getElementById('overview-status-filter').addEventListener('change', applyOverviewFilters);

      // Student filters
      document.getElementById('student-class-filter').addEventListener('change', applyStudentFilters);
      document.getElementById('student-status-filter').addEventListener('change', applyStudentFilters);
      document.getElementById('student-search').addEventListener('input', applyStudentFilters);

      // Question filter
      document.getElementById('question-level-filter').addEventListener('change', applyQuestionFilters);
    }

    // Apply overview filters
    function applyOverviewFilters() {
      // Get filter values
      const classFilter = document.getElementById('overview-class-filter').value;
      const periodFilter = document.getElementById('overview-period-filter').value;
      const statusFilter = document.getElementById('overview-status-filter').value;

      // Apply filters to chart data
      updateChartsWithFilters(classFilter, periodFilter, statusFilter);
    }

    // Apply student filters
    function applyStudentFilters() {
      // Get filter values
      const classFilter = document.getElementById('student-class-filter').value;
      const statusFilter = document.getElementById('student-status-filter').value;
      const searchQuery = document.getElementById('student-search').value.toLowerCase();

      // Filter students
      const filteredStudents = studentsData.filter(student => {
        if (classFilter !== 'all' && student.student_class !== classFilter) {
          return false;
        }

        if (statusFilter !== 'all') {
          const isAnswered = student.status === 'sudah_mengerjakan' || student.status === 'sedang_mengerjakan';

          if (statusFilter === 'answered' && !isAnswered) {
            return false;
          }
          if (statusFilter === 'not_started' && student.status !== 'belum_mengerjakan') {
            return false;
          }
        }

        if (searchQuery && !student.student_name.toLowerCase().includes(searchQuery)) {
          return false;
        }

        return true;
      });

        renderStudentsTable(filteredStudents); // Render with filtered data
    }


    // Apply question filters
    function applyQuestionFilters() {
        const levelFilter = document.getElementById('question-level-filter').value;

        const filteredQuestions = questionsData.filter(question => {
            if (levelFilter === 'all') return true; 
             const level = question.technology_level || 0;
             return level.toString() === levelFilter;
        });

         renderQuestionsTable(filteredQuestions); // Render with filtered data
    }


    // Update charts with filters
    function updateChartsWithFilters(classFilter, periodFilter, statusFilter) {
      // Filter students based on criteria
      const filteredStudents = studentsData.filter(student => {
        if (classFilter !== 'all' && student.student_class !== classFilter) {
          return false;
        }

        if (statusFilter !== 'all') {
            const isAnswered = student.status === 'sudah_mengerjakan' || student.status === 'sedang_mengerjakan';
            
            if (statusFilter === 'answered' && !isAnswered) {
                return false;
            }
            if (statusFilter === 'not_started' && student.status !== 'belum_mengerjakan') {
                return false;
            }
        }
        
        // TODO: Period filter (requires answer data timestamp)
        // ...

        return true;
      });

      // Update answer distribution chart
      updateAnswerDistributionChart(filteredStudents);

      // Update class comparison chart
      updateClassComparisonChart(filteredStudents);

      // Update level distribution chart
      updatelevelDistributionChart(filteredStudents);
      
      // Update chart di tab level
      updatelevelDistributionChart2(filteredStudents);
      
      // PERBAIKAN: Update kartu statistik level
      updateLevelDistributionStats(filteredStudents);
    }

    // Update answer distribution chart
    function updateAnswerDistributionChart(filteredStudents) {
      if (!chartInstances.answerDistribution) return;

      const totalStudents = filteredStudents.length;
      const answeredStudents = filteredStudents.filter(s => s.status === 'sudah_mengerjakan' || s.status === 'sedang_mengerjakan').length;
      const notStartedStudents = filteredStudents.filter(s => s.status === 'belum_mengerjakan').length;

      chartInstances.answerDistribution.data.labels = ['Sudah Mengerjakan', 'Belum Mengerjakan'];
      chartInstances.answerDistribution.data.datasets[0].data = [answeredStudents, notStartedStudents];
      chartInstances.answerDistribution.update();
    }

    // Update level distribution chart (MST 5 Tahap)
    function updatelevelDistributionChart(filteredStudents) {
      if (!chartInstances.levelDistribution) return;

      const stageData = calculateStageData(filteredStudents);

      // Update chart datasets
       chartInstances.levelDistribution.data.datasets[0].data = MST_STAGES.map(stage => stageData[stage].notStarted);
       chartInstances.levelDistribution.data.datasets[1].data = MST_STAGES.map(stage => stageData[stage].answered);

      chartInstances.levelDistribution.stageData = stageData;
      chartInstances.levelDistribution.update();
    }
    
    // Update chart kedua di tab "Analisis Level"
    function updatelevelDistributionChart2(filteredStudents) {
      if (!chartInstances.levelDistribution2) return;
      const stageData = calculateStageData(filteredStudents);
      chartInstances.levelDistribution2.data.datasets[0].data = MST_STAGES.map(stage => stageData[stage].notStarted);
      chartInstances.levelDistribution2.data.datasets[1].data = MST_STAGES.map(stage => stageData[stage].answered);
      chartInstances.levelDistribution2.stageData = stageData;
      chartInstances.levelDistribution2.update();
    }

    // Refresh data
    async function refreshData() {
      showLoading(true);

      try {
        studentsData = [];
        questionsData = [];
        selectedClasses = {}; 

        await initializeAnalytics();

        Swal.fire({
          title: 'Sukses!',
          text: 'Data berhasil disegarkan',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        showError('Gagal menyegarkan data: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    // Show loading overlay
    function showLoading(show) {
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    // Show error message
    function showError(message) {
      Swal.fire({
        title: 'Error!',
        text: message,
        icon: 'error',
        confirmButtonText: 'OK'
      });
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }


    // Setup export functionality
    function setupExportFunctionality() {
      // Export individual student data (dari tombol di tabel)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('export-student-btn') ||
            e.target.closest('.export-student-btn')) {

          const btn = e.target.classList.contains('export-student-btn') ?
                      e.target : e.target.closest('.export-student-btn');

          const studentId = btn.getAttribute('data-id');
          exportStudentData(studentId);
        }
      });

      // Handle export class data button
      document.getElementById('exportClassDataBtn').addEventListener('click', function() {
        const classSelect = document.getElementById('exportClassSelect');
        classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';

        const classes = [...new Set(studentsData.map(student => student.student_class))].filter(Boolean).sort(); // Sort classes

        classes.forEach(className => {
          const option = document.createElement('option');
          option.value = className;
          option.textContent = className;
          classSelect.appendChild(option);
        });

         const currentClassFilter = document.getElementById('student-class-filter').value;
         if (currentClassFilter !== 'all' && classes.includes(currentClassFilter)) {
             classSelect.value = currentClassFilter;
         }

        const modal = new bootstrap.Modal(document.getElementById('exportClassModal'));
        modal.show();
      });

      // Handle confirm export class button
      document.getElementById('confirmExportClassBtn').addEventListener('click', function() {
        const classId = document.getElementById('exportClassSelect').value;

        if (!classId) {
          Swal.fire({
            title: 'Pilihan belum lengkap',
            text: 'Silakan pilih kelas terlebih dahulu.',
            icon: 'warning',
            confirmButtonText: 'Mengerti'
          });
          return;
        }

        exportClassData(classId);

        bootstrap.Modal.getInstance(document.getElementById('exportClassModal')).hide();
      });

      // Handle export button in student detail modal
      document.getElementById('modalExportBtn').addEventListener('click', function() {
        const studentName = document.getElementById('modal-student-name').textContent;
        const studentId = this.getAttribute('data-student-id');

        if (!studentId) {
          showError('ID siswa tidak ditemukan');
          return;
        }

        const collectionName = (collectionData && collectionData.name) ? collectionData.name : '-';
        Swal.fire({
          title: 'Konfirmasi Ekspor Excel',
          html: `<div class="text-start small">
                    <div><strong>Siswa:</strong> ${escapeHtml(studentName)}</div>
                    <div><strong>Koleksi:</strong> ${escapeHtml(collectionName)}</div>
                 </div>`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: '<i class="bi bi-file-earmark-excel"></i> Ekspor Excel',
          cancelButtonText: 'Batal',
          focusConfirm: false
        }).then((result) => {
          if (result.isConfirmed) {
            exportStudentData(studentId);
          }
        });
      });

      // Handle export all data button
      document.getElementById('exportAllDataBtn').addEventListener('click', function() {
        const classSelect = document.getElementById('allExportClassSelect');
        const studentSelect = document.getElementById('allExportStudentSelect');

        classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        studentSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';

        const classes = [...new Set(studentsData.map(student => student.student_class))].filter(Boolean).sort(); // Sort classes

        classes.forEach(className => {
          const option = document.createElement('option');
          option.value = className;
          option.textContent = className;
          classSelect.appendChild(option);
        });

        const sortedStudents = [...studentsData].sort((a, b) => a.student_name.localeCompare(b.student_name));
        sortedStudents.forEach(student => {
          const option = document.createElement('option');
          option.value = student.student_id;
          option.textContent = `${student.student_name} (${student.student_class || 'Tidak ada kelas'})`;
          studentSelect.appendChild(option);
        });


        document.querySelectorAll('input[name="exportType"]').forEach(radio => {
          radio.addEventListener('change', updateExportFormVisibility);
        });

        updateExportFormVisibility();

        const modal = new bootstrap.Modal(document.getElementById('exportAllModal'));
        modal.show();
      });

      // Handle confirm all export button
      document.getElementById('confirmAllExportBtn').addEventListener('click', function() {
        const selectedType = document.querySelector('input[name="exportType"]:checked').value;

        if (selectedType === 'all') {
          exportAllData();
        } else if (selectedType === 'class') {
          const classId = document.getElementById('allExportClassSelect').value;

          if (!classId) {
            Swal.fire({
              title: 'Pilihan belum lengkap',
              text: 'Silakan pilih kelas terlebih dahulu.',
              icon: 'warning',
              confirmButtonText: 'Mengerti'
            });
            return;
          }

          exportClassData(classId);
        } else if (selectedType === 'individual') {
          const studentId = document.getElementById('allExportStudentSelect').value;

          if (!studentId) {
            Swal.fire({
              title: 'Pilihan belum lengkap',
              text: 'Silakan pilih siswa terlebih dahulu.',
              icon: 'warning',
              confirmButtonText: 'Mengerti'
            });
            return;
          }

          exportStudentData(studentId);
        }

        bootstrap.Modal.getInstance(document.getElementById('exportAllModal')).hide();
      });
    }

    // Update export form visibility based on selected type
    function updateExportFormVisibility() {
      const selectedType = document.querySelector('input[name="exportType"]:checked').value;

      document.getElementById('classSelectionForm').style.display =
        selectedType === 'class' ? 'block' : 'none';

      document.getElementById('studentSelectionForm').style.display =
        selectedType === 'individual' ? 'block' : 'none';
    }

    // Export individual student data
    function exportStudentData(studentId) {
      showLoading(true);

      const exportUrl = `${window.location.origin}/api/export_result_excel_teacher?type=individual&user_id=${studentId}&collection_id=${collectionId}`;

      const link = document.createElement('a');
      link.href = exportUrl;
      link.target = '_blank'; 
      document.body.appendChild(link);
      link.click();

      setTimeout(() => {
        document.body.removeChild(link);
        showLoading(false);
        Swal.fire({
          toast: true,
          position: 'bottom',
          icon: 'success',
          title: 'Ekspor dimulai',
          text: 'File Excel sedang diunduh.',
          showConfirmButton: false,
          timer: 2000
        });
      }, 1000);
    }

    // Export class data
    function exportClassData(classId) {
      showLoading(true);

      const exportUrl = `${window.location.origin}/api/export_result_excel_teacher?type=class&class_id=${classId}&collection_id=${collectionId}`;

      const link = document.createElement('a');
      link.href = exportUrl;
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();

      setTimeout(() => {
        document.body.removeChild(link);
        showLoading(false);
        Swal.fire({
          toast: true,
          position: 'bottom',
          icon: 'success',
          title: 'Ekspor dimulai',
          text: 'File Excel sedang diunduh.',
          showConfirmButton: false,
          timer: 2000
        });
      }, 1000);
    }

    // Export all data for this collection
    function exportAllData() {
      showLoading(true);

      const exportUrl = `${window.location.origin}/api/export_all_collection_data?collection_id=${collectionId}`;

      const link = document.createElement('a');
      link.href = exportUrl;
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();

      setTimeout(() => {
        document.body.removeChild(link);
        showLoading(false);
        Swal.fire({
          toast: true,
          position: 'bottom',
          icon: 'success',
          title: 'Ekspor dimulai',
          text: 'File Excel sedang diunduh.',
          showConfirmButton: false,
          timer: 2000
        });
      }, 1000);
    }
  </script>
</body>
</html>


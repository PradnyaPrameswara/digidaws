<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analisis Koleksi - DIGIDAWS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .navbar {
      background-color: #0d6efd;
    }
    .navbar-brand {
      font-weight: bold;
    }
    .stat-card {
      transition: all 0.3s ease;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .user-info {
      color: white;
      margin-right: 15px;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    .level-progress {
      height: 30px;
      margin-bottom: 15px;
      position: relative;
    }
    .level-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
    }
    .student-row {
      transition: all 0.2s;
      cursor: pointer;
    }
    .student-row:hover {
      background-color: rgba(13,110,253,0.1);
    }
    .filter-card {
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .tab-content {
      padding: 20px 0;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .badge-correct {
      background-color: #198754;
    }
    .badge-incorrect {
      background-color: #dc3545;
    }
    .badge-level {
      background-color: #0d6efd;
    }
    .form-check {
      display: inline-block;
      margin-right: 15px;
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      background-color: #f8f9fa;
      transition: all 0.2s;
    }
    .form-check:hover {
      background-color: #e9ecef;
    }
    .form-check-input:checked + .form-check-label {
      font-weight: bold;
      color: #0d6efd;
    }
    #classSelectionCollapse {
      background-color: #f8f9fa;
    }
    /* CSS untuk keterangan status siswa */
    .legend-list {
      list-style: none;
      padding-left: 0;
      font-size: 0.9rem;
    }
    .legend-list li {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .legend-list li:last-child {
      margin-bottom: 0;
    }
    .legend-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
  <a class="navbar-brand" href="/guru" title="DIGIDAWS = DIagnostik cerdas Guru untuk Identifikasi Deteksi Awal kemampuan siswa dan Wawasan Sistematis">DIGIDAWS</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="/guru">Dashboard Guru</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/guru/collections">Koleksi Soal</a>
          </li>
        </ul>
        <div class="d-flex align-items-center">
          <span class="user-info">
            <i class="bi bi-person-circle"></i> Guru
          </span>
          <a href="/logout" class="btn btn-outline-light">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container mt-4">
    <a href="/guru/collections" class="btn btn-primary mb-3">
        <i class="bi bi-arrow-left"></i> Kembali ke Koleksi
    </a>

    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 id="collection-title">Analisis Koleksi</h2>
            <p class="text-muted" id="collection-description">Memuat deskripsi...</p>
          </div>
          <div>
            <button class="btn btn-outline-success me-2" id="exportAllDataBtn">
              <i class="bi bi-file-earmark-excel"></i> Export Semua Data
            </button>
            <button class="btn btn-outline-primary" id="refreshDataBtn">
              <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-5">
            <div class="card stat-card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted">Total Siswa</h6>
                        <h2 class="mb-0 text-primary" id="total-students">0</h2>
                    </div>
                    <div class="border-start ps-3 ms-3">
                        <ul class="legend-list mb-0">
                            <li><span class="legend-dot" style="background-color: #198754;"></span> Selesai</li>
                            <li><span class="legend-dot" style="background-color: #ffc107;"></span> Mengerjakan</li>
                            <li><span class="legend-dot" style="background-color: #6c757d;"></span> Belum Mulai</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="row">
                <div class="col-md-4">
                    <div class="card stat-card h-100 bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Jawaban Benar</h6>
                            <h2 class="mb-0 text-success" id="total-correct">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card h-100 bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Jawaban Salah</h6>
                            <h2 class="mb-0 text-danger" id="total-incorrect">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card h-100 bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Akurasi Rata-rata</h6>
                            <h2 class="mb-0 text-info" id="avg-accuracy">0%</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="analyticsTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
          <i class="bi bi-pie-chart"></i> Ikhtisar
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab" aria-controls="students" aria-selected="false">
          <i class="bi bi-people"></i> Siswa
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="levels-tab" data-bs-toggle="tab" data-bs-target="#levels" type="button" role="tab" aria-controls="levels" aria-selected="false">
          <i class="bi bi-diagram-3"></i> Analisis level
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab" aria-controls="questions" aria-selected="false">
          <i class="bi bi-question-circle"></i> Soal
        </button>
      </li>
    </ul>

    <div class="tab-content" id="analyticsTabContent">
      <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <div class="card filter-card mb-4">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-funnel"></i> Filter</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Kelas</label>
                <select class="form-select" id="overview-class-filter">
                  <option value="all" selected>Semua Kelas</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Periode</label>
                <select class="form-select" id="overview-period-filter">
                  <option value="all" selected>Semua Waktu</option>
                  <option value="week">Minggu Ini</option>
                  <option value="month">Bulan Ini</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Status</label>
                <select class="form-select" id="overview-status-filter">
                  <option value="all" selected>Semua</option>
                  <option value="completed">Selesai</option>
                  <option value="in_progress">Sedang Dikerjakan</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header">
                <h5 class="mb-0">Status Pengerjaan Siswa</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="answerDistributionChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Perbandingan Kelas</h5>
                  <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" 
                          data-bs-target="#classSelectionCollapse" aria-expanded="false">
                    <i class="bi bi-funnel"></i> Pilih Kelas
                  </button>
                </div>
              </div>
              <div class="collapse" id="classSelectionCollapse">
                <div class="card-body border-bottom">
                  <div class="d-flex align-items-center mb-2">
                    <h6 class="mb-0 me-2">Pilih Kelas untuk Dibandingkan:</h6>
                    <button id="selectAllClasses" class="btn btn-sm btn-outline-secondary">Pilih Semua</button>
                    <button id="deselectAllClasses" class="btn btn-sm btn-outline-secondary ms-2">Batalkan Semua</button>
                  </div>
                  <div id="classCheckboxes" class="d-flex flex-wrap gap-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="classComparisonChart"></canvas>
                </div>
                <div id="noClassSelectedMessage" class="text-center text-muted py-5" style="display: none;">
                  <i class="bi bi-exclamation-circle fs-3"></i>
                  <p class="mt-2">Silakan pilih minimal satu kelas untuk melihat perbandingan</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">Distribusi Level</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-12">
                        <div class="chart-container">
                            <canvas id="levelDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <div class="tab-pane fade" id="students" role="tabpanel" aria-labelledby="students-tab">
        <div class="card filter-card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title"><i class="bi bi-funnel"></i> Filter Siswa</h5>
              <button class="btn btn-success" id="exportClassDataBtn">
                <i class="bi bi-file-earmark-excel"></i> Export Data Kelas
              </button>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Kelas</label>
                <select class="form-select" id="student-class-filter">
                  <option value="all" selected>Semua Kelas</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Status</label>
                <select class="form-select" id="student-status-filter">
                  <option value="all" selected>Semua</option>
                  <option value="completed">Selesai</option>
                  <option value="in_progress">Sedang Mengerjakan</option>
                  <option value="not_started">Belum Mulai</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Pencarian</label>
                <input type="text" class="form-control" id="student-search" placeholder="Nama siswa...">
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="mb-0">Daftar Siswa</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="studentsTable">
                <thead>
                  <tr>
                    <th>Nama</th>
                    <th>Kelas</th>
                    <th>Status</th>
                    <th>level</th>
                    <th>Benar</th>
                    <th>Salah</th>
                    <th>Akurasi</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="studentsTableBody">
                  <tr>
                    <td colspan="8" class="text-center">Memuat data siswa...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="levels" role="tabpanel" aria-labelledby="levels-tab">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Persebaran level</h5>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-12">
                <div class="chart-container">
                  <canvas id="levelPathChart"></canvas>
                </div>
              </div>
            </div>
            
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6 class="text-muted">level 1-2 (Dasar)</h6>
                    <h3 id="basic-level-percentage">0%</h3>
                    <small class="text-muted">Siswa di level Dasar</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6 class="text-muted">level 3-4 (Menengah)</h6>
                    <h3 id="intermediate-level-percentage">0%</h3>
                    <small class="text-muted">Siswa di level Menengah</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6 class="text-muted">level 5-7 (Lanjut)</h6>
                    <h3 id="advanced-level-percentage">0%</h3>
                    <small class="text-muted">Siswa di level Lanjut</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6 class="text-muted">Selesai</h6>
                    <h3 id="completed-percentage">0%</h3>
                    <small class="text-muted">Siswa Selesai</small>
                  </div>
                </div>
              </div>
            </div>
            
            <p class="text-muted mb-2">
                Tabel berikut menunjukkan alur perpindahan level yang paling umum terjadi di antara siswa. 
                Data ini membantu untuk mengidentifikasi jalur belajar utama dalam koleksi soal ini.
            </p>
            <h5 class="mb-3">Detail Perjalanan Level</h5>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Dari level</th>
                        <th>Ke level</th>
                        <th>Jumlah Siswa</th>
                        <th>Persentase</th>
                    </tr>
                </thead>
                <tbody id="levelJourneyTableBody">
                  </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="questions" role="tabpanel" aria-labelledby="questions-tab">
        <div class="card shadow-sm mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Analisis Soal</h5>
            <div>
              <select class="form-select form-select-sm" id="question-level-filter">
                <option value="all">Semua level</option>
                <option value="1">level 1</option>
                <option value="2">level 2</option>
                <option value="3">level 3</option>
                <option value="4">level 4</option>
                <option value="5">level 5</option>
                <option value="6">level 6</option>
                <option value="7">level 7</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>level</th>
                    <th>Soal</th>
                    <th>Tingkat Kesulitan</th>
                    <th>Benar</th>
                    <th>Salah</th>
                    <th>Akurasi</th>
                  </tr>
                </thead>
                <tbody id="questionsTableBody">
                  </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="studentDetailModal" tabindex="-1" aria-labelledby="studentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="studentDetailModalLabel">Detail Siswa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="card mb-4">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-muted">Nama</h6>
                  <h5 id="modal-student-name">-</h5>
                </div>
                <div class="col-md-3">
                  <h6 class="text-muted">Kelas</h6>
                  <h5 id="modal-student-class">-</h5>
                </div>
                <div class="col-md-3">
                  <h6 class="text-muted">level Sekarang</h6>
                  <h5><span class="badge bg-primary" id="modal-student-level">-</span></h5>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Status</h6>
                  <h5 id="modal-student-status">-</h5>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Jawaban Benar</h6>
                  <h5 class="text-success" id="modal-student-correct">0</h5>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Jawaban Salah</h6>
                  <h5 class="text-danger" id="modal-student-incorrect">0</h5>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Akurasi</h6>
                  <h5 class="text-info" id="modal-student-accuracy">0%</h5>
                </div>
              </div>
            </div>
          </div>
          
          <h5 class="mb-3">Riwayat Jawaban</h5>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>level</th>
                  <th>Soal</th>
                  <th>Jawaban Siswa</th>
                  <th>Status</th>
                  <th>Waktu</th>
                </tr>
              </thead>
              <tbody id="modal-answer-history">
                </tbody>
            </table>
          </div>
          
          <h5 class="mb-3 mt-4">Perjalanan level</h5>
          <div class="progress level-progress">
            <div class="progress-bar bg-success" role="progressbar" style="width: 14.28%" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100">
              <span class="level-label">1</span>
            </div>
            <div class="progress-bar bg-info" role="progressbar" style="width: 14.28%" aria-valuenow="2" aria-valuemin="0" aria-valuemax="100">
              <span class="level-label">2</span>
            </div>
            <div class="progress-bar bg-primary" role="progressbar" style="width: 14.28%" aria-valuenow="3" aria-valuemin="0" aria-valuemax="100">
              <span class="level-label">3</span>
            </div>
            <div class="progress-bar bg-warning" role="progressbar" style="width: 14.28%" aria-valuenow="4" aria-valuemin="0" aria-valuemax="100">
              <span class="level-label">4</span>
            </div>
            <div class="progress-bar bg-danger" role="progressbar" style="width: 14.28%" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100">
              <span class="level-label">5</span>
            </div>
            <div class="progress-bar bg-secondary" role="progressbar" style="width: 14.28%" aria-valuenow="6" aria-valuemin="0" aria-valuemax="100">
              <span class="level-label">6</span>
            </div>
            <div class="progress-bar bg-dark" role="progressbar" style="width: 14.28%" aria-valuenow="7" aria-valuemin="0" aria-valuemax="100">
              <span class="level-label">7</span>
            </div>
          </div>
          <div class="text-center mt-2 mb-4">
            <span class="badge bg-primary" id="modal-current-level-indicator">level Terkini: <span id="modal-current-level">-</span></span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="button" class="btn btn-success" id="modalExportBtn">
            <i class="bi bi-file-earmark-excel"></i> Export Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="exportClassModal" tabindex="-1" aria-labelledby="exportClassModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportClassModalLabel">Export Data Kelas</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="exportClassSelect" class="form-label">Pilih Kelas</label>
            <select class="form-select" id="exportClassSelect">
              <option value="">-- Pilih Kelas --</option>
              </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-success" id="confirmExportClassBtn">
            <i class="bi bi-file-earmark-excel"></i> Export
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="exportAllModal" tabindex="-1" aria-labelledby="exportAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportAllModalLabel">Export Semua Data</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Pilih data yang ingin diexport:</p>
          
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="exportType" id="exportTypeAll" value="all" checked>
            <label class="form-check-label" for="exportTypeAll">
              Semua Data (Semua Siswa)
            </label>
          </div>
          
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="exportType" id="exportTypeClass" value="class">
            <label class="form-check-label" for="exportTypeClass">
              Data Per Kelas
            </label>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="exportType" id="exportTypeStudent" value="individual">
            <label class="form-check-label" for="exportTypeStudent">
              Data Per Siswa
            </label>
          </div>
          
          <div id="classSelectionForm" class="mt-3" style="display: none;">
            <div class="mb-3">
              <label for="allExportClassSelect" class="form-label">Pilih Kelas</label>
              <select class="form-select" id="allExportClassSelect">
                <option value="">-- Pilih Kelas --</option>
                </select>
            </div>
          </div>
          
          <div id="studentSelectionForm" class="mt-3" style="display: none;">
            <div class="mb-3">
              <label for="allExportStudentSelect" class="form-label">Pilih Siswa</label>
              <select class="form-select" id="allExportStudentSelect">
                <option value="">-- Pilih Siswa --</option>
                </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-success" id="confirmAllExportBtn">
            <i class="bi bi-file-earmark-excel"></i> Export
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Global variables
    let collectionId = null;
    let collectionData = null;
    let studentsData = [];
    let questionsData = [];
    let answersData = [];
    let chartInstances = {};
    let selectedClasses = {}; // Untuk menyimpan kelas yang dipilih

    // Initialize on document ready
    document.addEventListener('DOMContentLoaded', function() {
      // Extract collection ID from URL
      const pathSegments = window.location.pathname.split('/');
      collectionId = pathSegments[pathSegments.length - 1];
      
      // Fetch data and initialize charts
      initializeAnalytics();
      
      // Setup event listeners
      document.getElementById('refreshDataBtn').addEventListener('click', refreshData);
      
      // Setup filter event listeners
      setupFilterListeners();
      
      // Setup export functionality
      setupExportFunctionality();
    });

    // Initialize analytics
    async function initializeAnalytics() {
      showLoading(true);
      try {
        // Fetch collection data
        await fetchCollectionData();
        
        // Fetch students data
        await fetchStudentsData();
        
        // Fetch questions data
        await fetchQuestionsData();
        
        // Fetch answers data
        await fetchAnswersData();
        
        // Update UI with collection info
        updateCollectionInfo();
        
        // Populate class filter options
        populateClassFilters();
        
        // Populate class checkboxes for comparison
        populateClassCheckboxes();
        
        // Initialize charts and tables
        initializeCharts();
        
        // Render tables
        renderStudentsTable();
        renderQuestionsTable();
        renderlevelJourneyTable();
        
        // Update summary stats
        updateSummaryStats();
        
        // Update level distribution stats
        updatelevelDistributionStats();
        
        showLoading(false);
      } catch (error) {
        showLoading(false);
        showError('Gagal memuat data analisis: ' + error.message);
      }
    }

    // Fetch collection data
    async function fetchCollectionData() {
      const response = await fetch(`/api/collections/${collectionId}`);
      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      if (!result.success) {
        throw new Error(result.message || 'Gagal mengambil data koleksi');
      }
      
      collectionData = result.collection;
      return collectionData;
    }

    // Fetch students assigned to this collection
    async function fetchStudentsData() {
      const response = await fetch(`/api/collections/${collectionId}/students`);
      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      if (!result.success) {
        throw new Error(result.message || 'Gagal mengambil data siswa');
      }
      
      // For each student, fetch their results for this collection
      const studentsWithResults = await Promise.all(
        result.students.map(async (student) => {
          try {
            const resultResponse = await fetch(`/api/siswa/results/${collectionId}?user_id=${student.id}`);
            if (resultResponse.ok) {
              const resultData = await resultResponse.json();
              return {
                ...student,
                result: resultData,
                currentlevel: resultData.current_level || 1,
                correct: resultData.correct || 0,
                incorrect: resultData.incorrect || 0,
                isCompleted: [5, 6, 7].includes(parseInt(resultData.current_level || 1))
              };
            } else {
              // If no results yet, return default values
              return {
                ...student,
                result: null,
                currentlevel: 1,
                correct: 0,
                incorrect: 0,
                isCompleted: false
              };
            }
          } catch (error) {
            console.error(`Error fetching results for student ${student.id}:`, error);
            return {
              ...student,
              result: null,
              currentlevel: 1,
              correct: 0,
              incorrect: 0,
              isCompleted: false
            };
          }
        })
      );
      
      studentsData = studentsWithResults;
      return studentsData;
    }

    // Fetch questions in this collection
    async function fetchQuestionsData() {
      const response = await fetch(`/api/collections/${collectionId}/questions`);
      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      if (!result.success) {
        throw new Error(result.message || 'Gagal mengambil data soal');
      }
      
      questionsData = result.questions.map(question => ({
        ...question,
        correctCount: 0,
        incorrectCount: 0,
        accuracy: 0
      }));
      
      return questionsData;
    }

    // Fetch answers data
    async function fetchAnswersData() {
      try {
        // For each student, fetch their answers
        const allAnswers = [];
        
        for (const student of studentsData) {
          try {
            const response = await fetch(`/api/siswa_answers?user_id=${student.id}&collection_id=${collectionId}`);
            if (response.ok) {
              const result = await response.json();
              if (result.siswa_answers && Array.isArray(result.siswa_answers)) {
                // Enrich answers with student info and question text
                const enrichedAnswers = result.siswa_answers.map(answer => {
                  // Find question data
                  const question = questionsData.find(q => q.id === answer.question_id);
                  
                  return {
                    ...answer,
                    student: {
                      id: student.id,
                      nama: student.nama,
                      kelas: student.kelas
                    },
                    question_text: question ? question.soal : 'Soal tidak ditemukan',
                    question_level: question ? question.level : null
                  };
                });
                
                allAnswers.push(...enrichedAnswers);
                
                // Update question stats based on answers
                updateQuestionStats(enrichedAnswers);
              }
            }
          } catch (error) {
            console.error(`Error fetching answers for student ${student.id}:`, error);
          }
        }
        
        answersData = allAnswers;
        return answersData;
      } catch (error) {
        console.error("Error fetching answers data:", error);
        throw error;
      }
    }

    // Update question statistics based on answers
    function updateQuestionStats(answers) {
      // Group answers by question ID
      const answersByQuestion = {};
      
      answers.forEach(answer => {
        if (!answersByQuestion[answer.question_id]) {
          answersByQuestion[answer.question_id] = [];
        }
        answersByQuestion[answer.question_id].push(answer);
      });
      
      // Update question stats
      Object.keys(answersByQuestion).forEach(questionId => {
        const question = questionsData.find(q => q.id === parseInt(questionId));
        if (question) {
          const questionAnswers = answersByQuestion[questionId];
          const correctAnswers = questionAnswers.filter(a => a.is_correct);
          
          question.correctCount = correctAnswers.length;
          question.incorrectCount = questionAnswers.length - correctAnswers.length;
          question.accuracy = questionAnswers.length > 0
            ? Math.round((correctAnswers.length / questionAnswers.length) * 100)
            : 0;
        }
      });
    }

    // Update collection info on the page
    function updateCollectionInfo() {
      if (collectionData) {
        document.getElementById('collection-title').textContent = `Analisis: ${collectionData.name}`;
        document.getElementById('collection-description').textContent = collectionData.description || 'Tidak ada deskripsi';
      }
    }

    // Populate class filter options
    function populateClassFilters() {
      // Get unique classes
      const classes = [...new Set(studentsData.map(student => student.kelas))].filter(Boolean);
      
      // Populate overview class filter
      const overviewClassFilter = document.getElementById('overview-class-filter');
      overviewClassFilter.innerHTML = '<option value="all" selected>Semua Kelas</option>';
      
      classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        overviewClassFilter.appendChild(option);
      });
      
      // Populate student class filter
      const studentClassFilter = document.getElementById('student-class-filter');
      studentClassFilter.innerHTML = '<option value="all" selected>Semua Kelas</option>';
      
      classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        studentClassFilter.appendChild(option);
      });
    }

    // Fungsi untuk mengisi checkbox kelas
    function populateClassCheckboxes() {
      // Dapatkan daftar kelas unik
      const classes = [...new Set(studentsData.map(student => student.kelas))].filter(Boolean);
      const checkboxContainer = document.getElementById('classCheckboxes');
      
      // Bersihkan container
      checkboxContainer.innerHTML = '';
      
      if (classes.length === 0) {
        checkboxContainer.innerHTML = '<p class="text-muted">Tidak ada data kelas</p>';
        return;
      }
      
      // Secara default semua kelas dipilih
      classes.forEach(className => {
        selectedClasses[className] = true;
        
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'form-check';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input class-checkbox';
        checkbox.id = `class-${className.replace(/\s+/g, '-')}`;
        checkbox.value = className;
        checkbox.checked = true;
        
        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.htmlFor = checkbox.id;
        label.textContent = className;
        
        checkbox.addEventListener('change', function() {
          selectedClasses[className] = this.checked;
          updateClassComparisonChart(studentsData);
        });
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        checkboxContainer.appendChild(checkboxDiv);
      });
      
      // Event listener untuk tombol "Pilih Semua"
      document.getElementById('selectAllClasses').addEventListener('click', function() {
        document.querySelectorAll('.class-checkbox').forEach(checkbox => {
          checkbox.checked = true;
          selectedClasses[checkbox.value] = true;
        });
        updateClassComparisonChart(studentsData);
      });
      
      // Event listener untuk tombol "Batalkan Semua"
      document.getElementById('deselectAllClasses').addEventListener('click', function() {
        document.querySelectorAll('.class-checkbox').forEach(checkbox => {
          checkbox.checked = false;
          selectedClasses[checkbox.value] = false;
        });
        updateClassComparisonChart(studentsData);
      });
    }

    // Initialize charts
    function initializeCharts() {
      // Answer distribution chart
      initAnswerDistributionChart();
      
      // Class comparison chart
      initClassComparisonChart();
      
      // level distribution chart
      initlevelDistributionChart();
      
      // level path chart
      initlevelPathChart();
    }

    // Initialize answer distribution chart (IMPROVED with "Not Started" data)
    function initAnswerDistributionChart() {
        const ctx = document.getElementById('answerDistributionChart').getContext('2d');

        // Hitung jumlah siswa untuk setiap status
        const totalStudents = studentsData.length;
        const completedStudents = studentsData.filter(s => s.isCompleted).length;
        const inProgressStudents = studentsData.filter(s => !s.isCompleted && (s.correct + s.incorrect > 0)).length;
        const notStartedStudents = totalStudents - completedStudents - inProgressStudents;

        // Data untuk pie chart
        const chartData = {
            labels: ['Selesai Mengerjakan', 'Sedang Mengerjakan', 'Belum Mengerjakan'],
            datasets: [{
                data: [completedStudents, inProgressStudents, notStartedStudents],
                backgroundColor: [
                    '#198754', // Hijau untuk Selesai
                    '#ffc107', // Kuning untuk Mengerjakan
                    '#6c757d'  // Abu-abu untuk Belum Mulai
                ],
                borderWidth: 1
            }]
        };
        
        // Ganti judul kartu berdasarkan data
        const cardHeader = document.querySelector('#answerDistributionChart').closest('.card').querySelector('.card-header h5');
        if (cardHeader) {
            cardHeader.textContent = 'Status Pengerjaan Siswa';
        }

        chartInstances.answerDistribution = new Chart(ctx, {
            type: 'pie',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const percentage = totalStudents > 0 ? ((value / totalStudents) * 100).toFixed(1) : 0;
                                return `${label}: ${value} siswa (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize class comparison chart
    function initClassComparisonChart() {
      const ctx = document.getElementById('classComparisonChart').getContext('2d');
      
      // Siapkan chart dengan data kosong
      chartInstances.classComparison = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Akurasi (%)',
            data: [],
            backgroundColor: '#0d6efd',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Akurasi (%)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Kelas'
              }
            }
          }
        }
      });
      
      // Update chart dengan data awal
      updateClassComparisonChart(studentsData);
    }

    // Initialize level distribution chart
    function initlevelDistributionChart() {
      const ctx = document.getElementById('levelDistributionChart').getContext('2d');
      
      // Group students by current level
      const levelDistribution = [0, 0, 0, 0, 0, 0, 0]; // For levels 1-7
      
      studentsData.forEach(student => {
        const level = parseInt(student.currentlevel || 1);
        if (level >= 1 && level <= 7) {
          levelDistribution[level - 1]++;
        }
      });
      
      chartInstances.levelDistribution = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['level 1', 'level 2', 'level 3', 'level 4', 'level 5', 'level 6', 'level 7'],
          datasets: [{
            label: 'Jumlah Siswa',
            data: levelDistribution,
            backgroundColor: [
              '#0275d8', // Primary
              '#5bc0de', // Info
              '#5cb85c', // Success
              '#f0ad4e', // Warning
              '#d9534f', // Danger
              '#292b2c', // Dark
              '#f7f7f7'  // Light
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Jumlah Siswa'
              }
            },
            x: {
              title: {
                display: true,
                text: 'level'
              }
            }
          }
        }
      });
    }

    // Initialize level path chart
    function initlevelPathChart() {
      const ctx = document.getElementById('levelPathChart').getContext('2d');
      
      // Data preparation for tracking level paths
      const levelTransitions = {
        '1-2': 0, '2-3': 0, '2-4': 0, '3-5': 0, '3-6': 0, '4-6': 0, '4-7': 0
      };
      
      // Count level transitions from answers data
      if (answersData && answersData.length > 0) {
        // Group answers by student
        const answersByStudent = {};
        
        answersData.forEach(answer => {
          if (!answersByStudent[answer.student.id]) {
            answersByStudent[answer.student.id] = [];
          }
          answersByStudent[answer.student.id].push(answer);
        });
        
        // For each student, order answers by time and analyze level transitions
        Object.values(answersByStudent).forEach(studentAnswers => {
          // Sort by answered_at
          studentAnswers.sort((a, b) => new Date(a.answered_at) - new Date(b.answered_at));
          
          // Track level changes
          let previouslevel = null;
          
          studentAnswers.forEach(answer => {
            const currentlevel = answer.level;
            
            if (previouslevel !== null && previouslevel !== currentlevel) {
              // Check if this is one of our tracked transitions
              const transitionKey = `${previouslevel}-${currentlevel}`;
              if (levelTransitions.hasOwnProperty(transitionKey)) {
                levelTransitions[transitionKey]++;
              }
            }
            
            previouslevel = currentlevel;
          });
        });
      }
      
      // Prepare data for chart
      const labels = Object.keys(levelTransitions).map(key => {
        const [from, to] = key.split('-');
        return `level ${from} → level ${to}`;
      });
      
      const data = Object.values(levelTransitions);
      
      chartInstances.levelPath = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Jumlah Transisi',
            data: data,
            backgroundColor: '#6f42c1',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Jumlah Transisi'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Jalur level'
              }
            }
          }
        }
      });
    }

    // Update Class Comparison Chart for selected classes
    function updateClassComparisonChart(filteredStudents) {
      if (!chartInstances.classComparison) return;
      
      // Group students by class and calculate average accuracy
      const classes = {};
      filteredStudents.forEach(student => {
        if (student.kelas && selectedClasses[student.kelas]) {
          if (!classes[student.kelas]) {
            classes[student.kelas] = {
              correctCount: 0,
              incorrectCount: 0,
              studentCount: 0
            };
          }
          
          classes[student.kelas].correctCount += student.correct || 0;
          classes[student.kelas].incorrectCount += student.incorrect || 0;
          classes[student.kelas].studentCount++;
        }
      });
      
      const classLabels = Object.keys(classes);
      const classAccuracies = classLabels.map(className => {
        const classData = classes[className];
        const total = classData.correctCount + classData.incorrectCount;
        return total > 0 ? Math.round((classData.correctCount / total) * 100) : 0;
      });
      
      // Update chart data
      chartInstances.classComparison.data.labels = classLabels;
      chartInstances.classComparison.data.datasets[0].data = classAccuracies;
      chartInstances.classComparison.update();
      
      // Tampilkan pesan jika tidak ada kelas yang dipilih
      const noClassMessage = document.getElementById('noClassSelectedMessage');
      if (noClassMessage) {
        if (classLabels.length === 0) {
          noClassMessage.style.display = 'block';
          document.getElementById('classComparisonChart').style.display = 'none';
        } else {
          noClassMessage.style.display = 'none';
          document.getElementById('classComparisonChart').style.display = 'block';
        }
      }
    }

    // Render students table
    function renderStudentsTable() {
      const tableBody = document.getElementById('studentsTableBody');
      
      if (!studentsData || studentsData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Tidak ada data siswa</td></tr>';
        return;
      }
      
      tableBody.innerHTML = studentsData.map(student => {
        const total = (student.correct || 0) + (student.incorrect || 0);
        const accuracy = total > 0 ? Math.round((student.correct / total) * 100) : 0;
        
        let statusBadge = '';
        if (student.isCompleted) {
          statusBadge = '<span class="badge bg-success">Selesai</span>';
        } else if (total > 0) {
          statusBadge = '<span class="badge bg-warning text-dark">Sedang Mengerjakan</span>';
        } else {
          statusBadge = '<span class="badge bg-secondary">Belum Mulai</span>';
        }
        
        return `
          <tr class="student-row" data-id="${student.id}">
            <td>${escapeHtml(student.nama || '-')}</td>
            <td>${escapeHtml(student.kelas || '-')}</td>
            <td>${statusBadge}</td>
            <td><span class="badge badge-level">${student.currentlevel || 1}</span></td>
            <td><span class="badge badge-correct">${student.correct || 0}</span></td>
            <td><span class="badge badge-incorrect">${student.incorrect || 0}</span></td>
            <td>${accuracy}%</td>
            <td>
              <button class="btn btn-sm btn-outline-primary view-student-btn" data-id="${student.id}">
                <i class="bi bi-eye"></i> Detail
              </button>
              <button class="btn btn-sm btn-outline-success export-student-btn" data-id="${student.id}">
                <i class="bi bi-file-earmark-excel"></i> Export
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      // Add event listeners for detail buttons
      document.querySelectorAll('.view-student-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const studentId = btn.getAttribute('data-id');
          showStudentDetail(studentId);
        });
      });
      
      // Add event listeners for export buttons
      document.querySelectorAll('.export-student-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const studentId = btn.getAttribute('data-id');
          exportStudentData(studentId);
        });
      });
      
      // Also add click event to rows
      document.querySelectorAll('.student-row').forEach(row => {
        row.addEventListener('click', (e) => {
          // Ignore if clicked on the button
          if (!e.target.closest('.view-student-btn') && !e.target.closest('.export-student-btn')) {
            const studentId = row.getAttribute('data-id');
            showStudentDetail(studentId);
          }
        });
      });
    }

    // Render questions table
    function renderQuestionsTable() {
      const tableBody = document.getElementById('questionsTableBody');
      
      if (!questionsData || questionsData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data soal</td></tr>';
        return;
      }
      
      tableBody.innerHTML = questionsData.map(question => {
        // Format question text (truncate if too long)
        const questionText = question.soal.length > 50
          ? question.soal.substring(0, 50) + '...'
          : question.soal;
          
        // Calculate difficulty label
        let difficultyLabel = '';
        const p = parseFloat(question.p);
        
        if (p >= 0.80) {
          difficultyLabel = '<span class="badge bg-success">Mudah</span>';
        } else if (p >= 0.50) {
          difficultyLabel = '<span class="badge bg-warning text-dark">Sedang</span>';
        } else {
          difficultyLabel = '<span class="badge bg-danger">Sulit</span>';
        }
        
        return `
          <tr>
            <td>${question.id}</td>
            <td><span class="badge badge-level">${question.level}</span></td>
            <td>${escapeHtml(questionText)}</td>
            <td>${difficultyLabel} (${question.p})</td>
            <td><span class="badge badge-correct">${question.correctCount}</span></td>
            <td><span class="badge badge-incorrect">${question.incorrectCount}</span></td>
            <td>${question.accuracy}%</td>
          </tr>
        `;
      }).join('');
    }

    // Render level journey table
    function renderlevelJourneyTable() {
        const tableBody = document.getElementById('levelJourneyTableBody');
        const levelTransitions = [
            { from: 1, to: 2 }, { from: 2, to: 3 }, { from: 2, to: 4 },
            { from: 3, to: 5 }, { from: 3, to: 6 }, { from: 4, to: 6 }, { from: 4, to: 7 }
        ];
        const transitionCounts = {};
        levelTransitions.forEach(t => { transitionCounts[`${t.from}-${t.to}`] = 0; });

        if (answersData && answersData.length > 0) {
            const answersByStudent = {};
            answersData.forEach(answer => {
                if (!answersByStudent[answer.student.id]) answersByStudent[answer.student.id] = [];
                answersByStudent[answer.student.id].push(answer);
            });
            Object.values(answersByStudent).forEach(studentAnswers => {
                studentAnswers.sort((a, b) => new Date(a.answered_at) - new Date(b.answered_at));
                let previouslevel = null;
                studentAnswers.forEach(answer => {
                    const currentlevel = answer.level;
                    if (previouslevel !== null && previouslevel !== currentlevel) {
                        const key = `${previouslevel}-${currentlevel}`;
                        if (transitionCounts.hasOwnProperty(key)) {
                            transitionCounts[key]++;
                        }
                    }
                    previouslevel = currentlevel;
                });
            });
        }

        const totalStudents = studentsData.length;
        let tableHTML = levelTransitions.map(transition => {
            const key = `${transition.from}-${transition.to}`;
            const count = transitionCounts[key] || 0;
            const percentage = totalStudents > 0 ? Math.round((count / totalStudents) * 100) : 0;
            
            if (count === 0) return ''; // Do not show row if count is zero

            return `
                <tr>
                    <td>Level ${transition.from}</td>
                    <td>Level ${transition.to}</td>
                    <td>${count}</td>
                    <td>${percentage}%</td>
                </tr>
            `;
        }).join('');

        if (tableHTML.trim() === '') {
            tableHTML = `<tr><td colspan="4" class="text-center text-muted">Belum ada data perjalanan level.</td></tr>`;
        }
        tableBody.innerHTML = tableHTML;
    }

    // Update summary statistics
    function updateSummaryStats() {
      // Total students
      document.getElementById('total-students').textContent = studentsData.length;
      
      // Total correct answers
      const totalCorrect = studentsData.reduce((sum, student) => sum + (student.correct || 0), 0);
      document.getElementById('total-correct').textContent = totalCorrect;
      
      // Total incorrect answers
      const totalIncorrect = studentsData.reduce((sum, student) => sum + (student.incorrect || 0), 0);
      document.getElementById('total-incorrect').textContent = totalIncorrect;
      
      // Average accuracy
      const totalAnswers = totalCorrect + totalIncorrect;
      const avgAccuracy = totalAnswers > 0 ? Math.round((totalCorrect / totalAnswers) * 100) : 0;
      document.getElementById('avg-accuracy').textContent = avgAccuracy + '%';
    }

    // Update level distribution statistics
    function updatelevelDistributionStats() {
      // Count students in each level category
      const basiclevels = studentsData.filter(s => [1, 2].includes(parseInt(s.currentlevel || 1))).length;
      const intermediatelevels = studentsData.filter(s => [3, 4].includes(parseInt(s.currentlevel || 1))).length;
      const advancedlevels = studentsData.filter(s => [5, 6, 7].includes(parseInt(s.currentlevel || 1))).length;
      const completedCount = studentsData.filter(s => s.isCompleted).length;
      
      const totalStudents = studentsData.length;
      
      // Calculate percentages
      const basicPercentage = totalStudents > 0 ? Math.round((basiclevels / totalStudents) * 100) : 0;
      const intermediatePercentage = totalStudents > 0 ? Math.round((intermediatelevels / totalStudents) * 100) : 0;
      const advancedPercentage = totalStudents > 0 ? Math.round((advancedlevels / totalStudents) * 100) : 0;
      const completedPercentage = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
      
      // Update UI
      document.getElementById('basic-level-percentage').textContent = basicPercentage + '%';
      document.getElementById('intermediate-level-percentage').textContent = intermediatePercentage + '%';
      document.getElementById('advanced-level-percentage').textContent = advancedPercentage + '%';
      document.getElementById('completed-percentage').textContent = completedPercentage + '%';
    }

    // Show student detail modal
    function showStudentDetail(studentId) {
      // Find student data
      const student = studentsData.find(s => s.id == studentId);
      
      if (!student) {
        showError('Data siswa tidak ditemukan');
        return;
      }
      
      // Populate modal with student data
      document.getElementById('modal-student-name').textContent = student.nama || '-';
      document.getElementById('modal-student-class').textContent = student.kelas || '-';
      document.getElementById('modal-student-level').textContent = student.currentlevel || 1;
      document.getElementById('modal-current-level').textContent = student.currentlevel || 1;
      
      // Set student ID for export button
      document.getElementById('modalExportBtn').setAttribute('data-student-id', studentId);
      
      // Status
      let statusText = '';
      if (student.isCompleted) {
        statusText = '<span class="badge bg-success">Selesai</span>';
      } else if ((student.correct || 0) + (student.incorrect || 0) > 0) {
        statusText = '<span class="badge bg-warning text-dark">Sedang Mengerjakan</span>';
      } else {
        statusText = '<span class="badge bg-secondary">Belum Mulai</span>';
      }
      document.getElementById('modal-student-status').innerHTML = statusText;
      
      // Statistics
      document.getElementById('modal-student-correct').textContent = student.correct || 0;
      document.getElementById('modal-student-incorrect').textContent = student.incorrect || 0;
      
      // Accuracy
      const total = (student.correct || 0) + (student.incorrect || 0);
      const accuracy = total > 0 ? Math.round((student.correct / total) * 100) : 0;
      document.getElementById('modal-student-accuracy').textContent = accuracy + '%';
      
      // Answer history
      const answerHistory = answersData.filter(a => a.student.id == studentId);
      
      // Sort by time
      answerHistory.sort((a, b) => new Date(b.answered_at) - new Date(a.answered_at));
      
      const historyTableBody = document.getElementById('modal-answer-history');
      
      if (answerHistory.length === 0) {
        historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada riwayat jawaban</td></tr>';
      } else {
        historyTableBody.innerHTML = answerHistory.map(answer => {
          // Format question text (truncate if too long)
          const questionText = answer.question_text.length > 30
            ? answer.question_text.substring(0, 30) + '...'
            : answer.question_text;
            
          // Format date
          const answerDate = new Date(answer.answered_at);
          const formattedDate = answerDate.toLocaleDateString('id-ID', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          return `
            <tr>
              <td><span class="badge badge-level">${answer.level}</span></td>
              <td>${escapeHtml(questionText)}</td>
              <td>${escapeHtml(answer.siswa_answer)}</td>
              <td>${answer.is_correct ? 
                '<span class="badge bg-success">Benar</span>' : 
                '<span class="badge bg-danger">Salah</span>'}</td>
              <td>${formattedDate}</td>
            </tr>
          `;
        }).join('');
      }
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
      modal.show();
    }

    // Setup filter event listeners
    function setupFilterListeners() {
      // Class filters
      document.getElementById('overview-class-filter').addEventListener('change', applyOverviewFilters);
      document.getElementById('overview-period-filter').addEventListener('change', applyOverviewFilters);
      document.getElementById('overview-status-filter').addEventListener('change', applyOverviewFilters);
      
      // Student filters
      document.getElementById('student-class-filter').addEventListener('change', applyStudentFilters);
      document.getElementById('student-status-filter').addEventListener('change', applyStudentFilters);
      document.getElementById('student-search').addEventListener('input', applyStudentFilters);
      
      // Question filter
      document.getElementById('question-level-filter').addEventListener('change', applyQuestionFilters);
    }

    // Apply overview filters
    function applyOverviewFilters() {
      // Get filter values
      const classFilter = document.getElementById('overview-class-filter').value;
      const periodFilter = document.getElementById('overview-period-filter').value;
      const statusFilter = document.getElementById('overview-status-filter').value;
      
      // Apply filters to chart data
      updateChartsWithFilters(classFilter, periodFilter, statusFilter);
    }

    // Apply student filters
    function applyStudentFilters() {
      // Get filter values
      const classFilter = document.getElementById('student-class-filter').value;
      const statusFilter = document.getElementById('student-status-filter').value;
      const searchQuery = document.getElementById('student-search').value.toLowerCase();
      
      // Filter students
      const filteredStudents = studentsData.filter(student => {
        // Class filter
        if (classFilter !== 'all' && student.kelas !== classFilter) {
          return false;
        }
        
        // Status filter
        if (statusFilter !== 'all') {
          const total = (student.correct || 0) + (student.incorrect || 0);
          
          if (statusFilter === 'completed' && !student.isCompleted) {
            return false;
          }
          
          if (statusFilter === 'in_progress' && (student.isCompleted || total === 0)) {
            return false;
          }
          
          if (statusFilter === 'not_started' && total > 0) {
            return false;
          }
        }
        
        // Search filter
        if (searchQuery && !student.nama.toLowerCase().includes(searchQuery)) {
          return false;
        }
        
        return true;
      });
      
      // Render filtered students table
      const tableBody = document.getElementById('studentsTableBody');
      
      if (filteredStudents.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Tidak ada data siswa yang sesuai filter</td></tr>';
        return;
      }
      
      tableBody.innerHTML = filteredStudents.map(student => {
        const total = (student.correct || 0) + (student.incorrect || 0);
        const accuracy = total > 0 ? Math.round((student.correct / total) * 100) : 0;
        
        let statusBadge = '';
        if (student.isCompleted) {
          statusBadge = '<span class="badge bg-success">Selesai</span>';
        } else if (total > 0) {
          statusBadge = '<span class="badge bg-warning text-dark">Sedang Mengerjakan</span>';
        } else {
          statusBadge = '<span class="badge bg-secondary">Belum Mulai</span>';
        }
        
        return `
          <tr class="student-row" data-id="${student.id}">
            <td>${escapeHtml(student.nama || '-')}</td>
            <td>${escapeHtml(student.kelas || '-')}</td>
            <td>${statusBadge}</td>
            <td><span class="badge badge-level">${student.currentlevel || 1}</span></td>
            <td><span class="badge badge-correct">${student.correct || 0}</span></td>
            <td><span class="badge badge-incorrect">${student.incorrect || 0}</span></td>
            <td>${accuracy}%</td>
            <td>
              <button class="btn btn-sm btn-outline-primary view-student-btn" data-id="${student.id}">
                <i class="bi bi-eye"></i> Detail
              </button>
              <button class="btn btn-sm btn-outline-success export-student-btn" data-id="${student.id}">
                <i class="bi bi-file-earmark-excel"></i> Export
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      // Add event listeners for detail buttons
      document.querySelectorAll('.view-student-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const studentId = btn.getAttribute('data-id');
          showStudentDetail(studentId);
        });
      });
      
      // Add event listeners for export buttons
      document.querySelectorAll('.export-student-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const studentId = btn.getAttribute('data-id');
          exportStudentData(studentId);
        });
      });
      
      // Also add click event to rows
      document.querySelectorAll('.student-row').forEach(row => {
        row.addEventListener('click', (e) => {
          // Ignore if clicked on the button
          if (!e.target.closest('.view-student-btn') && !e.target.closest('.export-student-btn')) {
            const studentId = row.getAttribute('data-id');
            showStudentDetail(studentId);
          }
        });
      });
    }

    // Apply question filters
    function applyQuestionFilters() {
      const levelFilter = document.getElementById('question-level-filter').value;
      
      // Filter questions
      const filteredQuestions = questionsData.filter(question => {
        if (levelFilter !== 'all' && question.level !== parseInt(levelFilter)) {
          return false;
        }
        return true;
      });
      
      // Render filtered questions table
      const tableBody = document.getElementById('questionsTableBody');
      
      if (filteredQuestions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data soal yang sesuai filter</td></tr>';
        return;
      }
      
      tableBody.innerHTML = filteredQuestions.map(question => {
        // Format question text (truncate if too long)
        const questionText = question.soal.length > 50
          ? question.soal.substring(0, 50) + '...'
          : question.soal;
          
        // Calculate difficulty label
        let difficultyLabel = '';
        const p = parseFloat(question.p);
        
        if (p >= 0.80) {
          difficultyLabel = '<span class="badge bg-success">Mudah</span>';
        } else if (p >= 0.50) {
          difficultyLabel = '<span class="badge bg-warning text-dark">Sedang</span>';
        } else {
          difficultyLabel = '<span class="badge bg-danger">Sulit</span>';
        }
        
        return `
          <tr>
            <td>${question.id}</td>
            <td><span class="badge badge-level">${question.level}</span></td>
            <td>${escapeHtml(questionText)}</td>
            <td>${difficultyLabel} (${question.p})</td>
            <td><span class="badge badge-correct">${question.correctCount}</span></td>
            <td><span class="badge badge-incorrect">${question.incorrectCount}</span></td>
            <td>${question.accuracy}%</td>
          </tr>
        `;
      }).join('');
    }

    // Update charts with filters
    function updateChartsWithFilters(classFilter, periodFilter, statusFilter) {
      // Filter students based on criteria
      const filteredStudents = studentsData.filter(student => {
        // Class filter
        if (classFilter !== 'all' && student.kelas !== classFilter) {
          return false;
        }
        
        // Status filter
        if (statusFilter !== 'all') {
          const total = (student.correct || 0) + (student.incorrect || 0);
          
          if (statusFilter === 'completed' && !student.isCompleted) {
            return false;
          }
          
          if (statusFilter === 'in_progress' && (student.isCompleted || total === 0)) {
            return false;
          }
        }
        
        return true;
      });
      
      // Filter answers based on period
      let filteredAnswers = [...answersData];
      
      if (periodFilter !== 'all') {
        const now = new Date();
        let cutoffDate = new Date();
        
        if (periodFilter === 'week') {
          cutoffDate.setDate(now.getDate() - 7);
        } else if (periodFilter === 'month') {
          cutoffDate.setMonth(now.getMonth() - 1);
        }
        
        filteredAnswers = answersData.filter(answer => {
          const answerDate = new Date(answer.answered_at);
          return answerDate >= cutoffDate;
        });
      }
      
      // Further filter answers to only include filtered students
      filteredAnswers = filteredAnswers.filter(answer => 
        filteredStudents.some(student => student.id == answer.student.id)
      );
      
      // Update answer distribution chart
      updateAnswerDistributionChart(filteredStudents);
      
      // Update class comparison chart
      updateClassComparisonChart(filteredStudents);
      
      // Update level distribution chart
      updatelevelDistributionChart(filteredStudents);
    }

    // Update answer distribution chart
    function updateAnswerDistributionChart(filteredStudents) {
      if (!chartInstances.answerDistribution) return;
      
      // Recalculate based on filtered students
      const totalStudents = filteredStudents.length;
      const completedStudents = filteredStudents.filter(s => s.isCompleted).length;
      const inProgressStudents = filteredStudents.filter(s => !s.isCompleted && (s.correct + s.incorrect > 0)).length;
      const notStartedStudents = totalStudents - completedStudents - inProgressStudents;

      // Update chart data
      chartInstances.answerDistribution.data.datasets[0].data = [completedStudents, inProgressStudents, notStartedStudents];
      chartInstances.answerDistribution.update();
    }

    // Refresh data
    async function refreshData() {
      showLoading(true);
      
      try {
        // Reset cache
        studentsData = [];
        questionsData = [];
        answersData = [];
        
        // Fetch fresh data
        await initializeAnalytics();
        
        // Show success message
        Swal.fire({
          title: 'Sukses!',
          text: 'Data berhasil disegarkan',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        showError('Gagal menyegarkan data: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    // Show loading overlay
    function showLoading(show) {
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    // Show error message
    function showError(message) {
      Swal.fire({
        title: 'Error!',
        text: message,
        icon: 'error',
        confirmButtonText: 'OK'
      });
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Setup export functionality
    function setupExportFunctionality() {
      // Export individual student data
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('export-student-btn') || 
            e.target.closest('.export-student-btn')) {
          
          const btn = e.target.classList.contains('export-student-btn') ? 
                      e.target : e.target.closest('.export-student-btn');
          
          const studentId = btn.getAttribute('data-id');
          exportStudentData(studentId);
        }
      });
      
      // Handle export class data button
      document.getElementById('exportClassDataBtn').addEventListener('click', function() {
        // Populate class select options
        const classSelect = document.getElementById('exportClassSelect');
        classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        
        // Get unique classes from studentsData
        const classes = [...new Set(studentsData.map(student => student.kelas))].filter(Boolean);
        
        classes.forEach(className => {
          const option = document.createElement('option');
          option.value = className;
          option.textContent = className;
          classSelect.appendChild(option);
        });
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('exportClassModal'));
        modal.show();
      });
      
      // Handle confirm export class button
      document.getElementById('confirmExportClassBtn').addEventListener('click', function() {
        const classId = document.getElementById('exportClassSelect').value;
        
        if (!classId) {
          Swal.fire({
            title: 'Error!',
            text: 'Silakan pilih kelas terlebih dahulu',
            icon: 'error',
            confirmButtonText: 'OK'
          });
          return;
        }
        
        exportClassData(classId);
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('exportClassModal')).hide();
      });
      
      // Handle export button in student detail modal
      document.getElementById('modalExportBtn').addEventListener('click', function() {
        const studentName = document.getElementById('modal-student-name').textContent;
        const studentId = this.getAttribute('data-student-id');
        
        if (!studentId) {
          showError('ID siswa tidak ditemukan');
          return;
        }
        
        // Show confirmation
        Swal.fire({
          title: 'Export Data',
          text: `Anda akan mengexport data untuk siswa: ${studentName}`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Export',
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            exportStudentData(studentId);
          }
        });
      });
      
      // Handle export all data button
      document.getElementById('exportAllDataBtn').addEventListener('click', function() {
        // Populate class and student select options
        const classSelect = document.getElementById('allExportClassSelect');
        const studentSelect = document.getElementById('allExportStudentSelect');
        
        // Clear previous options
        classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        studentSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
        
        // Get unique classes from studentsData
        const classes = [...new Set(studentsData.map(student => student.kelas))].filter(Boolean);
        
        // Populate class select
        classes.forEach(className => {
          const option = document.createElement('option');
          option.value = className;
          option.textContent = className;
          classSelect.appendChild(option);
        });
        
        // Populate student select
        studentsData.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.nama} (${student.kelas || 'Tidak ada kelas'})`;
          studentSelect.appendChild(option);
        });
        
        // Show/hide form sections based on selected export type
        document.querySelectorAll('input[name="exportType"]').forEach(radio => {
          radio.addEventListener('change', updateExportFormVisibility);
        });
        
        // Initial visibility update
        updateExportFormVisibility();
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('exportAllModal'));
        modal.show();
      });
      
      // Handle confirm all export button
      document.getElementById('confirmAllExportBtn').addEventListener('click', function() {
        const selectedType = document.querySelector('input[name="exportType"]:checked').value;
        
        if (selectedType === 'all') {
          // Export all data
          exportAllData();
        } else if (selectedType === 'class') {
          // Export class data
          const classId = document.getElementById('allExportClassSelect').value;
          
          if (!classId) {
            Swal.fire({
              title: 'Error!',
              text: 'Silakan pilih kelas terlebih dahulu',
              icon: 'error',
              confirmButtonText: 'OK'
            });
            return;
          }
          
          exportClassData(classId);
        } else if (selectedType === 'individual') {
          // Export individual student data
          const studentId = document.getElementById('allExportStudentSelect').value;
          
          if (!studentId) {
            Swal.fire({
              title: 'Error!',
              text: 'Silakan pilih siswa terlebih dahulu',
              icon: 'error',
              confirmButtonText: 'OK'
            });
            return;
          }
          
          exportStudentData(studentId);
        }
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('exportAllModal')).hide();
      });
    }

    // Update export form visibility based on selected type
    function updateExportFormVisibility() {
      const selectedType = document.querySelector('input[name="exportType"]:checked').value;
      
      // Show/hide appropriate forms
      document.getElementById('classSelectionForm').style.display = 
        selectedType === 'class' ? 'block' : 'none';
        
      document.getElementById('studentSelectionForm').style.display = 
        selectedType === 'individual' ? 'block' : 'none';
    }

    // Export individual student data
    function exportStudentData(studentId) {
      showLoading(true);
      
      // Generate export URL
      const exportUrl = `/api/export_result_excel?type=individual&user_id=${studentId}&collection_id=${collectionId}`;
      
      // Create a hidden link and trigger download
      const link = document.createElement('a');
      link.href = exportUrl;
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(link);
        showLoading(false);
      }, 1000);
    }

    // Export class data
    function exportClassData(classId) {
      showLoading(true);
      
      // Generate export URL
      const exportUrl = `/api/export_result_excel_teacher?type=class&class_id=${classId}&collection_id=${collectionId}`;
      
      // Create a hidden link and trigger download
      const link = document.createElement('a');
      link.href = exportUrl;
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(link);
        showLoading(false);
      }, 1000);
    }

    // Export all data for this collection
    function exportAllData() {
      showLoading(true);
      
      // Generate export URL for all data
      const exportUrl = `/api/export_all_collection_data?collection_id=${collectionId}`;
      
      // Create a hidden link and trigger download
      const link = document.createElement('a');
      link.href = exportUrl;
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(link);
        showLoading(false);
      }, 1000);
    }
  </script>
</body>
</html>
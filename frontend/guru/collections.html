<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koleksi Soal Pilihan Ganda</title>

    <!-- Link CSS utama yang dibutuhkan oleh halaman dan header -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        /* CSS untuk Navbar */
        body {
            padding-top: 70px; /* Memberi ruang untuk fixed-top navbar */
        }
        .main-navbar {
            background-color: #0d6efd;
            padding: 0.5rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .main-navbar .navbar-brand {
            font-weight: 700;
            font-size: 1.25rem;
        }
        .main-navbar .navbar-brand .brand-logo {
            height: 28px;
            width: auto;
            margin-right: 8px;
            vertical-align: middle;
        }
        .navbar-brand-disabled { pointer-events: none; cursor: default; color: #fff !important; }
        .main-navbar .user-info {
            color: white;
            margin-right: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .main-navbar .nav-link {
            color: rgba(255,255,255,0.85);
            padding: 0.5rem 1rem;
            transition: all 0.2s;
        }
        .main-navbar .nav-link:hover,
        .main-navbar .nav-link.active {
            color: #fff;
            background-color: rgba(255,255,255,0.12);
        }

        /* Styles untuk konten halaman */
        /* Filter styles */
        #questionCountFiltered {
            font-size: 0.9rem;
        }

        /* Question number styles */
        .question-number {
            min-width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1;
        }

        /* Responsive styles */
        @media (max-width: 576px) {
            .question-text {
                font-size: 1rem;
            }
            .question-number {
                min-width: 22px;
                height: 22px;
                font-size: 0.8rem;
            }
            .option-badge {
                font-size: 0.8rem;
                padding: 4px 8px;
            }
            .competency-text {
                display: block;
                margin-top: 0.25rem;
            }
            .border-end-lg {
                border-right: none !important;
                border-bottom: 1px solid #dee2e6;
                padding-bottom: 1rem;
                margin-bottom: 1rem;
            }
        }

        @media (min-width: 577px) and (max-width: 991px) {
            .border-end-lg {
                border-right: none !important;
                border-bottom: 1px solid #dee2e6;
                padding-bottom: 1rem;
                margin-bottom: 1rem;
            }
        }

        @media (min-width: 992px) {
            .border-end-lg {
                border-right: 1px solid #dee2e6 !important;
            }
        }

        .option-badge {
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 5px;
            padding: 5px 10px;
            border-radius: 15px;
        }
        .correct-answer {
            font-weight: bold;
            background-color: #d1e7dd;
            border: 1px solid #badbcc;
            color: #0f5132;
        }
        .question-card {
            border-left: 4px solid #0d6efd;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .question-card:hover {
            transform: translateY(-3px);
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        .collection-options {
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }
        .card:hover .collection-options {
            opacity: 1;
        }
        .student-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .student-badge:hover {
            background-color: #dc3545 !important;
            color: white !important;
        }
        .edit-description-btn {
            opacity: 0.2;
            font-size: 0.8rem;
            padding: 0.2rem 0.4rem;
        }
        .position-relative:hover .edit-description-btn {
            opacity: 1;
        }
        .description-edit {
            font-size: 0.875rem;
        }
        .remove-student {
            visibility: hidden;
            opacity: 0;
            transition: all 0.2s;
        }
        .student-badge:hover .remove-student {
            visibility: visible;
            opacity: 1;
        }
        .question-card[data-validated="true"] {
            border-color: #198754;
        }
        .btn-validated {
            background-color: #198754 !important;
            color: white !important;
            border-color: #198754 !important;
        }

        /* Warna stage soal - MST 5 Stage Technology Assessment */
        .badge.stage-L1 {
            background-color: #198754 !important;
            color: white !important;
        }
        .badge.stage-L2 {
            background-color: #20c997 !important;
            color: white !important;
        }
        .badge.stage-L3 {
            background-color: #ffc107 !important;
            color: #000 !important;
        }
        .badge.stage-L4 {
            background-color: #fd7e14 !important;
            color: white !important;
        }
        .badge.stage-L5 {
            background-color: #dc3545 !important;
            color: white !important;
        }

        /* Backward compatibility untuk level lama (JIKA MASIH DIGUNAKAN, tidak direkomendasikan jika hanya L1-L5) */
        .badge.level-1 { background-color: #198754 !important; }
        .badge.level-2 { background-color: #20c997 !important; }
        .badge.level-3 { background-color: #ffc107 !important; color: #000 !important;}
        .badge.level-4 { background-color: #ffc107 !important; color: #000 !important;} /* Level 4 lama -> L3 */
        .badge.level-5 { background-color: #dc3545 !important; } /* Level 5 lama -> L5 */
        .badge.level-6 { background-color: #dc3545 !important; } /* Level 6 lama -> L5 (jika perlu) */
        .badge.level-7 { background-color: #dc3545 !important; } /* Level 7 lama -> L5 (jika perlu) */

        /* Modern Page Header Styling */
        .page-header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 25px 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(13, 110, 253, 0.1);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #0d6efd 0%, #20c997 50%, #fd7e14 100%);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .page-title i {
            font-size: 1.8rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .page-subtitle {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.8;
        }

        /* Modern Button Styling */
        .btn-modern {
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            border: none;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2);
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 110, 253, 0.3);
        }

        .btn-modern:active {
            transform: translateY(0);
        }

        /* Collection Card Enhancements */
        .collection-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .collection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .collection-card .card-body {
            padding: 20px;
        }

        .collection-card .card-footer {
            background: rgba(13, 110, 253, 0.05);
            border-top: 1px solid rgba(13, 110, 253, 0.1);
            padding: 15px 20px;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        /* Card Title Enhancement */
        .collection-card .card-title {
            font-size: 1.1rem;
            line-height: 1.4;
            margin-bottom: 0;
        }

        .collection-card .card-text {
            font-size: 0.9rem;
            line-height: 1.5;
            height: 2.7em; /* Fixed height for 3 lines */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Action Button Groups */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-group-modern {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-sm-modern {
            padding: 8px 16px;
            font-size: 0.875rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-outline-primary-modern {
            border: 2px solid #0d6efd;
            color: #0d6efd;
            background: transparent;
        }

        .btn-outline-primary-modern:hover {
            background: #0d6efd;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
        }

        .btn-outline-success-modern {
            border: 2px solid #198754;
            color: #198754;
            background: transparent;
        }

        .btn-outline-success-modern:hover {
            background: #198754;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
        }

        .btn-outline-info-modern {
            border: 2px solid #0dcaf0;
            color: #0dcaf0;
            background: transparent;
        }

        .btn-outline-info-modern:hover {
            background: #0dcaf0;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 202, 240, 0.3);
        }

        .btn-outline-danger-modern {
            border: 2px solid #dc3545;
            color: #dc3545;
            background: transparent;
        }

        .btn-outline-danger-modern:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-header {
                padding: 20px;
            }

            .page-title {
                font-size: 1.5rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .page-title i {
                font-size: 1.3rem;
            }

            .action-buttons {
                width: 100%;
                justify-content: center;
            }

            .btn-group-modern {
                width: 100%;
                justify-content: center;
            }
        }

        /* Collection Statistics Styling */
        .collection-stats .stat-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .collection-stats .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .collection-stats .stat-item i {
            transition: transform 0.3s ease;
        }

        .collection-stats .stat-item:hover i {
            transform: scale(1.1);
        }

        /* Loading Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .collection-card {
            animation: fadeIn 0.5s ease-out;
            animation-fill-mode: both;
        }

        .collection-card:nth-child(1) { animation-delay: 0.1s; }
        .collection-card:nth-child(2) { animation-delay: 0.2s; }
        .collection-card:nth-child(3) { animation-delay: 0.3s; }
        .collection-card:nth-child(4) { animation-delay: 0.4s; }

        /* Button Group Spacing */
        .btn-group-modern .btn {
            margin: 2px;
        }

        /* Enhanced Loading Animation */
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Button Loading State */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Pulse Animation for Important Elements */
        .pulse-animation {
            animation: pulse-modern 2s infinite;
        }

        @keyframes pulse-modern {
            0% {
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
            }
        }

        /* Hover Effects Enhancement */
        .collection-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .btn-sm:hover {
            transform: translateY(-2px);
            transition: all 0.2s ease;
        }

        .btn-sm:active {
            transform: translateY(0);
        }

        /* Loading State for Collection Cards */
        .collection-card.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .collection-card.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            z-index: 10;
        }

        /* Tooltip Enhancement */
        .tooltip {
            font-size: 0.875rem;
        }

        .tooltip-inner {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            border-radius: 8px;
            padding: 8px 12px;
        }

        @media (max-width: 576px) {
            .page-header {
                padding: 15px;
            }

            .btn-modern {
                width: 100%;
                text-align: center;
            }

            .collection-stats {
                margin-bottom: 1rem !important;
            }

            .btn-group-modern {
                justify-content: center;
            }

            .btn-group-modern .btn {
                flex: 1;
                min-width: 0;
            }
        }

        /* Global responsive helpers */
        img, video {
            max-width: 100%;
            height: auto;
        }
        .text-wrap,
        .question-text,
        .collection-card .card-title,
        .collection-card .card-text {
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }
        .option-badge { white-space: normal; }

        /* Extra mobile-first enhancements */
        @media (max-width: 576px) {
            body { padding-top: 56px; }
            .main-navbar .navbar-brand { font-size: 1rem; }
            .page-title { font-size: 1.25rem; }
            .page-subtitle { font-size: 0.9rem; }
            .collection-card .card-body { padding: 16px; }
            .student-list { max-height: 220px; }
            .action-buttons { width: 100%; gap: 6px; }
            .btn-group-modern { width: 100%; }
            .btn-group-modern .btn,
            .action-buttons .btn,
            .btn-sm-modern { width: 100%; }
            .question-number { min-width: 22px; height: 22px; font-size: 0.8rem; }
            .question-card { margin-bottom: 12px; }
            /* Make modals full-screen on small devices */
            .modal-dialog { margin: 0; }
            .modal-content { border-radius: 0; }
        }

        /* Justify text for question content */
        .question-text {
            text-align: justify;
            text-justify: inter-word;
        }
        /* Fallback: justify common question text containers inside question cards */
        .question-card .card-body .question-text,
        .question-card .card-body p.question,
        .question-card .card-body p.soal {
            text-align: justify;
            text-justify: inter-word;
        }

        /* Footer */
        .site-footer {
            background: #ffffff;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }
        .site-footer a { color: #0d6efd; }
        .site-footer a:hover { text-decoration: underline; }
        @media (max-width: 576px) {
            .site-footer .row > [class^="col-"] { margin-top: 6px; margin-bottom: 6px; }
        }
    </style>
</head>

<body>
    <!-- Header/Navbar digabungkan langsung ke sini -->
    <nav class="navbar navbar-expand-lg navbar-dark main-navbar fixed-top">
        <div class="container">
            <span class="navbar-brand navbar-brand-disabled" title="DIGIDAWS = DIagnostik cerdas Guru untuk Identifikasi Deteksi Awal kemampuan siswa dan Wawasan Sistematis">
                <img src="/img/logo_digidaws.png" alt="Logo DIGIDAWS" class="brand-logo">DIGIDAWS
            </span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/guru" id="nav-dashboard">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/guru/collections" id="nav-collections">
                            <i class="bi bi-journal-bookmark"></i> Koleksi Soal
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/guru/panduan" id="nav-guide">
                            <i class="bi bi-question-circle"></i> Panduan
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="user-info">
                        <i class="bi bi-person-circle"></i> {{ current_user.nama }} (Guru)
                    </span>
                    <a href="/logout" class="btn btn-outline-light">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Modern Header Section -->
        <div class="page-header mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="page-title-section">
                    <h2 class="page-title mb-1">
                        <i class="bi bi-journal-bookmark text-primary me-2"></i>
                        Koleksi Soal
                    </h2>
                    <p class="page-subtitle text-muted mb-0">Kelola dan analisis koleksi soal diagnostik</p>
                </div>
                <div class="action-buttons">
                    <button id="createCollectionBtn" class="btn btn-primary btn-modern">
                        <i class="bi bi-plus-circle me-2"></i>
                        <span>Buat Baru</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="collectionsContainer">
            <!-- Loading Skeleton Cards -->
            <div class="col">
                <div class="card h-100 collection-card placeholder-glow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title placeholder col-6"></h5>
                            <span class="placeholder col-3"></span>
                        </div>
                        <p class="card-text placeholder col-8"></p>
                        <p class="card-text placeholder col-6"></p>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="placeholder col-12" style="height: 60px; border-radius: 12px;"></div>
                            </div>
                            <div class="col-6">
                                <div class="placeholder col-12" style="height: 60px; border-radius: 12px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex gap-2">
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 collection-card placeholder-glow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title placeholder col-7"></h5>
                            <span class="placeholder col-3"></span>
                        </div>
                        <p class="card-text placeholder col-9"></p>
                        <p class="card-text placeholder col-5"></p>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="placeholder col-12" style="height: 60px; border-radius: 12px;"></div>
                            </div>
                            <div class="col-6">
                                <div class="placeholder col-12" style="height: 60px; border-radius: 12px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex gap-2">
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 collection-card placeholder-glow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title placeholder col-5"></h5>
                            <span class="placeholder col-3"></span>
                        </div>
                        <p class="card-text placeholder col-7"></p>
                        <p class="card-text placeholder col-8"></p>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="placeholder col-12" style="height: 60px; border-radius: 12px;"></div>
                            </div>
                            <div class="col-6">
                                <div class="placeholder col-12" style="height: 60px; border-radius: 12px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex gap-2">
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                            <span class="placeholder col-2" style="height: 32px; border-radius: 8px;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="collectionDetail" class="mt-4" style="display: none;">
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                        <h4 class="mb-2 mb-sm-0" id="collectionTitle"></h4>
                        <div class="d-flex flex-wrap gap-2">
                            <button id="manageStudentsBtn" class="btn btn-sm btn-success">
                                <i class="bi bi-people-fill"></i> <span class="d-none d-md-inline">Kelola</span> Siswa
                            </button>
                            <button id="analysisCollectionBtn" class="btn btn-sm btn-info" onclick="openCollectionAnalysis()">
                                <i class="bi bi-graph-up"></i> <span class="d-none d-md-inline">Analisis</span> Soal
                            </button>
                            <button id="closeCollectionBtn" class="btn btn-sm btn-outline-light">
                                <i class="bi bi-arrow-left"></i> <span class="d-none d-md-inline">Kembali</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-lg-8 col-md-7 col-sm-12 mb-3 mb-md-0">
                            <div class="d-flex flex-wrap align-items-center mb-2">
                                <h5 class="mb-0 me-auto">Deskripsi</h5>
                                <button id="editDescriptionBtn" class="btn btn-sm btn-outline-primary mt-2 mt-sm-0">
                                    <i class="bi bi-pencil"></i> <span class="d-none d-sm-inline">Edit</span>
                                </button>
                            </div>
                            <div id="descriptionDisplayContainer">
                                <p class="text-muted" id="collectionDescription"></p>
                            </div>
                            <div id="descriptionEditContainer" class="d-none">
                                <div class="form-group">
                                    <textarea id="descriptionEditor" class="form-control" rows="3"></textarea>
                                    <div class="mt-2 d-flex flex-wrap gap-2">
                                        <button id="saveDescriptionBtn" class="btn btn-sm btn-primary">
                                            <i class="bi bi-save"></i> Simpan
                                        </button>
                                        <button id="cancelDescriptionBtn" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-x"></i> Batal
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-5 col-sm-12">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-info-circle"></i> Informasi Koleksi</h6>
                                    <div class="d-flex justify-content-between mt-3">
                                        <span>Jumlah Soal:</span>
                                        <span id="questionCount" class="fw-bold">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span>Jumlah Siswa:</span>
                                        <span id="studentCount" class="fw-bold">0</span>
                                    </div>
                                    <div class="mt-3">
                                        <h6 class="mb-2">Siswa dengan Akses:</h6>
                                        <div id="assignedStudentBadges" class="d-flex flex-wrap gap-1"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2 mb-3">
                        <h5 class="mb-0">Daftar Soal</h5>
                        <button id="validateAllQuestionsBtn" class="btn btn-outline-info">
                            <i class="bi bi-check-circle"></i> <span class="d-none d-sm-inline">Validasi Semua Soal</span><span class="d-inline d-sm-none">Validasi Semua</span>
                        </button>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                                <div class="d-flex align-items-center">
                                    <label for="levelFilter" class="form-label mb-0 me-2">Filter berdasarkan stage:</label>
                                    <select id="levelFilter" class="form-select form-select-sm" style="width: auto;">
                                        <option value="all">Semua Stage</option>
                                        <option value="L1">L1: Kesadaran Teknologi</option>
                                        <option value="L2">L2: Literasi Teknologi</option>
                                        <option value="L3">L3: Kemampuan Teknologi</option>
                                        <option value="L4">L4: Kreativitas Teknologi</option>
                                        <option value="L5">L5: Evaluasi Kritis Teknologi</option>
                                    </select>
                                </div>
                                <div class="ms-md-auto d-flex align-items-center">
                                    <span class="badge bg-secondary me-2" id="questionCountFiltered"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="collectionQuestions" class="row g-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer sama seperti Dashboard Guru -->
    <footer class="bg-light mt-5 py-4 border-top">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h6 class="text-primary"><i class="bi bi-gear"></i> Sistem MST Adaptive - Dashboard Guru</h6>
                    <p class="text-muted mb-0">
                        <small>Multistage Adaptive Testing dengan 5 Level Taksonomi Teknologi.
                        Sistem ini menggunakan alur percabangan kompleks untuk diagnosis kemampuan yang lebih akurat.</small>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <!-- Tombol/tautan footer mengikuti dashboard (kosong sesuai permintaan) -->
                </div>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="editQuestionModal" tabindex="-1" aria-labelledby="editQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editQuestionModalLabel">Edit Soal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-lg-6 border-end-lg pe-lg-4 mb-4 mb-lg-0">
                            <h5 class="mb-3">Edit Versi Terkini</h5>
                            <form id="editQuestionForm">
                                <input type="hidden" name="questionId" value="">
                                <div class="mb-3">
                                    <label for="editSoal" class="form-label">Pertanyaan</label>
                                    <textarea class="form-control" id="editSoal" name="soal" rows="3" required></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Opsi Jawaban</label>
                                    <div id="optionsContainer" class="mb-2"></div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="addOption">
                                        <i class="bi bi-plus-circle"></i> Tambah Opsi
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <label for="editJawabanBenar" class="form-label">Jawaban Benar</label>
                                    <select class="form-select" id="editJawabanBenar" name="jawaban_benar" required></select>
                                </div>

                                <div class="mb-3">
                                    <label for="editExplanation" class="form-label">Penjelasan</label>
                                    <textarea class="form-control" id="editExplanation" name="explanation" rows="3"></textarea>
                                </div>

                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label for="editP" class="form-label">Tingkat Kesulitan (p)</label>
                                        <input type="number" class="form-control" id="editP" name="p" step="0.01" min="0" max="1" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editVersion" class="form-label">Versi Saat Ini</label>
                                        <input type="text" class="form-control" id="editVersion" name="version" readonly>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="col-lg-6 ps-4">
                            <h5 class="mb-3">Riwayat Perubahan</h5>
                            <div id="versionHistory" class="list-group overflow-auto" style="max-height: 60vh;">
                                </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex-wrap gap-2 justify-content-center justify-content-sm-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> <span class="d-none d-sm-inline">Batal</span>
                    </button>
                    <button type="button" class="btn btn-outline-info" id="validateQuestionModalBtn">
                        <i class="bi bi-check-circle"></i> <span class="d-none d-sm-inline">Validasi Soal</span><span class="d-inline d-sm-none">Validasi</span>
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteQuestionBtn">
                        <i class="bi bi-trash"></i> Hapus Soal
                    </button>
                    <button type="button" class="btn btn-primary" id="saveQuestionChanges">
                        <i class="bi bi-save"></i> Simpan Perubahan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="manageStudentsModal" tabindex="-1" aria-labelledby="manageStudentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-fullscreen-md-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageStudentsModalLabel">Kelola Akses Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="classToAddSelect" class="form-label">Tambahkan Semua Siswa dari Kelas</label>
                            <div class="d-flex flex-column flex-sm-row gap-2">
                                <select class="form-select" id="classToAddSelect">
                                    <option value="">-- Pilih Kelas --</option>
                                </select>
                                <button class="btn btn-primary" id="addStudentsByClassBtn">
                                    <i class="bi bi-person-plus-fill"></i> <span class="d-none d-sm-inline">Tambahkan Semua Siswa</span><span class="d-inline d-sm-none">Tambah</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="mb-3">Siswa dengan Akses Koleksi Ini</h6>
                            <div class="input-group mb-3 position-relative">
                                <input type="text" id="assignedStudentSearch" class="form-control" placeholder="Cari siswa...">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <div id="assignedStudents" class="list-group student-list overflow-auto" style="max-height: 50vh;">
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-people" style="font-size: 2rem;"></i>
                                    <p class="mt-2">Memuat siswa...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex-wrap gap-2 justify-content-center justify-content-sm-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> <span class="d-none d-sm-inline">Tutup</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Tandai nav aktif berdasarkan path
        (function(){
            try {
                const path = window.location.pathname || '';
                const navDashboard = document.getElementById('nav-dashboard');
                const navCollections = document.getElementById('nav-collections');
                const navGuide = document.getElementById('nav-guide');
                [navDashboard, navCollections, navGuide].forEach(el => el && el.classList.remove('active'));
                if (path === '/guru' || path === '/guru/') {
                    navDashboard && navDashboard.classList.add('active');
                } else if (path.startsWith('/guru/collections')) {
                    navCollections && navCollections.classList.add('active');
                } else if (path.startsWith('/guru/panduan')) {
                    navGuide && navGuide.classList.add('active');
                }
            } catch (e) {}
        })();

        // Daftar kelas yang sudah ditentukan
        const kelasOptions = [
            'X.A', 'X.B', 'X.C', 'X.D', 'X.E', 'X.F', 'X.G', 'X.H', 'X.I', 'X.J', 'X.K', 'X.L',
            'XI P1.1', 'XI P1.2', 'XI P2.1', 'XI P2.2', 'XI P4.1', 'XI P3.2', 'XI P4', 'XI P5', 'XI P6', 'XI P7.1', 'XI P7.2', 'XI P7.3',
            'XII P 1', 'XII P 2.1', 'XII P 2.2', 'XII P 3', 'XII P 4', 'XII P 5', 'XII P 6.1', 'XII P 6.2', 'XII P 7.1', 'XII P 7.2', 'XII P 7.3', 'XII P 8'
        ];

        // Definisi stage soal - MST 5 Stage Technology Assessment
        const stageExplanations = {
            'L1': {
                title: "L1: Kesadaran Teknologi",
                name: "Kesadaran Teknologi",
                competency: "Tingkat kesadaran dasar tentang teknologi dan perannya dalam kehidupan sehari-hari",
                example: "Mengenali teknologi, memahami dampak teknologi, mengidentifikasi fungsi teknologi.",
                difficulty: "Sedang",
                color: "#198754"
            },
            'L2': {
                title: "L2: Literasi Teknologi",
                name: "Literasi Teknologi",
                competency: "Kemampuan memahami dan menggunakan teknologi dasar serta literasi digital",
                example: "Menggunakan aplikasi, memahami antarmuka, navigasi digital dasar.",
                difficulty: "Mudah/Sulit",
                color: "#20c997"
            },
            'L3': {
                title: "L3: Kemampuan Teknologi",
                name: "Kemampuan Teknologi",
                competency: "Kemampuan menerapkan teknologi untuk memecahkan masalah praktis",
                example: "Menyelesaikan tugas dengan teknologi, mengintegrasikan tools, problem solving digital.",
                difficulty: "Sedang/Sulit",
                color: "#ffc107"
            },
            'L4': {
                title: "L4: Kreativitas Teknologi",
                name: "Kreativitas Teknologi",
                competency: "Kemampuan menggunakan teknologi secara kreatif dan inovatif untuk menciptakan solusi baru",
                example: "Membuat konten digital, merancang solusi kreatif, inovasi teknologi.",
                difficulty: "Mudah/Sedang/Sulit",
                color: "#fd7e14"
            },
            'L5': {
                title: "L5: Evaluasi Kritis Teknologi",
                name: "Evaluasi Kritis Teknologi",
                competency: "Kemampuan mengevaluasi dan mengkritisi teknologi secara mendalam dan objektif",
                example: "Analisis dampak teknologi, evaluasi efektivitas, kritik konstruktif teknologi.",
                difficulty: "Mudah/Sedang/Sulit",
                color: "#dc3545"
            }
        };

        // KODE PERBAIKAN: Mapping level lama ke stage baru - Disesuaikan untuk 5 Stage
        const levelToStageMapping = {
            1: 'L1', // Awareness
            2: 'L2', // Literacy
            3: 'L3', // Capability
            4: 'L3', // Capability (lanjutan, jika ada data lama level 4)
            5: 'L5', // <-- DIPERBAIKI: Level 5 lama dipetakan ke L5 (Criticism)
            6: 'L5', // Level 6 lama dipetakan ke L5 (Criticism) - untuk data lama
            7: 'L5'  // Level 7 lama dipetakan ke L5 (Criticism) - untuk data lama
        };

        let currentCollection = null;
        let questionsCache = {};
        let versionsCache = {};
        let studentsCache = []; // Cache for all students (from /api/siswa)
        let assignedStudentsCache = []; // Cache for students assigned to the current collection
        let editQuestionModal = null;
        let manageStudentsModal = null;

        // Helper function to create absolute URL
        function getApiUrl(path) {
            // Ensure the path starts with a slash
            const formattedPath = path.startsWith('/') ? path : '/' + path;
            return window.location.origin + formattedPath;
        }


        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            loadCollections();
            setupEventListeners();

            editQuestionModal = new bootstrap.Modal(document.getElementById('editQuestionModal'));
            manageStudentsModal = new bootstrap.Modal(document.getElementById('manageStudentsModal'));

            // Inisialisasi dropdown kelas
            populateClassSelect();

            // Mobile enhancements
            setupMobileEnhancements();

            // Set footer year
            const fy = document.getElementById('footerYear');
            if (fy) fy.textContent = new Date().getFullYear();
        });

        // Loading Animation Helpers
        function showButtonLoading(button, originalText = '') {
            if (!originalText) {
                originalText = button.textContent.trim();
            }
            button.dataset.originalText = originalText;
            button.classList.add('btn-loading');
            button.innerHTML = `<span class="loading-spinner"></span> Loading...`;
            button.disabled = true;
        }

        function hideButtonLoading(button) {
            const originalText = button.dataset.originalText || 'Action';
            button.classList.remove('btn-loading');
            button.innerHTML = originalText;
            button.disabled = false;
        }

        function showCardLoading(card) {
            card.classList.add('placeholder-glow');
            const content = card.querySelector('.card-body');
            if (content) {
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title placeholder col-6"></h5>
                        <span class="placeholder col-3"></span>
                    </div>
                    <p class="card-text placeholder col-8"></p>
                    <p class="card-text placeholder col-6"></p>
                `;
            }
        }

        function fadeInElement(element, delay = 0) {
            setTimeout(() => {
                element.classList.add('fade-in');
            }, delay);
        }

        function showSuccessToast(message) {
            // Create toast element
            const toastHtml = `
                <div class="toast align-items-center text-white bg-success border-0 position-fixed"
                     style="top: 20px; right: 20px; z-index: 9999;" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-check-circle me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.body.lastElementChild;
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();

            // Remove element after hiding
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Improve mobile UX: collapse navbar after click and constrain tooltips
        function setupMobileEnhancements() {
            try {
                const navbar = document.getElementById('mainNavbar');
                document.addEventListener('click', (e) => {
                    const link = e.target.closest('.navbar-nav .nav-link');
                    if (!link) return;
                    if (navbar && navbar.classList.contains('show')) {
                        const bsCollapse = bootstrap.Collapse.getInstance(navbar) || new bootstrap.Collapse(navbar, { toggle: false });
                        bsCollapse.hide();
                    }
                });

                // Ensure tooltips render within body to avoid overflow on mobile
                const tooltipEls = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltipEls.forEach(el => el.setAttribute('data-bs-container', 'body'));
            } catch (e) { /* noop */ }
        }

        function smoothScrollTo(element, offset = 100) {
            const elementPosition = element.offsetTop - offset;
            window.scrollTo({
                top: elementPosition,
                behavior: 'smooth'
            });
        }

        function populateClassSelect() {
            const select = document.getElementById('classToAddSelect');
            select.innerHTML = '<option value="">-- Pilih Kelas --</option>';

            // Urutkan kelas secara alfabetis
            kelasOptions.sort().forEach(kelas => {
                const option = document.createElement('option');
                option.value = kelas;
                option.textContent = kelas;
                select.appendChild(option);
            });
        }

        function setupEventListeners() {
            document.getElementById('createCollectionBtn').addEventListener('click', showCreateModal);

            document.getElementById('closeCollectionBtn').addEventListener('click', async () => {
                // Hide detail view
                document.getElementById('collectionDetail').style.display = 'none';

                // Reload the collections to get updated data
                await loadCollections();

                // Show collections container
                document.getElementById('collectionsContainer').style.display = 'flex';
                // Reset scroll position
                window.scrollTo(0, 0);
            });

            document.getElementById('manageStudentsBtn').addEventListener('click', () => {
                if (currentCollection) {
                    showManageStudentsModal();
                }
            });

            // Stage filter event listener
            document.getElementById('levelFilter').addEventListener('change', (e) => {
                const selectedStage = e.target.value;
                if (questionsCache && Object.keys(questionsCache).length > 0) {
                    renderQuestions(Object.values(questionsCache), selectedStage);
                }
            });

            // Search for assigned students
            document.getElementById('assignedStudentSearch').addEventListener('input', (e) => {
                filterAssignedStudentList(e.target.value);
            });

            // Event listener for "Add Students by Class" button
            document.getElementById('addStudentsByClassBtn').addEventListener('click', async () => {
                const classToAdd = document.getElementById('classToAddSelect').value;
                if (!classToAdd) {
                    showError("Pilih kelas yang ingin ditambahkan!");
                    return;
                }
                if (currentCollection) {
                    await addStudentsByClass(currentCollection.id, classToAdd);
                }
            });

            document.addEventListener('click', async (e) => {
                if (e.target.closest('.view-collection-btn')) {
                    const btn = e.target.closest('.view-collection-btn');
                    const collectionId = btn.getAttribute('data-id');

                    if (collectionId) {
                        loadCollectionDetail(collectionId);
                    }
                }

                if (e.target.closest('.btn-revisi')) {
                    const card = e.target.closest('.question-card');
                    if (card && card.dataset.id) {
                        try {
                            const questionId = parseInt(card.dataset.id);
                            const questionData = questionsCache[questionId];

                            if (!questionData) {
                                throw new Error("Data soal tidak ditemukan dalam cache");
                            }

                            let versions = versionsCache[questionId] || [];

                            if (versions.length === 0) {
                                try {
                                    const fetchedVersions = await fetchVersions(questionId);
                                    if (fetchedVersions && fetchedVersions.length > 0) {
                                        versions = fetchedVersions;
                                        versionsCache[questionId] = versions;
                                    }
                                } catch (versionErr) {
                                    console.warn("Tidak dapat memuat riwayat versi:", versionErr);
                                }
                            }

                            showEditModal(questionData, versions);
                        } catch (error) {
                            showError('Gagal memuat data soal: ' + error.message);
                        }
                    }
                }

                if (e.target.closest('.btn-delete-collection')) {
                    const btn = e.target.closest('.btn-delete-collection');
                    const collectionId = btn.getAttribute('data-id');

                    if (collectionId) {
                        handleDeleteCollection(collectionId);
                    }
                }

                if (e.target.closest('.btn-validate-collection')) {
                    const btn = e.target.closest('.btn-validate-collection');
                    const collectionId = btn.getAttribute('data-id');

                    if (collectionId) {
                        validateAllQuestions(collectionId);
                    }
                }

                // Event listeners for description editing (will be set up later)
                // if (e.target.closest('.edit-description-btn')) { ... }
                // if (e.target.closest('.save-description-btn')) { ... }
                // if (e.target.closest('.cancel-description-btn')) { ... }

                if (e.target.closest('.version-item')) {
                    handlePreviewVersion(e);
                }

                if (e.target.closest('.btn-remove-option')) {
                    removeOption(e);
                }

                if (e.target.closest('.remove-student-btn')) {
                    const btn = e.target.closest('.remove-student-btn');
                    const studentId = parseInt(btn.getAttribute('data-id'));

                    if (studentId && currentCollection) {
                        await removeStudentFromCollection(currentCollection.id, studentId);
                    }
                }

                // Event handler for removing student via badge (requires confirmation)
                if (e.target.closest('.student-badge.remove-enabled .remove-student')) {
                    const badge = e.target.closest('.student-badge');
                    const studentId = parseInt(badge.getAttribute('data-id'));
                    if (studentId && currentCollection) {
                        const studentName = badge.getAttribute('data-name');
                        Swal.fire({
                            title: 'Hapus akses?',
                            text: `Apakah Anda yakin ingin menghapus akses untuk siswa ${studentName}?`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Ya, Hapus',
                            cancelButtonText: 'Batal'
                        }).then(async (result) => {
                            if (result.isConfirmed) {
                                await removeStudentFromCollection(currentCollection.id, studentId);
                            }
                        });
                    }
                }


                if (e.target.closest('.btn-delete-question')) {
                    const btn = e.target.closest('.btn-delete-question');
                    const questionId = parseInt(btn.getAttribute('data-id'));

                    if (questionId && currentCollection) { // Pastikan currentCollection ada
                         handleDeleteQuestionFromCollection(questionId);
                    } else if (questionId) {
                         console.warn("Attempted to delete question but currentCollection is not set.");
                         // Optionally show error or disable button if currentCollection is null
                    }
                }

                if (e.target.closest('.btn-validate')) {
                    const btn = e.target.closest('.btn-validate');
                    const questionId = parseInt(btn.getAttribute('data-id'));
                    if (questionId) {
                        handleValidateQuestion(questionId);
                    }
                }
            });

            document.getElementById('addOption').addEventListener('click', addNewOption);

            document.getElementById('saveQuestionChanges').addEventListener('click', saveQuestionChanges);

            document.getElementById('validateQuestionModalBtn').addEventListener('click', () => {
                const questionIdInput = document.querySelector('#editQuestionForm [name="questionId"]');
                if (questionIdInput && questionIdInput.value) {
                    const questionId = parseInt(questionIdInput.value);
                    handleValidateQuestion(questionId);
                } else {
                     console.error("Cannot validate: Question ID not found in modal form.");
                }
            });


            document.getElementById('deleteQuestionBtn').addEventListener('click', () => {
                const questionIdInput = document.querySelector('#editQuestionForm [name="questionId"]');
                 if (questionIdInput && questionIdInput.value) {
                    const questionId = parseInt(questionIdInput.value);
                    handleDeleteQuestionFromModal(questionId);
                 } else {
                     console.error("Cannot delete: Question ID not found in modal form.");
                 }
            });

            // Inisialisasi tooltip
            initializeTooltips();

            // Add hover effects to buttons using proper event delegation
            document.addEventListener('mouseover', (e) => {
                const target = e.target;
                if (target && typeof target.matches === 'function' && target.matches('.btn')) {
                    target.style.transition = 'all 0.2s ease';
                }
            }, true);

            // Add keyboard navigation support
            document.addEventListener('keydown', (e) => {
                // Escape key to close modals or details
                if (e.key === 'Escape') {
                    const detailView = document.getElementById('collectionDetail');
                    if (detailView.style.display !== 'none') {
                        document.getElementById('closeCollectionBtn').click();
                    }
                }
            });

            // Add loading state to form submissions
            document.addEventListener('submit', (e) => {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    showButtonLoading(submitBtn);
                }
            });

            // Set up the description and validation event listeners when the detail view is loaded
        }

        // Function to start editing the collection description
        function startDetailEditing() {
            try {
                // Get description text
                const descriptionElement = document.getElementById('collectionDescription');
                if (!descriptionElement) {
                    throw new Error('Elemen deskripsi tidak ditemukan');
                }

                const descriptionText = descriptionElement.textContent.trim();

                // Set editor value
                const editorElement = document.getElementById('descriptionEditor');
                if (!editorElement) {
                    throw new Error('Elemen editor tidak ditemukan');
                }

                editorElement.value = descriptionText === 'Tidak ada deskripsi' ? '' : descriptionText;

                // Toggle containers
                const displayContainer = document.getElementById('descriptionDisplayContainer');
                const editContainer = document.getElementById('descriptionEditContainer');

                if (displayContainer) {
                    displayContainer.classList.add('d-none');
                } else {
                    console.warn('Display container not found');
                }

                if (editContainer) {
                    editContainer.classList.remove('d-none');
                } else {
                    console.warn('Edit container not found');
                }
            } catch (error) {
                console.error('Error starting description editing:', error);
                showError(`Gagal memulai edit deskripsi: ${error.message}`);
            }
        }

        // Function to save the edited description
        async function saveDetailDescription() {
            try {
                if (!currentCollection) {
                    throw new Error('Data koleksi tidak ditemukan');
                }

                // Find the editor element safely
                const editorElement = document.getElementById('descriptionEditor');
                if (!editorElement) {
                    throw new Error('Elemen editor deskripsi tidak ditemukan');
                }

                const newDescription = editorElement.value.trim();

                // Show loading indicator
                const saveBtn = document.getElementById('saveDescriptionBtn');
                if (saveBtn) {
                    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
                    saveBtn.disabled = true;
                }

                // Send the update to the server
                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(`${window.location.origin}/api/collections/${currentCollection.id}/description`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: newDescription
                    })
                });


                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Update the cached collection with the data from the server
                    currentCollection.description = result.collection.description;

                    // Flag to indicate that the collection data has been updated
                    // This will be used to determine if we need to reload the collections list
                    window.collectionDataUpdated = true;

                    // Update the displayed description
                    const descriptionElement = document.getElementById('collectionDescription');
                    if (descriptionElement) {
                        descriptionElement.textContent = currentCollection.description || 'Tidak ada deskripsi';
                    } else {
                        console.warn('Element collectionDescription not found');
                    }

                    // Exit edit mode
                    try {
                        const displayContainer = document.getElementById('descriptionDisplayContainer');
                        const editContainer = document.getElementById('descriptionEditContainer');

                        if (displayContainer) {
                            displayContainer.classList.remove('d-none');
                        }

                        if (editContainer) {
                            editContainer.classList.add('d-none');
                        }
                    } catch (e) {
                        console.warn('Error toggling display/edit containers:', e);
                    }

                    showSuccess('Deskripsi koleksi berhasil diperbarui');

                    // Also update any reference to this collection in the DOM
                    updateCollectionInList(currentCollection.id, currentCollection);
                } else {
                    throw new Error(result.message || 'Gagal memperbarui deskripsi');
                }
            } catch (error) {
                console.error('Error updating detail description:', error);
                showError(`Gagal memperbarui deskripsi: ${error.message}`);
            } finally {
                // Reset the save button
                const saveBtn = document.getElementById('saveDescriptionBtn');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="bi bi-save"></i> Simpan';
                    saveBtn.disabled = false;
                }
            }
        }

        // Function to cancel editing description
        function cancelDetailEditing() {
            try {
                const displayContainer = document.getElementById('descriptionDisplayContainer');
                const editContainer = document.getElementById('descriptionEditContainer');

                if (displayContainer) {
                    displayContainer.classList.remove('d-none');
                }

                if (editContainer) {
                    editContainer.classList.add('d-none');
                }
            } catch (error) {
                console.error('Error canceling description editing:', error);
                // No need to show error to user for cancel operation, just log it
            }
        }

        // Function to validate all questions in the current collection detail view
        async function validateAllQuestionsInDetail() {
            try {
                if (!currentCollection) {
                    throw new Error('Data koleksi tidak ditemukan');
                }

                // Display confirmation modal
                const { isConfirmed } = await Swal.fire({
                    title: 'Validasi Semua Soal?',
                    text: 'Apakah Anda yakin ingin memvalidasi semua soal dalam koleksi ini?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#198754', // Warna hijau
                    cancelButtonColor: '#6c757d', // Warna abu-abu
                    confirmButtonText: 'Ya, Validasi Semua',
                    cancelButtonText: 'Batal'
                });

                if (!isConfirmed) {
                    return;
                }

                // Show loading state
                const validateBtn = document.getElementById('validateAllQuestionsBtn');
                if (!validateBtn) {
                    console.error('Tombol validasi tidak ditemukan, mencoba melanjutkan tanpa UI feedback');
                    // Continue without UI feedback rather than failing completely
                }
                let originalBtnText = '';
                if (validateBtn) {
                    originalBtnText = validateBtn.innerHTML;
                    validateBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memvalidasi...`;
                    validateBtn.disabled = true;
                }

                // Use the new endpoint that validates all questions at once
                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(`${window.location.origin}/api/collections/${currentCollection.id}/validate-all`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });


                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    const validatedIds = result.validated || [];

                    // Update the local cache with validated questions
                    validatedIds.forEach(questionId => {
                        if (questionsCache[questionId]) {
                            questionsCache[questionId].is_validated = true;
                        }
                    });

                    // Re-render the questions with updated validation status and current filter
                    const currentFilter = document.getElementById('levelFilter').value;
                    renderQuestions(Object.values(questionsCache), currentFilter);

                    // Show success message
                    showSuccess(`Berhasil memvalidasi ${result.count || validatedIds.length} soal`);
                } else {
                    throw new Error(result.message || 'Gagal memvalidasi soal');
                }
            } catch (error) {
                console.error('Error validating all questions:', error);
                showError(`Gagal memvalidasi soal: ${error.message}`);
            } finally {
                // Restore button state
                const validateBtn = document.getElementById('validateAllQuestionsBtn');
                if (validateBtn) {
                    validateBtn.innerHTML = `<i class="bi bi-check-circle"></i> Validasi Semua Soal`;
                    validateBtn.disabled = false;
                }
            }
        }

        async function loadCollections() {
            try {
                const container = document.getElementById('collectionsContainer');
                container.innerHTML = `
                    <div class="col-12 text-center p-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Memuat koleksi...</p>
                    </div>
                `;

                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(getApiUrl('/api/collections'));

                if (!response.ok) {
                     // Log detail error
                     console.error(`Fetch error: ${response.status} ${response.statusText}`);
                     const errorText = await response.text();
                     console.error(`Response body: ${errorText}`);
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                const collectionsWithCount = await Promise.all(
                    result.collections.map(async col => {
                        try { // Tambahkan try-catch di dalam map
                             // PERBAIKAN: Gunakan URL lengkap
                            const countResponse = await fetch(getApiUrl(`/api/collections/${col.id}/student-count`));
                            const countData = await countResponse.json();
                            return { ...col, student_count: countData.success ? countData.count : 0 }; // Default ke 0 jika gagal
                        } catch (countError) {
                            console.error(`Gagal mengambil student count untuk koleksi ${col.id}:`, countError);
                            return { ...col, student_count: 0 }; // Default ke 0 jika gagal
                        }
                    })
                );


                if (result.success && collectionsWithCount) {
                    renderCollections(collectionsWithCount);
                    // Re-initialize tooltips after rendering
                    setTimeout(() => initializeTooltips(), 100);
                } else {
                    throw new Error(result.message || 'Gagal memuat koleksi');
                }
            } catch (error) {
                console.error('Error loading collections:', error);
                const container = document.getElementById('collectionsContainer');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Gagal memuat koleksi: ${error.message}
                            <button class="btn btn-outline-danger mt-2" onclick="loadCollections()">
                                <i class="bi bi-arrow-clockwise"></i> Coba Lagi
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Function to update a specific collection in the list without reloading everything
        function updateCollectionInList(collectionId, updatedCollection) {
            // Find the collection card in the DOM
            const collectionCard = document.querySelector(`.card[data-id="${collectionId}"]`);
            if (!collectionCard) {
                console.warn(`Collection card for ID ${collectionId} not found in the list`);
                return; // Card not found in the current view
            }

            // Update the description in the card
            const descriptionElement = collectionCard.querySelector('.card-text');
            if (descriptionElement) {
                descriptionElement.textContent = updatedCollection.description || 'Tidak ada deskripsi';
            }

            console.log(`Updated collection ${collectionId} in the list view`);
        }

        function renderCollections(collections) {
            const container = document.getElementById('collectionsContainer');

            if (!collections.length) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Belum ada koleksi soal.
                            <p class="mt-2">Klik tombol "Buat Baru" untuk membuat koleksi pertama Anda.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = collections.map((col, index) => `
                <div class="col">
                    <div class="card h-100 collection-card fade-in" data-id="${col.id}" style="animation-delay: ${index * 0.1}s">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title mb-0 text-primary fw-bold">${escapeHtml(col.name)}</h5>
                                <span class="badge bg-light text-dark border">
                                    <i class="bi bi-calendar-event me-1"></i>
                                    ${col.created_at ? new Date(col.created_at).toLocaleDateString('id-ID') : 'N/A'}
                                </span>
                            </div>
                            <p class="card-text text-muted mb-3 small">${escapeHtml(col.description) || 'Tidak ada deskripsi'}</p>
                            <div class="collection-stats mb-3">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="stat-item text-center p-2 bg-primary bg-opacity-10 rounded-3">
                                            <i class="bi bi-question-circle text-primary fs-5"></i>
                                            <div class="fw-bold text-primary">${col.question_count || 0}</div>
                                            <small class="text-muted">Soal</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-item text-center p-2 bg-success bg-opacity-10 rounded-3">
                                            <i class="bi bi-people text-success fs-5"></i>
                                            <div class="fw-bold text-success">${col.student_count || 0}</div>
                                            <small class="text-muted">Siswa</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="btn-group-modern">
                                <button class="btn btn-sm btn-outline-primary-modern view-collection-btn" data-id="${col.id}" title="Lihat Detail Koleksi">
                                    <i class="bi bi-eye"></i>
                                    <span class="d-none d-md-inline ms-1">Detail</span>
                                </button>
                                <a href="/collection-analytics/${col.id}" class="btn btn-sm btn-outline-info-modern" data-id="${col.id}" title="Analisis Koleksi">
                                    <i class="bi bi-graph-up"></i>
                                    <span class="d-none d-md-inline ms-1">Analisis</span>
                                </a>
                                <button class="btn btn-sm btn-outline-success-modern btn-validate-collection" data-id="${col.id}" title="Validasi Semua Soal">
                                    <i class="bi bi-check-circle"></i>
                                    <span class="d-none d-lg-inline ms-1">Validasi</span>
                                </button>
                                <button class="btn btn-sm btn-outline-danger-modern btn-delete-collection" data-id="${col.id}" title="Hapus Koleksi">
                                    <i class="bi bi-trash"></i>
                                    <span class="d-none d-lg-inline ms-1">Hapus</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        document.addEventListener('click', function(e) {
            if (e.target.closest('a[href^="/collection-analytics/"]')) {
                e.preventDefault();
                const link = e.target.closest('a[href^="/collection-analytics/"]');
                const collectionId = link.getAttribute('data-id');

                // Show loading animation on button
                showButtonLoading(link, link.innerHTML);

                // Add slight delay for better UX
                setTimeout(() => {
                    // PERBAIKAN: Gunakan URL lengkap
                    window.location.href = getApiUrl(`/collection-analytics/${collectionId}`);
                }, 300);
            }
        });

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }


        function showEditModal(question, versions) {
            const form = document.getElementById('editQuestionForm');
            const validateButtonModal = document.getElementById('validateQuestionModalBtn');

            form.questionId.value = question.id;
            form.soal.value = question.soal;
            form.explanation.value = question.explanation || '';
            form.p.value = question.p;
            form.version.value = question.version || '1';

            if (question.is_validated) {
                validateButtonModal.classList.add('btn-validated');
                validateButtonModal.classList.remove('btn-outline-info');
                validateButtonModal.innerHTML = '<i class="bi bi-check-circle-fill"></i> Tervalidasi';
            } else {
                validateButtonModal.classList.remove('btn-validated');
                validateButtonModal.classList.add('btn-outline-info');
                validateButtonModal.innerHTML = '<i class="bi bi-check-circle"></i> Validasi Soal';
            }

            const options = Array.isArray(question.options) ? question.options :
                            (typeof question.options === 'string' ? JSON.parse(question.options) : []);
            renderOptions(options);
            updateAnswerOptions(options, question.jawaban_benar);

            renderVersionHistory(versions);

            editQuestionModal.show();
        }

        function renderOptions(options) {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = options.map((opt, i) => `
                <div class="input-group option-input-group mb-2">
                    <span class="input-group-text">${String.fromCharCode(65 + i)}</span>
                    <input type="text" class="form-control" value="${escapeHtml(opt)}">
                    <button class="btn btn-outline-danger btn-remove-option" type="button" title="Hapus opsi">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            `).join('');
        }


        function updateAnswerOptions(options, correctAnswer) {
            const select = document.querySelector('[name="jawaban_benar"]');
            select.innerHTML = options.map((opt, i) => `
                <option value="${escapeHtml(opt)}" ${opt === correctAnswer ? 'selected' : ''}>
                    ${String.fromCharCode(65 + i)}. ${escapeHtml(opt)}
                </option>
            `).join('');
        }

        function renderVersionHistory(versions) {
            const container = document.getElementById('versionHistory');

            if (!versions || versions.length === 0) {
                container.innerHTML = '<div class="text-muted p-3">Belum ada riwayat perubahan</div>';
                return;
            }

            container.innerHTML = versions.map(v => `
                <button class="list-group-item list-group-item-action version-item" data-version='${JSON.stringify(v)}'>
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>Versi ${v.version}</strong>
                            <div class="text-muted small">${new Date(v.created_at).toLocaleString()}</div>
                        </div>
                        <i class="bi bi-eye"></i>
                    </div>
                    <div class="small text-truncate">${escapeHtml(v.soal).substring(0, 50)}...</div>
                </button>
            `).join('');
        }

        async function handlePreviewVersion(e) {
            const versionItem = e.target.closest('.version-item');
            if (!versionItem || !versionItem.dataset.version) {
                return;
            }

            try {
                const version = JSON.parse(versionItem.dataset.version);
                const currentQuestionIdInput = document.querySelector('[name="questionId"]');
                if (!currentQuestionIdInput || !currentQuestionIdInput.value) {
                     throw new Error("ID Soal saat ini tidak ditemukan");
                }
                const currentQuestionId = currentQuestionIdInput.value;
                const currentQuestion = questionsCache[currentQuestionId];


                if (!currentQuestion) {
                    throw new Error("Data soal saat ini tidak ditemukan");
                }

                const diffHtml = generateDiffHtml(currentQuestion, version);

                Swal.fire({
                    title: `Versi ${version.version}`,
                    html: `
                        <div class="text-start">
                            <div class="mb-3">
                                <small class="text-muted">${new Date(version.created_at).toLocaleString()}</small>
                            </div>
                            ${diffHtml}
                        </div>
                    `,
                    confirmButtonText: 'Tutup',
                    width: '800px'
                });
            } catch (error) {
                console.error('Error previewing version:', error);
                showError('Gagal menampilkan riwayat versi');
            }
        }

        function generateDiffHtml(current, oldVersion) {
            const fields = [
                { name: 'soal', label: 'Pertanyaan' },
                { name: 'options', label: 'Opsi Jawaban', format: v => {
                    let optionsArray = [];
                    if (Array.isArray(v)) {
                         optionsArray = v;
                    } else if (typeof v === 'string') {
                        try {
                             optionsArray = JSON.parse(v);
                             if (!Array.isArray(optionsArray)) optionsArray = [];
                        } catch(e) {
                             console.warn("Could not parse options string:", v);
                             optionsArray = [];
                        }
                    }
                    return optionsArray.join(' | ') || '-';
                }},
                { name: 'jawaban_benar', label: 'Jawaban Benar' },
                { name: 'explanation', label: 'Penjelasan' },
                { name: 'p', label: 'Tingkat Kesulitan' }
            ];

            return fields.map(({ name, label, format }) => {
                let currentVal = current[name];
                let oldVal = oldVersion[name];

                if (format) {
                    try {
                        currentVal = format(currentVal);
                        oldVal = format(oldVal);
                    } catch (e) {
                        console.error(`Error formatting ${name}:`, e);
                        currentVal = String(currentVal || '-');
                        oldVal = String(oldVal || '-');
                    }
                } else {
                    currentVal = String(currentVal || '-');
                    oldVal = String(oldVal || '-');
                }

                if (currentVal !== oldVal) {
                    return `
                        <div class="mb-3">
                            <h6 class="fw-bold">${label}</h6>
                            <div class="alert alert-danger p-2 mb-1">
                                <div class="diff-removed"><del>${escapeHtml(oldVal)}</del></div>
                            </div>
                            <div class="alert alert-success p-2">
                                <div class="diff-added">${escapeHtml(currentVal)}</div>
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }

        async function saveQuestionChanges() {
            const saveBtn = document.getElementById('saveQuestionChanges');
            const originalBtnText = saveBtn.innerHTML;

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<div class="loading-spinner me-2"></div> Menyimpan...';

                const form = document.getElementById('editQuestionForm');
                const questionIdInput = form.questionId;
                 if (!questionIdInput || !questionIdInput.value) {
                      throw new Error("ID Soal tidak ditemukan");
                 }
                const questionId = parseInt(questionIdInput.value);


                const updatedQuestion = {
                    soal: form.soal.value,
                    options: Array.from(document.querySelectorAll('#optionsContainer input')).map(i => i.value),
                    jawaban_benar: form.jawaban_benar.value,
                    explanation: form.explanation.value,
                    p: parseFloat(form.p.value)
                };

                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(getApiUrl(`/api/questions/${questionId}`), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedQuestion)
                });


                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Perbarui cache dengan data yang diperbarui dari server
                    if (questionsCache[questionId] && result.question) {
                         // Update cache dengan data baru dari respons server
                         questionsCache[questionId] = {
                              ...questionsCache[questionId], // Pertahankan data asli
                              soal: result.question.soal,
                              options: result.question.options, // Asumsi server mengembalikan array
                              jawaban_benar: result.question.jawaban_benar,
                              explanation: result.question.explanation,
                              p: result.question.p,
                              version: result.question.version // Penting untuk versi
                         };
                         // Update versi cache juga
                         if (versionsCache[questionId]) {
                              // Reload versions to reflect new current version and history
                              delete versionsCache[questionId];
                         }
                    } else {
                         console.warn("Cache tidak diperbarui karena data respons tidak lengkap");
                    }


                    showSuccess('Perubahan berhasil disimpan');
                    editQuestionModal.hide();

                    if (currentCollection && currentCollection.id) {
                        await loadCollectionDetail(currentCollection.id); // Reload detail
                    } else {
                         await loadCollections(); // Fallback jika tidak ada koleksi saat ini
                    }
                } else {
                    throw new Error(result.message || "Gagal menyimpan perubahan");
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                showError(`Gagal menyimpan perubahan: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtnText;
            }
        }

        function addNewOption() {
            const options = Array.from(document.querySelectorAll('#optionsContainer input'))
                            .map(i => i.value);
            options.push('Opsi Baru');
            renderOptions(options);
            updateAnswerOptions(options, document.querySelector('[name="jawaban_benar"]').value);
        }

        function removeOption(e) {
            const inputGroup = e.target.closest('.input-group');
            if (inputGroup) {
                inputGroup.remove();
                updateAnswerOptionsAfterRemoval();
            }
        }

        function updateAnswerOptionsAfterRemoval() {
            const options = Array.from(document.querySelectorAll('#optionsContainer input'))
                            .map(i => i.value);
            const currentAnswerSelect = document.querySelector('[name="jawaban_benar"]');
            const currentAnswerValue = currentAnswerSelect ? currentAnswerSelect.value : null;

            updateAnswerOptions(options, options.includes(currentAnswerValue) ? currentAnswerValue : (options.length > 0 ? options[0] : null));
        }

        function showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'Berhasil',
                text: message,
                timer: 3000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Gagal',
                text: message
            });
        }

        async function showCreateModal() {
            const { value: formData } = await Swal.fire({
                title: 'Buat Koleksi Baru',
                html: `
                    <input type="text" id="name" class="swal2-input" placeholder="Nama Koleksi" required>
                    <textarea id="description" class="swal2-textarea" placeholder="Deskripsi (opsional)"></textarea>
                    <div id="nameValidationMessage" style="color: #d32f2f; font-size: 0.8em; margin-top: 5px; display: none;"></div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                cancelButtonText: 'Batal',
                didOpen: () => {
                    // Add real-time validation for collection name
                    const nameInput = document.getElementById('name');
                    const validationMessage = document.getElementById('nameValidationMessage');
                    let validationTimeout;

                    nameInput.addEventListener('input', () => {
                        clearTimeout(validationTimeout);
                        validationMessage.style.display = 'none';

                        const name = nameInput.value.trim();
                        if (name.length > 2) {
                            validationTimeout = setTimeout(async () => {
                                try {
                                    // Check if name exists using API endpoint
                                    // PERBAIKAN: Gunakan URL lengkap
                                    const response = await fetch(getApiUrl('/api/collections/check-name'), {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ name: name })
                                    });

                                    if (response.ok) {
                                        const result = await response.json();
                                        if (result.success && result.exists) {
                                            validationMessage.textContent = `Koleksi dengan nama "${name}" sudah ada. Gunakan nama yang berbeda.`;
                                            validationMessage.style.display = 'block';
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error validating name:', error);
                                }
                            }, 500);
                        }
                    });
                },
                preConfirm: () => {
                    const name = document.getElementById('name').value;
                    const validationMessage = document.getElementById('nameValidationMessage');

                    if (!name.trim()) {
                        Swal.showValidationMessage('Nama koleksi harus diisi');
                        return false;
                    }

                    // Check if validation message is shown
                    if (validationMessage.style.display !== 'none' && validationMessage.textContent) {
                        Swal.showValidationMessage(validationMessage.textContent);
                        return false;
                    }

                    return {
                        name: name.trim(),
                        description: document.getElementById('description').value.trim()
                    }
                }
            });

            if (formData) {
                try {
                    // PERBAIKAN: Gunakan URL lengkap
                    const response = await fetch(getApiUrl('/api/collections'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccess('Koleksi berhasil dibuat');
                        await loadCollections();
                    } else {
                        // Handle validation error (like duplicate name)
                        throw new Error(result.message || 'Gagal membuat koleksi');
                    }
                }
                catch (error) {
                    console.error('Error creating collection:', error);
                    showError(`Gagal membuat koleksi: ${error.message}`);
                }
            }
        }

        async function handleDeleteCollection(collectionId) {
            const { isConfirmed } = await Swal.fire({
                title: 'Hapus Koleksi?',
                 text: "Menghapus koleksi akan menghapus hubungan soal dengan koleksi ini dan data terkait lainnya (seperti hasil siswa untuk koleksi ini). Soal itu sendiri mungkin tetap ada jika digunakan di koleksi lain. Aksi ini tidak dapat dibatalkan!", // Pesan lebih jelas
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus',
                cancelButtonText: 'Batal'
            });

            if (isConfirmed) {
                try {
                    // PERBAIKAN: Gunakan URL lengkap
                    const response = await fetch(getApiUrl(`/api/collections/${collectionId}`), {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! Status: ${response.status} - ${errorText}`); // Sertakan error text
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccess('Koleksi berhasil dihapus');
                        await loadCollections(); // Muat ulang daftar koleksi
                         // Jika detail sedang terbuka, tutup
                         if (currentCollection && currentCollection.id === parseInt(collectionId)) {
                              document.getElementById('collectionDetail').style.display = 'none';
                              document.getElementById('collectionsContainer').style.display = 'flex';
                              currentCollection = null; // Reset current collection
                         }
                    } else {
                        throw new Error(result.message || 'Gagal menghapus koleksi');
                    }
                } catch (error) {
                    console.error('Error deleting collection:', error);
                    showError(`Gagal menghapus koleksi: ${error.message}`);
                }
            }
        }

        async function loadCollectionDetail(collectionId) {
            try {
                // Reset the flag that tracks if collection data was updated
                window.collectionDataUpdated = false;

                const questionsContainer = document.getElementById('collectionQuestions');
                questionsContainer.innerHTML = `
                    <div class="col-12 text-center p-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Memuat detail koleksi...</p>
                    </div>
                `;

                document.getElementById('collectionsContainer').style.display = 'none';
                document.getElementById('collectionDetail').style.display = 'block';

                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(getApiUrl(`/api/collections/${collectionId}/questions`));

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Gagal memuat detail koleksi');
                }

                currentCollection = result.collection;
                document.getElementById('collectionTitle').textContent = currentCollection.name;

                // Reset description edit state
                document.getElementById('collectionDescription').textContent = currentCollection.description || 'Tidak ada deskripsi';
                document.getElementById('descriptionDisplayContainer').classList.remove('d-none');
                document.getElementById('descriptionEditContainer').classList.add('d-none');

                document.getElementById('questionCount').textContent = result.questions ? result.questions.length : 0;

                // Set up event listeners for the collection detail view
                const editDescBtn = document.getElementById('editDescriptionBtn');
                const saveDescBtn = document.getElementById('saveDescriptionBtn');
                const cancelDescBtn = document.getElementById('cancelDescriptionBtn');
                const validateAllBtn = document.getElementById('validateAllQuestionsBtn');

                // Remove previous listeners first
                const newEditBtn = editDescBtn.cloneNode(true);
                editDescBtn.parentNode.replaceChild(newEditBtn, editDescBtn);
                newEditBtn.addEventListener('click', startDetailEditing);

                const newSaveBtn = saveDescBtn.cloneNode(true);
                saveDescBtn.parentNode.replaceChild(newSaveBtn, saveDescBtn);
                newSaveBtn.addEventListener('click', saveDetailDescription);

                const newCancelBtn = cancelDescBtn.cloneNode(true);
                cancelDescBtn.parentNode.replaceChild(newCancelBtn, cancelDescBtn);
                newCancelBtn.addEventListener('click', cancelDetailEditing);

                const newValidateBtn = validateAllBtn.cloneNode(true);
                validateAllBtn.parentNode.replaceChild(newValidateBtn, validateAllBtn);
                newValidateBtn.addEventListener('click', validateAllQuestionsInDetail);


                if (result.questions && Array.isArray(result.questions)) {
                    questionsCache = {};
                    result.questions.forEach(question => {
                        question._collectionId = currentCollection.id;
                        questionsCache[question.id] = question;
                    });
                } else {
                     questionsCache = {}; // Reset cache if no questions
                }

                // Panggil loadAssignedStudents setelah questionsCache terisi
                await loadAssignedStudents(collectionId);

                // Reset stage filter to "all" when loading a new collection
                const stageFilter = document.getElementById('levelFilter');
                if (stageFilter) {
                    stageFilter.value = 'all';
                }

                // Render questions with the default filter (all levels)
                renderQuestions(Object.values(questionsCache), 'all');

                 // Smooth scroll to the detail view
                 smoothScrollTo(document.getElementById('collectionDetail'));

            } catch (error) {
                console.error('Error loading collection detail:', error);

                const questionsContainer = document.getElementById('collectionQuestions');
                questionsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Gagal memuat detail koleksi: ${error.message}
                            <button class="btn btn-outline-danger mt-2" onclick="loadCollectionDetail('${collectionId}')">
                                <i class="bi bi-arrow-clockwise"></i> Coba Lagi
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        async function loadAssignedStudents(collectionId) {
            try {
                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(getApiUrl(`/api/collections/${collectionId}/students`));

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    assignedStudentsCache = result.students || [];
                    document.getElementById('studentCount').textContent = assignedStudentsCache.length;
                    renderAssignedStudentBadges(assignedStudentsCache);
                } else {
                    throw new Error(result.message || 'Gagal memuat daftar siswa yang ditugaskan');
                }
            } catch (error) {
                console.error('Error loading assigned students:', error);
                document.getElementById('assignedStudentBadges').innerHTML = `
                    <span class="badge bg-danger">Error: ${error.message}</span>
                `;
            }
        }

        function renderAssignedStudentBadges(students) {
            const container = document.getElementById('assignedStudentBadges');

            if (!students || students.length === 0) {
                container.innerHTML = `
                    <span class="text-muted small">Belum ada siswa yang dipilih</span>
                `;
                return;
            }

            container.innerHTML = students.map(student => `
                <span class="badge bg-light text-dark border student-badge remove-enabled"
                        data-id="${student.id}"
                        data-name="${escapeHtml(student.nama)}" title="Klik untuk menghapus">
                    ${escapeHtml(student.nama)}
                    <i class="bi bi-x-circle ms-1 text-danger remove-student" style="cursor: pointer;"></i>
                </span>
            `).join('');
        }


        async function showManageStudentsModal() {
            // Reset input pencarian
            document.getElementById('assignedStudentSearch').value = '';

            // Clear and show loading for assigned students
            document.getElementById('assignedStudents').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Memuat siswa...</p>
                </div>
            `;

            manageStudentsModal.show();

            try {
                // Load assigned students (always reload to ensure latest status)
                await loadAssignedStudents(currentCollection.id);

                // Render assigned students (always show updated list)
                renderAssignedStudentList(assignedStudentsCache);

            } catch (error) {
                console.error('Error loading students for management:', error);
                showError(`Gagal memuat data siswa untuk manajemen: ${error.message}`);
            }
        }

        function renderAssignedStudentList(students) {
            const container = document.getElementById('assignedStudents');

            if (!students || students.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-people" style="font-size: 2rem;"></i>
                        <p class="mt-2">Belum ada siswa yang dipilih</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = students.map(student => `
                <div class="list-group-item d-flex justify-content-between align-items-center student-item">
                    <div>
                        <strong>${escapeHtml(student.nama)}</strong>
                        <div class="text-muted small">${escapeHtml(student.kelas || '-')}</div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-student-btn" data-id="${student.id}">
                        <i class="bi bi-trash"></i> Hapus
                    </button>
                </div>
            `).join('');
        }

        async function addStudentsByClass(collectionId, className) {
            const addBtn = document.getElementById('addStudentsByClassBtn');
            const originalBtnText = addBtn.innerHTML;
            try {
                addBtn.disabled = true;
                addBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menambahkan...';

                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(getApiUrl(`/api/collections/${collectionId}/add_students_by_class`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_name: className })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status} - ${errorText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showSuccess(result.message);
                    // Reload assigned students to reflect changes
                    await loadAssignedStudents(collectionId); // Reload assignedStudentsCache
                    // Update global student count on collection card (jika ada)
                    const countBadgeCard = document.querySelector(`.card[data-id="${collectionId}"] .stat-item:nth-child(2) .fw-bold`);
                    if(countBadgeCard) countBadgeCard.textContent = assignedStudentsCache.length;
                    // Update student count in detail view
                    document.getElementById('studentCount').textContent = assignedStudentsCache.length;

                    // Re-render assigned student list in modal (using updated assignedStudentsCache)
                    renderAssignedStudentList(assignedStudentsCache);
                } else {
                    throw new Error(result.message || 'Gagal menambahkan siswa berdasarkan kelas');
                }
            } catch (error) {
                console.error('Error adding students by class:', error);
                showError(`Gagal menambahkan siswa: ${error.message}`);
            } finally {
                addBtn.disabled = false;
                addBtn.innerHTML = originalBtnText; // Kembalikan teks asli
            }
        }


        async function removeStudentFromCollection(collectionId, studentId) {
            try {
                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(getApiUrl(`/api/collections/${collectionId}/students/${studentId}`), {
                    method: 'DELETE'
                });


                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    assignedStudentsCache = assignedStudentsCache.filter(s => s.id != studentId);

                    document.getElementById('studentCount').textContent = assignedStudentsCache.length;
                    renderAssignedStudentBadges(assignedStudentsCache);

                    if (document.getElementById('manageStudentsModal').classList.contains('show')) {
                        renderAssignedStudentList(assignedStudentsCache);
                    }

                    showSuccess('Siswa berhasil dihapus dari koleksi');

                    // Update count on main card if visible
                    const countBadgeCard = document.querySelector(`.card[data-id="${collectionId}"] .stat-item:nth-child(2) .fw-bold`);
                    if(countBadgeCard) countBadgeCard.textContent = assignedStudentsCache.length;


                } else {
                    throw new Error(result.message || 'Gagal menghapus siswa');
                }
            } catch (error) {
                console.error('Error removing student:', error);
                showError(`Gagal menghapus siswa: ${error.message}`);
            }
        }

        // filterAssignedStudentList now only applies to assigned students list
        function filterAssignedStudentList(searchText) {
            const container = document.getElementById('assignedStudents');

            if (!searchText) {
                renderAssignedStudentList(assignedStudentsCache); // Use the full assigned cache
                return;
            }

            const searchLower = searchText.toLowerCase();
            const filtered = assignedStudentsCache.filter(student =>
                student.nama.toLowerCase().includes(searchLower) ||
                (student.kelas && student.kelas.toLowerCase().includes(searchLower))
            );

            renderAssignedStudentList(filtered);
        }

        function renderQuestions(questions, stageFilter = 'all') {
            const container = document.getElementById('collectionQuestions');
            const countFilteredElement = document.getElementById('questionCountFiltered');

            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Belum ada soal dalam koleksi ini
                        </div>
                    </div>
                `;
                countFilteredElement.textContent = "0 soal";
                return;
            }

            // Filter questions by stage if a specific stage is selected
            let filteredQuestions = questions;
            if (stageFilter !== 'all') {
                filteredQuestions = questions.filter(q => {
                    // Function to get stage, prioritizing technology_level
                    const getStage = (q) => {
                        if (q.technology_level && q.technology_level >= 1 && q.technology_level <= 5) {
                            return `L${q.technology_level}`;
                        }
                        // Fallback to old level mapping if technology_level is missing/invalid
                        const level = q.level || 1;
                        return levelToStageMapping[level] || 'L1';
                    };
                    return getStage(q) === stageFilter;
                });
            }


            // Update the filtered count badge
            countFilteredElement.textContent = `${filteredQuestions.length} soal${stageFilter !== 'all' ? ' (difilter)' : ''}`;

            if (filteredQuestions.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Tidak ada soal dengan stage ${stageFilter}
                        </div>
                    </div>
                `;
                return;
            }

            // Sort questions by stage/level
            const sortedQuestions = [...filteredQuestions].sort((a, b) => {
                // Function to get stage for sorting, prioritizing technology_level
                const getStageSortValue = (q) => {
                    if (q.technology_level && q.technology_level >= 1 && q.technology_level <= 5) {
                         return q.technology_level;
                    }
                    const level = q.level || 1;
                    const stage = levelToStageMapping[level] || 'L1';
                    return parseInt(stage.substring(1)); // Extract number from L1, L2, etc.
                };

                const aStageVal = getStageSortValue(a);
                const bStageVal = getStageSortValue(b);

                if (aStageVal !== bStageVal) {
                    return aStageVal - bStageVal;
                }
                // Jika stage sama, urutkan berdasarkan ID
                return a.id - b.id;
            });


            // Add a sequential number to each question (starting from 1)
            container.innerHTML = sortedQuestions.map((q, i) => renderQuestionCard(q, i)).join('');
            // Reinitialize tooltips after rendering questions
            setTimeout(() => initializeTooltips(), 100);
        }


        function renderQuestionCard(question, index) {
            const options = Array.isArray(question.options) ? question.options :
                           (typeof question.options === 'string' ? JSON.parse(question.options) : []);
            const difficulty = calculateDifficulty(question.p); // Kalkulasi berdasarkan p tetap bisa digunakan

            // Determine stage - PRIORITASKAN technology_level (1-5)
            let currentStage, stageInfo;
            if (question.technology_level && question.technology_level >= 1 && question.technology_level <= 5 && stageExplanations[`L${question.technology_level}`]) {
                currentStage = `L${question.technology_level}`;
                stageInfo = stageExplanations[currentStage];
            } else {
                // Fallback to old level system mapping jika technology_level tidak valid atau tidak ada
                const level = question.level || 1;
                currentStage = levelToStageMapping[level] || 'L1';
                stageInfo = stageExplanations[currentStage];
                 // Tambahkan peringatan jika fallback digunakan
                 console.warn(`Question ID ${question.id}: Using fallback mapping for level ${level} -> ${currentStage}. technology_level is ${question.technology_level}`);
            }

            const isQuestionValidated = question.is_validated;

            const validateButtonClass = isQuestionValidated ? 'btn-validated' : 'btn-outline-secondary';
            const validateButtonIcon = isQuestionValidated ? 'bi-check-circle-fill' : 'bi-check-circle';
            const validateButtonText = isQuestionValidated ? 'Tervalidasi' : 'Validasi';

            return `
                <div class="col-12">
                    <div class="card question-card shadow-sm" data-id="${question.id}" data-validated="${isQuestionValidated}">
                        <div class="card-body">
                            <div class="question-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                                <div class="d-flex flex-wrap gap-2 align-items-center mb-2 mb-sm-0">
                                    <span class="badge stage-${currentStage}"
                                          data-bs-toggle="tooltip"
                                          title="${stageInfo.title} - ${stageInfo.competency}">
                                        ${currentStage}: <span class="d-none d-sm-inline">${stageInfo.name}</span>
                                    </span>
                                    <span class="badge ${difficulty.class}">${difficulty.text}</span>
                                </div>
                                <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
                                    <button class="btn btn-sm ${validateButtonClass} btn-validate" data-id="${question.id}">
                                        <i class="bi ${validateButtonIcon}"></i> <span class="d-none d-sm-inline">${validateButtonText}</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger btn-delete-question" data-id="${question.id}">
                                        <i class="bi bi-trash"></i> <span class="d-none d-sm-inline">Hapus</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary btn-revisi" data-id="${question.id}">
                                        <i class="bi bi-pencil"></i> <span class="d-none d-sm-inline">Revisi</span>
                                    </button>
                                </div>
                            </div>

                            <div class="d-flex align-items-start gap-2 mt-3">
                                <span class="question-number badge bg-primary rounded-pill align-self-start mt-1">${index + 1}</span>
                                <h5 class="question-text flex-grow-1">${escapeHtml(question.soal)}</h5>
                            </div>

                            <div class="options-container mt-2 d-flex flex-wrap gap-1">
                                ${options.map((opt, i) => `
                                    <span class="option-badge ${opt === question.jawaban_benar ? 'correct-answer' : ''}">
                                        ${String.fromCharCode(65 + i)}. ${escapeHtml(opt)}
                                        ${opt === question.jawaban_benar ? '<i class="bi bi-check2 ms-1"></i>' : ''}
                                    </span>
                                `).join('')}
                            </div>

                            ${question.explanation ? `
                                <div class="explanation mt-3">
                                    <p class="text-muted small mb-0"><strong>Penjelasan:</strong> ${escapeHtml(question.explanation)}</p>
                                </div>
                            ` : ''}

                            <div class="mt-2 text-muted small competency-info">
                                <i class="bi bi-info-circle"></i> <strong>Kompetensi:</strong> <span class="competency-text">${stageInfo.competency}</span>
                            </div>

                            <div class="mt-1 text-muted small">
                                <i class="bi bi-lightbulb"></i> <strong>Contoh:</strong> <span class="example-text">${stageInfo.example}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateDifficulty(p) {
            if (p === null || p === undefined) return { class: 'bg-secondary', text: 'N/A' };
            if (p >= 0.75) return { class: 'bg-success', text: 'Mudah' }; // Sesuai mapping p_value_to_difficulty
            if (p >= 0.45) return { class: 'bg-warning text-dark', text: 'Sedang' };
            return { class: 'bg-danger', text: 'Sulit' };
        }


        async function fetchVersions(id) {
            if (versionsCache[id] && versionsCache[id].length > 0) {
                return versionsCache[id];
            }

            try {
                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(getApiUrl(`/api/questions/${id}/versions`));

                if (!response.ok) {
                    if (response.status === 404) {
                        return [];
                    }
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                const versions = result.versions || [];

                versionsCache[id] = versions;

                return versions;
            } catch (error) {
                console.error('Error fetching versions:', error);
                return [];
            }
        }

        async function handleValidateQuestion(questionId) {
            const questionData = questionsCache[questionId];
            if (!questionData) {
                showError("Data soal tidak ditemukan dalam cache untuk validasi.");
                return;
            }

            const isCurrentlyValidated = questionData.is_validated;
            const newValidationStatus = !isCurrentlyValidated;

            try {
                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(getApiUrl(`/api/questions/${questionId}/set_validation`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_validated: newValidationStatus })
                });


                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error server: ${response.status} - ${errorText}`);
                }


                const result = await response.json();

                if (result.success) {
                    showSuccess(`Soal ID ${questionId} berhasil ${newValidationStatus ? 'divalidasi' : 'dibatalkan validasinya'}.`);
                    questionsCache[questionId].is_validated = newValidationStatus;

                    const questionCardElement = document.querySelector(`.question-card[data-id="${questionId}"]`);
                    if (questionCardElement) {
                        questionCardElement.dataset.validated = newValidationStatus;
                    }
                    updateValidationButtons(questionId, newValidationStatus);

                } else {
                    throw new Error(result.message || 'Gagal mengubah status validasi.');
                }

            } catch (error) {
                console.error('Error validating question:', error);
                showError(`Gagal mengubah status validasi: ${error.message}`);
            }
        }

        // Function to show description edit form (not used in this version)
        function showDescriptionEditForm(collectionId) {
            console.log("Show description edit form called for", collectionId);
            // Implementation removed as it's handled in loadCollectionDetail now
        }

        // Function to hide description edit form (not used in this version)
        function hideDescriptionEditForm(collectionId) {
            console.log("Hide description edit form called for", collectionId);
             // Implementation removed as it's handled in loadCollectionDetail now
        }

        // Function to save description (not used in this version)
        async function saveDescription(collectionId) {
            console.log("Save description called for", collectionId);
            // Implementation removed as it's handled in loadCollectionDetail now
        }


        // Function to initialize tooltips
        function initializeTooltips() {
            // Dispose existing tooltips first
            const existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            existingTooltips.forEach(element => {
                const tooltip = bootstrap.Tooltip.getInstance(element);
                if (tooltip) {
                    tooltip.dispose();
                }
            });

            // Initialize new tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title], [data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                // Ensure the element is still in the DOM before initializing
                if (document.body.contains(tooltipTriggerEl)) {
                    return new bootstrap.Tooltip(tooltipTriggerEl, {
                        placement: 'top',
                        trigger: 'hover',
                        delay: { show: 500, hide: 100 }
                    });
                }
                return null; // Return null if element is not in DOM
            }).filter(Boolean); // Filter out null values
        }


        // Function to open collection analysis page
        function openCollectionAnalysis() {
            if (currentCollection && currentCollection.id) {
                // PERBAIKAN: Gunakan URL lengkap
                window.location.href = getApiUrl(`/collection-analytics/${currentCollection.id}`);
            } else {
                showError('Data koleksi tidak tersedia untuk analisis');
            }
        }

        // Function to validate all questions in a collection
        async function validateAllQuestions(collectionId) {
            // Ask for confirmation first
            const { isConfirmed } = await Swal.fire({
                title: 'Validasi Semua Soal?',
                text: 'Semua soal dalam koleksi ini akan ditandai sebagai tervalidasi. Lanjutkan?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Ya, Validasi Semua',
                cancelButtonText: 'Batal'
            });

            if (!isConfirmed) return;

            try {
                // Show loading
                const btn = document.querySelector(`.btn-validate-collection[data-id="${collectionId}"]`);
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span class="loading-spinner"></span> Validasi';
                btn.disabled = true;


                // Send validation request to server
                // PERBAIKAN: Gunakan URL lengkap
                const response = await fetch(getApiUrl(`/api/collections/${collectionId}/validate-all`), {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Update UI to show all questions validated
                     const validatedCount = result.count || 0; // Use 'count' from response

                    // Show success message
                    showSuccess(`${validatedCount} soal berhasil divalidasi`);

                    // If we're currently viewing this collection's questions, update the UI
                    if (currentCollection && currentCollection.id === parseInt(collectionId)) {
                        // Mark all question cards as validated
                         // Update cache first
                         if (result.validated && Array.isArray(result.validated)) {
                              result.validated.forEach(id => {
                                   if (questionsCache[id]) {
                                        questionsCache[id].is_validated = true;
                                   }
                              });
                         }
                         // Re-render based on updated cache
                         const currentFilter = document.getElementById('levelFilter').value;
                         renderQuestions(Object.values(questionsCache), currentFilter);
                    }
                } else {
                    throw new Error(result.message || 'Gagal memvalidasi semua soal');
                }
            } catch (error) {
                console.error('Error validating all questions:', error);
                showError(`Gagal validasi: ${error.message}`);
            } finally {
                // Reset button state
                const btn = document.querySelector(`.btn-validate-collection[data-id="${collectionId}"]`);
                if (btn) {
                    btn.innerHTML = '<i class="bi bi-check-circle"></i><span class="d-none d-lg-inline ms-1">Validasi</span>'; // Reset text
                    btn.disabled = false;
                }
            }
        }


        function updateValidationButtons(questionId, isValidated) {
            const questionCardElement = document.querySelector(`.question-card[data-id="${questionId}"]`);
            const validateButtonCard = questionCardElement ? questionCardElement.querySelector('.btn-validate') : null;
            const validateButtonModal = document.getElementById('validateQuestionModalBtn');

            // Use btn-validated for validated state, btn-outline-secondary for not validated
            const buttonCardClass = isValidated ? 'btn-validated' : 'btn-outline-secondary';
            // Use btn-validated for modal too, but maintain outline style for non-validated
            const buttonModalClass = isValidated ? 'btn-validated' : 'btn-outline-info';
            const buttonIcon = isValidated ? 'bi-check-circle-fill' : 'bi-check-circle';
            const buttonTextCard = isValidated ? 'Tervalidasi' : 'Validasi';
            const buttonTextModal = isValidated ? 'Tervalidasi' : 'Validasi Soal';

            if (validateButtonCard) {
                validateButtonCard.classList.remove('btn-validated', 'btn-outline-secondary');
                validateButtonCard.classList.add(buttonCardClass);
                validateButtonCard.innerHTML = `<i class="bi ${buttonIcon}"></i> <span class="d-none d-sm-inline">${buttonTextCard}</span>`;
            }
            if (validateButtonModal) {
                 // Update modal button classes and text
                 validateButtonModal.classList.remove('btn-validated', 'btn-outline-info', 'btn-outline-secondary'); // Remove all possibilities
                 validateButtonModal.classList.add(buttonModalClass); // Add the correct one
                 validateButtonModal.innerHTML = `<i class="bi ${buttonIcon}"></i> <span class="d-none d-sm-inline">${buttonTextModal}</span><span class="d-inline d-sm-none">${isValidated ? 'Validated' : 'Validate'}</span>`;
            }
        }


        async function handleDeleteQuestionFromCollection(questionId) {
            const question = questionsCache[questionId];
            if (!question || !currentCollection) { // Pastikan currentCollection ada
                 showError('Soal atau data koleksi tidak ditemukan');
                 return;
             }


            const { isConfirmed } = await Swal.fire({
                title: 'Hapus Soal Ini?',
                html: `
                    <p>Soal ini akan dihapus dari koleksi <strong>"${escapeHtml(currentCollection.name)}"</strong>.</p>
                    <p class="text-danger small">Jika soal ini tidak ada di koleksi lain & belum pernah dijawab siswa, soal akan dihapus permanen. Jika sudah dijawab, soal hanya akan diarsipkan.</p>
                    <p class="fw-bold text-danger">Aksi ini tidak dapat dibatalkan!</p>
                `, // Pesan diperjelas
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus Sekarang',
                cancelButtonText: 'Batal'
            });

            if (isConfirmed) {
                try {
                    // PERBAIKAN: Gunakan URL lengkap
                    const response = await fetch(getApiUrl(`/api/collections/${currentCollection.id}/questions/${questionId}`), {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });


                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error server: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccess(result.message || 'Soal berhasil dihapus.');

                        // Hapus soal dari cache
                        delete questionsCache[questionId];

                        // Re-render questions dengan filter yang sedang aktif
                        const currentFilter = document.getElementById('levelFilter').value;
                        renderQuestions(Object.values(questionsCache), currentFilter);

                        // Update jumlah soal di info koleksi
                        document.getElementById('questionCount').textContent = Object.keys(questionsCache).length;

                    } else {
                        throw new Error(result.message || 'Gagal menghapus soal.');
                    }
                } catch (error) {
                    console.error('Error deleting question:', error);
                    showError(`Gagal menghapus soal: ${error.message}`);
                }
            }
        }

        async function handleDeleteQuestionFromModal(questionId) {
             if (!currentCollection) {
                  showError("Tidak dapat menghapus soal: data koleksi tidak ditemukan.");
                  return;
             }

            const { isConfirmed } = await Swal.fire({
                title: 'Hapus Soal Ini?',
                html: `
                    <p>Soal ini akan dihapus dari koleksi <strong>"${escapeHtml(currentCollection.name)}"</strong>.</p>
                    <p class="text-danger small">Jika soal ini tidak ada di koleksi lain & belum pernah dijawab siswa, soal akan dihapus permanen. Jika sudah dijawab, soal hanya akan diarsipkan.</p>
                    <p class="fw-bold text-danger">Aksi ini tidak dapat dibatalkan!</p>
                `, // Pesan diperjelas
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus Sekarang',
                cancelButtonText: 'Batal'
            });

            if (isConfirmed) {
                try {
                    editQuestionModal.hide();

                    // PERBAIKAN: Gunakan URL lengkap
                    const removeResponse = await fetch(getApiUrl(`/api/collections/${currentCollection.id}/questions/${questionId}`), {
                        method: 'DELETE'
                    });

                    if (!removeResponse.ok) {
                        const errorText = await removeResponse.text();
                        throw new Error(`Error server saat menghapus dari koleksi: ${removeResponse.status} - ${errorText}`);
                    }

                    const removeResult = await removeResponse.json();

                    if (removeResult.success) {
                        showSuccess(removeResult.message || 'Soal berhasil dihapus.');

                        delete questionsCache[questionId];

                        if (currentCollection && currentCollection.id) {
                            await loadCollectionDetail(currentCollection.id); // Reload detail
                        } else {
                            await loadCollections(); // Fallback jika tidak ada koleksi saat ini
                        }

                    } else {
                        throw new Error(removeResult.message || 'Gagal menghapus soal.');
                    }
                } catch (error) {
                    console.error('Error deleting question:', error);
                    showError(`Gagal menghapus soal: ${error.message}`);
                }
            }
        }
    </script>
</body>
</html>


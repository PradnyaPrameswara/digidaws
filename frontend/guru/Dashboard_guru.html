<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="user-id" content="{{ current_user.id if current_user.is_authenticated else '' }}">
    <title>Guru - Generate Soal Pilihan Ganda</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        /* Styles untuk tampilan umum */
        .option-badge {
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 5px;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .correct-answer {
            font-weight: bold;
            background-color: #d1e7dd;
            border: 1px solid #badbcc;
            color: #0f5132;
        }

        .question-card {
            border-left: 4px solid #0d6efd;
            margin-bottom: 15px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .question-info {
            display: flex;
            gap: 10px;
        }

        /* 5 Level Taksonomi Teknologi MST Adaptive */
        .badge.level-1, span.badge.level-1, .progress-bar.level-1 {
            background-color: #1976d2 !important; /* Level 1: Awareness - Blue */
            color: white !important;
        }

        .badge.level-2, span.badge.level-2, .progress-bar.level-2 {
            background-color: #7b1fa2 !important; /* Level 2: Literacy - Purple */
            color: white !important;
        }

        .badge.level-3, span.badge.level-3, .progress-bar.level-3 {
            background-color: #388e3c !important; /* Level 3: Capability - Green */
            color: white !important;
        }

        .badge.level-4, span.badge.level-4, .progress-bar.level-4 {
            background-color: #f57c00 !important; /* Level 4: Creativity - Orange */
            color: white !important;
        }

        .badge.level-5, span.badge.level-5, .progress-bar.level-5 {
            background-color: #d32f2f !important; /* Level 5: Criticism - Red */
            color: white !important;
        }

        /* Difficulty badges for MST */
        .badge.difficulty-easy { background-color: #28a745 !important; color: white !important; }
        .badge.difficulty-medium { background-color: #ffc107 !important; color: black !important; }
        .badge.difficulty-hard { background-color: #dc3545 !important; color: white !important; }

        /* Navbar styles */
        .navbar {
            background-color: #0d6efd;
        }

        .navbar-brand {
            font-weight: bold;
        }
        .navbar-brand .brand-logo {
            height: 28px;
            width: auto;
            margin-right: 8px;
            vertical-align: middle;
        }
        /* Non-clickable brand */
        .navbar-brand-disabled {
            pointer-events: none;
            cursor: default;
            text-decoration: none;
            color: #fff !important;
        }

        /* Active link styling in navbar (white indicator) */
        .navbar .nav-link {
            color: rgba(255,255,255,0.85);
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .navbar .nav-link:hover,
        .navbar .nav-link.active {
            color: #fff !important;
            background-color: rgba(255,255,255,0.12);
        }

        .user-info {
            color: white;
            margin-right: 15px;
        }

        /* File transfer loading animation */
        .file-transfer-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .transfer-icon {
            font-size: 2rem;
            color: #007bff;
            margin-right: 15px;
            animation: pulse 2s infinite;
        }

        .transfer-progress {
            flex: 1;
            margin-right: 15px;
        }

        .transfer-status {
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
        }

        .progress {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-animated {
            background: linear-gradient(45deg, 
                rgba(0,123,255,0.6) 25%, 
                rgba(0,123,255,1) 25%, 
                rgba(0,123,255,1) 50%, 
                rgba(0,123,255,0.6) 50%, 
                rgba(0,123,255,0.6) 75%, 
                rgba(0,123,255,1) 75%);
            background-size: 30px 30px;
            animation: progress-slide 1.5s linear infinite;
        }

        @keyframes progress-slide {
            0% { background-position: 0 0; }
            100% { background-position: 30px 0; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .transfer-steps {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .transfer-steps li {
            padding: 5px 0;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .transfer-steps li.active {
            color: #007bff;
            font-weight: 500;
        }

        .transfer-steps li.completed {
            color: #28a745;
        }

        .transfer-steps li i {
            margin-right: 8px;
            width: 16px;
        }

        /* Style untuk soal dalam collection */
        .in-collection {
            border-left: 4px solid #28a745 !important;
            background-color: rgba(40, 167, 69, 0.05);
        }

        .collection-badge {
            position: absolute;
            top: 0;
            right: 0;
            padding: 0.25rem 0.5rem;
            border-bottom-left-radius: 0.25rem; 
            background-color: #28a745;
            color: white;
            font-size: 0.75rem;
        }
        .modal-body .guide-step { display: none; }
        .modal-body .guide-step.active { display: block; }
        .progress-bar { transition: width 0.4s ease; }

        /* Custom styling for taxonomy modal */
        .custom-taxonomy-popup {
            border-radius: 15px !important;
            overflow: hidden;
        }
        
        .custom-taxonomy-title {
            background: linear-gradient(135deg, #0d6efd, #6610f2) !important;
            color: white !important;
            padding: 20px !important;
            margin: 0 !important;
            border-radius: 0 !important;
        }
        
        .custom-taxonomy-content {
            padding: 20px !important;
        }
        
        .level-card {
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        .level-card:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
        }
        
        .level-taxonomy-icon {
            transition: all 0.3s ease;
        }
        
        .level-card:hover .level-taxonomy-icon {
            transform: scale(1.1);
        }
        
        /* Enhanced progress bars */
        .taxonomy-progress {
            background-color: rgba(0,0,0,0.1) !important;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .taxonomy-progress .progress-bar {
            transition: width 0.8s ease-in-out !important;
            border-radius: 10px;
        }
        
        /* Level badge styling */
        .level-badge-interactive {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .level-badge-interactive:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Enhanced chart card styling */
        .level-chart-card .card-body h5 {
            font-size: 1.1rem !important;
            font-weight: 600 !important;
        }
        
        .level-chart-card .card-body p {
            font-size: 0.95rem !important;
            font-weight: bold !important;
        }
        
        .level-chart-card .card-body i {
            transition: transform 0.3s ease;
        }
        
        .level-chart-card:hover .card-body i {
            transform: scale(1.1);
        }
        
        .level-badge-interactive::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .level-badge-interactive:hover::before {
            opacity: 1;
        }

        /* Animate.css fallback if not loaded */
        .animate__animated {
            animation-duration: 0.5s;
            animation-fill-mode: both;
        }
        
        .animate__fadeInUp {
            animation-name: fadeInUp;
        }
        
        .animate__fadeOutDown {
            animation-name: fadeOutDown;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 40px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        
        @keyframes fadeOutDown {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                transform: translate3d(0, 40px, 0);
            }
        }
        
        /* Scroll-to-top floating button */
        .scroll-top-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: none;
            z-index: 1050;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            padding: 0;
        }
        .scroll-top-btn.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scroll-top-btn i {
            font-size: 1.25rem;
        }

        /* Modern table styling for statistics */
        .table-modern {
            border-radius: 0.5rem;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .table-modern thead.table-light th {
            background-color: #f8f9fa !important;
            color: #212529 !important;
            border-bottom: 1px solid #e9ecef !important;
        }
        .table-modern tbody tr:hover {
            background-color: rgba(13,110,253,0.05);
        }
        .table-modern tbody tr {
            border-top: 1px solid #e9ecef;
        }
        .table-modern tbody tr:first-child {
            border-top: none;
        }
        .table-modern tfoot tr,
        .table-modern tbody tr.table-primary {
            border-top: 2px solid #cfe2ff;
        }
        .level-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        /* Helper column to fit 5 cards per row on large screens */
        @media (min-width: 992px) {
            .col-lg-20p { flex: 0 0 20%; max-width: 20%; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark main-navbar">
        <div class="container">
            <span class="navbar-brand navbar-brand-disabled" title="DIGIDAWS = DIagnostik cerdas Guru untuk Identifikasi Deteksi Awal kemampuan siswa dan Wawasan Sistematis">
                <img src="/img/logo_digidaws.png" alt="Logo DIGIDAWS" class="brand-logo">DIGIDAWS
            </span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/guru" id="nav-dashboard">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/guru/collections" id="nav-collections">
                            <i class="bi bi-journal-bookmark"></i> Koleksi Soal
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/guru/panduan" id="nav-guide">
                            <i class="bi bi-question-circle"></i> Panduan
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="user-info">
                        <i class="bi bi-person-circle"></i> {{ current_user.nama }} (Guru)
                    </span>
                    <a href="/logout" class="btn btn-outline-light">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>


    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-body text-center">
                        <h1 class="mb-3"><i class="bi bi-diagram-3"></i> Pembuatan Soal Diagnostik Menggunakan AI</h1>
                        <p class="text-muted">Unggah Modul Ajar, lalu sistem AI menghasilkan soal pilihan ganda berlabel Level (1–5) dan tingkat kesulitan (Easy/Medium/Hard) untuk asesmen diagnostik yang adaptif.</p>
                        <div class="alert alert-primary">
                            <i class="bi bi-info-circle"></i>
                            <strong>Catatan:</strong> Penentuan jalur adaptif dilakukan saat pelaksanaan tes/latihan. Di halaman ini Anda mempersiapkan bank soal terverifikasi dan seimbang untuk dipakai pada asesmen tersebut.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MST System Overview for Teachers -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-shuffle"></i> Alur Sistem</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">Berikut alur pembuatan dan pengelolaan soal diagnostik berbantuan AI:</p>
                        <ol>
                            <li><strong>Unggah</strong> file Modul Ajar (doc/pdf).</li>
                            <li><strong>AI mengekstrak</strong> materi inti dan kompetensi.</li>
                            <li><strong>AI menghasilkan</strong> soal pilihan ganda berlabel <em>Level</em> (1–5) dan <em>Difficulty</em> (E/M/H).</li>
                            <li><strong>Tinjau statistik</strong> distribusi level dan kesulitan.</li>
                            <li><strong>Filter & review</strong> soal, lalu <strong>pilih</strong> yang valid.</li>
                            <li><strong>Simpan</strong> ke <em>Collection</em> untuk dipakai pada asesmen/ujian.</li>
                        </ol>
                        <div class="alert alert-light">
                            <small><i class="bi bi-info-circle"></i> Label level & kesulitan digunakan saat menyusun asesmen adaptif. Jalur adaptif ditentukan ketika tes dijalankan, bukan pada tahap pembuatan soal.</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Penting untuk Guru</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">Sebagai kurator, mohon perhatikan hal berikut:</p>
                        <ul>
                            <li><strong>Akurasi label:</strong> Pastikan level (1–5) dan kesulitan (E/M/H) sesuai konten.</li>
                            <li><strong>Kualitas isi:</strong> Bahasa jelas, tidak ambigu, opsi jawaban unik, distraktor bermutu.</li>
                            <li><strong>Kesesuaian materi:</strong> Selaras dengan tujuan pembelajaran dan konteks siswa.</li>
                            <li><strong>Persebaran seimbang:</strong> Tiap level idealnya memiliki variasi E/M/H.</li>
                            <li><strong>Etika & orisinalitas:</strong> Hindari plagiarisme, sertakan penjelasan ringkas bila tersedia.</li>
                        </ul>
                        <div class="alert alert-light">
                            <small><i class="bi bi-lightbulb"></i> AI membantu percepatan, namun keputusan akhir kelayakan soal tetap pada guru.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-robot"></i> Pembuatan Soal Diagnostik Berbasis AI</h4>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <label for="fileInput" class="form-label">Pilih File (doc/pdf)</label>
                    <input type="file" id="fileInput" name="file" class="form-control mb-3" accept=".doc, .docx, .pdf" required>
                    <div class="alert alert-success">
                        <h6><i class="bi bi-robot"></i> Generate Soal MST dengan AI</h6>
                        <p class="mb-2">Sistem AI akan menganalisis konten dan menghasilkan soal berdasarkan:</p>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li><strong>5 Level Taksonomi:</strong> Level 1 (Awareness) → Level 5 (Criticism)</li>
                                    <li><strong>3 Tingkat Kesulitan:</strong> Easy, Medium, Hard</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li><strong>MST Compatibility:</strong> Sesuai alur percabangan</li>
                                    <li><strong>Auto-labeling:</strong> Technology level + difficulty</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-file-earmark-arrow-up"></i> Upload & Generate Soal MST Adaptive
                    </button>
                </form>

                <div id="statusMessage" class="mt-3"></div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-graph-up"></i> Statistik Soal - 5 Level Taksonomi Teknologi</h4>
            </div>
            <div class="card-body">
                <div id="levelStatistics" class="mt-3">
                    <div class="row" id="levelStatCharts">
                        <div class="col-12 text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Memuat statistik level...</p>
                        </div>
                    </div>
                    <table class="table table-hover align-middle table-modern mt-3">
                        <thead class="table-light">
                            <tr>
                                <th class="text-nowrap">Level Taksonomi Teknologi</th>
                                <th class="text-center">Jumlah Soal</th>
                                <th>Tingkat Kesulitan</th>
                            </tr>
                        </thead>
                        <tbody id="levelSummaryBody">
                            <tr>
                                <td colspan="3" class="text-center">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-collection"></i> Soal Dihasilkan Oleh AI</h4>
                <span id="selectionCounter" class="badge bg-light text-dark">0 soal dipilih</span>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-start mb-3">
                    <div class="btn-group">
                        <button id="selectAllBtn" class="btn btn-outline-primary">
                            <i class="bi bi-check-all"></i> Pilih Semua
                        </button>
                        <button id="unselectAllBtn" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg"></i> Hapus Pilihan
                        </button>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="levelFilter" class="form-label">Filter Level Taksonomi:</label>
                        <select id="levelFilter" class="form-select">
                            <option value="all">Semua Level (1–5)</option>
                            <option value="1">Level 1: Awareness</option>
                            <option value="2">Level 2: Literacy</option>
                            <option value="3">Level 3: Capability</option>
                            <option value="4">Level 4: Creativity</option>
                            <option value="5">Level 5: Criticism</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="difficultyFilter" class="form-label">Filter Tingkat Kesulitan MST:</label>
                        <select id="difficultyFilter" class="form-select">
                            <option value="all">Semua Tingkat Kesulitan</option>
                            <option value="easy">Easy - Untuk jalur bawah adaptif</option>
                            <option value="medium">Medium - Untuk jalur tengah/start</option>
                            <option value="hard">Hard - Untuk jalur atas adaptif</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="collectionFilter" class="form-label">Status di Koleksi:</label>
                        <select id="collectionFilter" class="form-select">
                            <option value="all">Semua Soal</option>
                            <option value="not_in_collection">Belum dalam Koleksi</option>
                            <option value="in_collection">Sudah dalam Koleksi</option>
                        </select>
                    </div>
                </div>

                <div id="questionList" class="position-relative">
                    <div class="text-center p-5">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Memuat soal pilihan ganda...</p>
                    </div>
                </div>
                
                <!-- Save Button (moved from top) -->
                <div class="mt-4 text-center">
                    <button id="saveSelectedBtn" class="btn btn-success" disabled>
                        Simpan Soal Terpilih
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let allGeneratedQuestions = [];
        let selectedQuestions = [];
        let selectionCounterElement = null;
        let questionsInCollection = []; // Move this declaration to the top with other variables

        // 5 Level Taksonomi Teknologi untuk MST Adaptive System
        const levelExplanations = {
            1: {
                title: "Level 1: Awareness (Kesadaran Teknologi)",
                competency: "Mengenali/mengingat istilah, alat dasar teknologi",
                bloom: "Mengingat (Remembering)",
                cognitive_process: "Mengingat dan mengenali terminologi teknologi dasar",
                example: "Definisi teknologi digital, mengenali perangkat IT dasar",
                sample_question: "Apa yang dimaksud dengan teknologi digital?",
                knowledge_type: "Knowledge That",
                difficulty: "Medium (untuk starting point MST)",
                icon: "bi-eye",
                color: "#1976d2",
                mst_usage: "Titik awal semua siswa - Level 1 Medium"
            },
            2: {
                title: "Level 2: Literacy (Literasi Teknologi)", 
                competency: "Menjelaskan fungsi, cara kerja sederhana teknologi",
                bloom: "Memahami (Understanding)",
                cognitive_process: "Memahami hubungan dan menjelaskan cara kerja teknologi",
                example: "Menjelaskan cara kerja internet, fungsi aplikasi",
                sample_question: "Bagaimana cara kerja dasar internet?",
                knowledge_type: "Knowledge That",
                difficulty: "Easy (jalur bawah) / Hard (jalur atas)",
                icon: "bi-book",
                color: "#7b1fa2",
                mst_usage: "Stage 2 - Percabangan pertama berdasarkan performa Level 1"
            },
            3: {
                title: "Level 3: Capability (Kemampuan Teknologi)",
                competency: "Menggunakan fitur dasar untuk tugas rutin",
                bloom: "Menerapkan (Applying)", 
                cognitive_process: "Menerapkan teknologi dalam tugas praktis sehari-hari",
                example: "Menggunakan spreadsheet, membuat presentasi digital",
                sample_question: "Untuk membuat presentasi digital yang menarik, fitur apa yang paling penting?",
                knowledge_type: "Knowledge How",
                difficulty: "Medium (jalur tengah) / Hard (jalur atas)",
                icon: "bi-gear",
                color: "#388e3c",
                mst_usage: "Stage 3 - Mengukur kemampuan praktis teknologi"
            },
            4: {
                title: "Level 4: Creativity (Kreativitas Teknologi)",
                competency: "Merancang/membuat solusi/produk baru sederhana",
                bloom: "Menganalisis + Mencipta",
                cognitive_process: "Merancang solusi kreatif menggunakan teknologi",
                example: "Membuat aplikasi sederhana, merancang website untuk bisnis",
                sample_question: "Jika ingin membuat aplikasi sederhana untuk mencatat pengeluaran harian, pendekatan mana yang paling praktis?",
                knowledge_type: "Knowledge How + Why",
                difficulty: "Easy/Medium/Hard (semua jalur adaptif)",
                icon: "bi-lightbulb",
                color: "#f57c00",
                mst_usage: "Stage 4 - Kreativitas dengan titik henti kedua di Easy"
            },
            5: {
                title: "Level 5: Criticism (Evaluasi Kritis Teknologi)",
                competency: "Mengevaluasi dampak, efektivitas, memberi justifikasi",
                bloom: "Mengevaluasi (Evaluating)",
                cognitive_process: "Mengevaluasi dan mengkritik dampak teknologi secara mendalam",
                example: "Menilai efektivitas implementasi AI, evaluasi bias algoritma",
                sample_question: "Dalam konteks etika AI, mengapa bias dalam algoritma menjadi masalah serius?",
                knowledge_type: "Knowledge How + Why",
                difficulty: "Easy/Medium/Hard (tingkat akhir berdasarkan jalur)",
                icon: "bi-search",
                color: "#d32f2f",
                mst_usage: "Stage 5 - Final evaluation untuk diagnosis akhir"
            }
        };

        document.addEventListener("DOMContentLoaded", async function() {
            try {
                console.log("Halaman dimuat, mengambil data soal...");

                // Set active nav based on current path
                const path = window.location.pathname || '';
                const navDashboard = document.getElementById('nav-dashboard');
                const navCollections = document.getElementById('nav-collections');
                const navGuide = document.getElementById('nav-guide');
                [navDashboard, navCollections, navGuide].forEach(el => el && el.classList.remove('active'));
                if (path === '/guru' || path === '/guru/') {
                    navDashboard && navDashboard.classList.add('active');
                } else if (path.startsWith('/guru/collections')) {
                    navCollections && navCollections.classList.add('active');
                } else if (path.startsWith('/guru/panduan')) {
                    navGuide && navGuide.classList.add('active');
                }
                
                // First load questions in collection
                await loadQuestionsInCollection();
                
                // Set default filter to show only questions not in collection
                document.getElementById("collectionFilter").value = "not_in_collection";
                
                // Then fetch questions and setup the UI
                await fetchQuestions(3);
                
                initializeQuestionSelection();

                // Initialize difficulty options then render with current filters (also updates stats)
                try { updateDifficultyFilterOptions(); } catch (e) { console.warn('Initial updateDifficultyFilterOptions error:', e); }
                try { filterAndDisplayQuestions(); } catch (e) { console.warn('Initial filterAndDisplayQuestions error:', e); }

                // Setup event listener untuk pop-up info level pada tabel header (ikon header dihapus)
                const infoHead = document.getElementById('levelInfoTableHead');
                if (infoHead) {
                    infoHead.addEventListener('click', () => {
                        showLevelExplanationPopup('all');
                    });
                }

                // Setup event listener untuk ikon info di setiap baris level tabel
                document.getElementById('levelSummaryBody').addEventListener('click', (event) => {
                    const target = event.target.closest('.level-info-icon');
                    if (target && target.dataset.level) {
                        showLevelExplanationPopup(parseInt(target.dataset.level));
                    }
                });
            } catch (error) {
                console.error("Error pada inisialisasi utama:", error);
                document.getElementById("questionList").innerHTML =
                    `<div class='alert alert-danger'>Terjadi kesalahan saat inisialisasi: ${error.message}</div>`;
            }
        });

        // Fungsi untuk menampilkan pop-up penjelasan level - DIPERBARUI dengan tampilan interaktif
        function showLevelExplanationPopup(level = null) {
            let title = "Taksonomi Kompetensi Teknologi Adaptif";
            let htmlContent = '';

            if (level === 'all') {
                htmlContent = `
                    <div style="text-align: left;">
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Sistem Taksonomi Teknologi Adaptif DIGIDAWS</strong><br>
                            Taksonomi berlapis dengan 4 Stage utama dan 7 Kotak kemampuan, menggabungkan knowledge that, how, dan why untuk pembelajaran teknologi yang komprehensif.
                        </div>
                        <div class="row">
                `;
                
                for (let i = 1; i <= 7; i++) {
                    const info = levelExplanations[i];
                    const progressPercent = ((i-1) / 6) * 100;
                    
                    htmlContent += `
                        <div class="col-12 mb-3">
                            <div class="card border-0 shadow-sm level-card" style="border-left: 5px solid ${info.color} !important; cursor: pointer;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="me-3">
                                            <i class="${info.icon}" style="font-size: 1.5rem; color: ${info.color};"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1" style="color: ${info.color};">${info.title}</h6>
                                            <small class="text-muted">${info.bloom} | ${info.knowledge_type}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge" style="background-color: ${info.color};">Level ${i}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="progress mb-2" style="height: 4px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: ${progressPercent}%; background-color: ${info.color};" 
                                             aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    
                                    <p class="mb-1 small"><strong>Fokus Soal:</strong> ${info.example}</p>
                                    <p class="mb-1 small"><strong>Contoh Soal:</strong> "${info.sample_question}"</p>
                                    <p class="mb-0 small text-muted"><strong>Tingkat Kesulitan:</strong> ${info.difficulty}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                htmlContent += `
                        </div>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <small><strong>Catatan Penting:</strong><br>
                            • Stage I-II: Pemahaman dasar teknologi (Knowledge That)<br>
                            • Stage III: Aplikasi praktis (Knowledge That + How)<br>
                            • Stage IV: Evaluasi & kreativitas tinggi (Knowledge That + How + Why)<br>
                            • Tingkat kesulitan menggunakan Easy/Medium/Hard untuk mendukung alur adaptif MST</small>
                        </div>
                    </div>
                `;
            } else if (levelExplanations[level]) {
                const info = levelExplanations[level];
                title = info.title;
                const progressPercent = ((level-1) / 6) * 100;
                
                htmlContent = `
                    <div style="text-align: left;">
                        <div class="text-center mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center rounded-circle" 
                                 style="width: 80px; height: 80px; background-color: ${info.color}15; border: 3px solid ${info.color};">
                                <i class="${info.icon}" style="font-size: 2rem; color: ${info.color};"></i>
                            </div>
                            <h5 class="mt-3 mb-1" style="color: ${info.color};">${info.title}</h5>
                            <p class="text-muted mb-0">${info.bloom}</p>
                        </div>
                        
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: ${progressPercent}%; background-color: ${info.color};" 
                                 aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light border-0 mb-3">
                                    <div class="card-body p-3">
                                        <h6 class="card-title">
                                            <i class="bi bi-brain me-2" style="color: ${info.color};"></i>
                                            Proses Kognitif
                                        </h6>
                                        <p class="card-text small">${info.cognitive_process}</p>
                                        <p class="card-text small text-muted"><strong>Jenis Pengetahuan:</strong> ${info.knowledge_type}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light border-0 mb-3">
                                    <div class="card-body p-3">
                                        <h6 class="card-title">
                                            <i class="bi bi-lightbulb me-2" style="color: ${info.color};"></i>
                                            Contoh Soal
                                        </h6>
                                        <p class="card-text small font-italic">"${info.sample_question}"</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card bg-light border-0 mb-3">
                            <div class="card-body p-3">
                                <h6 class="card-title">
                                    <i class="bi bi-target me-2" style="color: ${info.color};"></i>
                                    Fokus Soal
                                </h6>
                                <p class="card-text small">${info.example}</p>
                            </div>
                        </div>
                        
                        <div class="alert" style="border-color: ${info.color}; background-color: ${info.color}10;">
                            <h6 style="color: ${info.color};">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Tingkat Kesulitan
                            </h6>
                            <p class="mb-1">${info.difficulty}</p>
                            <p class="mb-0 small text-muted"><strong>Kompetensi:</strong> ${info.competency}</p>
                        </div>
                    </div>
                `;
            } else {
                title = "Informasi Level Tidak Tersedia";
                htmlContent = `
                    <div class="text-center py-4">
                        <i class="bi bi-question-circle" style="font-size: 3rem; color: #dc3545;"></i>
                        <h5 class="mt-3 text-muted">Penjelasan untuk level ini tidak ditemukan</h5>
                        <p class="text-muted">Silakan hubungi administrator sistem.</p>
                    </div>
                `;
            }

            Swal.fire({
                title: title,
                html: htmlContent,
                icon: null,
                confirmButtonText: 'Tutup',
                width: level === 'all' ? '90%' : '70%',
                showClass: {
                    popup: 'animate__animated animate__fadeInUp'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOutDown'
                },
                customClass: {
                    popup: 'custom-taxonomy-popup',
                    title: 'custom-taxonomy-title',
                    content: 'custom-taxonomy-content'
                },
                didOpen: () => {
                    // Add some interactivity to the opened modal
                    const popup = Swal.getPopup();
                    if (popup) {
                        // Add hover effects to cards
                        const cards = popup.querySelectorAll('.level-card, .card');
                        cards.forEach(card => {
                            card.addEventListener('mouseenter', function() {
                                this.style.transform = 'translateY(-2px)';
                                this.style.transition = 'all 0.2s ease';
                                this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                            });
                            card.addEventListener('mouseleave', function() {
                                this.style.transform = 'translateY(0)';
                                this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                            });
                        });
                    }
                }
            });
        }


        function initializeQuestionSelection() {
            setupCheckboxHandlers();
            setupSelectAllButtons();
            setupSaveSelectedButton();
            console.log("Fitur pemilihan soal berhasil diinisialisasi");
        }

        async function fetchQuestions(retries = 3) {
            let attempt = 0;
            while (attempt < retries) {
                try {
                    attempt++;
                    console.log(`Mengambil data soal (percobaan ${attempt})...`);
                    const timestamp = new Date().getTime();
                    const fetchUrl = `${window.location.origin}/get_questions?show_all=true&debug=true&t=${timestamp}`;
                    console.log(`Fetching URL: ${fetchUrl}`);

                    const response = await fetch(fetchUrl);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Server returned error: ${response.status} ${response.statusText}`);
                        console.error(`Error details: ${errorText}`);
                        throw new Error(`Server error: ${response.status} ${response.statusText}`);
                    }

                    const responseText = await response.text();
                    console.log("Raw response length:", responseText.length);
                    console.log("Response preview:", responseText.substring(0, 200) + "...");

                    try {
                        localStorage.setItem('lastQuestionResponse', responseText.substring(0, 5000));
                    } catch (e) {
                        console.warn("Couldn't save to localStorage:", e);
                    }

                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        console.error("Gagal parse JSON:", e);
                        console.error("Raw response yang tidak bisa di-parse:", responseText);
                        throw new Error("Invalid JSON response from server");
                    }

                    console.log(`Data soal berhasil diambil: ${result.data ? result.data.length : 0} soal`);

                    if (result.data && Array.isArray(result.data)) {
                        const levelDistribution = {};
                        result.data.forEach(q => {
                            const level = q.level;
                            levelDistribution[level] = (levelDistribution[level] || 0) + 1;
                        });
                        console.log("Distribusi soal per level:", levelDistribution);

                        if (result.data.length > 0) {
                            console.log("Contoh soal pertama:", result.data[0]);
                        }

                        allGeneratedQuestions = result.data;
                        console.log(`Berhasil memuat ${allGeneratedQuestions.length} soal`);

                        updatelevelStatistics(result.data);
                        filterAndDisplayQuestions();
                        return;
                    } else {
                        console.warn("Format data tidak valid:", result);
                        document.getElementById("questionList").innerHTML =
                            "<div class='alert alert-warning'>Format data tidak valid. Silakan hubungi administrator.</div>";
                        document.getElementById("levelSummaryBody").innerHTML =
                            "<tr><td colspan='3' class='text-center'>Format data tidak valid</td></tr>";
                    }
                } catch (error) {
                    console.error(`Error mengambil soal (percobaan ${attempt}):`, error);

                    if (attempt < retries) {
                        console.log(`Mencoba lagi dalam ${attempt * 2} detik...`);
                        document.getElementById("questionList").innerHTML =
                            `<div class='alert alert-info'>
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                Mencoba ulang mengambil data (${attempt}/${retries})...
                            </div>`;

                        await new Promise(resolve => setTimeout(resolve, attempt * 2000));
                    } else {
                        document.getElementById("questionList").innerHTML =
                            `<div class='alert alert-danger'>
                                <h5>Gagal memuat soal setelah ${retries} percobaan:</h5>
                                <p>${error.message}</p>
                                <p>Coba periksa koneksi database dan pastikan soal telah dibuat.</p>
                                <button class="btn btn-primary mt-2" onclick="checkDatabaseStatus()">Periksa Database</button>
                                <button class="btn btn-outline-primary mt-2 ms-2" onclick="window.location.reload()">Refresh Halaman</button>
                            </div>`;
                        document.getElementById("levelSummaryBody").innerHTML =
                            "<tr><td colspan='3' class='text-center'>Gagal memuat data</td></tr>";
                        document.getElementById("levelStatCharts").innerHTML = "";
                    }
                }
            }
        }

        function checkDatabaseStatus() {
            document.getElementById("questionList").innerHTML =
                `<div class='alert alert-info'>
                    <div class="spinner-border text-primary me-2" role="status"></div>
                    Memeriksa database...
                </div>`;

            fetch(`${window.location.origin}/api/db_check?t=` + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("questionList").innerHTML =
                            `<div class='alert alert-info'>
                                <h5>Status Database:</h5>
                                <p>Total soal di database: <strong>${data.total_questions}</strong></p>
                                <p>Distribusi per level: ${JSON.stringify(data.per_level)}</p>
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="fetchQuestions(1)">Coba Ambil Soal Lagi</button>
                                    <button class="btn btn-outline-secondary ms-2" onclick="window.location.reload()">Refresh Halaman</button>
                                </div>
                            </div>`;
                    } else {
                        document.getElementById("questionList").innerHTML =
                            `<div class='alert alert-danger'>
                                <h5>Gagal memeriksa database:</h5>
                                <p>${data.message}</p>
                            </div>`;
                    }
                })
                .catch(error => {
                    document.getElementById("questionList").innerHTML =
                        `<div class='alert alert-danger'>
                            <h5>Error memeriksa database:</h5>
                            <p>${error.message}</p>
                        </div>`;
                });
        }

        document.getElementById("levelFilter").addEventListener("change", function() {
            try { updateDifficultyFilterOptions(); } catch (e) { console.warn('updateDifficultyFilterOptions error:', e); }
            filterAndDisplayQuestions();
        });

        document.getElementById("difficultyFilter").addEventListener("change", function() {
            filterAndDisplayQuestions();
        });

        function filterAndDisplayQuestions() {
            const selectedLevel = document.getElementById("levelFilter").value;
            const selectedDifficulty = document.getElementById("difficultyFilter").value;
            const selectedCollectionStatus = document.getElementById("collectionFilter").value;

            let questionList = document.getElementById("questionList");
            questionList.innerHTML = "";

            console.log(`Memfilter soal: ${allGeneratedQuestions.length} total soal`);
            console.log(`Kriteria filter - level: ${selectedLevel}, Kesulitan: ${selectedDifficulty}, Collection: ${selectedCollectionStatus}`);

            if (!allGeneratedQuestions.length) {
                questionList.innerHTML = "<div class='alert alert-warning'>Tidak ada soal yang dibuat</div>";
                return;
            }

            let filteredQuestions = selectedLevel === "all" ?
                [...allGeneratedQuestions] :
                allGeneratedQuestions.filter(q => String(q.level) === selectedLevel);

            console.log(`Setelah filter level: ${filteredQuestions.length} soal`);

            if (selectedDifficulty !== "all") {
                filteredQuestions = filteredQuestions.filter(q => {
                    // Get difficulty from q.difficulty or convert from p value
                    const difficulty = q.difficulty || (q.p >= 0.75 ? 'Easy' : q.p >= 0.45 ? 'Medium' : 'Hard');
                    return difficulty.toLowerCase() === selectedDifficulty.toLowerCase();
                });
            }
            if (selectedCollectionStatus !== "all") {
                if (selectedCollectionStatus === "in_collection") {
                    filteredQuestions = filteredQuestions.filter(q => questionsInCollection.includes(q.id));
                } else if (selectedCollectionStatus === "not_in_collection") {
                    filteredQuestions = filteredQuestions.filter(q => !questionsInCollection.includes(q.id));
                }
            }
            console.log(`Setelah semua filter: ${filteredQuestions.length} soal`);

            console.log(`Setelah filter kesulitan: ${filteredQuestions.length} soal`);

            if (filteredQuestions.length === 0) {
                questionList.innerHTML = `<div class='alert alert-info'>Tidak ada soal yang sesuai dengan filter</div>`;
                return;
            }

            filteredQuestions.sort((a, b) => {
                if (a.level !== b.level) {
                    return a.level - b.level;
                }
                return parseFloat(b.p) - parseFloat(a.p);
            });

            const levelCountsDebug = {};
            filteredQuestions.forEach(q => {
                levelCountsDebug[q.level] = (levelCountsDebug[q.level] || 0) + 1;
            });
            console.log("Soal yang telah difilter berdasarkan level:", levelCountsDebug);

            // Update message based on collection filter status
            let displayMessage;
            if (selectedCollectionStatus === "not_in_collection") {
                displayMessage = `Menampilkan ${filteredQuestions.length} soal baru yang belum disimpan dalam collection`;
            } else if (selectedCollectionStatus === "in_collection") {
                displayMessage = `Menampilkan ${filteredQuestions.length} soal yang sudah disimpan dalam collection`;
            } else {
                displayMessage = `Menampilkan ${filteredQuestions.length} soal dari total ${allGeneratedQuestions.length} soal`;
            }
            
            questionList.innerHTML = `
                <div class="alert alert-primary mb-3">
                    ${displayMessage}
                </div>
            `;

            selectedQuestions = [];

            filteredQuestions.forEach((q, index) => {
                const card = document.createElement("div");
                card.className = `card question-card mb-3 ${questionsInCollection.includes(q.id) ? 'in-collection' : ''}`;

                let optionsHtml = '';

                try {
                    let options = q.options;
                    if (typeof q.options === 'string') {
                        try {
                            options = JSON.parse(q.options);
                        } catch (e) {
                            console.error("Error parsing options string:", q.options);
                            options = [];
                        }
                    }

                    if (options && Array.isArray(options)) {
                        optionsHtml = '<div class="mt-2">';
                        options.forEach(option => {
                            const isCorrect = option === q.jawaban_benar;
                            optionsHtml += `
                                <span class="option-badge ${isCorrect ? 'correct-answer' : ''}">
                                    ${option}
                                    ${isCorrect ? '<i class="bi bi-check"></i>' : ''}
                                </span>
                            `;
                        });
                        optionsHtml += '</div>';
                    }
                } catch (e) {
                    console.error("Error parsing options for question:", q.id, e);
                    optionsHtml = '<div class="alert alert-warning">Error menampilkan opsi jawaban</div>';
                }

                // Gunakan definisi level yang sudah diperbarui dari levelExplanations
                const levelInfo = levelExplanations[q.level];
                let levelText = levelInfo ? levelInfo.title : `Level ${q.level} - Tidak Dikenal`;
                let levelIcon = levelInfo ? levelInfo.icon : 'bi-question-circle';
                let levelColor = levelInfo ? levelInfo.color : '#6c757d';

                const levelClass = `level-${q.level}`;
                console.log("Menerapkan kelas:", levelClass, "untuk level:", q.level);

                let collectionBadgeHtml = '';
                if (questionsInCollection.includes(q.id)) {
                    collectionBadgeHtml = '<span class="collection-badge">Dalam Koleksi</span>';
                }

                // Create card structure with DOM methods instead of innerHTML
                const cardBody = document.createElement("div");
                cardBody.className = "card-body";
                
                // Create checkbox container
                const checkboxContainer = document.createElement("div");
                checkboxContainer.className = "d-flex justify-content-between align-items-center mb-2";
                
                const formCheck = document.createElement("div");
                formCheck.className = "form-check";
                
                // Create checkbox with direct event listener
                const checkbox = document.createElement("input");
                checkbox.className = "form-check-input question-checkbox";
                checkbox.type = "checkbox";
                checkbox.value = q.id;
                checkbox.id = `check-${q.id}`;
                if (selectedQuestions.includes(q.id)) {
                    checkbox.checked = true;
                }
                // Add event listener directly here
                checkbox.addEventListener('change', handleCheckboxChange);
                
                const checkLabel = document.createElement("label");
                checkLabel.className = "form-check-label";
                checkLabel.setAttribute("for", `check-${q.id}`);
                checkLabel.textContent = "Pilih soal ini";
                
                formCheck.appendChild(checkbox);
                formCheck.appendChild(checkLabel);
                
                // Create info container
                const infoContainer = document.createElement("div");
                infoContainer.className = "d-flex align-items-center gap-2";
                
                const questionInfo = document.createElement("div");
                questionInfo.className = "question-info position-relative";
                
                const levelBadge = document.createElement("span");
                levelBadge.className = `badge level-badge-interactive ${levelClass}`;
                levelBadge.style.backgroundColor = levelColor;
                levelBadge.style.cursor = 'pointer';
                levelBadge.title = `Klik untuk melihat detail ${levelText}`;
                
                // Create badge content with icon and text
                const badgeContent = document.createElement("div");
                badgeContent.className = "d-flex align-items-center gap-1";
                
                const iconElement = document.createElement("i");
                iconElement.className = `${levelIcon} level-taxonomy-icon`;
                iconElement.style.fontSize = "0.9rem";
                
                const textElement = document.createElement("span");
                textElement.textContent = `Level ${q.level}`;
                
                badgeContent.appendChild(iconElement);
                badgeContent.appendChild(textElement);
                levelBadge.appendChild(badgeContent);
                
                // Add click handler to show level details
                levelBadge.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showLevelExplanationPopup(q.level);
                });
                
                const difficultyBadge = document.createElement("span");
                // Use difficulty if available, otherwise convert p value to difficulty
                const difficulty = q.difficulty || (q.p >= 0.75 ? 'Easy' : q.p >= 0.45 ? 'Medium' : 'Hard');
                difficultyBadge.className = `badge difficulty-${difficulty.toLowerCase()}`;
                difficultyBadge.textContent = difficulty;
                
                questionInfo.appendChild(levelBadge);
                questionInfo.appendChild(difficultyBadge);
                
                if (questionsInCollection.includes(q.id)) {
                    const collectionBadge = document.createElement("span");
                    collectionBadge.className = "collection-badge";
                    collectionBadge.textContent = "Dalam Koleksi";
                    questionInfo.appendChild(collectionBadge);
                }
                
                // Create delete button
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "btn btn-danger btn-sm delete-question-btn";
                deleteBtn.setAttribute("data-question-id", q.id);
                deleteBtn.setAttribute("title", "Hapus soal");
                
                const trashIcon = document.createElement("i");
                trashIcon.className = "bi bi-trash";
                deleteBtn.appendChild(trashIcon);
                deleteBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const questionId = q.id;
                    
                    // Show confirmation dialog
                    const result = await Swal.fire({
                        title: 'Hapus Soal?',
                        text: 'Apakah Anda yakin ingin menghapus soal ini? Tindakan ini tidak dapat dibatalkan.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Ya, Hapus!',
                        cancelButtonText: 'Batal'
                    });

                    if (result.isConfirmed) {
                        try {
                            const response = await fetch(`${window.location.origin}/api/questions/${questionId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });

                            if (response.ok) {
                                Swal.fire({
                                    title: 'Berhasil!',
                                    text: 'Soal berhasil dihapus.',
                                    icon: 'success',
                                    timer: 1500,
                                    showConfirmButton: false
                                });

                                // Remove from selected questions if it was selected
                                selectedQuestions = selectedQuestions.filter(id => id !== questionId);
                                
                                // Remove from generated questions array
                                allGeneratedQuestions = allGeneratedQuestions.filter(q => q.id !== questionId);
                                
                                // Refresh the question list using existing filter function
                                filterAndDisplayQuestions();
                            } else {
                                const errorData = await response.json();
                                throw new Error(errorData.message || errorData.error || 'Gagal menghapus soal');
                            }
                        } catch (error) {
                            console.error('Error deleting question:', error);
                            Swal.fire({
                                title: 'Error!',
                                text: error.message || 'Terjadi kesalahan saat menghapus soal',
                                icon: 'error',
                            });
                        }
                    }
                });
                
                infoContainer.appendChild(questionInfo);
                infoContainer.appendChild(deleteBtn);
                
                checkboxContainer.appendChild(formCheck);
                checkboxContainer.appendChild(infoContainer);
                
                // Create question title
                const title = document.createElement("h5");
                title.className = "card-title";
                title.textContent = q.soal || 'Tidak ada teks soal';
                
                // Add card elements to card body
                cardBody.appendChild(checkboxContainer);
                cardBody.appendChild(title);
                
                // Add options
                if (optionsHtml) {
                    const optionsDiv = document.createElement("div");
                    optionsDiv.className = "mt-2";
                    optionsDiv.innerHTML = optionsHtml;
                    cardBody.appendChild(optionsDiv);
                }
                
                // Add correct answer
                const answerDiv = document.createElement("div");
                answerDiv.className = "mt-3";
                const answerP = document.createElement("p");
                answerP.className = "text-muted mb-0";
                const answerStrong = document.createElement("strong");
                answerStrong.textContent = "Jawaban Benar: ";
                answerP.appendChild(answerStrong);
                answerP.appendChild(document.createTextNode(q.jawaban_benar || 'Tidak ada jawaban'));
                answerDiv.appendChild(answerP);
                cardBody.appendChild(answerDiv);
                
                // Add explanation
                const explDiv = document.createElement("div");
                explDiv.className = "mt-2";
                const explSmall = document.createElement("small");
                explSmall.className = "text-muted";
                const explStrong = document.createElement("strong");
                explStrong.textContent = "Penjelasan: ";
                explSmall.appendChild(explStrong);
                explSmall.appendChild(document.createTextNode(q.explanation || 'Tidak ada penjelasan'));
                explDiv.appendChild(explSmall);
                cardBody.appendChild(explDiv);
                
                card.appendChild(cardBody);
                questionList.appendChild(card);
            });

            // Don't need setupCheckboxHandlers and setupDeleteHandlers anymore since we added listeners directly
            updateSelectedCount();

            // Keep the level statistics in sync with the current filtered dataset (real-time)
            try { updatelevelStatistics(getFilteredQuestions(true) || []); } catch (e) { console.warn('updatelevelStatistics error:', e); }
        }

        // Helper: derive difficulty label from question (q.difficulty or fallback from q.p)
        function getDifficultyLabel(q) {
            const d = (q && q.difficulty) ? String(q.difficulty).trim() : '';
            if (d) {
                const dl = d.toLowerCase();
                if (dl === 'easy' || dl === 'e') return 'Easy';
                if (dl === 'medium' || dl === 'm') return 'Medium';
                if (dl === 'hard' || dl === 'h') return 'Hard';
            }
            const p = typeof q.p === 'number' ? q.p : parseFloat(q.p);
            if (!isNaN(p)) {
                if (p >= 0.75) return 'Easy';
                if (p >= 0.45) return 'Medium';
                return 'Hard';
            }
            return 'Medium';
        }

        // Compute the base set for difficulty options: respects level and collection filters, but not difficulty
        function getBaseQuestionsForDifficulty() {
            const selectedLevel = document.getElementById('levelFilter')?.value || 'all';
            const selectedCollectionStatus = document.getElementById('collectionFilter')?.value || 'all';

            let base = Array.isArray(allGeneratedQuestions) ? [...allGeneratedQuestions] : [];

            if (selectedLevel !== 'all') {
                base = base.filter(q => String(q.level) === String(selectedLevel));
            }

            if (selectedCollectionStatus !== 'all') {
                if (selectedCollectionStatus === 'in_collection') {
                    base = base.filter(q => Array.isArray(questionsInCollection) && questionsInCollection.includes(q.id));
                } else if (selectedCollectionStatus === 'not_in_collection') {
                    base = base.filter(q => !Array.isArray(questionsInCollection) || !questionsInCollection.includes(q.id));
                }
            }

            return base;
        }

        // Update the Difficulty filter options based on currently available questions (real-time)
        function updateDifficultyFilterOptions() {
            const select = document.getElementById('difficultyFilter');
            if (!select) return;

            const baseQuestions = getBaseQuestionsForDifficulty();

            // Count difficulties
            const counts = { Easy: 0, Medium: 0, Hard: 0 };
            baseQuestions.forEach(q => {
                counts[getDifficultyLabel(q)]++;
            });

            const total = baseQuestions.length;
            const prevValue = select.value;

            // Build options dynamically (only include difficulties that exist)
            const options = [];
            options.push({ value: 'all', label: `Semua (${total})`, disabled: false });
            ['Easy','Medium','Hard'].forEach(k => {
                const c = counts[k] || 0;
                options.push({ value: k.toLowerCase(), label: `${k} (${c})`, disabled: c === 0 });
            });

            // Replace options
            select.innerHTML = '';
            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt.value;
                o.textContent = opt.label;
                if (opt.disabled) o.disabled = true;
                select.appendChild(o);
            });

            // Preserve previous selection if still valid; otherwise fallback to 'all'
            const values = options.map(o => o.value);
            if (values.includes(prevValue)) {
                select.value = prevValue;
            } else {
                select.value = 'all';
            }
        }

        // Get the list of questions matching current Level, Difficulty, and Collection filters
        function getFilteredQuestions(includeDifficulty = true) {
            const selectedLevel = document.getElementById('levelFilter')?.value || 'all';
            const selectedDifficulty = document.getElementById('difficultyFilter')?.value || 'all';
            const selectedCollectionStatus = document.getElementById('collectionFilter')?.value || 'all';

            let items = Array.isArray(allGeneratedQuestions) ? [...allGeneratedQuestions] : [];

            if (selectedLevel !== 'all') {
                items = items.filter(q => String(q.level) === String(selectedLevel));
            }

            if (includeDifficulty && selectedDifficulty !== 'all') {
                items = items.filter(q => getDifficultyLabel(q).toLowerCase() === selectedDifficulty.toLowerCase());
            }

            if (selectedCollectionStatus !== 'all') {
                if (selectedCollectionStatus === 'in_collection') {
                    items = items.filter(q => Array.isArray(questionsInCollection) && questionsInCollection.includes(q.id));
                } else if (selectedCollectionStatus === 'not_in_collection') {
                    items = items.filter(q => !Array.isArray(questionsInCollection) || !questionsInCollection.includes(q.id));
                }
            }

            return items;
        }

        function updatelevelStatistics(questions) {
            const levelCounts = {};
            const levelDifficultyDistribution = {};

            // Initialize for 5 levels only (MST system)
            for (let i = 1; i <= 5; i++) {
                levelCounts[i] = 0;
                levelDifficultyDistribution[i] = {Easy: 0, Medium: 0, Hard: 0};
            }

            questions.forEach(q => {
                const level = parseInt(q.level);
                if (level >= 1 && level <= 5) {
                    levelCounts[level]++;
                    // Get difficulty from q.difficulty or convert from p value
                    const difficulty = q.difficulty || (q.p >= 0.75 ? 'Easy' : q.p >= 0.45 ? 'Medium' : 'Hard');
                    levelDifficultyDistribution[level][difficulty]++;
                }
            });

            const levelDifficultyText = {};
            for (let level in levelDifficultyDistribution) {
                const dist = levelDifficultyDistribution[level];
                const total = dist.Easy + dist.Medium + dist.Hard;
                if (total > 0) {
                    const parts = [];
                    if (dist.Easy > 0) parts.push(`E:${dist.Easy}`);
                    if (dist.Medium > 0) parts.push(`M:${dist.Medium}`);
                    if (dist.Hard > 0) parts.push(`H:${dist.Hard}`);
                    levelDifficultyText[level] = parts.length > 0 ? parts.join(', ') : '-';
                } else {
                    levelDifficultyText[level] = '-';
                }
            }

            const tbody = document.getElementById("levelSummaryBody");
            tbody.innerHTML = "";

            const levelStatCharts = document.getElementById("levelStatCharts");
            levelStatCharts.innerHTML = '';

            // Only create charts for MST levels 1-5
            for (let level = 1; level <= 5; level++) {
                const tr = document.createElement("tr");
                // Gunakan levelExplanations untuk display yang konsisten
                let levelDisplay;
                if (level !== 'Total') {
                    const levelInfo = levelExplanations[level];
                    const levelColor = levelInfo ? levelInfo.color : '#6c757d';
                    
                    levelDisplay = `
                        <div class="d-flex align-items-center">
                            <span class="level-dot" style="background-color: ${levelColor};"></span>
                            <span class="level-table-text">Level ${level}</span>
                        </div>
                    `;
                } else {
                    levelDisplay = `<strong><i class="bi bi-bar-chart me-2"></i>Total</strong>`;
                }

                // Only show data for levels that exist in 5-level MST system
                if (level >= 1 && level <= 5) {
                    const dist = levelDifficultyDistribution[level];
                    const diffHtml = (dist.Easy + dist.Medium + dist.Hard) > 0 ? `
                        ${dist.Easy > 0 ? `<span class="badge difficulty-easy me-1">E:${dist.Easy}</span>` : ''}
                        ${dist.Medium > 0 ? `<span class="badge difficulty-medium me-1">M:${dist.Medium}</span>` : ''}
                        ${dist.Hard > 0 ? `<span class="badge difficulty-hard">H:${dist.Hard}</span>` : ''}
                    ` : '<small class="text-muted">-</small>';

                    tr.innerHTML = `
                        <td class="text-nowrap">${levelDisplay}</td>
                        <td class="text-center fw-semibold">${levelCounts[level]}</td>
                        <td>${diffHtml}</td>
                    `;
                    tbody.appendChild(tr);
                }

                const chartCol = document.createElement("div");
                chartCol.className = "col-6 col-sm-4 col-md-3 col-lg-20p mb-3";

                // Gunakan levelExplanations untuk chart yang konsisten
                const levelInfo = levelExplanations[level];
                const barColor = levelInfo ? levelInfo.color : "#6c757d";
                const levelName = levelInfo ? levelInfo.title.replace(`Level ${level}: `, "") : "Tidak Diketahui";
                const levelIcon = levelInfo ? levelInfo.icon : "bi-question-circle";
                
                // Calculate percentage relative to max count for better visualization
                const maxCount = Math.max(...Object.values(levelCounts));
                const percentage = maxCount > 0 ? (levelCounts[level] / maxCount) * 100 : 0;

                chartCol.innerHTML = `
                    <div class="card level-chart-card h-100" style="cursor: pointer; transition: all 0.3s ease;">
                        <div class="card-body text-center d-flex flex-column justify-content-between">
                            <div>
                                <div class="mb-3">
                                    <i class="${levelIcon}" style="font-size: 2.5rem; color: ${barColor};"></i>
                                </div>
                                <h5 style="color: ${barColor}; font-weight: 600;">Level ${level}</h5>
                                <p class="text-muted mb-3" style="font-size: 0.95rem; font-weight: bold;">${levelName}</p>
                            </div>
                            
                            <div>
                                <div class="progress taxonomy-progress" style="height: 12px; background-color: rgba(0,0,0,0.1);">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${percentage}%; background-color: ${barColor}; transition: width 0.8s ease;"
                                         aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add click event to chart card
                chartCol.addEventListener('click', function() {
                    showLevelExplanationPopup(parseInt(level));
                });
                
                // Add hover effect
                const cardElement = chartCol.querySelector('.level-chart-card');
                cardElement.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
                });
                cardElement.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                });

                levelStatCharts.appendChild(chartCol);
            }

            // Add total row
            const totalRow = document.createElement("tr");
            totalRow.className = "table-primary";
            const total = Object.values(levelCounts).reduce((sum, count) => sum + count, 0);
            
            // Calculate total difficulty distribution
            let totalEasy = 0, totalMedium = 0, totalHard = 0;
            Object.values(levelDifficultyDistribution).forEach(dist => {
                totalEasy += dist.Easy;
                totalMedium += dist.Medium;
                totalHard += dist.Hard;
            });
            const totalDiffHtml = `
                ${totalEasy > 0 ? `<span class="badge difficulty-easy me-1">E:${totalEasy}</span>` : ''}
                ${totalMedium > 0 ? `<span class="badge difficulty-medium me-1">M:${totalMedium}</span>` : ''}
                ${totalHard > 0 ? `<span class="badge difficulty-hard">H:${totalHard}</span>` : ''}
            `;
            
            totalRow.innerHTML = `
                <td class="text-nowrap"><strong><i class="bi bi-bar-chart me-2"></i>Total</strong></td>
                <td class="text-center fw-semibold"><strong>${total}</strong></td>
                <td>${totalDiffHtml || '<small class="text-muted">-</small>'}</td>
            `;
            tbody.appendChild(totalRow);
        }

        // Function to get current user ID (assuming it's available in the page context)
        function getCurrentUserId() {
            // Try to get user ID from meta tag
            const userIdMeta = document.querySelector('meta[name="user-id"]');
            if (userIdMeta && userIdMeta.getAttribute('content')) {
                const userId = userIdMeta.getAttribute('content').trim();
                if (userId && userId !== '') {
                    console.log(`User ID from meta tag: ${userId}`);
                    return userId;
                }
            }
            
            // Alternative: get from data attribute on body or main element
            const bodyUserId = document.body.getAttribute('data-user-id');
            if (bodyUserId && bodyUserId.trim() !== '') {
                console.log(`User ID from body attribute: ${bodyUserId}`);
                return bodyUserId.trim();
            }
            
            // Try from window global variable
            if (window.currentUserId) {
                console.log(`User ID from window global: ${window.currentUserId}`);
                return window.currentUserId;
            }
            
            // Fallback: try to extract from current URL or make a request
            console.warn("User ID not found in meta tag or attributes, using fallback");
            
            // For testing: use a default user ID but warn about it
            const fallbackId = '1';
            console.warn(`Using fallback user ID: ${fallbackId}. In production, ensure proper user ID is available.`);
            return fallbackId;
        }

        // Function to update loading step animation
        function updateStep(stepNumber) {
            const steps = document.querySelectorAll('.transfer-step');
            
            // Update all steps up to current step
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                const stepNum = i + 1;
                
                if (stepNum < stepNumber) {
                    // Mark previous steps as completed
                    step.classList.remove('active');
                    step.classList.add('completed');
                } else if (stepNum === stepNumber) {
                    // Mark current step as active
                    step.classList.remove('completed');
                    step.classList.add('active');
                } else {
                    // Reset future steps
                    step.classList.remove('active', 'completed');
                }
            }
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            const progressPercentage = Math.min(((stepNumber - 1) / (steps.length - 1)) * 100, 100);
            progressBar.style.width = progressPercentage + '%';
            progressBar.setAttribute('aria-valuenow', progressPercentage);
        }

        // Function to show error with suggestion
        function showErrorWithSuggestion(message, suggestion) {
            const statusMessage = document.getElementById("statusMessage");
            statusMessage.innerHTML = `
                <div class='alert alert-danger'>
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle-fill me-3 mt-1" style="font-size: 1.5rem; color: #dc3545;"></i>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">Modul Ajar Tidak Sesuai Format</h6>
                            <div class="mb-3">${message}</div>
                            <div class="bg-light p-3 rounded border-start border-primary border-3">
                                <small class="text-muted d-block mb-1"><strong>💡 Saran:</strong></small>
                                <small>${suggestion}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to show quality extraction error  
        function showQualityError(message, qualityScore, suggestion) {
            const statusMessage = document.getElementById("statusMessage");
            statusMessage.innerHTML = `
                <div class='alert alert-warning'>
                    <div class="d-flex align-items-start">
                        <i class="bi bi-clipboard-x-fill me-3 mt-1" style="font-size: 1.5rem; color: #856404;"></i>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">Kualitas Ekstraksi Rendah</h6>
                            <div class="mb-3">${message}</div>
                            <div class="mb-3">
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${qualityScore < 40 ? 'bg-danger' : qualityScore < 60 ? 'bg-warning' : 'bg-success'}" 
                                         role="progressbar" 
                                         style="width: ${qualityScore}%" 
                                         aria-valuenow="${qualityScore}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        ${qualityScore}%
                                    </div>
                                </div>
                                <small class="text-muted">Skor minimal yang dibutuhkan: 60%</small>
                            </div>
                            <div class="bg-light p-3 rounded border-start border-warning border-3">
                                <small class="text-muted d-block mb-1"><strong>💡 Saran:</strong></small>
                                <small>${suggestion}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to show system error with better formatting
        function showSystemError(message, errorType, suggestion) {
            const statusMessage = document.getElementById("statusMessage");
            let iconClass = "bi bi-exclamation-triangle-fill";
            let alertClass = "alert-danger";
            
            if (errorType === "network" || errorType === "timeout") {
                iconClass = "bi bi-wifi-off";
                alertClass = "alert-warning";
            } else if (errorType === "progress") {
                iconClass = "bi bi-arrow-clockwise";
                alertClass = "alert-info";
            }
            
            statusMessage.innerHTML = `
                <div class='alert ${alertClass}'>
                    <div class="d-flex align-items-start">
                        <i class="${iconClass} me-3 mt-1" style="font-size: 1.5rem;"></i>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">Kesalahan Sistem</h6>
                            <div class="mb-3">${message}</div>
                            ${suggestion ? `
                                <div class="bg-light p-3 rounded border-start border-info border-3">
                                    <small class="text-muted d-block mb-1"><strong>💡 Saran:</strong></small>
                                    <small>${suggestion}</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        document.getElementById("uploadForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            let fileInput = document.getElementById("fileInput");
            let statusMessage = document.getElementById("statusMessage");

            if (!fileInput.files.length) {
                statusMessage.innerHTML = "<div class='alert alert-danger'>Pilih file terlebih dahulu.</div>";
                return;
            }

            let formData = new FormData();
            formData.append("file", fileInput.files[0]);

            // Show file transfer loading animation
            statusMessage.innerHTML = `
                <div class='alert alert-info'>
                    <div class="file-transfer-container">
                        <div class="transfer-icon">
                            <i class="bi bi-file-earmark-arrow-up"></i>
                        </div>
                        <div class="transfer-progress">
                            <div class="transfer-status">Memproses modul ajar dan membuat soal...</div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-animated" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <ul class="transfer-steps">
                        <li id="step1" class="transfer-step active"><i class="bi bi-upload"></i>Mengunggah file modul ajar</li>
                        <li id="step2" class="transfer-step"><i class="bi bi-file-text"></i>Menganalisis struktur dokumen</li>
                        <li id="step3" class="transfer-step"><i class="bi bi-search"></i>Mengekstrak tujuan pembelajaran</li>
                        <li id="step4" class="transfer-step"><i class="bi bi-robot"></i>Memproses dengan AI Gemini</li>
                        <li id="step5" class="transfer-step"><i class="bi bi-check-circle"></i>Menyimpan soal ke database</li>
                    </ul>
                </div>
            `;

            // Start with step 1 (upload initiated)
            updateStep(1);

            try {
                // Initialize progress tracking
                const userId = getCurrentUserId();
                console.log(`Starting progress tracking for user ID: ${userId}`);
                
                // Create progress tracker instance
                if (window.progressTracker) {
                    window.progressTracker.stopPolling();
                }
                
                window.progressTracker = new ProgressTracker(userId, null, {
                    maxRetries: 15,     // Lebih banyak retry untuk VPS
                    pollIntervalMs: 1000, // Poll setiap 1 detik (tidak terlalu agresif)
                    timeoutMs: 120000     // Timeout 2 menit untuk proses AI
                });
                
                // Override updateProgressUI untuk kompatibilitas dengan UI lama
                window.progressTracker.updateProgressUI = function(progress) {
                    console.log('Progress update received:', progress);
                    
                    // Update step UI dengan format lama
                    if (progress && progress.current_step) {
                        const currentStep = progress.current_step;
                        updateStep(currentStep);
                        
                        // Update status message jika ada
                        const statusElement = document.querySelector('.transfer-status');
                        if (statusElement && progress.steps && progress.steps[currentStep]) {
                            const stepData = progress.steps[currentStep];
                            if (stepData.message) {
                                statusElement.textContent = stepData.message;
                            }
                        }
                        
                        // Update progress bar berdasarkan step
                        const progressBar = document.querySelector('.progress-bar');
                        if (progressBar) {
                            const progressPercent = (currentStep / 5) * 100;
                            progressBar.style.width = progressPercent + '%';
                        }
                    }
                };
                
                // Start progress tracking setelah delay kecil agar backend sempat setup
                setTimeout(() => {
                    console.log('Starting progress polling...');
                    window.progressTracker.startPolling();
                }, 1000); // Delay 1 detik
                
                let response = await fetch(`${window.location.origin}/upload`, {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    // Stop progress tracking properly
                    if (window.progressTracker) {
                        window.progressTracker.stopPolling();
                    }
                    
                    let errorText;
                    try {
                        const errorJson = await response.json();
                        errorText = errorJson.message || "Unknown error";
                        
                        // Handle different error types with better user messages
                        if (errorJson.error_type === "invalid_module_format") {
                            showErrorWithSuggestion(errorJson.message, errorJson.suggestion);
                            return;
                        } else if (errorJson.error_type === "low_quality_extraction") {
                            showQualityError(errorJson.message, errorJson.quality_score, errorJson.suggestion);
                            return;
                        }
                    } catch {
                        errorText = await response.text();
                    }
                    throw new Error("Server error: " + errorText);
                }

                let result = await response.json();

                // Stop progress tracking
                if (window.progressTracker) {
                    // Final completion - ensure step 5 is completed
                    updateStep(5);
                    
                    // Stop polling after a short delay to show completion
                    setTimeout(() => {
                        window.progressTracker.stopPolling();
                    }, 2000);
                }
                
                // Show success message after short delay
                setTimeout(() => {
                    statusMessage.innerHTML = "<div class='alert alert-success'>" + result.message + "</div>";
                }, 500);                if (result.data && Array.isArray(result.data)) {
                    allGeneratedQuestions = result.data;

                    updatelevelStatistics(result.data);

                    filterAndDisplayQuestions();

                    selectedQuestions = [];
                    updateSelectedCount();
                } else {
                    document.getElementById("questionList").innerHTML = "<div class='alert alert-warning'>Tidak ada soal yang dibuat</div>";
                    document.getElementById("levelSummaryBody").innerHTML = "<tr><td colspan='3' class='text-center'>Tidak ada data</td></tr>";
                    document.getElementById("levelStatCharts").innerHTML = "";
                }

            } catch (error) {
                // Stop progress tracking on error
                if (window.progressTracker) {
                    window.progressTracker.stopPolling();
                }
                
                console.error("Fetch error:", error);
                
                // Parse error message for better user experience
                let errorMessage = error.message;
                let errorType = "general";
                let suggestion = "💡 Silakan refresh halaman dan coba lagi. Pastikan file adalah Modul Ajar Kurikulum Merdeka yang valid.";
                
                if (errorMessage.includes("progressInterval is not defined")) {
                    errorType = "progress";
                    errorMessage = "🔄 Terjadi kesalahan dalam sistem pelacakan progress. Silakan refresh halaman dan coba lagi.";
                } else if (errorMessage.includes("timeout") || errorMessage.includes("fetch")) {
                    errorType = "network";
                    errorMessage = "🌐 Koneksi terputus atau server tidak merespons. Periksa koneksi internet Anda.";
                    suggestion = "💡 Periksa koneksi internet dan coba lagi dalam beberapa menit.";
                } else if (errorMessage.includes("Server error")) {
                    errorType = "server";
                    errorMessage = errorMessage.replace("Server error: ", "");
                    suggestion = "💡 Jika masalah berlanjut, silakan hubungi administrator sistem.";
                }
                
                // Use appropriate error display function
                showSystemError(errorMessage, errorType, suggestion);
            }
        });

        // Event listener for the check database button if it exists
        const checkDbButton = document.getElementById("checkDbButton");
        if (checkDbButton) {
            checkDbButton.addEventListener("click", async function() {
                try {
                    const statusMessage = document.getElementById("statusMessage");
                    statusMessage.innerHTML = `
                        <div class='alert alert-info'>
                            <div class="spinner-container">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            Memeriksa database secara langsung...
                        </div>
                    `;
                    console.log("Memanggil endpoint /api/check_questions_count");

                    const timestamp = new Date().getTime();
                    const response = await fetch(`${window.location.origin}/api/check_questions_count?t=${timestamp}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Server returned error: ${response.status}`, errorText);
                        throw new Error(`Server error: ${response.status}`);
                    }

                    const responseText = await response.text();
                    console.log("Raw response:", responseText);

                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        console.error("Failed to parse JSON:", e);
                        throw new Error("Invalid JSON response from server");
                    }

                    if (result.success) {
                        statusMessage.innerHTML = `
                            <div class='alert alert-success'>
                                <h5>Hasil Pemeriksaan Database:</h5>
                                <ul>
                                    <li>Total soal: ${result.totalQuestions}</li>
                                    <li>Soal per level: ${JSON.stringify(result.levelDistribution)}</li>
                                </ul>
                                <button class="btn btn-sm btn-primary mt-2" id="refreshQuestionsBtn">Reload Soal dari Database</button>
                            </div>
                        `;

                        const resetResponse = await fetch(`${window.location.origin}/reset_database`, {
                            method: "POST"
                        });

                        if (!resetResponse.ok) {
                            throw new Error(`Server error: ${resetResponse.status}`);
                        }

                        const resetResult = await resetResponse.json();

                        const resetMessageEl = document.getElementById("resetMessage") || document.getElementById("statusMessage");

                        if (resetResult.success) {
                            if (resetMessageEl) resetMessageEl.innerHTML = "<div class='alert alert-success'>" + resetResult.message + "</div>";
                            allGeneratedQuestions = [];
                            document.getElementById("questionList").innerHTML = "<div class='alert alert-warning'>Tidak ada soal yang dibuat</div>";
                            document.getElementById("levelSummaryBody").innerHTML = "<tr><td colspan='3' class='text-center'>Tidak ada data</td></tr>";
                            document.getElementById("levelStatCharts").innerHTML = "";
                            document.getElementById("statusMessage").innerHTML = "";

                            selectedQuestions = [];
                            updateSelectedCount();
                        } else {
                            if (resetMessageEl) resetMessageEl.innerHTML = "<div class='alert alert-danger'>" + (resetResult.message || 'Gagal mereset database') + "</div>";
                        }
                    }
                } catch (error) {
                    const resetMessageEl = document.getElementById("resetMessage") || document.getElementById("statusMessage");
                    if (resetMessageEl) {
                        resetMessageEl.innerHTML = "<div class='alert alert-danger'>Terjadi kesalahan: " + error.message + "</div>";
                    }
                    console.error("Reset error:", error);
                }
            });
        }

        function setupCheckboxHandlers() {
            try {
                const checkboxes = document.querySelectorAll('.question-checkbox');
                
                if (checkboxes.length === 0) {
                    console.log("No checkboxes found to initialize");
                    return;
                }
                
                checkboxes.forEach(checkbox => {
                    try {
                        // Remove existing event listeners by cloning
                        const oldCheckbox = checkbox;
                        
                        // Ensure the element is still in the DOM
                        if (!document.body.contains(oldCheckbox)) {
                            console.log("Checkbox is no longer in the DOM, skipping");
                            return;
                        }
                        
                        const parent = oldCheckbox.parentNode;
                        if (!parent) {
                            console.error("Parent node tidak ditemukan untuk checkbox:", oldCheckbox);
                            return;
                        }
                        
                        // Create a new checkbox with the same attributes
                        const newCheckbox = oldCheckbox.cloneNode(true);
                        
                        // Replace old with new
                        parent.replaceChild(newCheckbox, oldCheckbox);
                        
                        // Add event listener to new checkbox
                        newCheckbox.addEventListener('change', handleCheckboxChange);
                    } catch (err) {
                        console.error("Error setting up individual checkbox handler:", err);
                    }
                });
                console.log("Checkbox handlers initialized");
            } catch (error) {
                console.error("Error in setupCheckboxHandlers:", error);
            }
        }

        function handleCheckboxChange(e) {
            const questionId = parseInt(e.target.value);

            if (e.target.checked) {
                if (!selectedQuestions.includes(questionId)) {
                    selectedQuestions.push(questionId);
                }
            } else {
                selectedQuestions = selectedQuestions.filter(id => id !== questionId);
            }
            console.log("Selected questions array:", selectedQuestions);
            updateSelectedCount();
        }

        function setupDeleteHandlers() {
            document.querySelectorAll('.delete-question-btn').forEach(button => {
                button.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const questionId = parseInt(this.getAttribute('data-question-id'));
                    
                    // Show confirmation dialog
                    const result = await Swal.fire({
                        title: 'Hapus Soal?',
                        text: 'Apakah Anda yakin ingin menghapus soal ini? Tindakan ini tidak dapat dibatalkan.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Ya, Hapus!',
                        cancelButtonText: 'Batal'
                    });

                    if (result.isConfirmed) {
                        try {
                            const response = await fetch(`${window.location.origin}/api/questions/${questionId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });

                            if (response.ok) {
                                Swal.fire({
                                    title: 'Berhasil!',
                                    text: 'Soal berhasil dihapus.',
                                    icon: 'success',
                                    timer: 1500,
                                    showConfirmButton: false
                                });

                                // Remove from selected questions if it was selected
                                selectedQuestions = selectedQuestions.filter(id => id !== questionId);
                                
                                // Remove from generated questions array
                                allGeneratedQuestions = allGeneratedQuestions.filter(q => q.id !== questionId);
                                
                                // Refresh the question list using existing filter function
                                filterAndDisplayQuestions();
                            } else {
                                const errorData = await response.json();
                                throw new Error(errorData.message || errorData.error || 'Gagal menghapus soal');
                            }
                        } catch (error) {
                            console.error('Error deleting question:', error);
                            Swal.fire({
                                title: 'Error!',
                                text: error.message || 'Terjadi kesalahan saat menghapus soal.',
                                icon: 'error'
                            });
                        }
                    }
                });
            });
        }

        function setupSelectAllButtons() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const unselectAllBtn = document.getElementById('unselectAllBtn');

            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll('.question-checkbox');
                    selectedQuestions = [];
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                        const questionId = parseInt(checkbox.value);
                        if (!selectedQuestions.includes(questionId)) {
                            selectedQuestions.push(questionId);
                        }
                    });
                    console.log("Selected all questions:", selectedQuestions);
                    updateSelectedCount();
                });
            }

            if (unselectAllBtn) {
                unselectAllBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll('.question-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    selectedQuestions = [];
                    console.log("Deselected all questions");
                    updateSelectedCount();
                });
            }
            console.log("Select/unselect buttons initialized");
        }

        function updateSelectedCount() {
            if (!selectionCounterElement) {
                selectionCounterElement = document.getElementById('selectionCounter');
            }

            if (selectionCounterElement) {
                selectionCounterElement.textContent = `${selectedQuestions.length} soal dipilih`;
            }

            const saveBtn = document.getElementById('saveSelectedBtn');
            if (saveBtn) {
                if (selectedQuestions.length > 0) {
                    saveBtn.textContent = `Simpan ${selectedQuestions.length} Soal Terpilih`;
                    saveBtn.disabled = false; // Enable if questions are selected
                } else {
                    saveBtn.textContent = 'Simpan Soal Terpilih';
                    saveBtn.disabled = true; // Disable if no questions are selected
                }
            }
            console.log(`Selected questions updated: ${selectedQuestions.length} questions selected`);
        }

        function setupSaveSelectedButton() {
            const saveBtn = document.getElementById('saveSelectedBtn');
            // Menghapus event listener lama sebelum menambahkan yang baru
            saveBtn.removeEventListener('click', handleSaveSelectedClick);
            saveBtn.addEventListener('click', handleSaveSelectedClick);
            console.log("Save button initialized");
        }

        async function handleSaveSelectedClick() {
            const saveBtn = document.getElementById('saveSelectedBtn');

            if (selectedQuestions.length === 0) {
                alert('Pilih minimal 1 soal untuk disimpan!');
                // Tombol sudah disabled karena tidak ada soal yang dipilih, tidak perlu enable/disable di sini lagi
                return;
            }

            // Menonaktifkan tombol utama saat proses modal dimulai
            saveBtn.disabled = true;

            try {
                showSaveToCollectionModal();
            } catch (error) {
                console.error('Error showing collection modal:', error);
                showToast('Error', 'Terjadi kesalahan saat membuka modal: ' + error.message, 'error');
            } finally {
                // Tombol utama akan di-enable kembali setelah modal ditutup
                // atau di handle di fungsi `createAndShowModal` atau `showSimpleSaveForm`
                // agar terintegrasi dengan alur penonaktifan/pengaktifan tombol modal.
            }
        }


        function showSaveToCollectionModal() {
            if (!selectedQuestions || selectedQuestions.length === 0) {
                alert('Pilih minimal satu soal untuk disimpan!');
                // Ini seharusnya tidak terpicu jika tombol sudah disabled dengan benar
                document.getElementById('saveSelectedBtn').disabled = false;
                return;
            }

            // PERBAIKAN UTAMA: Dapatkan referensi tombol utama sekali di awal
            const mainSaveSelectedBtn = document.getElementById('saveSelectedBtn');

            try {
                if (typeof bootstrap === 'undefined') {
                    console.warn("Bootstrap tidak tersedia! Memuat dari CDN...");
                    const bootstrapScript = document.createElement('script');
                    bootstrapScript.src = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js";
                    bootstrapScript.integrity = "sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz";
                    bootstrapScript.crossOrigin = "anonymous";
                    document.head.appendChild(bootstrapScript);

                    bootstrapScript.onload = function() {
                        console.log("Bootstrap berhasil dimuat dari CDN");
                        createAndShowModal();
                    };

                    bootstrapScript.onerror = function() {
                        console.error("Gagal memuat Bootstrap dari CDN");
                        showSimpleSaveForm();
                        mainSaveSelectedBtn.disabled = false; // Aktifkan kembali tombol utama
                    };
                    return;
                }
                createAndShowModal();
            } catch (error) {
                console.error('Error showing collection modal:', error);
                showSimpleSaveForm();
                mainSaveSelectedBtn.disabled = false; // Aktifkan kembali tombol utama
            }
        }

        function createAndShowModal() {
            const modalHtml = `
                <div class="modal fade" id="saveCollectionModal" tabindex="-1" aria-labelledby="saveCollectionModalLabel">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="saveCollectionModalLabel">Simpan ${selectedQuestions.length} Soal ke Koleksi</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="collectionOption" id="newCollection" value="new" checked>
                                        <label class="form-check-label" for="newCollection">
                                            Buat Koleksi Baru
                                        </label>
                                    </div>

                                    <div id="newCollectionForm">
                                        <div class="mb-3">
                                            <label for="collectionName" class="form-label">Nama Koleksi</label>
                                            <input type="text" class="form-control" id="collectionName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="collectionDesc" class="form-label">Deskripsi (opsional)</label>
                                            <textarea class="form-control" id="collectionDesc" rows="2"></textarea>
                                        </div>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="collectionOption" id="existingCollection" value="existing">
                                        <label class="form-check-label" for="existingCollection">
                                            Tambahkan ke Koleksi yang Ada
                                        </label>
                                    </div>

                                    <div id="existingCollectionForm" style="display: none;">
                                        <div class="mb-3">
                                            <label for="collectionSelect" class="form-label">Pilih Koleksi</label>
                                            <select class="form-select" id="collectionSelect">
                                                <option value="">Memuat koleksi...</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <small>
                                        <i class="bi bi-info-circle"></i>
                                        Soal yang disimpan ke koleksi tidak akan hilang ketika Anda membuat soal baru
                                    </small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-primary" id="saveToCollectionBtn">Simpan</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('saveCollectionModal');
            if (existingModal) {
                const modalInstance = bootstrap.Modal.getInstance(existingModal);
                if (modalInstance) {
                    modalInstance.dispose();
                }
                existingModal.remove();
            }

            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);

            // Dapatkan referensi tombol utama lagi di sini, karena modal HTML baru mungkin telah dibuat
            const mainSaveSelectedBtn = document.getElementById('saveSelectedBtn');

            try {
                const modal = new bootstrap.Modal(document.getElementById('saveCollectionModal'), {
                    backdrop: 'static',
                    keyboard: true
                });

                // PERBAIKAN: Tambahkan event listener untuk 'hidden.bs.modal'
                // Ini akan terpicu saat modal ditutup, baik dengan tombol X, Escape, atau tombol Batal
                modalContainer.addEventListener('hidden.bs.modal', function onHidden() {
                    modalContainer.removeEventListener('hidden.bs.modal', onHidden); // Hapus listener ini sendiri
                    modalContainer.remove(); // Hapus elemen modal dari DOM
                    // Aktifkan kembali tombol utama saat modal ditutup (jika ada soal yang dipilih)
                    updateSelectedCount(); // Ini akan memeriksa `selectedQuestions.length` dan mengatur `disabled`
                });

                const setupRadioHandlers = () => {
                    const newCollectionRadio = document.getElementById('newCollection');
                    const existingCollectionRadio = document.getElementById('existingCollection');
                    const newCollectionForm = document.getElementById('newCollectionForm');
                    const existingCollectionForm = document.getElementById('existingCollectionForm');

                    if (newCollectionRadio && existingCollectionRadio) {
                        newCollectionRadio.addEventListener('change', function() {
                            if (this.checked) {
                                if (newCollectionForm) newCollectionForm.style.display = 'block';
                                if (existingCollectionForm) existingCollectionForm.style.display = 'none';
                            }
                        });

                        existingCollectionRadio.addEventListener('change', function() {
                            if (this.checked) {
                                if (newCollectionForm) newCollectionForm.style.display = 'none';
                                if (existingCollectionForm) existingCollectionForm.style.display = 'block';
                                loadCollections();
                            }
                        });
                    }
                };

                setupRadioHandlers();

                const saveBtn = document.getElementById('saveToCollectionBtn');
                if (saveBtn) {
                    saveBtn.onclick = null; // Menghapus event listener lama
                    saveBtn.addEventListener('click', async function() {
                        const radioOption = document.querySelector('input[name="collectionOption"]:checked');

                        saveBtn.disabled = true; // Menonaktifkan tombol simpan modal
                        // Tidak perlu menonaktifkan mainSaveSelectedBtn di sini, sudah dihandle di handleSaveSelectedClick
                        // dan akan diaktifkan kembali saat modal ditutup oleh listener hidden.bs.modal

                        let operationSuccess = false; // Flag untuk melacak keberhasilan operasi

                        try {
                            if (!radioOption) {
                                alert('Pilih apakah membuat koleksi baru atau menambahkan ke koleksi yang ada');
                                return;
                            }

                            const option = radioOption.value;

                            if (option === 'new') {
                                const nameInput = document.getElementById('collectionName');
                                const descInput = document.getElementById('collectionDesc');

                                if (!nameInput || !nameInput.value.trim()) {
                                    alert('Nama koleksi harus diisi!');
                                    return;
                                }

                                operationSuccess = await createNewCollection(
                                    nameInput.value.trim(),
                                    descInput ? descInput.value.trim() : '',
                                    selectedQuestions
                                );
                            } else {
                                const selectEl = document.getElementById('collectionSelect');

                                if (!selectEl || !selectEl.value) {
                                    alert('Pilih koleksi terlebih dahulu!');
                                    return;
                                }

                                operationSuccess = await addToExistingCollection(selectEl.value, selectedQuestions);
                            }

                            if (operationSuccess) { // Jika operasi berhasil
                                modal.hide(); // Sembunyikan modal
                            }

                        } catch (e) {
                            console.error('Error saving to collection:', e);
                            showToast('Error', 'Gagal menyimpan koleksi: ' + e.message, 'error');
                        } finally {
                            // Mengaktifkan kembali tombol simpan modal
                            saveBtn.disabled = false;
                            // Tombol utama akan diaktifkan kembali oleh event listener 'hidden.bs.modal'
                        }
                    });
                }

                modal.show();

            } catch (error) {
                console.error('Error initializing modal:', error);
                mainSaveSelectedBtn.disabled = false; // Aktifkan kembali tombol utama jika inisialisasi modal gagal
                // Cleanup modal jika inisialisasi gagal dan modal sudah ditambahkan ke DOM
                const potentialModal = document.getElementById('saveCollectionModal');
                if (potentialModal) {
                    const modalInstance = bootstrap.Modal.getInstance(potentialModal);
                    if (modalInstance) {
                        modalInstance.dispose();
                    }
                    potentialModal.remove();
                }
                showToast('Error', 'Terjadi kesalahan saat membuka modal. Coba lagi.', 'error');
            }
        }

        function showSimpleSaveForm() {
            const container = document.createElement('div');
            container.className = 'fixed-top w-100 h-100 d-flex justify-content-center align-items-center';
            container.style.backgroundColor = 'rgba(0,0,0,0.5)';
            container.style.zIndex = '9999';

            container.innerHTML = `
                <div class="card" style="width: 500px; max-width: 90%;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Simpan ${selectedQuestions.length} Soal ke Koleksi Baru</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="simpleName" class="form-label">Nama Koleksi</label>
                            <input type="text" class="form-control" id="simpleName" required>
                        </div>
                        <div class="mb-3">
                            <label for="simpleDesc" class="form-label">Deskripsi (opsional)</label>
                            <textarea class="form-control" id="simpleDesc" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end">
                        <button class="btn btn-secondary me-2" id="simpleCancel">Batal</button>
                        <button class="btn btn-primary" id="simpleSave">Simpan</button>
                    </div>
                </div>
            `;

            document.body.appendChild(container);

            // Dapatkan referensi tombol utama
            const mainSaveSelectedBtn = document.getElementById('saveSelectedBtn');

            document.getElementById('simpleCancel').addEventListener('click', function() {
                document.body.removeChild(container);
                updateSelectedCount(); // Perbarui status tombol utama
            });

            document.getElementById('simpleSave').addEventListener('click', async function() {
                const name = document.getElementById('simpleName').value;
                const description = document.getElementById('simpleDesc').value;

                this.disabled = true; // Menonaktifkan tombol simpan di simple form
                mainSaveSelectedBtn.disabled = true; // Menonaktifkan tombol utama

                try {
                    if (!name) {
                        alert('Nama koleksi harus diisi!');
                        return;
                    }

                    const success = await createNewCollection(name, description, selectedQuestions);
                    if (success) {
                       document.body.removeChild(container); // Hanya hapus jika berhasil
                    }
                } catch (e) {
                    console.error('Error saving via simple form:', e);
                    showToast('Error', 'Gagal menyimpan koleksi: ' + e.message, 'error');
                } finally {
                    this.disabled = false; // Aktifkan kembali tombol simpan di simple form
                    updateSelectedCount(); // Perbarui status tombol utama
                }
            });
        }

        async function loadQuestionsInCollection() {
            try {
                const response = await fetch(`${window.location.origin}/api/questions/in_collection`);
                const data = await response.json();

                if (data.success) {
                    questionsInCollection = data.question_ids || [];
                    console.log(`Loaded ${questionsInCollection.length} questions in collection`);
                } else {
                    console.error('Error loading questions in collection:', data.message);
                }
            } catch (error) {
                console.error('Error fetching questions in collection:', error);
            }
        }

        document.getElementById("collectionFilter").addEventListener("change", function() {
            try { updateDifficultyFilterOptions(); } catch (e) { console.warn('updateDifficultyFilterOptions error:', e); }
            filterAndDisplayQuestions();
        });

        async function loadCollections() {
            try {
                const select = document.getElementById('collectionSelect');
                if (!select) return;

                select.innerHTML = '<option value="">Memuat koleksi...</option>';

                const response = await fetch(`${window.location.origin}/api/collections`);
                const data = await response.json();

                if (data.success && data.collections.length > 0) {
                    select.innerHTML = '';

                    data.collections.forEach(collection => {
                        const option = document.createElement('option');
                        option.value = collection.id;
                        option.textContent = `${collection.name} (${collection.question_count} soal)`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Tidak ada koleksi</option>';

                    document.getElementById('newCollection').checked = true;
                    document.getElementById('existingCollection').disabled = true;
                    document.getElementById('newCollectionForm').style.display = 'block';
                    document.getElementById('existingCollectionForm').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading collections:', error);

                const select = document.getElementById('collectionSelect');
                if (select) {
                    select.innerHTML = '<option value="">Error memuat koleksi</option>';
                }

                showToast('Error', 'Gagal memuat daftar koleksi', 'error');
            }
        }

        async function createNewCollection(name, description, questionIds) {
            try {
                showToast('Proses', `Menyimpan ${questionIds.length} soal ke koleksi baru...`, 'info');

                if (!name || name.trim() === '') {
                    showToast('Gagal', 'Nama koleksi tidak boleh kosong', 'error');
                    return false; // Indicate failure
                }

                if (!Array.isArray(questionIds) || questionIds.length === 0) {
                    showToast('Gagal', 'Tidak ada soal yang dipilih untuk disimpan', 'error');
                    return false; // Indicate failure
                }

                console.log('Data yang akan dikirim ke server:', {
                    name,
                    description: description || '',
                    question_ids: questionIds
                });

                const response = await fetch(`${window.location.origin}/api/collections`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description || '',
                        question_ids: questionIds
                    }),
                });

                if (!response.ok) {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (parseError) {
                        console.error('Error parsing error response:', parseError);
                    }

                    throw new Error(errorMessage);
                }

                let responseText = await response.text();
                let result;

                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Response is not valid JSON:', responseText);
                    throw new Error('Respons server tidak valid: bukan format JSON');
                }

                if (result && result.success) {
                    showToast('Berhasil', `${questionIds.length} soal berhasil disimpan ke koleksi "${name}"`, 'success');
                    resetSelection();
                    await loadQuestionsInCollection();
                    // Set filter to show only new questions
                    document.getElementById("collectionFilter").value = "not_in_collection";
                    filterAndDisplayQuestions();
                    return true; // Indicate success
                } else {
                    const errorMsg = (result && result.message) ? result.message : 'Gagal membuat koleksi';
                    showToast('Gagal', errorMsg, 'error');
                    return false; // Indicate failure
                }
            } catch (error) {
                console.error('Error creating collection:', error);
                showToast('Error', `Gagal menyimpan koleksi: ${error.message}`, 'error');
                return false; // Indicate failure
            }
        }

        async function addToExistingCollection(collectionId, questionIds) {
            try {
                showToast('Proses', `Menambahkan ${questionIds.length} soal ke koleksi...`, 'info');

                if (!collectionId) {
                    showToast('Gagal', 'ID koleksi tidak valid', 'error');
                    return false; // Indicate failure
                }

                if (!Array.isArray(questionIds) || questionIds.length === 0) {
                    showToast('Gagal', 'Tidak ada soal yang dipilih untuk disimpan', 'error');
                    return false; // Indicate failure
                }

                console.log('Data yang akan dikirim ke server:', {
                    collection_id: collectionId,
                    question_ids: questionIds
                });

                const response = await fetch(`${window.location.origin}/api/collections/${collectionId}/questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        question_ids: questionIds
                    }),
                });

                if (!response.ok) {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    try { // <-- Blok 'try' yang hilang telah ditambahkan
                        const errorData = await response.json();
                        if (errorData && errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (parseError) { // <-- 'catch' ini sekarang valid
                        console.error('Error parsing error response:', parseError);
                    }
                    throw new Error(errorMessage);
                }

                let responseText = await response.text();
                let result;

                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Response is not valid JSON:', responseText);
                    throw new Error('Respons server tidak valid: bukan format JSON');
                }

                if (result && result.success) {
                    showToast('Berhasil', `${questionIds.length} soal berhasil ditambahkan ke koleksi`, 'success');
                    resetSelection();
                    await loadQuestionsInCollection();
                    // Set filter to show only new questions
                    document.getElementById("collectionFilter").value = "not_in_collection";
                    filterAndDisplayQuestions();
                    return true; // Indicate success
                } else {
                    const errorMsg = (result && result.message) ? result.message : 'Gagal menambahkan soal ke koleksi';
                    showToast('Gagal', errorMsg, 'error');
                    return false; // Indicate failure
                }
            } catch (error) {
                console.error('Error adding to collection:', error);
                showToast('Error', `Gagal menambahkan soal ke koleksi: ${error.message}`, 'error');
                return false; // Indicate failure
            }
        }

        function resetSelection() {
            const checkboxes = document.querySelectorAll('.question-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            selectedQuestions = [];
            updateSelectedCount();
        }

        function showToast(title, message, type = 'info') {
            if (!document.getElementById('toastContainer')) {
                const container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }

            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${type === 'error' ? 'bg-danger text-white' : type === 'success' ? 'bg-success text-white' : 'bg-primary text-white'}">
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            document.getElementById('toastContainer').insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);

            if (typeof bootstrap !== 'undefined') {
                const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
                toast.show();

                toastElement.addEventListener('hidden.bs.toast', function() {
                    this.remove();
                });
            } else {
                toastElement.style.display = 'block';
                setTimeout(() => {
                    toastElement.style.opacity = '0';
                    toastElement.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        toastElement.remove();
                    }, 500);
                }, 5000);
            }
        }

        /**
         * Progress Tracking System untuk VPS Production
         * Compatible dengan multiple Gunicorn workers
         */
        class ProgressTracker {
            constructor(userId, progressContainer, options = {}) {
                this.userId = userId;
                this.progressContainer = progressContainer;
                this.pollingInterval = null;
                this.isActive = false;
                this.retryCount = 0;
                this.maxRetries = options.maxRetries || 10;
                this.pollIntervalMs = options.pollIntervalMs || 500;
                this.timeoutMs = options.timeoutMs || 30000;
                
                this.pollProgress = this.pollProgress.bind(this);
                this.stopPolling = this.stopPolling.bind(this);
                
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
            }

            startPolling() {
                if (this.isActive) {
                    console.log('Progress polling already active');
                    return;
                }

                this.isActive = true;
                this.retryCount = 0;
                
                console.log(`Starting progress polling for user ${this.userId}`);
                
                this.pollProgress();
                this.pollingInterval = setInterval(this.pollProgress, this.pollIntervalMs);
                
                setTimeout(() => {
                    if (this.isActive) {
                        console.log('Progress polling timeout reached, stopping...');
                        this.stopPolling();
                    }
                }, this.timeoutMs);
            }

            async pollProgress() {
                if (!this.isActive) return;

                try {
                    const response = await fetch(`${window.location.origin}/api/progress/${this.userId}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    this.retryCount = 0;
                    
                    if (data.success && data.progress) {
                        this.updateProgressUI(data.progress);
                    } else if (data.status === 'no_active_progress') {
                        console.log('No active progress, stopping polling');
                        this.stopPolling();
                    }

                } catch (error) {
                    console.error('Progress polling error:', error);
                    this.handlePollingError(error);
                }
            }

            handlePollingError(error) {
                this.retryCount++;
                
                if (this.retryCount >= this.maxRetries) {
                    console.error(`Max retries (${this.maxRetries}) reached, stopping progress polling`);
                    this.stopPolling();
                    return;
                }
                
                const backoffMs = Math.min(1000 * Math.pow(2, this.retryCount), 10000);
                console.log(`Retry ${this.retryCount}/${this.maxRetries} in ${backoffMs}ms`);
                
                setTimeout(() => {
                    if (this.isActive) {
                        this.pollProgress();
                    }
                }, backoffMs);
            }

            updateProgressUI(progress) {
                // This method will be overridden in the main script for UI compatibility
                console.log('Progress update:', progress);
            }

            stopPolling() {
                if (!this.isActive) return;

                this.isActive = false;
                
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                    this.pollingInterval = null;
                }

                console.log(`Progress polling stopped for user ${this.userId}`);
                this.cleanup();
            }

            async cleanup() {
                try {
                    await fetch(`${window.location.origin}/api/progress/stop/${this.userId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    console.log('Progress tracking cleaned up on server');
                } catch (error) {
                    console.warn('Failed to cleanup progress tracking:', error);
                }
            }
        }

        // Make ProgressTracker globally available
        window.ProgressTracker = ProgressTracker;

        // Scroll-to-top button behavior
        document.addEventListener('DOMContentLoaded', function() {
            const scrollBtn = document.getElementById('scrollTopBtn');
            if (!scrollBtn) return;

            const toggleVisibility = () => {
                if (window.scrollY > 600) {
                    scrollBtn.classList.add('show');
                } else {
                    scrollBtn.classList.remove('show');
                }
            };

            window.addEventListener('scroll', toggleVisibility, { passive: true });
            toggleVisibility();

            scrollBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    </script>

    <!-- MST System Footer -->
    <footer class="bg-light mt-5 py-4 border-top">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h6 class="text-primary"><i class="bi bi-gear"></i> Sistem MST Adaptive - Dashboard Guru</h6>
                    <p class="text-muted mb-0">
                        <small>Multistage Adaptive Testing dengan 5 Level Taksonomi Teknologi. 
                        Sistem ini menggunakan alur percabangan kompleks untuk diagnosis kemampuan yang lebih akurat.</small>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <!-- Tombol panduan di footer dihapus sesuai permintaan -->
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Scroll-to-top floating button -->
    <button type="button" id="scrollTopBtn" class="btn btn-primary scroll-top-btn" aria-label="Kembali ke atas" title="Kembali ke atas">
        <i class="bi bi-arrow-up"></i>
    </button>
</body>
</html>
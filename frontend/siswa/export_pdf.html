<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Laporan Hasil Tes Diagnostik - {{ student.nama }}</title>
    <style type="text/css">
        @page {
            size: a4 portrait;
            margin: 2.54cm; /* Standard margin */
        }

        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #333333;
            margin: 0;
            padding: 0;
        }

        /* Single-line spacing (1.0) for student info and summary sections */
        .student-info-table,
        .student-info-table *,
        .summary-table,
        .summary-table *,
        .section-title {
            line-height: 1.0;
        }

        .report-header {
            background-color: #003366; /* Dark blue */
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }
        .report-header h1 {
            margin: 0;
            font-size: 20pt;
            font-weight: bold;
        }

        .report-date {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
            font-size: 10pt;
            color: #555;
            font-style: italic;
        }

        .student-info-table {
            width: 100%;
            font-size: 11pt;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        .student-info-table td {
            padding: 6px 8px;
            vertical-align: top;
        }
        /* Center the student info block and its content */
        .student-info-table > tr > td > table.student-info-table {
            margin-left: auto;
            margin-right: auto;
            width: auto; /* shrink to content so it centers nicely */
        }
        .student-info-table > tr > td > table.student-info-table td {
            text-align: center;
        }
        .info-label {
            width: 120px;
            font-weight: bold;
        }
        .info-value {
            font-weight: normal;
        }
        .info-right {
            text-align: left;
        }

        .section-title {
            font-size: 14pt;
            font-weight: bold;
            color: #003366;
            border-bottom: 2px solid #003366;
            padding-bottom: 6px;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .subsection-title {
            font-size: 12pt;
            font-weight: bold;
            color: #003366;
            background-color: #f0f8ff;
            padding: 10px 15px;
            margin-top: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #0056b3;
            border-radius: 0 5px 5px 0;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        .summary-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
            vertical-align: top;
        }
        .summary-label {
            background-color: #f8f9fa;
            font-weight: bold;
            width: 40%;
        }
        .summary-value {
            text-align: right;
            font-weight: bold;
            font-size: 12pt;
        }
        .description-box {
            background-color: #eef7ff;
            border: 1px solid #d1e9ff;
            padding: 12px;
            font-size: 10pt;
            border-radius: 5px;
            margin-top: 5px;
            text-align: justify;
        }

        /* Compact table for level descriptions (space-efficient) */
        .compact-desc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
            margin-top: 6px;
        }
        .compact-desc-table td {
            border: 1px solid #d1e9ff;
            padding: 4px 6px;
            vertical-align: top;
        }
        .compact-desc-table .col-level {
            width: 36%;
            white-space: nowrap;
            font-weight: bold;
            color: #003366;
        }

        /* ----- CSS BARU UNTUK HISTORY TABLE (Layout Fixed + Persentase) ----- */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt; /* (PERUBAHAN) Diubah dari 12pt ke 10pt */
            table-layout: fixed; /* (PERUBAHAN) Kembali ke 'fixed' untuk kontrol penuh */
            page-break-inside: auto;
            margin: 10px 0 20px 0;
            border: 1.0px solid #cccccc; /* Border luar tabel */
            word-wrap: break-word; /* Wrap teks panjang */
        }
        .history-table tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }
        .history-table td {
            padding: 6px; /* Padding sel data */
            border: 1.0px solid #cccccc;
            vertical-align: top; /* (PERUBAHAN) Kembali ke 'top' sebagai default */
            word-wrap: break-word; 
            overflow-wrap: break-word; 
            line-height: 1.4;
            text-align: left; /* Default rata kiri */
            box-sizing: border-box;
        }
        .history-table thead tr {
            background-color: #ecf0f1;
            border-bottom: 1.5px solid #b0bec5; /* Garis bawah header */
        }
        .history-table th {
            color: #34495e;
            font-weight: bold;
            padding: 8px 5px; /* Padding header */
            border-left: 1.0px solid #cccccc;
            border-right: 1.0px solid #cccccc;
            border-top: 1.0px solid #cccccc;
            text-align: center;
            vertical-align: middle;
            font-size: 10pt; /* (PERUBAHAN) Diubah dari 12pt ke 10pt */
            border-bottom: none; /* Hapus border bawah individual header */
            box-sizing: border-box;
            word-wrap: break-word; /* Wrap header jika terlalu panjang */
        }

        /* (PERUBAHAN) Lebar Kolom Diatur Ulang Menggunakan Persentase */
        
        .history-table th:nth-child(1), /* Pertanyaan */
        .history-table td:nth-child(1) {
            width: 66.2%; /* (PERUBAHAN) Diperlebar lagi */
            text-align: justify; /* Rata Kiri-Kanan */
            vertical-align: top; /* Tetap 'top' */
        }
        .history-table th:nth-child(2), /* Jawabanmu */
        .history-table td:nth-child(2) {
            width: 10.5%; /* (PERUBAHAN) Diperlebar */
            padding-left: 10px; 
            padding-right: 10px; 
            vertical-align: middle; /* (PERUBAHAN) Ditetapkan eksplisit */
        }
        .history-table th:nth-child(3), /* Jawaban Benar */
        .history-table td:nth-child(3) {
            width: 10.5%; /* (PERUBAHAN) Diperlebar */
            padding-left: 10px; 
            padding-right: 10px; 
            vertical-align: middle; /* (PERUBAHAN) Ditetapkan eksplisit */
        }
        .history-table th:nth-child(4), /* Tingkatan */
        .history-table td:nth-child(4) {
            width: 12%; /* (PERUBAHAN) Disesuaikan */
            text-align: center;
            vertical-align: middle; /* (PERUBAHAN) Ditetapkan eksplisit */
        }
        .history-table th:nth-child(5), /* Hasil */
        .history-table td:nth-child(5) {
            width: 0.8%; /* (PERUBAHAN) Diperkecil lagi */
            text-align: center;
            vertical-align: middle; /* (PERUBAHAN) Ditetapkan eksplisit */
            padding: 0 1px; /* Kompakkan ruang lebih */
            line-height: 1.0; /* Lebih padat */
            white-space: normal; /* Izinkan wrap jika perlu */
            font-size: 8pt; /* Lebih kecil */
        }
        /* ----- AKHIR CSS HISTORY TABLE ----- */


        .status-correct, .text-correct {
            color: #198754; /* Green */
            font-weight: bold;
        }
        .status-incorrect, .text-incorrect {
            color: #dc3545; /* Red */
            font-weight: bold;
        }

        .footer {
            text-align: center;
            font-size: 9pt;
            color: #7f8c8d;
            border-top: 1px solid #ecf0f1;
            padding-top: 15px;
            margin-top: 40px;
        }

        .page-break {
            page-break-before: always;
        }

        .recommendation-intro {
            background-color: #f8f9fa;
            border-left: 4px solid #003366;
            padding: 15px;
            margin: 15px 0;
            font-style: italic;
            line-height: 1.6;
            border-radius: 5px;
        }

        .recommendation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 11pt;
            page-break-inside: auto;
            table-layout: auto;
            line-height: 1.5;
        }

        .recommendation-table th {
            background-color: #ecf0f1;
            color: #34495e;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #cccccc;
            vertical-align: middle;
            font-size: 11pt;
        }

        .recommendation-table td {
            padding: 10px;
            border: 1px solid #cccccc;
            vertical-align: top;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 11pt;
            text-align: justify;
        }

        .recommendation-table tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        .recommendation-table tbody {
            page-break-inside: auto;
        }

        .recommendation-table .rec-number {
            width: 5%;
            text-align: center;
            font-weight: bold;
            background-color: #f8f9fa;
            vertical-align: middle;
            font-size: 11pt;
        }

        .recommendation-table td strong {
            color: #003366;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 5px;
            font-size: 11pt;
        }

        .recommendation-table td .activity-description {
            color: #444;
            line-height: 1.5;
            text-align: justify;
        }

        .recommendation-outro {
            background-color: #eef7ff;
            border: 1px solid #d1e9ff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            line-height: 1.6;
            font-style: italic;
        }

        .ai-recommendation-text {
            background-color: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
            font-size: 10pt;
            line-height: 1.7;
            text-align: justify;
        }

        .ai-recommendation-text ul,
        .ai-recommendation-text ol,
        .ai-recommendation-text li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .ai-recommendation-text p {
            margin: 0 0 15px 0;
            text-indent: 0;
        }

        .narrative-text {
            text-align: justify;
            margin-bottom: 15px;
            text-indent: 0;
        }

        .improvement-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 11pt;
            line-height: 1.5;
        }

        .improvement-table th {
            background-color: #ecf0f1;
            color: #34495e;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #cccccc;
            font-size: 11pt;
        }

        .improvement-table td {
            padding: 10px;
            border: 1px solid #cccccc;
            vertical-align: top;
            text-align: justify;
            line-height: 1.5;
            font-size: 11pt;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .improvement-table .number-cell {
            width: 5%;
            text-align: center;
            font-weight: bold;
            background-color: #f8f9fa;
            vertical-align: middle;
            font-size: 11pt;
        }

        .improvement-table .content-cell {
            width: 95%;
        }

        .question-preview {
            color: #333;
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .answer-comparison {
            color: #666;
            font-size: 11pt;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .analysis-content {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 11pt;
        }

        .explanation-box {
            color: #2e7d32;
            background-color: #f1f8f4;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #2e7d32;
            font-size: 11pt;
            line-height: 1.5;
        }

        .tip-box {
            color: #1976d2;
            background-color: #e3f2fd;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #1976d2;
            font-size: 11pt;
            line-height: 1.5;
        }

        .section-d-container {
            page-break-inside: avoid;
        }

        /* --- STYLING ALUR TES (DIHAPUS NAMUN STYLE DIBIARKAN JIKA DIPERLUKAN LAGI) --- */
        .path-container {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        .path-visual-container {
            display: -webkit-box; /* Flexbox for PDF */
            -webkit-box-orient: horizontal;
            -webkit-box-align: center; /* Vertically center items */
            flex-wrap: wrap; /* Allow wrapping */
            padding: 10px; /* Padding around the whole container */
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px; /* Rounded container */
            margin-top: 8px;
        }
        .path-step {
            display: inline-block; /* Use inline-block for wrapping */
            padding: 8px 14px; /* More padding */
            border-radius: 20px; /* Pill shape */
            font-size: 10pt; /* Larger font */
            font-family: 'Helvetica', 'Arial', sans-serif;
            font-weight: 500; /* Slightly bolder */
            border: 1px solid transparent; /* Start with transparent border */
            text-align: center;
            line-height: 1.4;
            margin: 4px; /* Spacing between pills */
        }
        .path-step .outcome-icon {
            font-weight: normal; /* Icon shouldn't be bold */
            margin-left: 5px;
            font-size: 10pt; /* Match font size */
        }
        
        /* --- Coloring the pills --- */
        .path-step.start {
            background-color: #6c757d; /* Grey */
            color: white;
            font-weight: bold;
        }
        .path-step.correct {
            background-color: #d1e7dd; /* Light green */
            border-color: #a3cfbb;
            color: #0f5132; /* Dark green */
        }
        .path-step.incorrect {
            background-color: #f8d7da; /* Light red */
            border-color: #f1aeae;
            color: #58151c; /* Dark red */
        }
        .path-step.diagnosis {
            background-color: #003366; /* Dark Blue (match header) */
            color: white;
            font-weight: bold;
            padding: 8px 16px;
        }
        .path-step.summary {
            background-color: #fff3cd; /* Light yellow */
            border-color: #ffe69c;
            color: #664d03; /* Dark yellow */
            font-weight: bold;
        }
        .path-step.pending {
            background-color: #fefefe;
            border-color: #ced4da;
            color: #6c757d;
            font-style: italic;
        }

        /* --- The Connector --- */
        .path-connector {
            display: inline-block;
            color: #adb5bd; /* Lighter grey */
            font-size: 14pt; /* Bigger arrow */
            font-weight: bold;
            margin: 0 4px;
            vertical-align: middle;
        }

        /* Hide old styles if they exist */
        .path-flow, .path-node, .path-arrow {
            display: none !important;
        }
        /* --- AKHIR STYLING ALUR TES --- */

        .stage-summary-table {
            display: none;
        }

    </style>
</head>
<body>
    <div class="report-header">
        <h1>Laporan Hasil Tes Diagnostik</h1>
    </div>

    <div class="page-container">
        <div class="report-date">
            Tanggal Laporan: {{ result.updated_at.strftime('%d %B %Y') if result.updated_at else now().strftime('%d %B %Y') }}
        </div>

        <table class="student-info-table">
            <tr>
                <td style="width: 100%;">
                    <table class="student-info-table">
                        <tr><td class="info-label">Nama Siswa</td><td>:</td><td class="info-value">{{ student.nama }}</td></tr>
                        <tr><td class="info-label">Kelas</td><td>:</td><td class="info-value">{{ student.kelas }}</td></tr>
                        <tr><td class="info-label">Materi Tes</td><td>:</td><td class="info-value">{{ collection.name }}</td></tr>
                        <tr><td class="info-label">Guru Pengampu</td><td>:</td><td class="info-value">{{ collection.guru.nama if collection and collection.guru else 'Nama Guru' }}</td></tr>
                    </table>
                </td>
            </tr>
        </table>
        <div class="section-title">A. Ringkasan Hasil Tes</div>
        <table class="summary-table">
             {% set level_descriptions = {
                 1: 'L1 - Awareness: Siswa mulai mengenal konsep dasar dan istilah teknologi.',
                 2: 'L2 - Literacy: Siswa dapat menggunakan dan menjelaskan alat/fitur dasar secara praktis.',
                 3: 'L3 - Capability: Siswa mampu menerapkan teknologi untuk menyelesaikan tugas dan memecahkan masalah sederhana.',
                 4: 'L4 - Creativity: Siswa mampu mengembangkan solusi kreatif dengan menggabungkan beberapa konsep teknologi.',
                 5: 'L5 - Criticism: Siswa mampu mengevaluasi, membandingkan dan mengkritisi penerapan teknologi secara mendalam.'
             } %}

             {# --- LOGIKA PENENTUAN LEVEL (v3 - Berdasarkan Capaian Benar Tertinggi) --- #}
             {% set display_text = '' %}
             {% set level_for_description = 1 %}
             {% set mst_state = mst_state if mst_state else {} %}
             {% set is_test_completed = mst_state.test_completed if mst_state.test_completed is defined else False %}
             {% set final_diagnosis_str = mst_state.final_diagnosis if mst_state.final_diagnosis else '' %}

             {% macro get_level_from_diagnosis(diagnosis_str) %}
                 {% set level_num = 1 %}
                 {% if diagnosis_str == '< L2' %}
                     {% set level_num = 1 %}
                 {% elif diagnosis_str and diagnosis_str.startswith('L') %}
                     {% set num_part = diagnosis_str[1:] %}
                     {% if num_part.isdigit() %}
                         {% set level_num = num_part|int %}
                     {% endif %}
                 {% endif %}
                 {{ level_num }}
             {% endmacro %}

             {# --- PERUBAHAN: Cari stage tertinggi DARI JAWABAN YANG BENAR --- #}
             {% set max_correct_stage = namespace(value=0) %}
             {% if answers and answers|length > 0 %}
                {% for ans in answers %}
                    {% if ans.is_correct %}
                        {% set current_stage = ans.stage|int if ans.stage else 0 %}
                        {% if current_stage > max_correct_stage.value %}
                            {% set max_correct_stage.value = current_stage %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
             {% endif %}
             
             {% if max_correct_stage.value > 0 %}
                {# Ditemukan jawaban benar, gunakan level tertinggi #}
                {% set level_for_description = max_correct_stage.value %}
                {% set diagnosis_level = get_level_from_diagnosis(final_diagnosis_str)|int %}
                
                {% if is_test_completed and final_diagnosis_str and diagnosis_level == level_for_description %}
                    {# Jika diagnosis akhir (misal L4) = capaian benar tertinggi (L4), tampilkan diagnosis #}
                    {% set display_text = final_diagnosis_str %}
                {% elif is_test_completed and final_diagnosis_str and diagnosis_level != level_for_description %}
                    {# Kasus: Diagnosis L3, tapi capaian benar L1. Tampilkan capaian benar. #}
                    {% set display_text = 'L' ~ level_for_description %}
                {% else %}
                    {# Jika tes belum selesai, tampilkan capaian benar #}
                    {% set display_text = 'L' ~ level_for_description %}
                {% endif %}
                
             {% elif is_test_completed and final_diagnosis_str %}
                {# Tidak ada jawaban benar, TAPI tes selesai (misal gagal L1 -> L2E -> STOP) #}
                {% set level_for_description = get_level_from_diagnosis(final_diagnosis_str)|int %}
                {% set display_text = final_diagnosis_str %}
             
             {% elif answers and answers|length > 0 %}
                 {# Fallback: Tes belum selesai, tidak ada jawaban benar. Tampilkan stage terakhir. #}
                 {% set last_answer = answers[-1] %}
                 {% set last_stage = last_answer.stage if last_answer.stage else 1 %}
                 {% set level_for_description = last_stage|int %}
                 {% set display_text = 'Tahap ' ~ level_for_description ~ ' (Belum Selesai)' %}
             
             {% else %}
                 {# Fallback: Belum mulai / Gagal L1 dan belum ada jawaban #}
                 {% set level_for_description = mst_state.current_stage|int if mst_state.current_stage else 1 %}
                 {% set display_text = 'Tahap 1 (Belum Dimulai)' %}
             {% endif %}
             {# --- AKHIR PERBAIKAN (v3) --- #}

             {% if level_for_description < 1 or level_for_description > 5 %}
                 {% set level_for_description = 1 %}
             {% endif %}
             {# --- AKHIR LOGIKA LAMA (v2) --- #}

            <!-- Row removed as requested: Tingkat Kemampuan Tercapai -->
            <tr>
                <td class="summary-label">Level Tercapai</td>
                <td class="summary-value">
                    {% if answers and answers|length > 0 %}
                        {% set achieved = namespace(nums=[]) %}
                        {% for ans in answers %}
                            {% if ans.is_correct %}
                                {% set stage_num = ans.stage|int if ans.stage else 0 %}
                                {% if stage_num > 0 and stage_num not in achieved.nums %}
                                    {% set _ = achieved.nums.append(stage_num) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% if achieved.nums|length > 0 %}
                            {% for n in achieved.nums|sort %}
                                L{{ n }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        {% else %}-{% endif %}
                    {% else %}-{% endif %}
                </td>
            </tr>
            <tr>
                <td class="summary-label">Akurasi Jawaban</td>
                <td class="summary-value">{{ "%.2f"|format(accuracy|float) }}%</td>
            </tr>
            <tr>
                <td class="summary-label">Detail Jawaban</td>
                <td class="summary-value" style="font-size: 11pt;">
                    <span class="text-correct">Tepat: {{ result.correct }}</span> |
                    <span class="text-incorrect">Kurang Tepat: {{ result.incorrect }}</span> |
                    Total: {{ total_questions }}
                </td>
            </tr>
        </table>
        <div class="description-box">
            <strong>Deskripsi Tingkat Kemampuan:</strong>
            {# Kumpulkan kembali level yang tercapai (jawaban benar) #}
            {% set achieved = namespace(nums=[]) %}
            {% if answers and answers|length > 0 %}
                {% for ans in answers %}
                    {% if ans.is_correct %}
                        {% set stage_num = ans.stage|int if ans.stage else 0 %}
                        {% if stage_num > 0 and stage_num not in achieved.nums %}
                            {% set _ = achieved.nums.append(stage_num) %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            <table class="compact-desc-table">
                <tbody>
                {% if achieved.nums|length > 0 %}
                    {% for n in achieved.nums|sort %}
                        {% set full = level_descriptions.get(n, 'Level tidak terdefinisi.') %}
                        {% set parts = full.split(':', 1) %}
                        <tr>
                            <td class="col-level">{{ parts[0] }}</td>
                            <td>{{ parts[1] if parts|length > 1 else '' }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    {% set full = level_descriptions.get(level_for_description, 'Level tidak terdefinisi.') %}
                    {% set parts = full.split(':', 1) %}
                    <tr>
                        <td class="col-level">{{ parts[0] }}</td>
                        <td>{{ parts[1] if parts|length > 1 else '' }}</td>
                    </tr>
                {% endif %}
                </tbody>
            </table>
        </div>

        <div class="page-break"></div>

        <div class="section-title">B. Riwayat Jawaban Siswa</div>
        <div class="history-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Pertanyaan</th>
                        <th>Jawabanmu</th>
                        <th>Jawaban Benar</th>
                        <th>Tingkatan</th>
                        <th>âœ“</th>
                    </tr>
                </thead>
                <tbody>
                    {% if answers and answers|length > 0 %}
                        {% for ans in answers %}
                        <tr>
                            <td>{{ ans.question }}</td>
                            <td>{{ ans.user_answer }}</td>
                            <td>{{ ans.correct_answer }}</td>
                             {% set stage_num = ans.stage if ans.stage else 0 %}
                             {% set difficulty = ans.difficulty if ans.difficulty else 'N/A' %}
                             {% set tingkatan_text = 'L' ~ stage_num ~ ' ' ~ difficulty if stage_num > 0 else 'N/A' %}
                            <td>{{ tingkatan_text }}</td>
                            <td>{% if ans.is_correct %}<span class="text-correct">âœ“</span>{% else %}<span class="text-incorrect">âœ—</span>{% endif %}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="5" style="text-align:center; color:#6c757d;">Riwayat jawaban tidak tersedia.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div class="section-d-container">
            
            <div class="section-title">C. Analisis Jawaban</div>
            
            {% set total_answered = result.correct + result.incorrect %}
            {% set accuracy_rate = (result.correct / total_answered * 100) if total_answered > 0 else 0 %}
            {% set incorrect_percentage = (result.incorrect / (result.correct + result.incorrect) * 100) if (result.correct + result.incorrect) > 0 else 0 %}

            {% if result.incorrect > 0 %}
            <div style="margin-top: 25px;">
                
                <table class="improvement-table">
                    <thead>
                        <tr>
                            <th class="number-header" style="width: 5%; text-align: center;">No</th>
                            <th style="width: 95%; text-align: left;">Catatan Guru untuk Perbaikan</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set wrong_count = namespace(value=0) %}
                        {% for answer in answers %}
                            {% if not answer.is_correct %}
                            {% set wrong_count.value = wrong_count.value + 1 %}
                            <tr>
                                <td class="number-cell">{{ wrong_count.value }}</td>
                                <td class="content-cell">
                                    <div class="question-preview">
                                        <strong>Pertanyaan:</strong> {{ answer.question }}
                                    </div>
                                    <div class="answer-comparison">
                                        <strong>Jawabanmu:</strong> {{ answer.user_answer }} |
                                        <strong>Jawaban Benar:</strong> {{ answer.correct_answer }}
                                    </div>
                                    <div class="analysis-content">
                                        {% set ans_stage = answer.stage if answer.stage else 0 %}
                                        {% set ans_level_num = 0 %}
                                        {% if ans_stage > 0 %}
                                            {% set ans_level_num = ans_stage %}
                                        {% endif %}

                                        {% if ans_level_num == 1 %}
                                        Kesalahan di Level 1 (Awareness): Konsep dasar atau istilah mungkin belum sepenuhnya dipahami. Perlu penguatan definisi dan contoh paling fundamental.
                                        {% elif ans_level_num == 2 %}
                                        Kesalahan di Level 2 (Literacy): Pemahaman dasar sudah ada, tetapi penerapan praktis atau penjelasan cara kerja masih perlu diasah. Latih menggunakan alat/fitur dasar.
                                        {% elif ans_level_num == 3 %}
                                        Kesalahan di Level 3 (Capability): Penerapan untuk tugas sederhana perlu ditingkatkan. Fokus pada langkah-langkah penyelesaian masalah praktis menggunakan teknologi.
                                        {% elif ans_level_num == 4 %}
                                        Kesalahan di Level 4 (Creativity): Menunjukkan tantangan dalam menggunakan teknologi secara inovatif atau menggabungkan konsep. Latih problem solving yang lebih terbuka.
                                        {% elif ans_level_num == 5 %}
                                        Kesalahan di Level 5 (Criticism): Kemampuan evaluasi dan analisis mendalam perlu ditingkatkan. Latih membandingkan solusi, mengidentifikasi kelebihan/kekurangan, dan memberi justifikasi.
                                        {% else %}
                                        Tingkatan tidak tercatat. Fokus pada pengulangan materi dan tanyakan guru jika ada bagian yang membingungkan.
                                        {% endif %}
                                    </div>

                                    {% if answer.explanation %}
                                    <div class="explanation-box">
                                        <strong>ðŸ“– Penjelasan:</strong> {{ answer.explanation }}
                                    </div>
                                    {% endif %}

                                    <div class="tip-box">
                                        <strong>ðŸ’¡ Tips Belajar:</strong>
                                        {% if answer.personalized_tip %}
                                            {{ answer.personalized_tip }}
                                        {% else %}
                                            Ulangi pembahasan topik ini sampai benar-benar paham, lalu coba variasi soal serupa untuk memastikan penguasaan konsep.
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="margin-top: 25px;">
                <div class="description-box" style="text-align: center; padding: 20px; background-color: #f0fdf4; border-color: #10b981;">
                    <strong>ðŸŽ‰ Luar Biasa! ðŸŽ‰</strong><br>
                    Semua jawaban Anda sudah benar. Tidak ada rekomendasi perbaikan yang diperlukan untuk tes ini.
                    <br>Pertahankan pemahaman Anda!
                </div>
            </div>
            {% endif %}
        </div>

        <div class="footer">
            <p>Laporan ini dibuat secara otomatis pada {{ now().strftime('%d %B %Y, %H:%M:%S') }}</p>
        </div>
    </div>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Siswa - Tes Diagnostik</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bs-primary-rgb: 13, 110, 253;
      --bs-body-font-family: 'Plus Jakarta Sans', sans-serif;
      --bs-body-bg: #f5f7fa;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --card-shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.12);
    }
    body {
      padding-top: 56px;
      background-color: var(--bs-body-bg);
      font-family: var(--bs-body-font-family);
    }
    .navbar {
      background-color: #0d6efd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .user-info {
      color: white;
      margin-right: 15px;
    }
    .page-header h1 {
      font-weight: 700;
      color: #343a40;
    }
    .section-title {
      font-weight: 600;
      color: #495057;
      padding-bottom: 8px;
      position: relative;
    }
    .stat-card {
      background-color: #fff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: var(--card-shadow);
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-shadow-hover);
    }
    .stat-card .icon-wrapper {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .stat-card .stat-value {
      font-size: 2rem;
      font-weight: 700;
    }
    .stat-card .stat-label {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .teacher-card {
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      height: 100%;
      border: none;
    }
    .teacher-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-shadow-hover);
    }
    .teacher-card .card-header {
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      border-bottom: none;
    }
    .collection-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      color: #212529;
    }
    .collection-item:hover {
      background-color: #e2e6ea;
      transform: scale(1.02);
    }
    .test-collection-container {
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    .workflow-card {
      background-color: #fff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: var(--card-shadow);
      height: 100%;
    }
    .workflow-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-shadow-hover);
    }
    .workflow-card .step-icon {
      font-size: 2.5rem;
      color: var(--bs-primary);
      margin-bottom: 1rem;
      display: inline-block;
    }
    .result-summary-card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .result-stat-item-large {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      background-color: var(--bs-primary-bg-subtle);
      color: var(--bs-primary);
      flex: 1;
      min-width: 120px;
    }
    .result-stat-item-large .value {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    .result-stat-item-large .label {
      font-size: 0.9rem;
      color: var(--bs-primary);
      opacity: 0.8;
    }
    .result-stat-item-large.correct {
      background-color: var(--bs-success-bg-subtle);
      color: var(--bs-success);
    }
    .result-stat-item-large.incorrect {
      background-color: var(--bs-danger-bg-subtle);
      color: var(--bs-danger);
    }
    .result-stat-item-large.accuracy {
      background-color: var(--bs-info-bg-subtle);
      color: var(--bs-info);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/DashboardSiswa" title="DIGIDAWS = DIagnostik cerdas Guru untuk Identifikasi Deteksi Awal kemampuan siswa dan Wawasan Sistematis">DIGIDAWS</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
        </ul>
        <div class="d-flex align-items-center">
          <span class="user-info">
            <i class="bi bi-person-circle"></i> {{ current_user.nama }} ({{ current_user.kelas }})
          </span>
          <a href="/logout" class="btn btn-outline-light ms-2">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container py-5">
    <div class="page-header mb-4">
      <h1 id="siswa-nama-header">Selamat Datang, {{ current_user.nama }}!</h1>
      <p class="text-muted">Ini adalah ringkasan aktivitas tes diagnostik Anda.</p>
    </div>

    <div id="statusMessage" class="mb-3"></div>

    <div class="alert alert-primary bg-primary-subtle border-0 mb-5">
      <h4 class="alert-heading"><i class="bi bi-info-circle-fill"></i> Halo Siswa Hebat!</h4>
      <p>Selamat datang di dasbor tes diagnostik. Di sini, Anda dapat melihat semua tes yang telah dibagikan oleh guru, mengerjakan tes, dan melihat kembali hasil tes yang sudah selesai untuk bahan belajar.</p>
      <hr>
      <p class="mb-0">Mari mulai perjalanan belajar Anda dan lihat sejauh mana pemahaman Anda!</p>
    </div>

    <div class="mb-5">
      <h3 class="section-title mb-4 text-center">Alur Pengerjaan Tes</h3>
      <div class="row g-4 text-center">
        <div class="col-md-4">
          <div class="card workflow-card">
            <div class="card-body">
              <i class="bi bi-cursor-fill step-icon"></i>
              <h5 class="card-title">1. Pilih Tes</h5>
              <p class="card-text text-muted">Cari dan pilih tes yang tersedia dari daftar guru di bawah ini. Klik tes yang ingin Anda kerjakan.</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card workflow-card">
            <div class="card-body">
              <i class="bi bi-pencil-square step-icon"></i>
              <h5 class="card-title">2. Kerjakan Soal</h5>
              <p class="card-text text-muted">Anda akan diarahkan ke halaman pengerjaan soal. Baca pertanyaan dengan teliti dan jawablah sebaik mungkin.</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card workflow-card">
            <div class="card-body">
              <i class="bi bi-clipboard-check-fill step-icon"></i>
              <h5 class="card-title">3. Lihat Hasil</h5>
              <p class="card-text text-muted">Setelah selesai, Anda dapat melihat hasil rinci, termasuk jawaban yang benar dan salah, serta penjelasannya.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <h3 class="section-title mb-3">Ringkasan Statistik</h3>
    <div class="row g-4 mb-5">
      <div class="col-md-6 col-lg-3">
        <div class="stat-card">
          <div class="icon-wrapper bg-primary bg-opacity-10 text-primary"><i class="bi bi-journal-text"></i></div>
          <div id="total-tes" class="stat-value">0</div>
          <div class="stat-label">Total Tes Diberikan</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="stat-card">
          <div class="icon-wrapper bg-success bg-opacity-10 text-success"><i class="bi bi-journal-check"></i></div>
          <div id="tes-selesai" class="stat-value">0</div>
          <div class="stat-label">Tes Selesai</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="stat-card">
          <div class="icon-wrapper bg-info bg-opacity-10 text-info"><i class="bi bi-check-circle"></i></div>
          <div id="jawaban-benar" class="stat-value">0</div>
          <div class="stat-label">Jawaban Tepat</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="stat-card">
          <div class="icon-wrapper bg-danger bg-opacity-10 text-danger"><i class="bi bi-x-circle"></i></div>
          <div id="jawaban-salah" class="stat-value">0</div>
          <div class="stat-label">Jawaban Kurang Tepat</div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h3 class="section-title mb-0">Tes Tersedia</h3>
      <div class="input-group" style="max-width: 350px;">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input type="text" id="search-input" class="form-control" placeholder="Cari guru atau nama tes...">
      </div>
    </div>

    <div id="teachers-container" class="row g-4">
      <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Memuat data guru dan tes...</p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const userId = "{{ current_user.id }}";
    let teachersData = [];

    // ### KODE PERBAIKAN ###

    // Fungsi ini dipanggil saat siswa mengklik sebuah tes di dashboard
    async function startTest(collectionId) {
        if (!collectionId) {
            Swal.fire('Error', 'ID koleksi tidak valid.', 'error');
            return;
        }
        
        Swal.fire({
            title: 'Memeriksa Status Tes...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
            allowEscapeKey: false
        });

        const isCompleted = await checkTestCompletionStatus(collectionId);
        
        if (!isCompleted) {
            Swal.close();
            Swal.fire({
                title: 'Mulai Tes',
                html: `
                  <div class="text-start">
                    <p><i class="bi bi-info-circle text-primary me-2"></i> Anda akan memulai tes diagnostik.</p>
                    <p><i class="bi bi-check-circle text-success me-2"></i> Pastikan Anda berada di tempat yang tenang.</p>
                    <p><strong>Apakah Anda siap untuk memulai tes?</strong></p>
                  </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Saya Siap',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#0d6efd'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/qna?collection_id=${collectionId}`;
                }
            });
        }
    }

    // Fungsi untuk memeriksa apakah tes sudah selesai
    async function checkTestCompletionStatus(collectionId) {
        try {
            const response = await fetch(`/api/siswa/test_status?collection_id=${collectionId}&user_id=${userId}&t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Error server: ${response.status}`);
            
            const data = await response.json();
            const currentLevel = parseInt(data.current_level || 0);
            const isCompleted = data.is_completed === true || [5, 6, 7].includes(currentLevel);
            
            if (isCompleted) {
                await showTestResultPopup(collectionId);
                return true;
            }
            return false;
        } catch (error) {
            console.error("Error memeriksa status tes:", error);
            Swal.fire('Error', 'Gagal memeriksa status tes. Coba lagi nanti.', 'error');
            return false;
        }
    }

    // Fungsi untuk menampilkan popup hasil jika tes sudah selesai
    async function showTestResultPopup(collectionId) {
        try {
            const response = await fetch(`/api/siswa/results/${collectionId}?user_id=${userId}`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();

            const correct = data.correct || 0;
            const incorrect = data.incorrect || 0;
            const total = correct + incorrect;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

            let modalContent = `
                <div class="result-summary-card mb-4">
                    <h5 class="text-center mb-3">Ringkasan Hasil Tes</h5>
                    <div class="d-flex justify-content-around align-items-center flex-wrap gap-3">
                        <div class="result-stat-item-large correct">
                            <div class="value">${correct}</div><div class="label">Benar</div>
                        </div>
                        <div class="result-stat-item-large incorrect">
                            <div class="value">${incorrect}</div><div class="label">Salah</div>
                        </div>
                        <div class="result-stat-item-large accuracy">
                            <div class="value">${accuracy}%</div><div class="label">Akurasi</div>
                        </div>
                    </div>
                    <div class="alert alert-success text-center mt-4 mb-0">
                        <i class="bi bi-award-fill me-2"></i> Anda telah menyelesaikan tes ini!
                    </div>
                </div>
                <p class="text-center">Untuk melihat detail jawaban Anda, klik tombol di bawah.</p>
            `;
            
            Swal.fire({
                title: 'Hasil Tes',
                html: modalContent,
                icon: 'info',
                confirmButtonText: 'Lihat Detail Hasil',
                showCancelButton: true,
                cancelButtonText: 'Tutup',
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/result?collection_id=${collectionId}`;
                }
            });
        } catch (error) {
            console.error("Error mengambil hasil tes:", error);
            Swal.fire('Error', 'Gagal memuat hasil tes: ' + error.message, 'error');
        }
    }

    // Fungsi untuk mengambil dan menampilkan daftar tes
    async function fetchAndDisplayTests() {
        const container = document.getElementById('teachers-container');
        try {
            const response = await fetch('/api/siswa/collections');
            if (!response.ok) throw new Error(`Gagal mengambil data dari server: ${response.status}`);
            
            const result = await response.json();

            if (result.success && result.teachers && result.teachers.length > 0) {
                teachersData = result.teachers; // Simpan data untuk pencarian
                renderTeachers(teachersData);
            } else {
                container.innerHTML = `
                  <div class="col-12">
                    <div class="card">
                      <div class="card-body empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>Belum Ada Tes Tersedia</h5>
                        <p class="text-muted">Guru belum membagikan tes apa pun kepada Anda.</p>
                      </div>
                    </div>
                  </div>`;
            }
        } catch (error) {
            console.error('Terjadi kesalahan:', error);
            container.innerHTML = `<div class="col-12"><div class="alert alert-danger">Gagal memuat tes. Coba refresh halaman.</div></div>`;
        }
    }

    // Fungsi untuk me-render kartu guru dan tes
    function renderTeachers(teachers) {
        const container = document.getElementById('teachers-container');
        container.innerHTML = ''; // Kosongkan container

        if (!teachers || teachers.length === 0) {
            container.innerHTML = `
              <div class="col-12">
                <div class="card">
                  <div class="card-body empty-state">
                    <i class="bi bi-search-heart"></i>
                    <h5>Tidak Ditemukan</h5>
                    <p class="text-muted">Tidak ada guru atau tes yang cocok dengan pencarian Anda.</p>
                  </div>
                </div>
              </div>`;
            return;
        }

        container.innerHTML = teachers.map(teacher => {
            const collections = teacher.collections || [];
            return `
              <div class="col-md-6 col-lg-4">
                <div class="card teacher-card h-100">
                  <div class="card-header bg-primary text-white">
                    <div>
                      <h5 class="mb-0">${teacher.nama}</h5>
                      <small class="text-light">${teacher.email}</small>
                    </div>
                  </div>
                  <div class="card-body">
                    <h6 class="border-bottom pb-2 mb-3">Tes Tersedia:</h6>
                    <div class="test-collection-container">
                      ${collections.length > 0 ? 
                          collections.map(collection => `
                            <div class="collection-item" onclick="startTest(${collection.id})">
                              <strong>${collection.name}</strong>
                            </div>
                          `).join('') 
                          : 
                          '<p class="text-center text-muted my-3">Tidak ada tes tersedia dari guru ini</p>'
                      }
                    </div>
                  </div>
                </div>
              </div>
            `;
        }).join('');
    }

    // Fungsi untuk menangani pencarian
    function handleSearch() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        if (!teachersData || teachersData.length === 0) return;

        const filteredTeachers = teachersData.map(teacher => {
            const teacherMatch = teacher.nama.toLowerCase().includes(searchTerm) || teacher.email.toLowerCase().includes(searchTerm);
            const filteredCollections = (teacher.collections || []).filter(collection => collection.name.toLowerCase().includes(searchTerm));
            
            if (teacherMatch) return teacher; // Jika nama/email guru cocok, tampilkan semua tesnya
            if (filteredCollections.length > 0) return { ...teacher, collections: filteredCollections }; // Jika hanya nama tes yang cocok
            return null;
        }).filter(Boolean); // Hapus hasil null
        
        renderTeachers(filteredTeachers);
    }
    
    // Fungsi untuk mengambil statistik
    async function fetchStatistics() {
        try {
            const response = await fetch(`/get_summary?user_id=${userId}`);
            if (!response.ok) throw new Error(`Error server: ${response.status}`);
            
            const data = await response.json();
            
            document.getElementById("total-tes").textContent = data.total_tests || 0;
            document.getElementById("tes-selesai").textContent = data.completed_tests || 0;
            document.getElementById("jawaban-benar").textContent = data.correct || 0;
            document.getElementById("jawaban-salah").textContent = data.incorrect || 0;
        } catch (error) {
            console.error("Gagal mengambil statistik:", error);
        }
    }

    // Menjalankan semuanya setelah halaman siap
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.getElementById('statusMessage').innerHTML = `<div class="alert alert-info d-flex align-items-center"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>Memuat data dashboard...</div>`;
            
            await fetchStatistics();
            await fetchAndDisplayTests();
            
            document.getElementById('statusMessage').innerHTML = '';
        } catch (error) {
            console.error("Error inisialisasi:", error);
            document.getElementById('statusMessage').innerHTML = `<div class="alert alert-danger">Gagal memuat data.</div>`;
        }
    });

  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hasil Tes Diagnostik</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Global Styles */
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 60px; /* Space for fixed navbar */
    }

    /* Navbar Styling */
    .navbar {
      background-color: #0d6efd; /* Bootstrap primary blue */
    }
    .navbar-brand {
      font-weight: bold;
    }
    .user-info {
      color: white;
      margin-right: 15px;
    }

    /* Card Base Styling */
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      overflow: hidden;
      margin-bottom: 25px;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .card-header {
      border-bottom: none;
      padding: 15px 20px;
      font-weight: bold;
    }

    /* Specific Card Colors */
    .summary-card {
      background-color: #0d6efd; /* Sama seperti warna header navbar */
      color: white;
    }
    .summary-card .card-header {
      background: rgba(0,0,0,0.1); /* Slightly transparent background for header */
    }
    .benar { color: #198754; font-weight: bold; } /* Green for tepat */
    .salah { color: #dc3545; font-weight: bold; } /* Red for kurang tepat */

    /* Chart Specific Styles */
    .chart-container {
      width: 100%;
      max-width: 300px; /* Limit chart size */
      margin: 0 auto;
      padding: 15px;
      height: 300px;
      position: relative;
    }
    .chart-explanation {
      color: #212529; /* Dark text color */
      background-color: #f8f9fa; /* Light background */
      border-radius: 5px;
      padding: 10px;
      margin-top: 15px;
      font-size: 0.9rem;
      border-left: 4px solid #0d6efd; /* Blue left border for emphasis */
    }

    /* Answer Card Styles in Modal */
    .answer-card {
      transition: all 0.3s ease;
      border-left: 5px solid #6c757d; /* Default gray border */
      background-color: white;
    }
    .answer-card.correct {
      border-left-color: #198754; /* Green border for correct answers */
    }
    .answer-card.incorrect {
      border-left-color: #dc3545; /* Red border for incorrect answers */
    }
    .answer-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Level Badge (currently not used in this HTML, but kept for consistency) */
    .level-badge {
      position: absolute;
      top: 15px;
      right: 15px;
    }

    /* Statistic Cards within Summary */
    .stat-card {
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      background: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6c757d;
    }
    .stat-explanation {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 5px;
    }

    /* Clickable Elements */
    .clickable {
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent; /* Default transparent border */
    }
    .clickable:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    .clickable.benar:hover {
      border-color: #198754; /* Green border on hover for correct */
    }
    .clickable.salah:hover {
      border-color: #dc3545; /* Red border on hover for incorrect */
    }

    /* Button Styling */
    .btn {
      border-radius: 50px; /* Pill-shaped buttons */
      padding: 10px 25px;
      font-weight: 600;
      letter-spacing: 0.5px;
      transition: all 0.3s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .btn-icon {
      margin-right: 8px;
    }

    /* Progress Bar Styling */
    .progress-container {
      margin: 20px 0;
    }
    .progress {
      height: 25px;
      border-radius: 50px;
      background-color: #e9ecef;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .progress-explanation {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
    }

    /* Badges */
    .badge {
      font-size: 85%;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px; /* Rounded badge corners */
    }
    /* Specific style for the current level badge */
    .current-level-badge-style {
      font-size: 16px;
      font-weight: bold;
      padding: 6px 12px;
    }


    /* Explanation Text Styling */
    .explanation-text {
      background-color: #f8f9fa;
      border-left: 4px solid #17a2b8; /* Cyan border */
      padding: 15px;
      border-radius: 0 8px 8px 0;
    }

    /* Answer Display in Modal */
    .answer-question {
      font-weight: 500;
      line-height: 1.5;
    }
    .answer-response {
      background-color: #f8f9fa;
      padding: 8px 15px;
      border-radius: 8px;
      margin-top: 8px;
      display: inline-block;
    }

    /* Level Path Visualization */
    .level-path {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .level-step {
      width: 14%; /* Distribute steps evenly */
      display: inline-block;
      text-align: center;
      position: relative;
    }
    .level-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 50%;
      right: -10px;
      width: 20px;
      height: 2px;
      background-color: #dee2e6; /* Line between steps */
    }
    .level-icon {
      width: 40px;
      height: 40px;
      line-height: 40px; /* Center text vertically */
      background-color: #e9ecef;
      border-radius: 50%;
      margin: 0 auto 8px;
    }
    .level-icon.active {
      background-color: #0d6efd; /* Active level color */
      color: white;
    }
    .level-icon.completed {
      background-color: #198754; /* Completed level color */
      color: white;
    }
    .level-explanation {
      background-color: rgba(13, 110, 253, 0.1); /* Light blue background */
      border-radius: 10px;
      padding: 10px 15px;
      margin-top: 15px;
      font-size: 0.9rem;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    /* Error Container */
    .error-container {
      padding: 20px;
      border-radius: 10px;
      background-color: #f8d7da; /* Light red background */
      border-left: 5px solid #dc3545; /* Red left border */
      margin-bottom: 20px;
    }
    .refresh-button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      margin-top: 10px;
    }

    /* Level Display (if used outside path) */
    .level-number-display {
    font-size: 28px;
    font-weight: bold;
    color: #212529; /* Dark text color */
    background-color: #f8f9fa; /* Light background */
    border: 2px solid #0d6efd; /* Blue border */
    border-radius: 12px;
    padding: 8px 16px;
    display: inline-block;
    margin-bottom: 15px;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    .level-top-display {
    font-size: 42px;
    font-weight: bold;
    color: #198754; /* Green color for better visibility */
    margin: 20px auto;
    text-align: center;
    display: block;
    }

    /* Modern Breadcrumb Styling */
    .modern-breadcrumb {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 15px;
      padding: 15px 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(13, 110, 253, 0.1);
      margin-bottom: 0;
      position: relative;
      overflow: hidden;
    }
    
    .modern-breadcrumb::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #0d6efd 0%, #20c997 50%, #fd7e14 100%);
    }

    .modern-breadcrumb .breadcrumb-item {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .modern-breadcrumb .breadcrumb-item + .breadcrumb-item::before {
      content: "";
      display: none;
    }

    .breadcrumb-link {
      color: #0d6efd;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      padding: 8px 15px;
      border-radius: 10px;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }

    .breadcrumb-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(13, 110, 253, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .breadcrumb-link:hover::before {
      left: 100%;
    }

    .breadcrumb-link:hover {
      color: #0b5ed7;
      background: rgba(13, 110, 253, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
    }

    .breadcrumb-link i {
      font-size: 1rem;
      transition: transform 0.3s ease;
    }

    .breadcrumb-link:hover i {
      transform: scale(1.1);
    }

    .modern-breadcrumb .breadcrumb-item.active {
      color: #495057;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      padding: 8px 15px;
      background: rgba(13, 110, 253, 0.05);
      border-radius: 10px;
      border-left: 3px solid #0d6efd;
    }

    .modern-breadcrumb .breadcrumb-item.active i {
      color: #0d6efd;
      font-size: 1rem;
    }

    /* Responsive breadcrumb */
    @media (max-width: 768px) {
      .modern-breadcrumb {
        padding: 12px 20px;
      }
      
      .breadcrumb-link span,
      .modern-breadcrumb .breadcrumb-item.active span {
        display: none;
      }
      
      .breadcrumb-link,
      .modern-breadcrumb .breadcrumb-item.active {
        padding: 8px 10px;
      }
    }

    /* Animation for breadcrumb on load */
    .modern-breadcrumb {
      animation: slideInDown 0.6s ease-out;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Modern Page Header Styling */
    .page-header {
      margin: 30px 0;
      animation: fadeInUp 0.8s ease-out;
      animation-delay: 0.2s;
      animation-fill-mode: both;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .page-title i {
      font-size: 2.2rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .page-subtitle {
      font-size: 1.1rem;
      font-weight: 400;
      margin-bottom: 0;
      opacity: 0.8;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive page header */
    @media (max-width: 768px) {
      .page-title {
        font-size: 2rem;
        text-align: center;
      }
      
      .page-title i {
        font-size: 1.8rem;
      }
      
      .page-subtitle {
        font-size: 1rem;
      }
    }

    @media (max-width: 576px) {
      .page-title {
        font-size: 1.75rem;
        flex-direction: column;
        gap: 10px;
      }
      
      .page-subtitle {
        font-size: 0.9rem;
        padding: 0 15px;
      }
    }

    /* Achievement Analysis Styles */
    .level-achievement-display {
      animation: bounceIn 0.8s ease-out;
    }

    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .strength-analysis, .improvement-analysis, .next-steps {
      animation: fadeInUp 0.6s ease-out;
      animation-fill-mode: both;
    }

    .strength-analysis {
      animation-delay: 0.2s;
    }

    .improvement-analysis {
      animation-delay: 0.4s;
    }

    .next-steps {
      animation-delay: 0.6s;
    }

    /* Achievement card hover effects */
    .achievement-analysis-container .card {
      transition: all 0.3s ease;
    }

    .achievement-analysis-container .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    /* Recommendation list styling */
    #recommendation-list {
      list-style: none;
      padding-left: 0;
    }

    #recommendation-list li {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #0d6efd;
      transition: all 0.3s ease;
    }

    #recommendation-list li:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 1);
    }

    /* Progress bar styling for achievement analysis */
    .progress-bar {
      transition: width 1.2s ease-out;
    }

    /* Badge hover effects in achievement analysis */
    .badge {
      transition: all 0.3s ease;
    }

    .badge:hover {
      transform: scale(1.1);
    }

    /* Card border animations for achievement analysis */
    .card.border-success, .card.border-warning, .card.border-primary, .card.border-info {
      border-width: 2px !important;
      transition: all 0.3s ease;
    }

    .card.border-success:hover {
      border-color: #198754 !important;
      box-shadow: 0 0 20px rgba(25, 135, 84, 0.2);
    }

    .card.border-warning:hover {
      border-color: #dc3545 !important;
      box-shadow: 0 0 20px rgba(220, 53, 69, 0.2);
    }

    .card.border-primary:hover {
      border-color: #0d6efd !important;
      box-shadow: 0 0 20px rgba(13, 110, 253, 0.2);
    }

    .card.border-info:hover {
      border-color: #0dcaf0 !important;
      box-shadow: 0 0 20px rgba(13, 202, 240, 0.2);
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
  <a class="navbar-brand" href="/DashboardSiswa" title="DIGIDAWS = DIagnostik cerdas Guru untuk Identifikasi Deteksi Awal kemampuan siswa dan Wawasan Sistematis">DIGIDAWS</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
        </ul>
        <div class="d-flex align-items-center">
          <span class="user-info">
            <i class="bi bi-person-circle"></i> {{ current_user.nama }} ({{ current_user.kelas }})
          </span>
          <a href="/logout" class="btn btn-outline-light ms-2">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container mt-4">
    <!-- Modern Breadcrumb navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb modern-breadcrumb">
        <li class="breadcrumb-item">
          <a href="/DashboardSiswa" class="breadcrumb-link">
            <i class="bi bi-house-door me-1"></i>
            <span>Beranda</span>
          </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          <i class="bi bi-clipboard-data me-1"></i>
          <span>Hasil Tes</span>
        </li>
      </ol>
    </nav>

    <div class="page-header text-center mb-4">
      <h1 class="page-title">
        <i class="bi bi-clipboard-data me-2 text-primary"></i>
        Hasil Tes Diagnostik
      </h1>
      <p class="page-subtitle text-muted">Ringkasan lengkap hasil tes diagnostik Anda</p>
    </div>
    
    <!-- Error container (hidden by default) -->
    <div class="error-container" id="errorContainer" style="display: none;">
      <h5><i class="bi bi-exclamation-triangle me-2"></i>Terjadi Masalah dengan Data</h5>
      <p id="errorMessage">Terdapat ketidaksesuaian data pada hasil tes Anda.</p>
      <button class="refresh-button" id="refreshDataButton">
        <i class="bi bi-arrow-clockwise me-2"></i>Perbaiki Data
      </button>
    </div>
    
    <!-- MST Path Visualization -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Alur Progres Tes MST (Multistage Adaptive Test)</h5>
      </div>
      <div class="card-body">
        <!-- MST Horizontal Diagram -->
        <div class="mst-diagram-container mb-4">
          <div class="mst-flow">
            <!-- Stage I -->
            <div class="mst-stage" id="mst-stage-1">
              <div class="stage-header">Stage I</div>
              <div class="level-node" id="level-node-1">1</div>
            </div>
            
            <!-- Transition Line 1 -->
            <div class="transition-line"></div>
            
            <!-- Stage II -->
            <div class="mst-stage" id="mst-stage-2">
              <div class="stage-header">Stage II</div>
              <div class="level-node" id="level-node-2">2</div>
            </div>
            
            <!-- Transition Line 2 -->
            <div class="transition-line"></div>
            
            <!-- Stage III -->
            <div class="mst-stage-split">
              <div class="mst-stage upper-path" id="mst-stage-3-upper">
                <div class="stage-header">Stage III</div>
                <div class="level-node" id="level-node-4">4</div>
              </div>
              <div class="mst-stage lower-path" id="mst-stage-3-lower">
                <div class="stage-header">Stage III</div>
                <div class="level-node" id="level-node-3">3</div>
              </div>
            </div>
            
            <!-- Transition Line 3 -->
            <div class="transition-line"></div>
            
            <!-- Stage IV -->
            <div class="mst-stage" id="mst-stage-4">
              <div class="stage-header">Stage IV</div>
              <div class="final-levels">
                <div class="level-node" id="level-node-7">7</div>
                <div class="level-node" id="level-node-6">6</div>
                <div class="level-node" id="level-node-5">5</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Explanation -->
        <div class="mst-explanation">
          <p><i class="bi bi-info-circle me-2"></i><strong class="text-dark">Level Terakhir yang Dicapai: <span id="current-level-text">{{ current_level }}</span></strong></p>
          
          <!-- Student Achievement Analysis -->
          <div class="achievement-analysis mb-4">
            <h6 class="text-success mb-3"><i class="bi bi-trophy me-2"></i>Analisis Pencapaian Anda</h6>
            <div class="narrative-description" id="narrative-description">
              <!-- Deskripsi naratif akan diisi oleh JavaScript -->
            </div>
          </div>
          

        </div>
      </div>
    </div>
    
    <!-- CSS untuk MST Diagram -->
    <style>
      .mst-diagram-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid rgba(0,0,0,0.1);
        overflow-x: auto;
        width: 100%;
        box-sizing: border-box;
      }
      
      .mst-flow {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        gap: 12px;
        flex-wrap: nowrap;
        min-height: 100px;
      }
      
      .mst-stage {
        background: #ffffff;
        border-radius: 12px;
        padding: 16px 12px;
        text-align: center;
        border: 2px solid #dee2e6;
        min-width: 90px;
        max-width: 140px;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .mst-stage.passed {
        background: #d1e7dd;
        border-color: #198754;
        box-shadow: 0 3px 8px rgba(25,135,84,0.2);
      }
      
      .transition-line {
        width: 30px;
        height: 3px;
        background: #dee2e6;
        position: relative;
        flex-shrink: 0;
        border-radius: 2px;
      }
      
      .transition-line::after {
        content: '';
        position: absolute;
        right: -4px;
        top: -2px;
        width: 0;
        height: 0;
        border-left: 6px solid #dee2e6;
        border-top: 3px solid transparent;
        border-bottom: 3px solid transparent;
      }
      
      .stage-header {
        font-size: 1rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 10px;
        text-align: center;
        letter-spacing: 0.5px;
      }
      
      .mst-stage.passed .stage-header {
        color: #198754;
        font-weight: 800;
      }
      
      .level-node {
        width: 40px;
        height: 40px;
        line-height: 40px;
        background: #6c757d;
        color: white;
        border-radius: 50%;
        font-weight: 700;
        margin: 0 auto;
        font-size: 1.1rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      }
      
      .mst-stage-split {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .upper-path {
        transform: translateY(-4px);
      }
      
      .lower-path {
        transform: translateY(4px);
      }
      
      .final-levels {
        display: flex;
        flex-direction: column;
        gap: 2px;
        align-items: center;
      }
      
      .final-levels .level-node {
        width: 36px;
        height: 36px;
        line-height: 36px;
        font-size: 1rem;
        margin: 2px auto;
      }
      
      .mst-explanation {
        background: rgba(13, 110, 253, 0.05);
        border-radius: 10px;
        padding: 20px;
        border-left: 4px solid #0d6efd;
      }
      
      .achievement-analysis {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.05) 0%, rgba(13, 110, 253, 0.05) 100%);
        border-radius: 10px;
        padding: 18px;
        border: 1px solid rgba(25, 135, 84, 0.2);
      }
      
      .narrative-description {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid rgba(0,0,0,0.1);
        line-height: 1.6;
        text-align: justify;
      }
      
      .narrative-description p {
        margin-bottom: 15px;
        color: #495057;
      }
      
      .mst-description {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border: 1px solid rgba(0,0,0,0.1);
      }
      
      .flow-description ol.list-styled {
        padding-left: 20px;
        margin-bottom: 15px;
      }
      
      .flow-description ol.list-styled li {
        margin-bottom: 8px;
        line-height: 1.5;
      }
      
      .sub-list {
        margin-top: 5px;
        padding-left: 15px;
      }
      
      .sub-list li {
        margin-bottom: 3px;
        font-size: 0.9rem;
      }
      
      .advantages .advantage-item {
        text-align: center;
        padding: 10px;
        background: #fff;
        border-radius: 6px;
        border: 1px solid rgba(0,0,0,0.1);
        height: 100%;
      }
      
      .advantages .advantage-item i {
        font-size: 1.2rem;
        margin-bottom: 5px;
        display: block;
      }
      
      .stage-legend {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(0,0,0,0.1);
      }
      
      .stage-explanation {
        text-align: center;
        padding: 10px 8px;
        border-radius: 8px;
        font-size: 0.8rem;
        border: 1px solid rgba(0,0,0,0.1);
        transition: all 0.2s ease;
      }
      
      .stage-explanation:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .stage-1-bg { background-color: rgba(25, 135, 84, 0.1); }
      .stage-2-bg { background-color: rgba(13, 110, 253, 0.1); }
      .stage-3-bg { background-color: rgba(253, 126, 20, 0.1); }
      .stage-4-bg { background-color: rgba(111, 66, 193, 0.1); }
      
      /* Responsive Design */
      @media (max-width: 768px) {
        .mst-diagram-container {
          padding: 15px;
          overflow-x: auto;
        }
        
        .mst-flow {
          gap: 8px;
          min-width: 450px;
          min-height: 85px;
        }
        
        .mst-stage {
          min-width: 75px;
          max-width: 115px;
          padding: 12px 8px;
        }
        
        .transition-line {
          width: 25px;
        }
        
        .level-node {
          width: 34px;
          height: 34px;
          line-height: 34px;
          font-size: 1rem;
        }
        
        .stage-header {
          font-size: 0.9rem;
        }
        
        .final-levels .level-node {
          width: 30px;
          height: 30px;
          line-height: 30px;
          font-size: 0.9rem;
        }
      }
      
      @media (max-width: 576px) {
        .mst-diagram-container {
          padding: 12px;
        }
        
        .mst-flow {
          min-width: 380px;
          gap: 6px;
          min-height: 75px;
        }
        
        .mst-stage {
          min-width: 65px;
          max-width: 95px;
          padding: 10px 6px;
        }
        
        .transition-line {
          width: 20px;
        }
        
        .level-node {
          width: 30px;
          height: 30px;
          line-height: 30px;
          font-size: 0.9rem;
        }
        
        .stage-header {
          font-size: 0.8rem;
        }
        
        .final-levels .level-node {
          width: 26px;
          height: 26px;
          line-height: 26px;
          font-size: 0.8rem;
        }
      }
    </style>
    
    <!-- Card untuk ringkasan hasil -->
    <div class="card summary-card mb-4">
      <div class="card-header">
        <h3><i class="bi bi-clipboard-data me-2"></i>Ringkasan Hasil</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <div class="stat-card mb-3 clickable" onclick="showAnswersModal('correct')">
              <div class="stat-label">Jawaban Tepat</div>
              <div class="stat-value benar" id="correct-value">{{ correct }}</div>
              <div class="small">Soal dijawab dengan tepat</div>
              <div class="stat-explanation"><i class="bi bi-hand-index-thumb"></i> Klik untuk melihat detail jawaban tepat</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card mb-3 clickable" onclick="showAnswersModal('incorrect')">
              <div class="stat-label">Jawaban Kurang Tepat</div>
              <div class="stat-value salah" id="incorrect-value">{{ incorrect }}</div>
              <div class="small">Soal dijawab kurang tepat</div>
              <div class="stat-explanation"><i class="bi bi-hand-index-thumb"></i> Klik untuk melihat detail jawaban kurang tepat</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card mb-3">
              <div class="stat-label">Akurasi</div>
              <div class="stat-value text-primary" id="accuracy-value">{{ accuracy }}%</div>
              <div class="small">Tingkat ketepatan jawaban</div>
              <div class="stat-explanation">Persentase jawaban tepat dari total soal</div>
            </div>
          </div>
        </div>
        
        <div class="row mt-3">
          <div class="col-md-7">
            <div class="card h-100">
              <div class="card-body">
                <p>
                  <strong class="text-dark">Level Terakhir yang Dicapai:</strong> 
                  <span class="badge bg-light text-dark border border-primary current-level-badge-style" 
                        id="current-level-badge">{{ current_level }}</span>
                </p>
                <!-- Progress bar with explanation -->
                <div class="progress-container">
                  <label><strong>Performa Jawaban:</strong></label>
                  <div class="progress">
                    <div id="correct-progress" class="progress-bar" role="progressbar" 
                        style="background-color: #198754;" aria-valuemin="0" aria-valuemax="100">
                      <span id="correct-percent">0%</span>
                    </div>
                    <div id="incorrect-progress" class="progress-bar" role="progressbar" 
                        style="background-color: #dc3545;" aria-valuemin="0" aria-valuemax="100">
                      <span id="incorrect-percent">0%</span>
                    </div>
                  </div>
                  <div class="progress-explanation">
                    <i class="bi bi-info-circle me-1"></i> Diagram di atas menunjukkan perbandingan jawaban tepat (<span style="color: #198754; font-weight: bold;">hijau</span>) dan kurang tepat (<span style="color: #dc3545; font-weight: bold;">merah</span>) dari semua soal yang telah Anda kerjakan.
                  </div>
                </div>
                
                <!-- Badges for additional information -->
                <div class="mt-4">
                  <p><strong>Statistik Lanjutan:</strong></p>
                  <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-info" id="total-questions">Total Soal: {{ correct + incorrect }}</span>
                    <span class="badge bg-secondary" id="collection-name">Koleksi: {{ collection_name if collection_name else 'N/A' }}</span>
                    
                  </div>
                </div>
                
                <!-- Action buttons -->
                <div class="mt-4">
                  <a href="/DashboardSiswa" class="btn btn-outline-primary">
                    <i class="bi bi-grid btn-icon"></i>Kembali ke Dashboard
                  </a>
                  <button id="exportPdfBtn" class="btn btn-danger">
                    <i class="bi bi-file-pdf btn-icon"></i>Export ke PDF
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="card h-100">
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="resultChart"></canvas>
                </div>
                <div class="chart-explanation">
                  <strong>Diagram Donat:</strong> Diagram ini menunjukkan perbandingan persentase jawaban tepat (hijau) dan jawaban kurang tepat (merah) dari keseluruhan tes yang telah Anda kerjakan. Visualisasi berbentuk donat ini memudahkan Anda untuk melihat proporsi jawaban secara visual.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Analisis Pencapaian -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h3><i class="bi bi-trophy me-2"></i>Analisis Pencapaian Anda</h3>
      </div>
      <div class="card-body">
        <div id="achievement-analysis-container">
          <!-- Achievement analysis akan diisi secara dinamis -->
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Memuat analisis pencapaian...</span>
            </div>
            <p class="mt-2">Menganalisis hasil tes Anda...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Rekomendasi -->
    <div class="card mb-5">
      <div class="card-header bg-white">
        <h3><i class="bi bi-lightbulb me-2"></i>Bantuan Belajar untuk Anda</h3>
      </div>
      <div class="card-body">
        <div class="alert alert-primary">
          <h5><i class="bi bi-mortarboard me-2"></i>Saran Pembelajaran</h5>
          <p>Berdasarkan hasil tes diagnostik Anda, berikut bantuan belajar yang sesuai dengan kemampuan Anda:</p>
          <ul id="recommendation-list">
            <li>Sedang memuat bantuan belajar...</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal untuk menampilkan jawaban -->
  <div class="modal fade" id="answersModal" tabindex="-1" aria-labelledby="answersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="answersModalLabel">Riwayat Jawaban</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="answersModalBody">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Memuat data jawaban...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Directly inject values from Flask backend for robustness
    const userId = parseInt("{{ current_user.id }}") || null;
    const collectionId = parseInt("{{ collection_id }}") || null;

    // Log for debugging
    console.log("Parsed userId:", userId);
    console.log("Parsed collectionId:", collectionId);

    let hasDataError = false; // Flag untuk menandai adanya kesalahan data
    let allAnswers = []; // Variable untuk menyimpan semua jawaban
    let questionLevelMap = {}; // Map untuk menyimpan ID soal -> level
    let collectionQuestions = []; // Array untuk menyimpan data lengkap soal dari koleksi
    let collectionInfo = {}; // Object untuk menyimpan informasi koleksi
    
    // Setup chart and visualizations
    document.addEventListener('DOMContentLoaded', function() {
      // Aktifkan tombol ekspor PDF secara independen (tidak menunggu inisialisasi data)
      setupExportButtons();
      
      // Inisialisasi
      initResultPage().catch(error => {
        console.error("Terjadi kesalahan saat inisialisasi halaman:", error);
        showError("Terjadi kesalahan saat memuat data hasil. Tombol export tetap dapat digunakan.");
        showLoading(false);
      });
      
      // Setup refresh button
      const refreshButton = document.getElementById('refreshDataButton');
      if (refreshButton) {
        refreshButton.addEventListener('click', async function() {
          await forceRefreshData();
        });
      }
    });
    
    // Fungsi untuk mengambil informasi koleksi
    async function fetchCollectionInfo() {
      if (!collectionId) {
        console.error("fetchCollectionInfo: collectionId tidak valid.");
        return;
      }

      try {
        const response = await fetch(`/api/collections/${collectionId}`);
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            collectionInfo = data.data;
            console.log("Informasi koleksi berhasil dimuat:", collectionInfo);
          }
        }
      } catch (error) {
        console.warn("Gagal mengambil informasi koleksi:", error);
      }
    }

    // Fungsi untuk mengambil data soal dan level dari server
    async function fetchQuestionData() {
      // Only fetch if userId is valid
      if (userId === null || collectionId === null) {
        console.error("fetchQuestionData: userId atau collectionId tidak valid. Tidak dapat mengambil data soal.");
        return;
      }

      try {
        console.log("Mengambil data soal dari database...");
        // Ambil informasi koleksi terlebih dahulu
        await fetchCollectionInfo();
        let successful = false;
        
        // Coba menggunakan endpoint koleksi terlebih dahulu
        try {
          const response = await fetch(`/api/collections/${collectionId}/questions`);
          
          if (response.ok) {
            const data = await response.json();
            processQuestionData(data);
            successful = true;
            console.log("Berhasil mengambil data soal dari /api/collections/${collectionId}/questions");
            return;
          } else {
            console.warn(`Endpoint /api/collections/${collectionId}/questions tidak tersedia (${response.status}). Mencoba endpoint alternatif...`);
          }
        } catch (err) {
          console.warn("Gagal mengakses endpoint collection questions:", err.message);
        }
        
        // Jika endpoint pertama gagal, coba dengan endpoint generic
        if (!successful) {
          try {
            const response = await fetch(`/api/get_questions`);
            
            if (response.ok) {
              const data = await response.json();
              processQuestionData(data);
              successful = true;
              console.log("Berhasil mengambil data soal dari /api/get_questions");
              return;
            } else {
              console.warn(`Endpoint /api/get_questions tidak tersedia (${response.status}).`);
            }
          } catch (err) {
            console.warn("Gagal mengakses endpoint get_questions:", err.message);
          }
        }

        // Jika kedua endpoint gagal, coba dengan endpoint collection detail
        if (!successful) {
          try {
            const response = await fetch(`/api/collections/${collectionId}`);
            
            if (response.ok) {
              const data = await response.json();
              if (data.questions && Array.isArray(data.questions)) {
                processQuestionData(data.questions);
                successful = true;
                console.log("Berhasil mengambil data soal dari /api/collections/${collectionId}");
                return;
              } else {
                console.warn("Data questions tidak ditemukan dalam response /api/collections/${collectionId}");
              }
            } else {
              console.warn(`Endpoint /api/collections/${collectionId} tidak tersedia (${response.status}).`);
            }
          } catch (err) {
            console.warn("Gagal mengakses endpoint collection detail:", err.message);
          }
        }
        
        // Jika semua endpoint gagal, beri pesan error
        if (!successful) {
          throw new Error("Tidak dapat mengambil data soal dari semua endpoint yang tersedia");
        }
      } catch (error) {
        console.error("Error mengambil data soal:", error);
        // Tetap lanjutkan eksekusi program meskipun gagal mengambil data soal
      }
    }
    
    // Fungsi untuk memproses data soal dari berbagai format API response
    function processQuestionData(data) {
      try {
        // Handle both API response formats
        if (data.success && Array.isArray(data.data)) {
          // Format /api/get_questions
          collectionQuestions = data.data;
          data.data.forEach(question => {
            questionLevelMap[question.id] = question.level;
          });
          console.log("Data soal lengkap berhasil dimuat", collectionQuestions);
          console.log("Peta soal ke level berhasil dibuat", questionLevelMap);
        } else if (Array.isArray(data)) {
          // Format /api/collections/${collectionId}/questions
          collectionQuestions = data;
          data.forEach(question => {
            questionLevelMap[question.id] = question.level;
          });
          console.log("Data soal lengkap berhasil dimuat", collectionQuestions);
          console.log("Peta soal ke level berhasil dibuat", questionLevelMap);
        } else {
          console.warn("Gagal membuat peta soal ke level, format data tidak dikenali:", data);
        }
      } catch (error) {
        console.error("Error memproses data soal:", error);
      }
    }
    
    async function initResultPage() {
      try {
        // Tampilkan loading overlay
        showLoading(true);

        // Check if IDs are valid before proceeding with fetches
        if (userId === null || collectionId === null) {
            showError("ID pengguna atau koleksi tidak tersedia. Pastikan Anda login dan mengakses halaman ini dengan benar.");
            showLoading(false);
            // Tetap setup tombol export (mereka akan menampilkan pesan error jika parameter tidak valid)
            setupExportButtons();
            return; // Stop initialization if IDs are invalid
        }
        
        // Cek dan perbaiki inkonsistensi data (jika ada)
        try {
          await fixStatisticsInconsistency();
        } catch (err) {
          console.warn("Gagal memperbaiki inkonsistensi data:", err.message);
          // Lanjutkan meskipun gagal
        }
        
        // Ambil riwayat jawaban terlebih dahulu (untuk memastikan data tersedia untuk export)
        try {
          await fetchAndCacheAnswerHistory();
          console.log("Riwayat jawaban berhasil di-cache untuk keperluan export");
        } catch (err) {
          console.warn("Gagal mengambil riwayat jawaban:", err.message);
          // Lanjutkan meskipun gagal
        }
        
        // Ambil data hasil tes
        let testData;
        try {
          testData = await fetchTestResultData();
          // Render visualisasi dan statistik
          renderResultPage(testData);
        } catch (err) {
          console.error("Gagal mengambil data hasil tes:", err.message);
          showError("Gagal mengambil data hasil tes. Tombol export tetap dapat digunakan meskipun data visual tidak dapat ditampilkan.");
          
          // Tetap sembunyikan loading meskipun gagal mendapatkan data visualisasi
          showLoading(false);
          
          // Pastikan tombol export tetap diaktifkan meskipun data visual gagal diambil
          setupExportButtons();
          return;
        }
        
        // Sembunyikan loading overlay
        showLoading(false);
      } catch (error) {
        console.error("Error initializing result page:", error);
        showLoading(false);
        showError("Terjadi kesalahan saat memuat hasil tes. Tombol export tetap dapat digunakan.");
        
        // Pastikan tombol export tetap diaktifkan meskipun ada error
        setupExportButtons();
      }
    }
    
    // Fungsi untuk menampilkan/menyembunyikan loading overlay
    function showLoading(show) {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
      }
    }
    
    // Fungsi untuk menampilkan pesan error
    function showError(message) {
      const errorContainer = document.getElementById('errorContainer');
      const errorMessage = document.getElementById('errorMessage');
      
      if (errorContainer && errorMessage) {
        errorMessage.textContent = message;
        errorContainer.style.display = 'block';
      } else {
        // Fallback if elements don't exist
        alert(message);
      }
    }
    
    // Fungsi untuk memperbaiki inkonsistensi data statistik
    async function fixStatisticsInconsistency() {
      // Only proceed if IDs are valid
      if (userId === null || collectionId === null) {
        console.error("fixStatisticsInconsistency: userId or collectionId is null. Cannot proceed.");
        return false;
      }

      try {
        console.log(`Memeriksa konsistensi data untuk koleksi: ${collectionId}`);
        
        // Panggil endpoint khusus untuk menyegarkan data jawaban
        const response = await fetch(`/api/siswa/refresh_answers/${collectionId}?user_id=${userId}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error(`Error memeriksa data: ${errorText}`);
          return false;
        }
        
        const result = await response.json();
        console.log("Hasil pemeriksaan data:", result);
        
        // Jika ada perubahan, tandai ada masalah data
        if (result.changes) {
          hasDataError = true;
          const oldCorrect = result.changes.old_correct || 0;
          const newCorrect = result.changes.new_correct || 0;
          const oldIncorrect = result.changes.old_incorrect || 0;
          const newIncorrect = result.changes.new_incorrect || 0;
          
          // Tampilkan pesan error jika ada perbedaan data
          if (oldCorrect !== newCorrect || oldIncorrect !== newIncorrect) {
            showError(`Terdapat perbedaan data. Data awal: Benar=${oldCorrect}, Salah=${oldIncorrect}. Data terkoreksi: Benar=${newCorrect}, Salah=${newIncorrect}.`);
          }
        }
        
        return result.success || false;
      } catch (error) {
        console.error("Error memperbaiki inkonsistensi:", error);
        return false;
      }
    }
    
    // Fungsi untuk memaksa refresh data
    async function forceRefreshData() {
      // Only proceed if IDs are valid
      if (userId === null || collectionId === null) {
        console.error("forceRefreshData: userId or collectionId is null. Cannot proceed.");
        showError("ID pengguna atau koleksi tidak tersedia. Tidak dapat memperbaiki data.");
        return;
      }

      try {
        showLoading(true);
        
        const response = await fetch(`/api/siswa/refresh_answers/${collectionId}?user_id=${userId}&force=true`);
        
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          // Reload halaman untuk menampilkan data yang sudah diperbaiki
          window.location.reload();
        } else {
          throw new Error(result.message || "Gagal memperbaiki data");
        }
      } catch (error) {
        console.error("Error refreshing data:", error);
        showLoading(false);
        showError(`Gagal memperbaiki data: ${error.message}`);
      }
    }
    
    // Fungsi untuk mengambil data hasil tes
    async function fetchTestResultData() {
      // Only proceed if IDs are valid
      if (userId === null || collectionId === null) {
        console.error("fetchTestResultData: userId or collectionId is null. Cannot fetch test data.");
        throw new Error("ID pengguna atau koleksi tidak tersedia.");
      }

      try {
        // Tambahkan timestamp untuk menghindari cache
        const timestamp = new Date().getTime();
        const url = `/api/siswa/results/${collectionId}?user_id=${userId}&t=${timestamp}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Data hasil tes:", data);
        
        if (!data.success && data.message) {
          throw new Error(data.message);
        }
        
        return data;
      } catch (error) {
        console.error("Error fetching test data:", error);
        throw error;
      }
    }
    
    // Fungsi untuk mengambil data siswa_answers langsung dari database
    async function fetchSiswaAnswers() {
      // Only proceed if IDs are valid
      if (userId === null || collectionId === null) {
        console.error("fetchSiswaAnswers: userId or collectionId is null. Cannot fetch student answers.");
        return null;
      }

      try {
        // Fetch data siswa_answers langsung dari database
        const timestamp = new Date().getTime();
        const url = `/api/siswa_answers?user_id=${userId}&collection_id=${collectionId}&t=${timestamp}`;
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const data = await response.json();
        return data.siswa_answers || [];
      } catch (error) {
        console.error("Error fetching siswa_answers:", error);
        return null;
      }
    }
    
    // Fungsi untuk mengambil dan menyimpan riwayat jawaban (tanpa menampilkannya)
    async function fetchAndCacheAnswerHistory() {
      // Only proceed if IDs are valid
      if (userId === null || collectionId === null) {
        console.error("fetchAndCacheAnswerHistory: userId or collectionId is null. Cannot fetch answer history.");
        return;
      }

      try {
        // Hanya ambil data, tapi tidak perlu menampilkan
        const timestamp = new Date().getTime();
        const url = `/api/siswa/results/${collectionId}?user_id=${userId}&t=${timestamp}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Riwayat jawaban disimpan:", data.answers);
        
        // Simpan semua jawaban untuk digunakan nanti
        allAnswers = data.answers || [];
        
        // Tambahkan informasi level ke jawaban jika tidak ada
        try {
          await enrichAnswersWithLevels(allAnswers);
        } catch (levelError) {
          console.error("Error saat menambahkan informasi level ke jawaban:", levelError);
          console.warn("Melanjutkan dengan data yang ada meskipun terjadi error pada enrichAnswersWithLevels");
        }
        
        // Update level path setelah data jawaban tersedia
        const currentLevelElement = document.getElementById('current-level-text');
        if (currentLevelElement) {
          const currentLevel = parseInt(currentLevelElement.textContent) || 1;
          updateLevelPath(currentLevel);
        }
        
      } catch (error) {
        console.error("Error fetching answer history:", error);
        // Tetap lanjutkan eksekusi program meskipun gagal mengambil riwayat jawaban
      }
    }
    
    // Fungsi untuk memperkaya data jawaban dengan informasi level
    async function enrichAnswersWithLevels(answers) {
      if (!answers || answers.length === 0) return;
      
      try {
        let levelFound = false;
        
        // Periksa terlebih dahulu apakah jawaban sudah memiliki informasi level
        const allAnswersHaveLevel = answers.every(answer => answer.level !== undefined && answer.level !== null);
        if (allAnswersHaveLevel) {
          console.log("Semua jawaban sudah memiliki informasi level");
          return; // Semua jawaban sudah memiliki level, tidak perlu melakukan apa-apa lagi
        }
        
        // Cek jika data level sudah tersimpan dalam questionLevelMap
        if (Object.keys(questionLevelMap).length > 0) {
          levelFound = true;
          console.log("Menggunakan data level yang sudah tersimpan di questionLevelMap");
        }
        // Jika questionLevelMap belum ada, coba ambil data soal dulu
        else {
          try {
            await fetchQuestionData();
            if (Object.keys(questionLevelMap).length > 0) {
              levelFound = true;
              console.log("Level berhasil diambil dari endpoint collections/questions");
            }
          } catch (err) {
            console.warn("Gagal mengambil data soal:", err.message);
          }
        }
        
        // Jika masih belum ada, coba ambil data siswa_answers langsung dari database
        if (!levelFound) {
          try {
            const siswaAnswers = await fetchSiswaAnswers();
            if (siswaAnswers && siswaAnswers.length > 0) {
              siswaAnswers.forEach(answer => {
                if (answer.level && answer.question_id) {
                  questionLevelMap[answer.question_id] = answer.level;
                  levelFound = true;
                }
              });
              if (levelFound) {
                console.log("Level berhasil diambil dari endpoint siswa_answers");
              }
            }
          } catch (err) {
            console.warn("Gagal mengambil data jawaban siswa:", err.message);
            // Lanjutkan meskipun gagal
          }
        }
        
        // Tambahkan informasi level ke jawaban
        let updatedCount = 0;
        answers.forEach(answer => {
          // Jika jawaban belum memiliki level tapi ada di questionLevelMap
          if ((!answer.level || answer.level === undefined) && answer.question_id && questionLevelMap[answer.question_id]) {
            answer.level = questionLevelMap[answer.question_id];
            updatedCount++;
          } 
          // Fallback: gunakan level default jika masih tidak ada
          else if (!answer.level || answer.level === undefined) {
            answer.level = answer.level || 3; // Default level 3 jika tidak ada informasi
            console.log(`Menggunakan level default (3) untuk pertanyaan ID: ${answer.question_id || 'unknown'}`);
          }
        });
        
        // Log hasil update
        if (updatedCount > 0) {
          console.log(`Berhasil menambahkan level ke ${updatedCount} jawaban`);
        }
        
        // Fallback: Jika masih tidak ada data level, lanjutkan dengan data yang ada
        if (!levelFound) {
          console.warn("Tidak dapat mengambil data level lengkap, beberapa jawaban mungkin menggunakan level default");
        }
      } catch (error) {
        console.error("Error enriching answers with levels:", error);
        // Pastikan fungsi tidak gagal total, tangkap error dan lanjutkan eksekusi
      }
    }
    
    // Fungsi untuk menampilkan modal jawaban
    function showAnswersModal(type) {
      // Set judul modal
      const modalTitle = document.getElementById('answersModalLabel');
      modalTitle.textContent = type === 'correct' ? 'Jawaban Tepat' : 'Jawaban Kurang Tepat';
      
      // Tampilkan loading
      const modalBody = document.getElementById('answersModalBody');
      modalBody.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Memuat data jawaban...</p>
        </div>
      `;
      
      // Tampilkan modal
      const answersModal = new bootstrap.Modal(document.getElementById('answersModal'));
      answersModal.show();
      
      // Filter jawaban berdasarkan tipe (benar/salah)
      if (allAnswers.length > 0) {
        // Jika data jawaban sudah tersedia, gunakan data yang ada
        renderFilteredAnswers(type);
      } else {
        // Jika belum, ambil data jawaban dari API
        fetchAndRenderFilteredAnswers(type);
      }
    }
    
    // Fungsi untuk mengambil dan menampilkan jawaban yang difilter
    async function fetchAndRenderFilteredAnswers(type) {
      // Only proceed if IDs are valid
      if (userId === null || collectionId === null) {
        console.error("fetchAndRenderFilteredAnswers: userId or collectionId is null. Cannot fetch and render answers.");
        const modalBody = document.getElementById('answersModalBody');
        modalBody.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>ID pengguna atau koleksi tidak tersedia. Tidak dapat memuat jawaban.
          </div>
        `;
        return;
      }

      try {
        const timestamp = new Date().getTime();
        const url = `/api/siswa/results/${collectionId}?user_id=${userId}&t=${timestamp}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Error server: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Detail struktur data jawaban:", data);
        
        if (data.answers && data.answers.length > 0) {
          console.log("Contoh objek jawaban pertama:", data.answers[0]);
        } else {
          console.log("Tidak ada jawaban dalam data");
        }
        
        // Simpan semua jawaban untuk digunakan nanti
        allAnswers = data.answers || [];
        
        // Tambahkan informasi level ke jawaban jika tidak ada
        await enrichAnswersWithLevels(allAnswers);
        
        // Render jawaban yang difilter
        renderFilteredAnswers(type);
        
      } catch (error) {
        console.error("Error fetching answers:", error);
        const modalBody = document.getElementById('answersModalBody');
        modalBody.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>Gagal memuat data jawaban: ${error.message}
          </div>
        `;
      }
    }
    
   // Fungsi untuk menampilkan jawaban yang difilter (dengan jawaban tepat untuk jawaban kurang tepat)
function renderFilteredAnswers(type) {
  const modalBody = document.getElementById('answersModalBody');
  
  // Filter jawaban berdasarkan tipe
  const isCorrect = type === 'correct';
  const filteredAnswers = allAnswers.filter(answer => answer.is_correct === isCorrect);
  
  if (filteredAnswers.length === 0) {
    modalBody.innerHTML = `
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>Tidak ada jawaban ${isCorrect ? 'tepat' : 'kurang tepat'} yang tersedia.
      </div>
    `;
    return;
  }
  
  // Render jawaban
  let answersHTML = '';
  
  filteredAnswers.forEach((answer, index) => {
    // Cek apakah ada jawaban tepat yang tersedia (untuk jawaban kurang tepat)
    const correctAnswer = answer.jawaban_benar || answer.correct_answer || '';
    
    answersHTML += `
      <div class="card answer-card mb-3 ${isCorrect ? 'correct' : 'incorrect'}">
        <div class="card-body">
          <h5 class="card-title">Pertanyaan:</h5>
          <p class="answer-question">${answer.question || 'Tidak tersedia'}</p>
          
          <h5 class="card-title mt-3">Jawaban Anda:</h5>
          <div class="answer-response ${isCorrect ? 'bg-success text-white' : 'bg-danger text-white'}">
            ${answer.user_answer || 'Tidak tersedia'}
          </div>
          
          ${!isCorrect && correctAnswer ? `
            <h5 class="card-title mt-3">Jawaban Tepat:</h5>
            <div class="answer-response bg-info text-white">
              ${correctAnswer}
            </div>
          ` : ''}
          
          ${answer.explanation ? `
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-info w-100" type="button" data-bs-toggle="collapse" data-bs-target="#modalExplanation${index}">
                <i class="bi bi-lightbulb me-1"></i>Lihat Penjelasan
              </button>
              <div class="collapse mt-2" id="modalExplanation${index}">
                <div class="explanation-text">
                  ${answer.explanation}
                </div>
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  modalBody.innerHTML = answersHTML;
}
    
    // Fungsi untuk merender halaman hasil
    function renderResultPage(data) {
      const ctx = document.getElementById('resultChart').getContext('2d');
      
      // Ambil data dari response API
      const correctValue = parseInt(data.correct || 0);
      const incorrectValue = parseInt(data.incorrect || 0);
      const totalValue = correctValue + incorrectValue;
      const currentLevel = parseInt(data.current_level || 1);
      
      // Hitung akurasi
      const accuracyValue = totalValue > 0 ? Math.round((correctValue / totalValue) * 100) : 0;
      
      // Update nilai statistik
      document.getElementById('correct-value').textContent = correctValue;
      document.getElementById('incorrect-value').textContent = incorrectValue;
      document.getElementById('accuracy-value').textContent = accuracyValue + '%';
      document.getElementById('total-questions').textContent = `Total Soal: ${totalValue}`;
      document.getElementById('current-level-badge').textContent = currentLevel;
      document.getElementById('current-level-text').textContent = currentLevel;
      
      // Hitung persentase untuk progress bar
      const correctPercent = totalValue > 0 ? Math.round((correctValue / totalValue) * 100) : 0;
      const incorrectPercent = totalValue > 0 ? 100 - correctPercent : 0;
      
      // Update progress bar dengan animasi halus
      const correctProgressBar = document.getElementById('correct-progress');
      const incorrectProgressBar = document.getElementById('incorrect-progress');
      
      // Set width awal ke 0 untuk animasi
      correctProgressBar.style.width = '0%';
      incorrectProgressBar.style.width = '0%';
      
      // Animasi ke nilai target setelah delay singkat
      setTimeout(() => {
        correctProgressBar.style.width = correctPercent + '%';
        incorrectProgressBar.style.width = incorrectPercent + '%';
      }, 300);
      
      document.getElementById('correct-percent').textContent = correctPercent + '%';
      document.getElementById('incorrect-percent').textContent = incorrectPercent + '%';
      
      // Konfigurasi dan render chart
      const resultChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Tepat', 'Kurang Tepat'],
          datasets: [{
            data: [correctValue, incorrectValue],
            backgroundColor: ['#198754', '#dc3545'],
            borderColor: ['#198754', '#dc3545'],
            borderWidth: 1,
            hoverOffset: 15
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: {
                  size: 14
                },
                padding: 15
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const percentage = Math.round((value / totalValue) * 100) || 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          },
          cutout: '65%',
          animation: {
            animateScale: true,
            animateRotate: true,
            duration: 1000
          }
        }
      });
      
      // Generate personalized recommendations
      generateRecommendations(correctValue, incorrectValue, currentLevel);
      
      // Perbarui visualisasi MST stages setelah data siap
      // Gunakan setTimeout untuk memastikan allAnswers sudah terisi
      setTimeout(() => {
        updateMSTStages(currentLevel);
        generateAchievementAnalysis(currentLevel);
        generateStudentFriendlyAnalysis(correctValue, incorrectValue, currentLevel);
      }, 100);
    }
    
    // Update MST stages visualization - hanya level yang dilalui yang hijau
    function updateMSTStages(currentLevel) {
      // Dapatkan level yang dilalui siswa dari riwayat jawaban
      const passedLevels = getPassedLevelsFromAnswers();
      
      console.log("Passed levels:", passedLevels);
      console.log("Current level:", currentLevel);
      
      // Reset semua level nodes ke state default (abu-abu)
      const allLevelNodes = ['level-node-1', 'level-node-2', 'level-node-3', 'level-node-4', 'level-node-5', 'level-node-6', 'level-node-7'];
      allLevelNodes.forEach(nodeId => {
        const levelNode = document.getElementById(nodeId);
        if (levelNode) {
          levelNode.style.background = '#6c757d'; // Abu-abu default
          levelNode.style.color = 'white';
        }
      });
      
      // Reset semua stage ke state default
      const allStages = ['mst-stage-1', 'mst-stage-2', 'mst-stage-3-upper', 'mst-stage-3-lower', 'mst-stage-4'];
      allStages.forEach(stageId => {
        const stageElement = document.getElementById(stageId);
        if (stageElement) {
          stageElement.classList.remove('passed');
        }
      });
      
      // Warnai hijau hanya level yang benar-benar dilalui siswa
      passedLevels.forEach(level => {
        const levelNode = document.getElementById(`level-node-${level}`);
        if (levelNode) {
          levelNode.style.background = '#198754'; // Hijau untuk level yang dilalui
          levelNode.style.color = 'white';
        }
        
        // Warnai stage yang sesuai jika ada level yang dilalui di dalamnya
        if (level === 1) {
          const stage1 = document.getElementById('mst-stage-1');
          if (stage1) stage1.classList.add('passed');
        }
        
        if (level === 2) {
          const stage2 = document.getElementById('mst-stage-2');
          if (stage2) stage2.classList.add('passed');
        }
        
        if (level === 3) {
          const stage3Lower = document.getElementById('mst-stage-3-lower');
          if (stage3Lower) stage3Lower.classList.add('passed');
        }
        
        if (level === 4) {
          const stage3Upper = document.getElementById('mst-stage-3-upper');
          if (stage3Upper) stage3Upper.classList.add('passed');
        }
        
        if ([5, 6, 7].includes(level)) {
          const stage4 = document.getElementById('mst-stage-4');
          if (stage4) stage4.classList.add('passed');
        }
      });
    }
    
    // Fungsi untuk mendapatkan level yang dilalui siswa dari riwayat jawaban
    function getPassedLevelsFromAnswers() {
      const passedLevels = new Set();
      
      // Jika ada data jawaban, ekstrak level dari jawaban
      if (allAnswers && allAnswers.length > 0) {
        allAnswers.forEach(answer => {
          if (answer.level && answer.level >= 1 && answer.level <= 7) {
            passedLevels.add(answer.level);
          }
        });
      }
      
      // Jika tidak ada data jawaban atau set kosong, fallback ke logic lama
      if (passedLevels.size === 0) {
        console.warn("Tidak ada data level dari jawaban, menggunakan fallback logic");
        // Fallback: asumsikan siswa melewati level 1 sampai current level
        for (let i = 1; i <= parseInt(document.getElementById('current-level-text').textContent) || 1; i++) {
          passedLevels.add(i);
        }
      }
      
      // Konversi Set ke Array dan sort
      return Array.from(passedLevels).sort((a, b) => a - b);
    }
    
    // Fungsi untuk menampilkan analisis pencapaian siswa dengan narasi deskriptif
    function generateAchievementAnalysis(currentLevel) {
      const detailedAnalysis = getDetailedAnswerAnalysis();
      const narrativeContainer = document.getElementById('narrative-description');
      
      if (!narrativeContainer) return;
      
      // Generate narrative description only
      generateNarrativeDescription(detailedAnalysis, currentLevel, narrativeContainer);
    }
    
    // Fungsi untuk mendapatkan analisis jawaban yang detail dengan informasi koleksi
    function getDetailedAnswerAnalysis() {
      const analysis = {
        correctLevels: [],
        incorrectLevels: [],
        totalQuestions: 0,
        correctAnswers: 0,
        accuracyRate: 0,
        levelPerformance: {},
        topicPerformance: {},
        collectionFocus: '',
        subjectAreas: [],
        difficultyDistribution: {},
        strengthAreas: [],
        challengeAreas: [],
        learningPattern: '',
        cognitiveProfile: ''
      };
      
      if (!allAnswers || allAnswers.length === 0) {
        return analysis;
      }

      // Analisis informasi koleksi
      if (collectionInfo.name) {
        analysis.collectionFocus = collectionInfo.name;
      }
      if (collectionInfo.description) {
        analysis.collectionDescription = collectionInfo.description;
      }
      
      // Analisis per level dan topic
      allAnswers.forEach(answer => {
        const level = answer.level;
        const isCorrect = answer.is_correct;
        const questionId = answer.question_id;
        
        analysis.totalQuestions++;
        if (isCorrect) {
          analysis.correctAnswers++;
          if (!analysis.correctLevels.includes(level)) {
            analysis.correctLevels.push(level);
          }
        } else {
          if (!analysis.incorrectLevels.includes(level)) {
            analysis.incorrectLevels.push(level);
          }
        }
        
        // Tracking per level
        if (!analysis.levelPerformance[level]) {
          analysis.levelPerformance[level] = { correct: 0, total: 0, topics: [], questions: [] };
        }
        analysis.levelPerformance[level].total++;
        if (isCorrect) {
          analysis.levelPerformance[level].correct++;
        }
        
        // Cari data soal yang lengkap dari collectionQuestions
        const questionData = collectionQuestions.find(q => q.id === questionId);
        if (questionData) {
          // Collect topics for analysis
          if (questionData.topic && !analysis.levelPerformance[level].topics.includes(questionData.topic)) {
            analysis.levelPerformance[level].topics.push(questionData.topic);
          }
          
          // Analisis per topik
          const topic = questionData.topic || 'Umum';
          if (!analysis.topicPerformance[topic]) {
            analysis.topicPerformance[topic] = { correct: 0, total: 0, levels: [] };
          }
          analysis.topicPerformance[topic].total++;
          if (isCorrect) {
            analysis.topicPerformance[topic].correct++;
          }
          if (!analysis.topicPerformance[topic].levels.includes(level)) {
            analysis.topicPerformance[topic].levels.push(level);
          }
          
          // Collect subject areas
          if (questionData.subject && !analysis.subjectAreas.includes(questionData.subject)) {
            analysis.subjectAreas.push(questionData.subject);
          }
          
          analysis.levelPerformance[level].questions.push({
            id: questionId,
            topic: questionData.topic,
            difficulty: questionData.difficulty,
            isCorrect: isCorrect
          });
        }
      });
      
      analysis.accuracyRate = analysis.totalQuestions > 0 ? 
        (analysis.correctAnswers / analysis.totalQuestions * 100).toFixed(1) : 0;
      
      // Sort levels
      analysis.correctLevels.sort((a, b) => a - b);
      analysis.incorrectLevels.sort((a, b) => a - b);
      
      // Simple learning pattern analysis
      const correctLevels = analysis.correctLevels;
      const incorrectLevels = analysis.incorrectLevels;
      
      if (correctLevels.some(l => l >= 4) && incorrectLevels.some(l => l <= 2)) {
        analysis.learningPattern = 'advanced_with_gaps';
      } else if (correctLevels.length > 0 && incorrectLevels.length > 0 && 
          Math.abs(Math.max(...correctLevels) - Math.min(...incorrectLevels)) > 2) {
        analysis.learningPattern = 'inconsistent_performance';
      } else if (correctLevels.length >= 3 && correctLevels.every((level, index) => 
          index === 0 || level >= correctLevels[index - 1])) {
        analysis.learningPattern = 'progressive_improvement';
      } else {
        analysis.learningPattern = 'developing';
      }
      
      return analysis;
    }
    
    // Fungsi untuk membuat deskripsi naratif yang sederhana dan deskriptif dengan konteks koleksi
    function generateNarrativeDescription(analysis, currentLevel, container) {
      let narrative = '';
      
      const correctLevels = analysis.correctLevels;
      const incorrectLevels = analysis.incorrectLevels;
      const accuracyRate = parseFloat(analysis.accuracyRate);
      const pathString = correctLevels.join('-');
      
      // Opening paragraph dengan konteks singkat
      if (analysis.collectionFocus) {
        narrative += `<p>Dalam tes diagnostik "<strong>${analysis.collectionFocus}</strong>", Anda telah menjalani penilaian bertingkat yang disesuaikan dengan kemampuan individual. Melalui jalur diagnostik ini, Anda berhasil mencapai level tertinggi ${currentLevel}. `;
      } else {
        narrative += `<p>Melalui tes diagnostik bertingkat yang adaptif, Anda berhasil mencapai level tertinggi ${currentLevel}. `;
      }
      
      if (correctLevels.length > 0) {
        narrative += `Anda berhasil menguasai level ${correctLevels.join(', ')}, menunjukkan kemampuan yang baik di area-area tersebut. `;
      }
      
      if (accuracyRate > 0) {
        narrative += `Secara keseluruhan, tingkat akurasi Anda mencapai ${accuracyRate}% dari seluruh soal yang dijawab.`;
      }
      narrative += `</p>`;
      
      // Topic and subject analysis
      if (Object.keys(analysis.topicPerformance).length > 0) {
        narrative += `<p>Analisis berdasarkan area konten menunjukkan variasi kemampuan Anda di berbagai topik. `;
        
        const strongTopics = [];
        const challengingTopics = [];
        
        Object.entries(analysis.topicPerformance).forEach(([topic, performance]) => {
          const accuracy = (performance.correct / performance.total * 100);
          if (accuracy >= 70) {
            strongTopics.push(topic);
          } else if (accuracy < 50) {
            challengingTopics.push(topic);
          }
        });
        
        if (strongTopics.length > 0) {
          narrative += `Anda menunjukkan penguasaan yang baik pada topik ${strongTopics.join(', ')}. `;
        }
        
        if (challengingTopics.length > 0) {
          narrative += `Sementara itu, topik ${challengingTopics.join(', ')} memberikan tantangan yang lebih besar dan menjadi area potensial untuk pengembangan lebih lanjut. `;
        }
        
        narrative += `Pola ini memberikan insight yang berharga tentang profil kekuatan akademik Anda yang spesifik pada area konten yang diujikan.`;
        narrative += `</p>`;
      }
      
      // Performance pattern analysis singkat
      if (correctLevels.length > 0 && incorrectLevels.length > 0) {
        narrative += `<p>Pola pencapaian Anda menunjukkan: `;
        
        // Advanced with gaps pattern
        if (correctLevels.some(l => l >= 4) && incorrectLevels.some(l => l <= 2)) {
          narrative += `kemampuan berpikir tingkat tinggi yang kuat, namun perlu penguatan di konsep fundamental untuk konsistensi optimal.`;
        }
        // Inconsistent performance
        else if (Math.abs(Math.max(...correctLevels) - Math.min(...incorrectLevels)) > 2) {
          narrative += `performa bervariasi dengan keunggulan di level ${Math.max(...correctLevels)} namun tantangan di level ${Math.min(...incorrectLevels)}, menunjukkan kekuatan spesifik yang dapat dikembangkan.`;
        }
        // Progressive improvement
        else if (correctLevels.every((level, index) => index === 0 || level >= correctLevels[index - 1])) {
          narrative += `progression sistematis dan terstruktur, menunjukkan proses pembelajaran yang sehat dan metodis.`;
        }
        // Mixed performance
        else {
          narrative += `profil kemampuan beragam dengan kekuatan dan area pengembangan tersebar, memberikan roadmap jelas untuk pembelajaran lanjut.`;
        }
        narrative += `</p>`;
      }
      
      // Learning insights singkat
      narrative += `<p>Berdasarkan hasil diagnostik pada "${analysis.collectionFocus || 'materi ini'}", `;
      
      if (correctLevels.includes(1) && correctLevels.includes(2)) {
        narrative += `kemampuan fundamental Anda sudah solid untuk eksplorasi yang lebih advanced. `;
      }
      
      if (correctLevels.some(l => l >= 5)) {
        narrative += `Pencapaian di level tinggi menunjukkan kemampuan berpikir kritis yang excellent. `;
      }
      
      if (incorrectLevels.length > 0) {
        narrative += `Area tantangan di level ${incorrectLevels.join(' dan ')} menjadi fokus pembelajaran selanjutnya.`;
      } else {
        narrative += `profil pembelajaran Anda menunjukkan konsistensi yang baik di semua level.`;
      }
      narrative += `</p>`;
      
      // Saran pengembangan singkat
      if (currentLevel < 7) {
        narrative += `<p><strong>Langkah Selanjutnya:</strong> `;
        
        if (analysis.learningPattern === 'advanced_with_gaps') {
          narrative += `Hubungkan konsep tinggi dengan fondasi dasar untuk pemahaman yang konsisten.`;
        } else if (analysis.learningPattern === 'inconsistent_performance') {
          narrative += `Identifikasi pola keberhasilan Anda dan terapkan ke area lain untuk konsistensi.`;
        } else {
          narrative += `Lanjutkan pembelajaran bertahap dengan penguatan sistematis sesuai kurikulum.`;
        }
        narrative += `</p>`;
      }
      
      container.innerHTML = narrative;
    }
    

    

    
    // Function to export results to Excel
function exportToExcel() {
  try {
    // Validasi parameter
    if (!userId || !collectionId) {
      Swal.fire({
        icon: 'error',
        title: 'Export Gagal',
        text: 'Parameter user atau koleksi tidak valid.',
        confirmButtonText: 'OK'
      });
      return;
    }
    
    showLoading(true);
    
    // Cek apakah ada data jawaban
    if (allAnswers.length === 0) {
      console.warn("Tidak ada data jawaban saat melakukan export Excel. Mencoba reload data terlebih dahulu...");
      
      // Coba ambil data jawaban secara singkat
      fetchAndCacheAnswerHistory()
        .catch(err => {
          console.warn("Gagal mengambil data jawaban:", err.message);
          console.warn("Melanjutkan export Excel meskipun tidak ada data jawaban lengkap");
        })
        .finally(() => {
          // Lanjutkan proses export Excel
          performExcelExport();
        });
    } else {
      // Langsung export jika data sudah ada
      performExcelExport();
    }
    
  } catch (error) {
    console.error("Error exporting to Excel:", error);
    showLoading(false);
    
    // Show error notification
    Swal.fire({
      icon: 'error',
      title: 'Export Gagal',
      text: 'Terjadi kesalahan saat mengexport data ke Excel: ' + error.message,
      confirmButtonText: 'OK'
    });
  }
}

// Fungsi untuk melakukan export Excel setelah persiapan data
function performExcelExport() {
  try {
    // Construct the URL with parameters
    const exportUrl = `/api/export_result_excel?user_id=${userId}&collection_id=${collectionId}`;
    
    // Tambahkan timestamp untuk menghindari cache
    const timestampedUrl = `${exportUrl}&t=${new Date().getTime()}`;
    
    // Create a hidden link element
    const link = document.createElement('a');
    link.href = timestampedUrl;
    link.style.display = 'none';
    
    // Append to body and trigger click
    document.body.appendChild(link);
    link.click();
    
    // Clean up
    setTimeout(() => {
      document.body.removeChild(link);
      showLoading(false);
    }, 2000);
    
  } catch (error) {
    console.error("Error performing Excel export:", error);
    showLoading(false);
    
    // Show error notification
    Swal.fire({
      icon: 'error',
      title: 'Export Gagal',
      text: 'Terjadi kesalahan saat mengexport data ke Excel: ' + error.message,
      confirmButtonText: 'OK'
    });
  }
}

// Event listener sudah ditangani di fungsi setupExportButtons()
    // Generate personalized recommendations dengan bahasa yang ramah siswa
    function generateRecommendations(correct, incorrect, currentLevel) {
      const recommendationList = document.getElementById('recommendation-list');
      if (!recommendationList) return;
      
      const recommendations = [];
      const total = correct + incorrect;
      const accuracy = total > 0 ? (correct / total) * 100 : 0;
      
      // Clear existing recommendations
      recommendationList.innerHTML = '';
      
      // Add recommendations based on performance dengan bahasa yang ramah
      if (accuracy < 50) {
        recommendations.push({
          icon: '📚',
          text: 'Mulai dengan memperkuat konsep dasar. Jangan terburu-buru, belajar pelan tapi pasti!',
          type: 'primary'
        });
        recommendations.push({
          icon: '🤝', 
          text: 'Jangan malu untuk bertanya pada guru atau teman. Mereka pasti senang membantu!',
          type: 'info'
        });
        recommendations.push({
          icon: '🎯',
          text: 'Coba gunakan cara belajar yang kamu suka: video, gambar, atau praktek langsung',
          type: 'success'
        });
        recommendations.push({
          icon: '⏰',
          text: 'Buat jadwal belajar rutin 15-30 menit setiap hari. Konsistensi adalah kunci!',
          type: 'warning'
        });
      } else if (accuracy < 75) {
        recommendations.push({
          icon: '🚀',
          text: 'Kamu sudah di jalur yang tepat! Tingkatkan dengan banyak latihan soal variasi',
          type: 'success'
        });
        recommendations.push({
          icon: '🔍',
          text: 'Review jawaban yang salah dan pahami mengapa jawaban itu kurang tepat',
          type: 'info'
        });
        recommendations.push({
          icon: '📝',
          text: 'Buat catatan kecil untuk konsep-konsep yang masih membingungkan',
          type: 'primary'
        });
        recommendations.push({
          icon: '👥',
          text: 'Diskusi dengan teman sekelas bisa membantu melihat sudut pandang yang berbeda',
          type: 'secondary'
        });
      } else {
        recommendations.push({
          icon: '🌟',
          text: 'Luar biasa! Kamu sudah menguasai dengan baik. Saatnya eksplorasi yang lebih menantang!',
          type: 'success'
        });
        recommendations.push({
          icon: '🎓',
          text: 'Coba materi pengayaan atau ikuti olimpiade untuk mengasah kemampuan lebih jauh',
          type: 'primary'
        });
        recommendations.push({
          icon: '🤗',
          text: 'Berbagi ilmu dengan mengajari teman yang masih kesulitan. Teaching is learning!',
          type: 'info'
        });
        recommendations.push({
          icon: '📖',
          text: 'Eksplorasi topik-topik terkait yang mungkin menarik minatmu',
          type: 'warning'
        });
      }
      
      // Add level-specific recommendations
      if (currentLevel < 5) {
        recommendations.push({
          icon: '🎯',
          text: `Tantang diri untuk mencapai level yang lebih tinggi! Sekarang kamu di level ${currentLevel}, masih ada peluang naik!`,
          type: 'primary'
        });
      } else if (currentLevel >= 5) {
        recommendations.push({
          icon: '👑',
          text: 'Amazing! Kamu sudah mencapai level tinggi. Coba koleksi soal lain untuk tantangan baru!',
          type: 'success'
        });
      }
      
      // Add motivational recommendation
      recommendations.push({
        icon: '💪',
        text: 'Yang terpenting: jangan pernah berhenti belajar dan selalu percaya pada kemampuanmu!',
        type: 'danger'
      });
      
      // Add recommendations to the list dengan styling yang menarik
      recommendations.forEach(rec => {
        const li = document.createElement('li');
        li.className = 'mb-2';
        li.innerHTML = `
          <div class="d-flex align-items-start">
            <span class="me-2 fs-5">${rec.icon}</span>
            <span class="flex-grow-1">${rec.text}</span>
            <span class="badge bg-${rec.type} ms-2" style="font-size: 0.6em;">Tips</span>
          </div>
        `;
        recommendationList.appendChild(li);
      });
    }

    // Fungsi untuk menghasilkan analisis pencapaian yang ramah siswa
    function generateStudentFriendlyAnalysis(correct, incorrect, currentLevel) {
      const container = document.getElementById('achievement-analysis-container');
      if (!container) return;
      
      const total = correct + incorrect;
      const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
      
      let analysisHTML = '';
      
      // Bagian 1: Pencapaian Level
      analysisHTML += `
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-primary">
              <div class="card-body text-center">
                <h4 class="text-primary mb-3"><i class="bi bi-award me-2"></i>Pencapaian Level Anda</h4>
                <div class="level-achievement-display mb-3">
                  <span class="badge bg-primary fs-4 px-4 py-2">Level ${currentLevel}</span>
                </div>
                <p class="lead">
                  ${getLevelAchievementMessage(currentLevel)}
                </p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Bagian 2: Analisis Performa
      analysisHTML += `
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card border-success h-100">
              <div class="card-body">
                <h5 style="color: #198754;"><i class="bi bi-check-circle me-2"></i>Kekuatan Anda</h5>
                <div class="mb-3">
                  <div class="d-flex align-items-center">
                    <span class="badge me-2" style="background-color: #198754;">${correct}</span>
                    <span>Jawaban Tepat</span>
                  </div>
                  <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar" style="background-color: #198754; --progress-width: ${accuracy}%; width: 0%;"></div>
                  </div>
                </div>
                <div class="strength-analysis">
                  ${getStrengthAnalysis(accuracy, correct, currentLevel)}
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-warning h-100">
              <div class="card-body">
                <h5 style="color: #dc3545;"><i class="bi bi-exclamation-triangle me-2"></i>Area Pengembangan</h5>
                <div class="mb-3">
                  <div class="d-flex align-items-center">
                    <span class="badge me-2" style="background-color: #dc3545;">${incorrect}</span>
                    <span>Jawaban Kurang Tepat</span>
                  </div>
                  <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar" style="background-color: #dc3545; --progress-width: ${100 - accuracy}%; width: 0%;"></div>
                  </div>
                </div>
                <div class="improvement-analysis">
                  ${getImprovementAnalysis(accuracy, incorrect, currentLevel)}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Bagian 3: Motivasi dan Langkah Selanjutnya
      analysisHTML += `
        <div class="row">
          <div class="col-12">
            <div class="card border-info">
              <div class="card-body">
                <h5 class="text-info"><i class="bi bi-rocket me-2"></i>Langkah Selanjutnya</h5>
                <div class="next-steps">
                  ${getNextStepsMessage(accuracy, currentLevel, correct, incorrect)}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = analysisHTML;
      
      // Trigger progress bar animations after DOM update
      setTimeout(() => {
        const progressBars = container.querySelectorAll('.progress-bar');
        progressBars.forEach(bar => {
          const targetWidth = bar.style.getPropertyValue('--progress-width');
          bar.style.width = targetWidth;
        });
      }, 100);
    }

    // Fungsi untuk mendapatkan pesan pencapaian level dengan fokus struktur materi
    function getLevelAchievementMessage(level) {
      const messages = {
        1: `<span style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: 600; color: #2d3748; line-height: 1.6;">Kamu telah menguasai dasar-dasar materi pada tingkat pemahaman dan hafalan. Fondasi pengetahuanmu sudah mulai terbangun! 📚</span>`,
        2: `<span style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: 600; color: #2d3748; line-height: 1.6;">Excellent! Kamu berhasil menerapkan konsep dasar dalam situasi sederhana. Kemampuan aplikasimu berkembang baik! 🎯</span>`,
        3: `<span style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: 600; color: #2d3748; line-height: 1.6;">Impressive! Kamu mampu menganalisis informasi dan memecahkan masalah tingkat menengah. Berpikir kritismu semakin tajam! 🔍</span>`,
        4: `<span style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: 600; color: #2d3748; line-height: 1.6;">Outstanding! Kamu berhasil menguasai analisis mendalam dan evaluasi konsep. Kemampuan sintesis dan pemecahan masalah kompleks terasah! 💡</span>`,
        5: `<span style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: 600; color: #2d3748; line-height: 1.6;">Remarkable! Kamu mencapai kemampuan evaluasi tinggi dan dapat membuat keputusan berdasar kriteria yang tepat! ⚡</span>`,
        6: `<span style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: 600; color: #2d3748; line-height: 1.6;">Exceptional! Kamu telah menguasai kemampuan sintesis dan kreasi. Dapat menghubungkan berbagai konsep menjadi solusi inovatif! 🌟</span>`,
        7: `<span style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: 600; color: #2d3748; line-height: 1.6;">MASTERFUL! Pencapaian tertinggi dalam hierarki pembelajaran! Kamu mampu menciptakan, merancang, dan menghasilkan karya original! 👑</span>`
      };
      return messages[level] || `<span style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: 600; color: #2d3748; line-height: 1.6;">Selamat atas pencapaianmu dalam struktur pembelajaran bertingkat! 🎉</span>`;
    }

    // Fungsi untuk analisis kekuatan berdasar struktur materi
    function getStrengthAnalysis(accuracy, correct, level) {
      if (accuracy >= 80) {
        return `
          <p class="mb-2" style="color: #198754;"><strong>🎯 Penguasaan Materi Excellent!</strong></p>
          <p>Dengan ${accuracy}% ketepatan, kamu menunjukkan penguasaan struktural yang kuat:</p>
          <ul class="small">
            <li><strong>Pemahaman Konseptual:</strong> Materi dasar sudah dikuasai dengan solid</li>
            <li><strong>Aplikasi Pengetahuan:</strong> Mampu menerapkan konsep pada berbagai konteks</li>
            <li><strong>Analisis & Sintesis:</strong> Berpikir tingkat tinggi sudah berkembang baik</li>
            <li><strong>Transfer Learning:</strong> Dapat menghubungkan antar konsep dengan tepat</li>
          </ul>
        `;
      } else if (accuracy >= 60) {
        return `
          <p class="mb-2" style="color: #198754;"><strong>👍 Fondasi Materi Solid!</strong></p>
          <p>Dengan ${accuracy}% ketepatan, kamu menunjukkan penguasaan yang baik pada:</p>
          <ul class="small">
            <li><strong>Konsep Fundamental:</strong> Dasar-dasar materi sudah terpahami</li>
            <li><strong>Penerapan Sederhana:</strong> Mampu menggunakan rumus dan prosedur standar</li>
            <li><strong>Pemecahan Masalah:</strong> Bisa menyelesaikan soal dengan pola familiar</li>
            <li><strong>Koneksi Konsep:</strong> Mulai bisa menghubungkan antar topik</li>
          </ul>
        `;
      } else {
        return `
          <p class="mb-2" style="color: #198754;"><strong>💪 Pondasi Awal Terbangun!</strong></p>
          <p>Dari ${correct} jawaban benar, kamu menunjukkan kemajuan pada:</p>
          <ul class="small">
            <li><strong>Pengenalan Konsep:</strong> Mulai familiar dengan terminologi dan definisi</li>
            <li><strong>Hafalan Dasar:</strong> Ingatan untuk fakta-fakta penting sudah mulai terbentuk</li>
            <li><strong>Pemahaman Literal:</strong> Bisa memahami informasi langsung dari teks</li>
            <li><strong>Potensi Berkembang:</strong> Foundation untuk pembelajaran lanjut sudah ada</li>
          </ul>
        `;
      }
    }

    // Fungsi untuk analisis area pengembangan berdasar struktur materi
    function getImprovementAnalysis(accuracy, incorrect, level) {
      if (incorrect === 0) {
        return `
          <p class="mb-2" style="color: #dc3545;"><strong>🌟 Mastery Sempurna!</strong></p>
          <p>Tidak ada kesalahan dalam struktur materi ini! Peluang pengembangan lanjut:</p>
          <ul class="small">
            <li><strong>Eksplorasi Mendalam:</strong> Pelajari aspek advanced dari topik yang sama</li>
            <li><strong>Transfer Knowledge:</strong> Terapkan konsep ini ke bidang lain</li>
            <li><strong>Peer Teaching:</strong> Bantu teman memahami struktur materi ini</li>
            <li><strong>Higher Order Thinking:</strong> Coba soal-soal olimpiade atau kompetisi</li>
          </ul>
        `;
      } else if (accuracy >= 70) {
        return `
          <p class="mb-2" style="color: #dc3545;"><strong>📈 Hampir Tuntas!</strong></p>
          <p>${incorrect} area dalam struktur materi perlu diperkuat. Target pengembangan:</p>
          <ul class="small">
            <li><strong>Detail Procedural:</strong> Teliti lagi langkah-langkah penyelesaian</li>
            <li><strong>Koneksi Konsep:</strong> Perkuat hubungan antar topik dalam materi</li>
            <li><strong>Aplikasi Kontekstual:</strong> Latih penerapan dalam situasi berbeda</li>
            <li><strong>Metacognition:</strong> Evaluasi strategi belajar yang digunakan</li>
          </ul>
        `;
      } else {
        return `
          <p class="mb-2" style="color: #dc3545;"><strong>🚀 Struktur Learning Gap!</strong></p>
          <p>${incorrect} area dalam hierarki materi perlu penguatan systematik:</p>
          <ul class="small">
            <li><strong>Prerequisite Skills:</strong> Pastikan konsep prasyarat sudah dikuasai</li>
            <li><strong>Scaffolding Learning:</strong> Belajar bertahap dari level sederhana</li>
            <li><strong>Conceptual Framework:</strong> Bangun kerangka berpikir yang terstruktur</li>
            <li><strong>Practice & Reflection:</strong> Latihan terbimbing dengan feedback</li>
          </ul>
        `;
      }
    }

    // Fungsi untuk pesan langkah selanjutnya
    function getNextStepsMessage(accuracy, level, correct, incorrect) {
      let message = '';
      
      if (accuracy >= 85) {
        message = `
          <div class="alert alert-success border-0 mb-3">
            <h6><i class="bi bi-trophy-fill me-2"></i>Prestasi Luar Biasa!</h6>
            <p class="mb-2">Kamu sudah menguasai materi ini dengan sangat baik! Saatnya melangkah ke tantangan berikutnya:</p>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="card bg-light border-0">
                <div class="card-body p-3">
                  <h6 class="text-success">💡 Eksplorasi Lebih Dalam</h6>
                  <ul class="small mb-0">
                    <li>Cari materi pengayaan atau olimpiade</li>
                    <li>Baca buku atau artikel terkait</li>
                    <li>Ikuti kompetisi atau lomba</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light border-0">
                <div class="card-body p-3">
                  <h6 class="text-primary">🤝 Bantu Sesama</h6>
                  <ul class="small mb-0">
                    <li>Ajari teman yang kesulitan</li>
                    <li>Buat catatan untuk dibagi</li>
                    <li>Jadi tutor sebaya</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (accuracy >= 60) {
        message = `
          <div class="alert alert-info border-0 mb-3">
            <h6><i class="bi bi-graph-up-arrow me-2"></i>Kamu Di Jalur yang Tepat!</h6>
            <p class="mb-2">Performamu sudah cukup baik, tapi masih ada ruang untuk berkembang. Yuk tingkatkan lagi:</p>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="card bg-light border-0">
                <div class="card-body p-3">
                  <h6 class="text-info">📚 Perkuat Pemahaman</h6>
                  <ul class="small mb-0">
                    <li>Review materi yang masih lemah</li>
                    <li>Buat ringkasan atau mind map</li>
                    <li>Diskusi dengan teman atau guru</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light border-0">
                <div class="card-body p-3">
                  <h6 class="text-warning">🎯 Latihan Terarah</h6>
                  <ul class="small mb-0">
                    <li>Fokus pada tipe soal yang salah</li>
                    <li>Cari contoh soal serupa</li>
                    <li>Latihan rutin sedikit demi sedikit</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        message = `
          <div class="alert alert-warning border-0 mb-3">
            <h6><i class="bi bi-heart-fill me-2"></i>Jangan Menyerah, Kamu Pasti Bisa!</h6>
            <p class="mb-2">Setiap orang punya kecepatan belajar yang berbeda. Yang penting adalah terus berusaha. Mari kita buat rencana belajar yang fun:</p>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="card bg-light border-0">
                <div class="card-body p-3">
                  <h6 class="text-success">🌱 Mulai dari Dasar</h6>
                  <ul class="small mb-0">
                    <li>Pahami konsep dasar dulu</li>
                    <li>Belajar pelan-pelan tapi konsisten</li>
                    <li>Gunakan cara belajar yang kamu suka</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light border-0">
                <div class="card-body p-3">
                  <h6 class="text-danger">❤️ Cari Dukungan</h6>
                  <ul class="small mb-0">
                    <li>Minta bantuan guru atau teman</li>
                    <li>Gabung grup belajar</li>
                    <li>Jangan malu bertanya</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Tambahkan motivasi penutup
      message += `
        <div class="mt-4 p-3 bg-gradient" style="background: linear-gradient(45deg, #e3f2fd, #f3e5f5); border-radius: 10px;">
          <div class="text-center">
            <h6 class="text-dark mb-2">💪 Ingat Selalu:</h6>
            <p class="mb-0 text-dark"><em>"Setiap jawaban yang salah adalah langkah menuju jawaban yang benar. Terus belajar, terus berkembang, dan percaya pada kemampuanmu!"</em></p>
          </div>
        </div>
      `;
      
      return message;
    }

    // Fungsi untuk setup tombol export (PDF dan Excel)
    function setupExportButtons() {
      // Setup export PDF button
      const exportPdfBtn = document.getElementById('exportPdfBtn');
      if (exportPdfBtn) {
        console.log("Menambahkan event listener untuk export PDF");
        exportPdfBtn.addEventListener('click', function() {
          try {
            exportToPdf();
          } catch (err) {
            console.error("Error dalam handler exportToPdf:", err);
            showLoading(false);
            Swal.fire({
              icon: 'error',
              title: 'Export Gagal',
              text: 'Terjadi kesalahan saat mengeksport hasil ke PDF. Silakan coba lagi nanti.',
              confirmButtonText: 'OK'
            });
          }
        });
      } else {
        console.warn("Tombol export PDF tidak ditemukan");
      }
      
      // Setup export Excel button
      const exportExcelBtn = document.getElementById('exportExcelBtn');
      if (exportExcelBtn) {
        console.log("Menambahkan event listener untuk export Excel");
        exportExcelBtn.addEventListener('click', function() {
          try {
            exportToExcel();
          } catch (err) {
            console.error("Error dalam handler exportToExcel:", err);
            showLoading(false);
            Swal.fire({
              icon: 'error',
              title: 'Export Gagal',
              text: 'Terjadi kesalahan saat mengeksport hasil ke Excel. Silakan coba lagi nanti.',
              confirmButtonText: 'OK'
            });
          }
        });
      }
    }

// Function to export to PDF
function exportToPdf() {
  try {
    // Validasi parameter
    if (!userId || !collectionId) {
      Swal.fire({
        icon: 'error',
        title: 'Export Gagal',
        text: 'Parameter user atau koleksi tidak valid.',
        confirmButtonText: 'OK'
      });
      return;
    }
    
    showLoading(true);
    
    // Cek apakah ada data jawaban
    if (allAnswers.length === 0) {
      console.warn("Tidak ada data jawaban saat melakukan export PDF. Mencoba reload data terlebih dahulu...");
      
      // Coba ambil data jawaban secara singkat
      fetchAndCacheAnswerHistory()
        .catch(err => {
          console.warn("Gagal mengambil data jawaban:", err.message);
          console.warn("Melanjutkan export PDF meskipun tidak ada data jawaban lengkap");
        })
        .finally(() => {
          // Lanjutkan proses export PDF
          performPdfExport();
        });
    } else {
      // Langsung export jika data sudah ada
      performPdfExport();
    }
    
  } catch (error) {
    console.error("Error exporting to PDF:", error);
    showLoading(false);
    
    // Show error notification
    Swal.fire({
      icon: 'error',
      title: 'Export Gagal',
      text: 'Terjadi kesalahan saat mengexport data ke PDF: ' + error.message,
      confirmButtonText: 'OK'
    });
  }
}

// Fungsi untuk melakukan export PDF setelah persiapan data
function performPdfExport() {
  try {
    // Construct the URL with parameters
    const exportUrl = `/api/export_result_pdf?user_id=${userId}&collection_id=${collectionId}`;
    
    // Tambahkan timestamp untuk menghindari cache
    const timestampedUrl = `${exportUrl}&t=${new Date().getTime()}`;
    
    // Log info untuk debugging
    console.log("Mengeksport hasil ke PDF dengan URL:", timestampedUrl);
    
    // Open in a new tab or download directly
    window.open(timestampedUrl, '_blank');
    
    // Hide loading after a short delay
    setTimeout(() => {
      showLoading(false);
    }, 2000);
    
  } catch (error) {
    console.error("Error performing PDF export:", error);
    showLoading(false);
    
    // Show error notification
    Swal.fire({
      icon: 'error',
      title: 'Export Gagal',
      text: 'Terjadi kesalahan saat mengexport data ke PDF: ' + error.message,
      confirmButtonText: 'OK'
    });
  }
}
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hasil Tes Diagnostik</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Global Styles */
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 60px; /* Space for fixed navbar */
    }

    /* Navbar Styling */
    .navbar {
      background-color: #0d6efd; /* Bootstrap primary blue */
    }
    .navbar-brand {
      font-weight: bold;
    }
    .user-info {
      color: white;
      margin-right: 15px;
    }

    /* Card Base Styling */
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      overflow: hidden;
      margin-bottom: 25px;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .card-header {
      border-bottom: none;
      padding: 15px 20px;
      font-weight: bold;
    }

    /* Specific Card Colors */
    .summary-card {
      background-color: #0d6efd; /* Sama seperti warna header navbar */
      color: white;
    }
    .summary-card .card-header {
      background: rgba(0,0,0,0.1); /* Slightly transparent background for header */
    }
    /* Ensure nested cards/text inside blue summary have solid dark text (not inheriting white) */
    .summary-card .card,
    .summary-card .card .card-body,
    .summary-card .stat-card {
      color: #212529; /* Bootstrap body color */
    }
    .summary-card .stat-explanation,
    .summary-card .chart-explanation,
    .summary-card label {
      color: #212529; /* readable on white inner card */
    }
    .benar { color: #198754; font-weight: bold; } /* Green for tepat */
    .salah { color: #dc3545; font-weight: bold; } /* Red for kurang tepat */

    /* Chart Specific Styles */
    .chart-container {
      width: 100%;
      max-width: 300px; /* Limit chart size */
      margin: 0 auto;
      padding: 15px;
      height: 300px;
      position: relative;
    }
    .chart-explanation {
      color: #212529; /* Dark text color */
      background-color: #f8f9fa; /* Light background */
      border-radius: 5px;
      padding: 10px;
      margin-top: 15px;
      font-size: 0.9rem;
      border-left: 4px solid #0d6efd; /* Blue left border for emphasis */
    }

    /* Answer Card Styles in Modal */
    .answer-card {
      transition: all 0.3s ease;
      border-left: 5px solid #6c757d; /* Default gray border */
      background-color: white;
    }
    .answer-card.correct {
      border-left-color: #198754; /* Green border for correct answers */
    }
    .answer-card.incorrect {
      border-left-color: #dc3545; /* Red border for incorrect answers */
    }
    .answer-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Level Badge (currently not used in this HTML, but kept for consistency) */
    .level-badge {
      position: absolute;
      top: 15px;
      right: 15px;
    }

    /* Statistic Cards within Summary */
    .stat-card {
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      background: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6c757d;
    }
    .stat-explanation {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 5px;
    }

    /* Clickable Elements */
    .clickable {
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent; /* Default transparent border */
    }
    .clickable:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    .clickable.benar:hover {
      border-color: #198754; /* Green border on hover for correct */
    }
    .clickable.salah:hover {
      border-color: #dc3545; /* Red border on hover for incorrect */
    }

    /* Button Styling */
    .btn {
      border-radius: 50px; /* Pill-shaped buttons */
      padding: 10px 25px;
      font-weight: 600;
      letter-spacing: 0.5px;
      transition: all 0.3s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .btn-icon {
      margin-right: 8px;
    }

    /* Progress Bar Styling */
    .progress-container {
      margin: 20px 0;
    }
    .progress {
      height: 25px;
      border-radius: 50px;
      background-color: #e9ecef;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .progress-explanation {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
    }

    /* Badges */
    .badge {
      font-size: 85%;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px; /* Rounded badge corners */
    }
    /* Specific style for the current level badge */
    .current-level-badge-style {
      font-size: 16px;
      font-weight: bold;
      padding: 6px 12px;
    }


    /* Explanation Text Styling */
    .explanation-text {
      background-color: #f8f9fa;
      border-left: 4px solid #17a2b8; /* Cyan border */
      padding: 15px;
      border-radius: 0 8px 8px 0;
    }

    /* Answer Display in Modal */
    .answer-question {
      font-weight: 500;
      line-height: 1.5;
    }
    .answer-response {
      background-color: #f8f9fa;
      padding: 8px 15px;
      border-radius: 8px;
      margin-top: 8px;
      display: inline-block;
    }

    /* Level Path Visualization */
    .level-path {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .level-step {
      width: 14%; /* Distribute steps evenly */
      display: inline-block;
      text-align: center;
      position: relative;
    }
    .level-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 50%;
      right: -10px;
      width: 20px;
      height: 2px;
      background-color: #dee2e6; /* Line between steps */
    }
    .level-icon {
      width: 40px;
      height: 40px;
      line-height: 40px; /* Center text vertically */
      background-color: #e9ecef;
      border-radius: 50%;
      margin: 0 auto 8px;
    }
    .level-icon.active {
      background-color: #0d6efd; /* Active level color */
      color: white;
    }
    .level-icon.completed {
      background-color: #198754; /* Completed level color */
      color: white;
    }
    .level-explanation {
      background-color: rgba(13, 110, 253, 0.1); /* Light blue background */
      border-radius: 10px;
      padding: 10px 15px;
      margin-top: 15px;
      font-size: 0.9rem;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    /* Error Container */
    .error-container {
      padding: 20px;
      border-radius: 10px;
      background-color: #f8d7da; /* Light red background */
      border-left: 5px solid #dc3545; /* Red left border */
      margin-bottom: 20px;
    }
    .refresh-button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      margin-top: 10px;
    }

    /* Level Display (if used outside path) */
    .level-number-display {
    font-size: 28px;
    font-weight: bold;
    color: #212529; /* Dark text color */
    background-color: #f8f9fa; /* Light background */
    border: 2px solid #0d6efd; /* Blue border */
    border-radius: 12px;
    padding: 8px 16px;
    display: inline-block;
    margin-bottom: 15px;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    .level-top-display {
    font-size: 42px;
    font-weight: bold;
    color: #198754; /* Green color for better visibility */
    margin: 20px auto;
    text-align: center;
    display: block;
    }

    /* Level Node Styling for MST */
    .level-node {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 8px;
      margin: 4px 2px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      min-width: 60px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .level-label {
      font-weight: bold;
      font-size: 12px;
      color: #495057;
    }

    .level-name {
      font-size: 9px;
      color: #6c757d;
      margin: 2px 0;
    }

    .difficulty {
      font-size: 8px;
      color: #17a2b8;
      font-weight: 500;
    }

    /* Modern Breadcrumb Styling */
    .modern-breadcrumb {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 15px;
      padding: 15px 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(13, 110, 253, 0.1);
      margin-bottom: 0;
      position: relative;
      overflow: hidden;
    }

    .modern-breadcrumb::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #0d6efd 0%, #20c997 50%, #fd7e14 100%);
    }

    .modern-breadcrumb .breadcrumb-item {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .modern-breadcrumb .breadcrumb-item + .breadcrumb-item::before {
      content: "";
      display: none;
    }

    .breadcrumb-link {
      color: #0d6efd;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      padding: 8px 15px;
      border-radius: 10px;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }

    .breadcrumb-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(13, 110, 253, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .breadcrumb-link:hover::before {
      left: 100%;
    }

    .breadcrumb-link:hover {
      color: #0b5ed7;
      background: rgba(13, 110, 253, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
    }

    .breadcrumb-link i {
      font-size: 1rem;
      transition: transform 0.3s ease;
    }

    .breadcrumb-link:hover i {
      transform: scale(1.1);
    }

    .modern-breadcrumb .breadcrumb-item.active {
      color: #495057;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      padding: 8px 15px;
      background: rgba(13, 110, 253, 0.05);
      border-radius: 10px;
      border-left: 3px solid #0d6efd;
    }

    .modern-breadcrumb .breadcrumb-item.active i {
      color: #0d6efd;
      font-size: 1rem;
    }

    /* Responsive breadcrumb */
    @media (max-width: 768px) {
      .modern-breadcrumb {
        padding: 12px 20px;
      }

      .breadcrumb-link span,
      .modern-breadcrumb .breadcrumb-item.active span {
        display: none;
      }

      .breadcrumb-link,
      .modern-breadcrumb .breadcrumb-item.active {
        padding: 8px 10px;
      }
    }

    /* Animation for breadcrumb on load */
    .modern-breadcrumb {
      animation: slideInDown 0.6s ease-out;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Modern Page Header Styling */
    .page-header {
      margin: 30px 0;
      animation: fadeInUp 0.8s ease-out;
      animation-delay: 0.2s;
      animation-fill-mode: both;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .page-title i {
      font-size: 2.2rem;
      /* animation: pulse 2s infinite; */ /* Hapus animasi pulse */
    }

    /* @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    } */ /* Komentari atau hapus animasi pulse jika tidak diinginkan */

    .page-subtitle {
      font-size: 1.1rem;
      font-weight: 400;
      margin-bottom: 0;
      opacity: 0.8;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive page header */
    @media (max-width: 768px) {
      .page-title {
        font-size: 2rem;
        text-align: center;
      }

      .page-title i {
        font-size: 1.8rem;
      }

      .page-subtitle {
        font-size: 1rem;
      }
    }

    @media (max-width: 576px) {
      .page-title {
        font-size: 1.75rem;
        flex-direction: column;
        gap: 10px;
      }

      .page-subtitle {
        font-size: 0.9rem;
        padding: 0 15px;
      }
    }

    /* Achievement Analysis Styles */
    .level-achievement-display {
      animation: bounceIn 0.8s ease-out;
    }

    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .strength-analysis, .improvement-analysis, .next-steps {
      animation: fadeInUp 0.6s ease-out;
      animation-fill-mode: both;
    }

    .strength-analysis {
      animation-delay: 0.2s;
    }

    .improvement-analysis {
      animation-delay: 0.4s;
    }

    .next-steps {
      animation-delay: 0.6s;
    }

    /* Achievement card hover effects */
    .achievement-analysis-container .card {
      transition: all 0.3s ease;
    }

    .achievement-analysis-container .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    /* Recommendation list styling */
    #recommendation-list {
      list-style: none;
      padding-left: 0;
    }

    #recommendation-list li {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #0d6efd;
      transition: all 0.3s ease;
    }

    #recommendation-list li:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 1);
    }

    /* Progress bar styling for achievement analysis */
    .progress-bar {
      transition: width 1.2s ease-out;
    }

    /* Badge hover effects in achievement analysis */
    .badge {
      transition: all 0.3s ease;
    }

    .badge:hover {
      transform: scale(1.1);
    }

    /* Card border animations for achievement analysis */
    .card.border-success, .card.border-warning, .card.border-primary, .card.border-info {
      border-width: 2px !important;
      transition: all 0.3s ease;
    }

    .card.border-success:hover {
      border-color: #198754 !important;
      box-shadow: 0 0 20px rgba(25, 135, 84, 0.2);
    }

    .card.border-warning:hover {
      border-color: #dc3545 !important;
      box-shadow: 0 0 20px rgba(220, 53, 69, 0.2);
    }

    .card.border-primary:hover {
      border-color: #0d6efd !important;
      box-shadow: 0 0 20px rgba(13, 110, 253, 0.2);
    }

    .card.border-info:hover {
      border-color: #0dcaf0 !important;
      box-shadow: 0 0 20px rgba(13, 202, 240, 0.2);
    }

     /* MST Path Visualization */
      .mst-path-container {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #dee2e6;
        box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      }
      .path-title {
        font-weight: 600;
        color: #0d6efd;
        font-size: 1.1rem;
      }

      /* Linear Path Display with Visual Nodes */
     .linear-path-container {
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        margin-top: 1rem;
      }

     .path-nodes-wrapper {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 1rem 0;
      }

      .path-node {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }

     .node-circle {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
        border: 3px solid;
        background: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        z-index: 2;
      }

      .node-circle:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      }

      .node-circle.correct {
        border-color: #198754;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
      }

      .node-circle.incorrect {
        border-color: #dc3545;
        background: linear-gradient(135deg, #f8d7da 0%, #f5c2c7 100%);
        color: #721c24;
      }

      .node-circle.final {
        border-color: #0d6efd;
        background: linear-gradient(135deg, #cfe2ff 0%, #9ec5fe 100%);
        color: #084298;
        font-weight: 700;
      }
       /* Style for the currently active/latest node */
      .node-circle.current {
        border-color: #ffc107;
        background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        color: #856404;
      }
       /* --- PERBAIKAN: Style untuk node yang datanya tidak lengkap --- */
      .node-circle.unknown {
        border-color: #6c757d;
        background: #f8f9fa;
        color: #495057;
      }


      .node-label {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #6c757d;
        text-align: center;
      }

      .node-result {
        font-size: 0.7rem;
        font-weight: 600;
        margin-top: 0.25rem;
      }

      .node-result.correct {
        color: #198754;
      }

      .node-result.incorrect {
        color: #dc3545;
      }

      .path-arrow {
        display: flex;
        align-items: center;
        color: #6c757d;
        font-size: 1.5rem;
        padding: 0 0.5rem;
        z-index: 1;
      }

      /* .path-arrow i {} */ /* Hapus ruleset kosong */

       /* Colors adjusted for 5 levels */
      .diagnosis-badge {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 700;
        font-size: 1.1rem;
        margin-top: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      .diagnosis-badge.level-1 { /* For < L2 or L1 */
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        color: #495057;
        border: 2px solid #adb5bd;
      }
      .diagnosis-badge.level-2 { /* Literacy */
        background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        color: #856404;
        border: 2px solid #ffc107;
      }
      .diagnosis-badge.level-3 { /* Capability */
        background: linear-gradient(135deg, #cfe2ff 0%, #9ec5fe 100%);
        color: #084298;
        border: 2px solid #0d6efd;
      }
      .diagnosis-badge.level-4 { /* Creativity */
        background: linear-gradient(135deg, #d1ecf1 0%, #b8daff 100%);
        color: #004085;
        border: 2px solid #0dcaf0;
      }
      .diagnosis-badge.level-5 { /* Criticism */
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        border: 2px solid #198754;
      }


      .path-summary {
        margin-top: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #0d6efd;
      }

      .path-summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
      }

      .path-summary-item:last-child {
        border-bottom: none;
      }

      .path-summary-label {
        font-weight: 600;
        color: #495057;
      }

      .path-summary-value {
        color: #212529;
      }

      /* Additional path styling */
      #linear-path-display .path-segment {
        font-weight: normal;
        color: #495057;
      }

      #linear-path-display .diagnosis-segment,
      #linear-path-display .bs-segment {
        margin-left: 0.75em;
        margin-right: 0.75em;
        font-weight: bold;
      }

      #linear-path-display .diagnosis-segment {
            color: #198754; /* Green for diagnosis */
       }
       #linear-path-display .bs-segment {
            color: #dc3545; /* Red for B/S count */
       }
       #linear-path-display .arrow { /* Styling for the arrow */
           color: #6c757d; /* Grey arrow */
           margin: 0 0.3em;
           font-weight: normal;
       }

      /* --- Footer --- */
      .site-footer {
        background: #ffffff;
        border-top: 1px solid #e9ecef;
        color: #6c757d;
      }
      .site-footer a {
        color: #0d6efd;
      }
      .site-footer a:hover {
        text-decoration: underline;
      }

      /* --- Tiles for Achieved Taxonomy Levels --- */
      .level-tile {
        background: #ffffff;
        border: 1px solid #e9ecef;
        border-left: 5px solid #adb5bd; /* default, overridden per-level */
        border-radius: 12px;
        padding: 12px 14px;
        height: 100%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: all 0.25s ease;
      }
      .level-tile:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      }
      .level-tile .level-title {
        font-weight: 600;
        color: #212529;
      }
      .level-tile .level-desc {
        color: #6c757d;
        font-size: 0.925rem;
        line-height: 1.5;
      }
      /* Accent colors per level (left border) */
      .level-tile.l1 { border-left-color: #6c757d; }
      .level-tile.l2 { border-left-color: #ffc107; }
      .level-tile.l3 { border-left-color: #0d6efd; }
      .level-tile.l4 { border-left-color: #0dcaf0; }
      .level-tile.l5 { border-left-color: #198754; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
  <a class="navbar-brand" href="/DashboardSiswa" title="DIGIDAWS = DIagnostik cerdas Guru untuk Identifikasi Deteksi Awal kemampuan siswa dan Wawasan Sistematis">DIGIDAWS</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
        </ul>
        <div class="d-flex align-items-center">
          <span class="user-info">
            <i class="bi bi-person-circle"></i> {{ current_user.nama }} ({{ current_user.kelas }})
          </span>
          <a href="/logout" class="btn btn-outline-light ms-2">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb modern-breadcrumb">
        <li class="breadcrumb-item">
          <a href="/DashboardSiswa" class="breadcrumb-link">
            <i class="bi bi-house-door me-1"></i>
            <span>Beranda</span>
          </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          <i class="bi bi-clipboard-data me-1"></i>
          <span>Hasil Tes</span>
        </li>
      </ol>
    </nav>

    <div class="page-header text-center mb-4">
      <h1 class="page-title">
        <i class="bi bi-clipboard-data me-2 text-primary"></i>
        Hasil Tes Diagnostik
      </h1>
      <p class="page-subtitle text-muted">Ringkasan lengkap hasil tes diagnostik Anda</p>
    </div>

    <div class="error-container" id="errorContainer" style="display: none;">
      <h5><i class="bi bi-exclamation-triangle me-2"></i>Terjadi Masalah dengan Data</h5>
      <p id="errorMessage">Terdapat ketidaksesuaian data pada hasil tes Anda.</p>
      <button class="refresh-button" id="refreshDataButton">
        <i class="bi bi-arrow-clockwise me-2"></i>Perbaiki Data
      </button>
    </div>

    <div class="card summary-card mb-4">
      <div class="card-header">
        <h3><i class="bi bi-clipboard-data me-2"></i>Ringkasan Hasil</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <div class="stat-card mb-3 clickable" onclick="showAnswersModal('correct')">
              <div class="stat-label">Jawaban Tepat</div>
              <div class="stat-value benar" id="correct-value">0</div>
              <div class="small">Soal dijawab dengan tepat</div>
              <div class="stat-explanation"><i class="bi bi-hand-index-thumb"></i> Klik untuk melihat detail jawaban tepat</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card mb-3 clickable" onclick="showAnswersModal('incorrect')">
              <div class="stat-label">Jawaban Kurang Tepat</div>
              <div class="stat-value salah" id="incorrect-value">0</div>
              <div class="small">Soal dijawab kurang tepat</div>
              <div class="stat-explanation"><i class="bi bi-hand-index-thumb"></i> Klik untuk melihat detail jawaban kurang tepat</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card mb-3">
              <div class="stat-label">Akurasi</div>
              <div class="stat-value text-primary" id="accuracy-value">0%</div>
              <div class="small">Tingkat ketepatan jawaban</div>
              <div class="stat-explanation">Persentase jawaban tepat dari total soal</div>
            </div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-7">
            <div class="card h-100">
              <div class="card-body">
                <p class="mt-2">
                  <strong class="text-dark">Level Benar Tercapai:</strong>
                  <span id="achieved-levels-container" class="text-dark">-</span>
                </p>
                
                <div class="progress-container">
                  <label class="text-dark"><strong>Performa Jawaban:</strong></label>
                  <div class="progress">
                    <div id="correct-progress" class="progress-bar" role="progressbar"
                        style="background-color: #198754; width: 0%;" aria-valuemin="0" aria-valuemax="100">
                      <span id="correct-percent">0%</span>
                    </div>
                    <div id="incorrect-progress" class="progress-bar" role="progressbar"
                        style="background-color: #dc3545; width: 0%;" aria-valuemin="0" aria-valuemax="100">
                      <span id="incorrect-percent">0%</span>
                    </div>
                  </div>
                  <div class="progress-explanation">
                    <i class="bi bi-info-circle me-1"></i> Diagram di atas menunjukkan perbandingan jawaban tepat (<span style="color: #198754; font-weight: bold;">hijau</span>) dan kurang tepat (<span style="color: #dc3545; font-weight: bold;">merah</span>) dari semua soal yang telah Anda kerjakan.
                  </div>
                </div>

                <div class="mt-4">
                  <p><strong>Statistik Lanjutan:</strong></p>
                  <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-info" id="total-questions">Total Soal: 0</span>
                    <span class="badge bg-secondary" id="collection-name">Koleksi: N/A</span>

                  </div>
                </div>

                <div class="mt-4">
                  <a href="/DashboardSiswa" class="btn btn-outline-primary">
                    <i class="bi bi-grid btn-icon"></i>Kembali ke Dashboard
                  </a>
                  <button id="exportPdfBtn" class="btn btn-danger">
                    <i class="bi bi-file-pdf btn-icon"></i>Export ke PDF
                  </button>
                  </div>
              </div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="card h-100">
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="resultChart"></canvas>
                </div>
                <div class="chart-explanation">
                  <strong>Diagram Donat:</strong> Diagram ini menunjukkan perbandingan persentase jawaban tepat (hijau) dan jawaban kurang tepat (merah) dari keseluruhan tes yang telah Anda kerjakan. Visualisasi berbentuk donat ini memudahkan Anda untuk melihat proporsi jawaban secara visual.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header bg-white">
        <h3><i class="bi bi-trophy me-2"></i>Analisis Pencapaian Anda</h3>
      </div>
      <div class="card-body">
        <div id="achievement-analysis-container">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Memuat analisis pencapaian...</span>
            </div>
            <p class="mt-2">Menganalisis hasil tes Anda...</p>
          </div>
        </div>
      </div>
    </div>

    </div>

  <div class="modal fade" id="answersModal" tabindex="-1" aria-labelledby="answersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="answersModalLabel">Riwayat Jawaban</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="answersModalBody">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Memuat data jawaban...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Directly inject values from Flask backend for robustness
    const userId = parseInt("{{ current_user.id }}") || null;
    // Extract collection_id from URL query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const collectionId = parseInt(urlParams.get('collection_id')) || null;


    // Log for debugging
    console.log("Parsed userId:", userId);
    console.log("Parsed collectionId:", collectionId);

    let hasDataError = false; // Flag untuk menandai adanya kesalahan data
    let allAnswers = []; // Variable untuk menyimpan semua jawaban
    let questionLevelMap = {}; // Map untuk menyimpan ID soal -> level
    let collectionQuestions = []; // Array untuk menyimpan data lengkap soal dari koleksi
    let collectionInfo = {}; // Object untuk menyimpan informasi koleksi
    let testDataGlobal = {}; // Global variable to store the main test result data
    
    // Definisikan taxonomyNames di scope global
    const taxonomyNames = {
        1: 'Awareness',
        2: 'Literacy',
        3: 'Capability',
        4: 'Creativity',
        5: 'Criticism'
    };

    // Helper function untuk fetch dengan autentikasi
    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      const headers = {};
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      return headers;
    }

    async function authenticatedFetch(url, options = {}) {
      const headers = {
        ...getAuthHeaders(),
        ...(options.headers || {})
      };
      return fetch(url, { ...options, headers });
    }

    // Helper function to extract level number from state name (MST 5-stage system)
    function getLevelFromState(stateName) {
      if (!stateName) return 1;

      // Map state names to levels (MST 5-stage system)
      const stateToLevel = {
        'Awareness': 1, 'L1M': 1, 'L1H': 1, 'L1E': 1,
        'Literacy': 2, 'L2M': 2, 'L2H': 2, 'L2E': 2,
        'Capability': 3, 'L3M': 3, 'L3H': 3, 'L3E': 3,
        'Creativity': 4, 'L4M': 4, 'L4H': 4, 'L4E': 4,
        'Criticism': 5, 'L5M': 5, 'L5H': 5, 'L5E': 5,
        // Include full state names if they appear in logs
        'L1 AwarenessM': 1,
        'L2 LiteracyH': 2, 'L2 LiteracyE': 2,
        'L3 CapabilityH': 3, 'L3 CapabilityM': 3,
        'L4 CreativityH': 4, 'L4 CreativityM': 4, 'L4 CreativityE': 4,
        'L5 CriticismH': 5, 'L5 CriticismM': 5, 'L5 CriticismE': 5,
        // Handle diagnosis strings
        'L5': 5, 'L4': 4, 'L3': 3, '< L2': 1
      };

      // Direct lookup first
      if (stateToLevel.hasOwnProperty(stateName)) {
        return stateToLevel[stateName];
      }

      // Try matching parts
      for (const key in stateToLevel) {
          // Be more specific to avoid partial matches like 'L1' matching 'L1 AwarenessM' incorrectly
          if (stateName === key || stateName.startsWith(key + ' ') || stateName.endsWith(' ' + key)) {
             return stateToLevel[key];
          }
      }


      // Fallback: extract number from state name like L1, L2, etc.
      const match = stateName.match(/^L(\d+)$/); // Match exactly L followed by number(s)
      if (match) {
          const levelNum = parseInt(match[1]);
          return Math.max(1, Math.min(5, levelNum)); // Ensure level is between 1 and 5
      }

      // Final fallback if nothing matches
      console.warn(`Could not determine level from stateName: '${stateName}'. Defaulting to 1.`);
      return 1;
    }

    // Setup chart and visualizations
    document.addEventListener('DOMContentLoaded', function() {
      // Aktifkan tombol ekspor PDF secara independen (tidak menunggu inisialisasi data)
      setupExportButtons();

      // Inisialisasi
      initResultPage().catch(error => {
        console.error("Terjadi kesalahan saat inisialisasi halaman:", error);
        showError("Terjadi kesalahan saat memuat data hasil. Tombol export tetap dapat digunakan.");
        showLoading(false);
      });

      // Setup refresh button
      const refreshButton = document.getElementById('refreshDataButton');
      if (refreshButton) {
        refreshButton.addEventListener('click', async function() {
          await forceRefreshData();
        });
      }
    });

    // Fungsi untuk mengambil informasi koleksi
    async function fetchCollectionInfo() {
      if (!collectionId) {
        console.error("fetchCollectionInfo: collectionId tidak valid.");
        return;
      }

      try {
        // Coba endpoint siswa terlebih dahulu
        const response = await authenticatedFetch(`/api/collections/${collectionId}/details`); // Gunakan endpoint details

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.collection) {
            collectionInfo = data.collection;
            console.log("Informasi koleksi berhasil dimuat:", collectionInfo);
            // Juga simpan info guru jika ada
            if (data.guru) {
                collectionInfo.guru_name = data.guru.nama;
            }
          } else {
            console.warn("Data koleksi tidak lengkap:", data);
          }
        } else {
            console.warn("Gagal mengambil info koleksi (siswa), status:", response.status);
             // Fallback: coba endpoint /api/collections/<id> jika ada (mungkin butuh autentikasi guru)
            try {
                const fallbackResponse = await authenticatedFetch(`/api/collections/${collectionId}`);
                if (fallbackResponse.ok) {
                    const fallbackData = await fallbackResponse.json();
                    if (fallbackData.success && fallbackData.collection) {
                        collectionInfo = fallbackData.collection;
                         console.log("Informasi koleksi (fallback) berhasil dimuat:", collectionInfo);
                    }
                }
            } catch (fallbackError) {
                 console.warn("Fallback fetchCollectionInfo juga gagal:", fallbackError);
            }
        }
      } catch (error) {
        console.warn("Gagal mengambil informasi koleksi:", error);
      }
    }


    async function initResultPage() {
      try {
        showLoading(true);

        if (userId === null || collectionId === null) {
            showError("ID pengguna atau koleksi tidak tersedia. Pastikan Anda login dan mengakses halaman ini dengan benar.");
            showLoading(false);
            setupExportButtons();
            return;
        }

        await fixStatisticsInconsistency();
        await fetchCollectionInfo(); // Try to fetch collection info (handle failure gracefully)
        
        // **PERBAIKAN**: Panggil fetchAndCacheAnswerHistory() SEBELUM fetchTestResultData()
        // agar allAnswers tersedia saat fetchTestResultData() membutuhkannya untuk fallback
        await fetchAndCacheAnswerHistory(); 

        try {
          testDataGlobal = await fetchTestResultData(); // Store in global variable
          
          // **PERBAIKAN**: Panggil renderResultPage setelah SEMUA data (termasuk allAnswers) siap
          renderResultPage(testDataGlobal); 
        } catch (err) {
          console.error("Gagal mengambil data hasil tes:", err.message);
          showError("Gagal mengambil data hasil tes. Tombol export tetap dapat digunakan.");
          showLoading(false);
          setupExportButtons();
          return;
        }

        showLoading(false);
      } catch (error) {
        console.error("Error initializing result page:", error);
        showLoading(false);
        showError("Terjadi kesalahan saat memuat hasil tes. Tombol export tetap dapat digunakan.");
        setupExportButtons();
      }
    }

    // Fungsi untuk menampilkan/menyembunyikan loading overlay
    function showLoading(show) {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
      }
    }

    // Fungsi untuk menampilkan pesan error
    function showError(message) {
      const errorContainer = document.getElementById('errorContainer');
      const errorMessage = document.getElementById('errorMessage');

      if (errorContainer && errorMessage) {
        errorMessage.textContent = message;
        errorContainer.style.display = 'block';
      } else {
        // Fallback alert jika container tidak ditemukan
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: message,
        });
      }
    }

    // Fungsi untuk memperbaiki inkonsistensi data statistik
    async function fixStatisticsInconsistency() {
      if (userId === null || collectionId === null) {
        console.error("fixStatisticsInconsistency: userId or collectionId is null.");
        return false;
      }
      try {
        const response = await authenticatedFetch(`/api/siswa/refresh_answers/${collectionId}?user_id=${userId}`);
        if (!response.ok) return false;
        const result = await response.json();
        if (result.success && result.changes && (result.changes.old_correct !== result.changes.new_correct || result.changes.old_incorrect !== result.changes.new_incorrect)) {
            // Tampilkan pesan perbaikan data jika ada perubahan signifikan
            Swal.fire({
                icon: 'info',
                title: 'Data Diperbarui',
                html: `Statistik jawaban Anda telah disinkronkan.<br>
                       Sebelumnya: Benar ${result.changes.old_correct}, Salah ${result.changes.old_incorrect}<br>
                       Sekarang: Benar ${result.changes.new_correct}, Salah ${result.changes.new_incorrect}`,
                timer: 4000,
                timerProgressBar: true
            });
        } else if (result.success) {
            console.log("Statistik jawaban sudah konsisten.");
        }
        return result.success || false;
      } catch (error) {
        console.error("Error saat memperbaiki statistik:", error);
        return false;
       }
    }

    // Fungsi untuk memaksa refresh data
    async function forceRefreshData() {
      if (userId === null || collectionId === null) {
        showError("ID pengguna atau koleksi tidak tersedia."); return;
      }
      try {
        showLoading(true);
        const response = await authenticatedFetch(`/api/siswa/refresh_answers/${collectionId}?user_id=${userId}&force=true`);
        if (!response.ok) throw new Error(`Error: ${response.status}`);
        const result = await response.json();
        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: 'Data telah diperbarui. Memuat ulang halaman...',
                timer: 2000,
                timerProgressBar: true,
                didClose: () => {
                    window.location.reload();
                }
            });
        }
        else throw new Error(result.message || "Gagal memperbarui data");
      } catch (error) {
        showLoading(false); showError(`Gagal memperbarui data: ${error.message}`);
      }
    }

    // Fungsi untuk mengambil data hasil tes
    async function fetchTestResultData() {
      if (userId === null || collectionId === null) throw new Error("ID pengguna atau koleksi tidak tersedia.");
      try {
        const timestamp = new Date().getTime();
        const url = `/api/mst/status/${collectionId}?user_id=${userId}&t=${timestamp}`; // Endpoint status MST
        const response = await authenticatedFetch(url);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({})); 
             throw new Error(`Gagal mengambil hasil: ${errorData.message || response.status}`);
        }
        
        const data = await response.json();
        if (!data.success && data.message) throw new Error(data.message);
        console.log("Data hasil tes (fetchTestResultData - from /api/mst/status):", data); 

        // **PERBAIKAN**: Gunakan allAnswers (yang sudah di-fetch oleh initResultPage) untuk B/S
        let correctCount = 0;
        let incorrectCount = 0;

        if (allAnswers && allAnswers.length > 0) {
             correctCount = allAnswers.filter(a => a.is_correct).length;
             incorrectCount = allAnswers.length - correctCount;
             console.log("Using B/S from allAnswers:", correctCount, incorrectCount);
        } else {
             // Fallback jika allAnswers gagal di-fetch (seharusnya tidak terjadi)
             correctCount = data.mst_status?.questions_correct ?? 0;
             incorrectCount = (data.mst_status?.questions_answered ?? 0) - correctCount;
             console.warn("Fallback B/S from mst_status:", correctCount, incorrectCount);
        }
        // **AKHIR PERBAIKAN**

        const compatibleData = {
            success: data.success,
            correct: correctCount, // Gunakan hasil hitungan dari allAnswers
            incorrect: incorrectCount, // Gunakan hasil hitungan dari allAnswers
            current_level: data.mst_status?.stage || 1, // Gunakan stage dari mst_status
            collection_name: collectionInfo?.name, 
            mst_state: data.mst_status, // Simpan data mst_status
            answers: allAnswers // Sertakan answers yang sudah di-cache
        };
        
        console.log("Compatible data structure for render:", compatibleData);
        return compatibleData;
      } catch (error) {
         console.error("fetchTestResultData error:", error);
         throw error;
       }
    }

    // Fungsi untuk mengambil data siswa_answers langsung dari database (FALLBACK)
    async function fetchSiswaAnswers() {
      if (userId === null || collectionId === null) return null;
      try {
        const timestamp = new Date().getTime();
        const url = `/api/siswa_answers?user_id=${userId}&collection_id=${collectionId}&t=${timestamp}`;
        const response = await authenticatedFetch(url);
        if (!response.ok) throw new Error(`Error fetching siswa_answers: ${response.status}`);
        const data = await response.json();
        console.log("Fetched siswa_answers directly:", data);
        return data.siswa_answers || [];
      } catch (error) {
        console.warn("Failed to fetch siswa_answers directly:", error);
        return null;
       }
    }

    // Fungsi untuk mengambil dan menyimpan riwayat jawaban (tanpa menampilkannya)
    async function fetchAndCacheAnswerHistory() {
      if (userId === null || collectionId === null) {
          console.warn("fetchAndCacheAnswerHistory: userId or collectionId is null.");
          allAnswers = []; // Pastikan reset jika ID tidak valid
          return;
      }
      try {
        const timestamp = new Date().getTime();
        const url = `/api/siswa/results/${collectionId}?user_id=${userId}&t=${timestamp}`;
        const response = await authenticatedFetch(url);
        if (!response.ok) throw new Error(`Error fetching answer history: ${response.status}`);
        const data = await response.json();
        if (data.success && Array.isArray(data.answers)) {
            allAnswers = data.answers; // Cache the answers from the correct endpoint
            console.log("Jawaban di-cache:", allAnswers.length);
            // Enrich levels immediately after caching
            await enrichAnswersWithLevels(allAnswers);
        } else {
            console.warn("Gagal mendapatkan riwayat jawaban dari API:", data.message || "Struktur data tidak sesuai");
            allAnswers = []; // Reset jika gagal
        }
      } catch (error) {
           console.error("Error caching history:", error);
           allAnswers = []; // Reset on error
      }
    }

    // Fungsi untuk memperkaya data jawaban dengan informasi level (Stage dan Difficulty)
    async function enrichAnswersWithLevels(answers) {
      if (!answers || answers.length === 0) return;
      console.log("Attempting to enrich answers with level info...");
      try {
          // Cek apakah data level (stage/difficulty) sudah ada
          const needsEnrichment = answers.some(answer =>
              answer.stage === undefined || answer.stage === null ||
              answer.difficulty === undefined || answer.difficulty === null
          );

          if (!needsEnrichment) {
              console.log("Level/Stage information already present in fetched answers.");
              // Pastikan level_name terisi jika stage ada
              answers.forEach(answer => {
                  if (answer.stage && !answer.level_name) {
                      answer.level_name = `L${answer.stage}`;
                  }
                  if(!answer.level && answer.stage) {
                      answer.level = taxonomyNames[answer.stage] || `Level ${answer.stage}`;
                  }
              });
              return;
          }

          console.warn("Some answers lack stage/difficulty info, attempting fallback enrichment...");

          // Fallback: Coba fetch siswa_answers langsung
          const siswaAnswers = await fetchSiswaAnswers();
          const levelMapFromSiswaAnswers = {};
          if (siswaAnswers) {
              siswaAnswers.forEach(sa => {
                  if (sa.question_id) {
                      levelMapFromSiswaAnswers[sa.question_id] = {
                          stage: sa.stage || null, 
                          difficulty: sa.difficulty || null,
                          levelName: sa.level || null 
                      };
                  }
              });
          }

          let updatedCount = 0;
          answers.forEach(answer => {
              const needsStage = answer.stage === undefined || answer.stage === null;
              const needsDifficulty = answer.difficulty === undefined || answer.difficulty === null;
              const needsLevelName = answer.level === undefined || answer.level === null;

              if ((needsStage || needsDifficulty || needsLevelName) && answer.question_id) {
                  const fallbackData = levelMapFromSiswaAnswers[answer.question_id];
                  if (fallbackData) {
                      let updated = false;
                      if (needsStage && fallbackData.stage) {
                          answer.stage = fallbackData.stage;
                          if (!answer.level_name) answer.level_name = `L${fallbackData.stage}`;
                          updated = true;
                      }
                      if (needsDifficulty && fallbackData.difficulty) {
                          answer.difficulty = fallbackData.difficulty;
                          updated = true;
                      }
                      if (needsLevelName && fallbackData.levelName) {
                          answer.level = fallbackData.levelName;
                           updated = true;
                      } else if (needsLevelName && answer.stage) {
                          answer.level = taxonomyNames[answer.stage] || `Level ${answer.stage}`;
                           updated = true;
                      }
                      if(updated) updatedCount++;

                  } else {
                      if (needsStage) answer.stage = 1; 
                      if (needsDifficulty) answer.difficulty = 'Medium';
                      if (needsLevelName) answer.level = taxonomyNames[answer.stage || 1];
                      console.log(`Final fallback Stage/Difficulty/Level for QID: ${answer.question_id}`);
                  }
              } else if (answer.stage && !answer.level_name) {
                  answer.level_name = `L${answer.stage}`;
              } else if (answer.stage && !answer.level) {
                   answer.level = taxonomyNames[answer.stage] || `Level ${answer.stage}`;
              }
          });
          if (updatedCount > 0) console.log(`Fallback Stage/Difficulty/Level added to ${updatedCount} jawaban.`);

      } catch (error) { console.error("Error during fallback stage/difficulty enrichment:", error); }
    }



    // Fungsi untuk menampilkan modal jawaban
    function showAnswersModal(type) {
      const modalTitle = document.getElementById('answersModalLabel');
      modalTitle.textContent = type === 'correct' ? 'Jawaban Tepat' : 'Jawaban Kurang Tepat';
      const modalBody = document.getElementById('answersModalBody');
      modalBody.innerHTML = `<div class="text-center"><div class="spinner-border"></div><p>Memuat...</p></div>`;
      const answersModal = new bootstrap.Modal(document.getElementById('answersModal'));
      answersModal.show();
      renderFilteredAnswers(type);
    }

   // Fungsi untuk menampilkan jawaban yang difilter
    function renderFilteredAnswers(type) {
      const modalBody = document.getElementById('answersModalBody');
      const isCorrectType = type === 'correct';

       if (!allAnswers || allAnswers.length === 0) {
           console.warn("renderFilteredAnswers: allAnswers kosong.");
           modalBody.innerHTML = `<div class="alert alert-warning">Data jawaban belum tersedia.</div>`;
           return;
       }

      const filteredAnswers = allAnswers.filter(answer => answer.is_correct === isCorrectType);

      if (filteredAnswers.length === 0) {
        modalBody.innerHTML = `<div class="alert alert-info">Tidak ada jawaban ${isCorrectType ? 'tepat' : 'kurang tepat'} yang ditemukan.</div>`; return;
      }

      let answersHTML = '';
      filteredAnswers.forEach((answer, index) => {
        const correctAnswer = answer.correct_answer || '';
        const userAns = answer.user_answer || 'Tidak terjawab';
        const explanation = answer.explanation || '';
        const tip = answer.personalized_tip || ''; 

        // **PERBAIKAN**: Gunakan data stage & difficulty dari 'answer'
        const stageInfo = answer.stage ? `Tahap ${answer.stage}` : '';
        const diffInfo = answer.difficulty ? `(${answer.difficulty})` : '';
        const levelInfo = stageInfo || diffInfo ? `<span class="badge bg-secondary ms-2">${stageInfo} ${diffInfo}</span>` : '';


        answersHTML += `
          <div class="card answer-card mb-3 ${isCorrectType ? 'correct' : 'incorrect'}">
            <div class="card-body">
              <h5 class="card-title mb-2 d-flex justify-content-between align-items-center">
                <span>Pertanyaan ${index + 1}:</span>
                ${levelInfo}
              </h5>
              <p class="answer-question mb-3">${escapeHtml(answer.question || 'Pertanyaan tidak tersedia')}</p>

              <div class="row mb-2">
                 <div class="col-md-6">
                    <h6 class="card-subtitle mb-2 text-muted">Jawaban Anda:</h6>
                    <div class="answer-response ${isCorrectType ? 'bg-success-subtle text-success-emphasis' : 'bg-danger-subtle text-danger-emphasis'}">${escapeHtml(userAns)}</div>
                 </div>
                 ${!isCorrectType && correctAnswer ? `
                 <div class="col-md-6">
                    <h6 class="card-subtitle mb-2 text-muted">Jawaban Tepat:</h6>
                    <div class="answer-response bg-info-subtle text-info-emphasis">${escapeHtml(correctAnswer)}</div>
                 </div>` : ''}
              </div>

              ${explanation || tip ? `
              <div class="mt-3">
                 <button class="btn btn-sm btn-outline-info w-100" type="button" data-bs-toggle="collapse" data-bs-target="#modalInfo${index}">
                    <i class="bi bi-info-circle"></i> Lihat Info Tambahan
                 </button>
                 <div class="collapse mt-2" id="modalInfo${index}">
                    ${explanation ? `<div class="explanation-text mb-2"><strong>Penjelasan:</strong> ${escapeHtml(explanation)}</div>` : ''}
                    ${tip ? `<div class="alert alert-primary small p-2"><strong>Tips:</strong> ${escapeHtml(tip)}</div>` : ''}
                 </div>
              </div>` : ''}
            </div>
          </div>`;
      });
      modalBody.innerHTML = answersHTML;
    }

    // Fungsi untuk merender halaman hasil
    function renderResultPage(data) { 
      console.log("Rendering result page with data:", data); 
      const correctValue = parseInt(data.correct || 0);
      const incorrectValue = parseInt(data.incorrect || 0);
      const totalValue = correctValue + incorrectValue;

      // --- PERBAIKAN PENENTUAN LEVEL (SESUAI PERMINTAAN PENGGUNA) ---
      // Cari level (stage) TERTINGGI dari jawaban yang BENAR
      let finalDiagnosisLevel = 1; // Default L1
      let finalDiagnosisText = "Tahap 1";
      const mstState = data.mst_state || {}; 

      if (allAnswers && allAnswers.length > 0) {
          // Filter jawaban yang benar
          const correctAnswers = allAnswers.filter(a => a.is_correct === true);
          
          let maxStage = 0;
          if (correctAnswers.length > 0) {
              // Cari stage tertinggi dari jawaban yang benar
              correctAnswers.forEach(answer => {
                  const stage = parseInt(answer.stage || getLevelFromState(answer.state_name || answer.state || 'L1') || 0);
                  if (stage > maxStage) {
                      maxStage = stage;
                  }
              });
          }

          if (maxStage > 0) {
              finalDiagnosisLevel = maxStage;
              // Tampilkan diagnosis (e.g., "L4", "L5") jika tes selesai DAN
              // diagnosisnya cocok dengan level tertinggi yang dicapai
              if (mstState.test_completed && mstState.final_diagnosis) {
                  const diagnosisLevel = getLevelFromState(mstState.final_diagnosis);
                  if (diagnosisLevel === finalDiagnosisLevel) {
                        finalDiagnosisText = mstState.final_diagnosis; // e.g., "L5"
                  } else {
                        // Kasus: Siswa lolos L4, gagal L5. Diagnosis="L4". maxStage=4. Cocok.
                        // Kasus: Siswa lolos L1, gagal L2, L3, L4. Diagnosis="L3". maxStage=1. Tidak cocok.
                        // Ikuti permintaan user: Tampilkan capaian tertinggi yang BENAR.
                        finalDiagnosisText = `L${finalDiagnosisLevel}`;
                  }
              } else {
                  // Jika tes belum selesai, tampilkan level tertinggi yang dicapai
                  finalDiagnosisText = `L${finalDiagnosisLevel}`;
              }
              console.log("Level from MAX CORRECT answer:", finalDiagnosisLevel, `(${finalDiagnosisText})`);
          } else {
              // Tidak ada jawaban benar sama sekali
              finalDiagnosisLevel = 1;
              finalDiagnosisText = (mstState.test_completed && mstState.final_diagnosis) ? mstState.final_diagnosis : "Tahap 1"; // Tampilkan diagnosis jika ada (misal < L2)
              console.log("No correct answers found. Defaulting to L1/Diagnosis:", finalDiagnosisLevel, `(${finalDiagnosisText})`);
          }
          
      } else if (mstState.test_completed && mstState.final_diagnosis) {
          // Fallback jika allAnswers kosong (misal siswa gagal di L1 dan belum ada jawaban)
          finalDiagnosisLevel = getLevelFromState(mstState.final_diagnosis);
          finalDiagnosisText = mstState.final_diagnosis;
          console.log("No answers, using final_diagnosis:", finalDiagnosisLevel, `(${finalDiagnosisText})`);
      }
      
      // Pastikan level antara 1-5
      finalDiagnosisLevel = Math.max(1, Math.min(5, finalDiagnosisLevel));
      // Jika diagnosis < L2, levelnya tetap 1
      if (finalDiagnosisText === "< L2") {
          finalDiagnosisLevel = 1;
      }
      
      console.log("=== FINAL DETERMINED LEVEL FOR DISPLAY (Correct-Only Logic):", finalDiagnosisLevel, `(${finalDiagnosisText}) ===`);
      // --- AKHIR PERBAIKAN ---


      const accuracyValue = totalValue > 0 ? Math.round((correctValue / totalValue) * 100) : 0;

      safeSetText('correct-value', correctValue);
      safeSetText('incorrect-value', incorrectValue);
      safeSetText('accuracy-value', accuracyValue + '%');
      safeSetText('total-questions', `Total Soal Dijawab: ${totalValue}`);

      // Map level ke nama Taksonomi Teknologi
      const taxonomyColors = {
        1: ['bg-light', 'text-dark', 'border', 'border-secondary'], // Abu-abu muda untuk Awareness
        2: ['bg-warning-subtle', 'text-warning-emphasis'], // Kuning muda untuk Literacy
        3: ['bg-primary-subtle', 'text-primary-emphasis'],   // Biru muda untuk Capability
        4: ['bg-info-subtle', 'text-info-emphasis'],     // Cyan muda untuk Creativity
        5: ['bg-success-subtle', 'text-success-emphasis']    // Hijau muda untuk Criticism
      };
      
      const badgeText = finalDiagnosisText; // Gunakan teks yang sudah ditentukan
      const taxonomyName = taxonomyNames[finalDiagnosisLevel] || `Level ${finalDiagnosisLevel}`;

  // Tampilkan daftar semua level yang memiliki jawaban benar sebagai badge berwarna
  renderAchievedLevelsBadges();
  // (Detail nama & deskripsi per level di bagian atas dihapus; detail lengkap tersedia di Analisis Pencapaian Anda)

      // (Bagian badge diagnosis tunggal dihapus sesuai permintaan)

      // Update nama koleksi
      const collectionName = collectionInfo.name || data.collection_name || 'N/A';
      safeSetText('collection-name', `Koleksi: ${collectionName}`);


      const correctPercent = totalValue > 0 ? Math.round((correctValue / totalValue) * 100) : 0;
      const incorrectPercent = totalValue > 0 ? 100 - correctPercent : 0;

      safeUpdateProgressBar('correct-progress', correctPercent);
      safeUpdateProgressBar('incorrect-progress', incorrectPercent);
      safeSetText('correct-percent', correctPercent + '%');
      safeSetText('incorrect-percent', incorrectPercent + '%');

      const chartElement = document.getElementById('resultChart');
      if (chartElement) {
        const ctx = chartElement.getContext('2d');
        if (window.resultChartInstance) window.resultChartInstance.destroy(); 
        window.resultChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Tepat', 'Kurang Tepat'],
                datasets: [{
                    data: [correctValue, incorrectValue],
                    backgroundColor: ['#198754', '#dc3545'], 
                    borderColor: ['#ffffff', '#ffffff'], 
                    borderWidth: 2,
                    hoverOffset: 15
                 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 14 }, padding: 15 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw || 0;
                                const percentage = totalValue > 0 ? Math.round((value / totalValue) * 100) : 0;
                                return `${context.label || ''}: ${value} (${percentage}%)`;
                            }
                        }
                    },
                     title: { display: false } 
                },
                cutout: '65%', 
                animation: { animateScale: true, animateRotate: true, duration: 1000 }
            }
        });
      } else { console.warn("Elemen chart 'resultChart' tidak ditemukan."); }

      // Hasilkan analisis pencapaian setelah data utama dirender
      setTimeout(() => {
        generateAchievementAnalysis(finalDiagnosisLevel); // Gunakan level diagnosis akhir
      }, 100); 
    }

   // --- renderMSTPath FUNCTION DIHAPUS ---
   /* function renderMSTPath(mstState) { ... } */



    // Fungsi untuk mendapatkan level yang dilalui siswa dari riwayat jawaban - sistem 5 stage
    function getPassedLevelsFromAnswers() {
      const passedSteps = []; // Store { stage, difficulty, is_correct }
      if (allAnswers && allAnswers.length > 0) {
         allAnswers.forEach(answer => {
             // Prioritize stage and difficulty from the answer object itself
             const stageNum = answer.stage || getLevelFromState(answer.level_name || answer.state);
             const difficulty = answer.difficulty || 'Medium'; // Default if missing
             const stageName = `L${stageNum}`;

             if (stageNum >= 1 && stageNum <= 5) {
                 passedSteps.push({
                     stage: stageName,
                     difficulty: difficulty,
                     is_correct: answer.is_correct
                 });
             }
         });
      }
      // Add a default starting step if none found
      if (passedSteps.length === 0) {
         console.warn("No valid steps found in answers, adding default start.");
         passedSteps.push({ stage: 'L1', difficulty: 'Medium', is_correct: undefined }); // is_correct undefined for start
      }
      console.log("Passed Steps from Answers:", passedSteps);
      return passedSteps;
    }

    // Fungsi untuk menampilkan analisis pencapaian siswa dengan narasi deskriptif
    function generateAchievementAnalysis(currentLevel) {
       const container = document.getElementById('achievement-analysis-container');
       if (!container) { console.warn("Achievement analysis container not found."); return; }

       // Generate the detailed analysis based on cached answers
       const detailedAnalysis = getDetailedAnswerAnalysis();

       // Generate the narrative HTML using the analysis data and the final determined level
       const analysisHTML = generateStudentFriendlyAnalysisHTML(detailedAnalysis, currentLevel);
       container.innerHTML = analysisHTML;

       // Animate progress bars after inserting HTML
       setTimeout(() => {
            container.querySelectorAll('.progress-bar').forEach(bar => {
                const width = bar.getAttribute('data-progress-width');
                if (width) {
                    bar.style.width = width;
                }
            });
       }, 100); // Small delay to ensure elements are in DOM
    }

    // --- NEW FUNCTION: Generate HTML for Student-Friendly Analysis ---
    function generateStudentFriendlyAnalysisHTML(analysis, currentLevel) {
        const correct = analysis.correctAnswers;
        const incorrect = analysis.totalQuestions - analysis.correctAnswers;
        const accuracy = parseFloat(analysis.accuracyRate);

  // Bagian: Taksonomi Teknologi Tercapai (hanya level dengan jawaban benar)
        let analysisHTML = `<div class="row mb-4">
          <div class="col-12">
            <div class="card border-primary">
              <div class="card-body">
                <h4 class="text-primary mb-3 text-center"><i class="bi bi-award me-2"></i>Taksonomi Teknologi Tercapai</h4>
                
                <div class="mt-3">${buildLevelsSummaryHTML(analysis)}</div>
              </div>
            </div>
          </div>
        </div>`; // Display level message + ringkasan semua level

        // Bagian: Kekuatan
        analysisHTML += `<div class="row mb-4"><div class="col-md-6"><div class="card border-success h-100"><div class="card-body"><h5 style="color: #198754;"><i class="bi bi-check-circle me-2"></i>Kekuatan Anda</h5><div class="mb-3"><div class="d-flex align-items-center"><span class="badge me-2" style="background-color:#198754;">${correct}</span><span>Tepat (${accuracy.toFixed(1)}%)</span></div><div class="progress mt-2" style="height:8px;"><div class="progress-bar" style="background-color:#198754;" data-progress-width="${accuracy}%"></div></div></div><div class="strength-analysis">${getStrengthAnalysis(accuracy, correct, currentLevel)}</div></div></div></div>`; // Strength Analysis

        // Bagian: Area Pengembangan
        analysisHTML += `<div class="col-md-6"><div class="card border-warning h-100"><div class="card-body"><h5 style="color:#dc3545;"><i class="bi bi-exclamation-triangle me-2"></i>Area Pengembangan</h5><div class="mb-3"><div class="d-flex align-items-center"><span class="badge me-2" style="background-color:#dc3545;">${incorrect}</span><span>Kurang Tepat (${(100-accuracy).toFixed(1)}%)</span></div><div class="progress mt-2" style="height:8px;"><div class="progress-bar" style="background-color:#dc3545;" data-progress-width="${100 - accuracy}%"></div></div></div><div class="improvement-analysis">${getImprovementAnalysis(accuracy, incorrect, currentLevel)}</div></div></div></div></div>`; // Improvement Analysis

        // Bagian: Langkah Selanjutnya
        analysisHTML += `<div class="row"><div class="col-12"><div class="card border-info"><div class="card-body"><h5 class="text-info"><i class="bi bi-rocket me-2"></i>Langkah Selanjutnya</h5><div class="next-steps">${getNextStepsMessage(accuracy, currentLevel, correct, incorrect)}</div></div></div></div></div>`; // Next Steps

        return analysisHTML;
    }

  // Bangun ringkasan level yang TERCAPAI (memiliki jawaban benar) (per level: badge, deskripsi, dan badge kesulitan)
    function buildLevelsSummaryHTML(analysis) {
        const perf = analysis.levelPerformance || {};
    // Ambil hanya level yang memiliki minimal 1 jawaban benar
    const levels = Object.keys(perf)
      .map(n => parseInt(n))
      .filter(n => n>=1 && n<=5 && perf[n] && (perf[n].correct || 0) > 0)
      .sort((a,b)=>a-b);
        if (levels.length === 0) {
            // Tampilkan notifikasi yang lebih informatif jika tidak ada jawaban benar
            const guruName = (typeof collectionInfo !== 'undefined' && collectionInfo && collectionInfo.guru_name)
                ? ` ${escapeHtml(collectionInfo.guru_name)}`
                : '';
            return `
              <div class="alert alert-danger border-0 text-center p-4" role="alert" style="border-radius:12px;">
                <div class="mb-1" style="font-size:1.25rem;font-weight:700;">
                  <i class="bi bi-x-circle-fill me-2"></i>Tidak Lulus
                </div>
                <p class="mb-1">Anda belum menjawab dengan benar pada tes ini.</p>
                <p class="mb-0">Silakan hubungi guru${guruName ? '' : ''}${guruName || ''} untuk pemahaman lebih lanjut dan rencana pembelajaran berikutnya.</p>
              </div>`;
        }

        const badgeClasses = {
            1: ['bg-light','text-dark','border','border-secondary'],
            2: ['bg-warning-subtle','text-warning-emphasis'],
            3: ['bg-primary-subtle','text-primary-emphasis'],
            4: ['bg-info-subtle','text-info-emphasis'],
            5: ['bg-success-subtle','text-success-emphasis']
        };

        // Helper: pilih kesulitan (prioritas tertinggi) berdasarkan jawaban benar; jika tidak ada benar, gunakan yang dicoba
        function pickLevelDifficulty(level) {
            const q = (perf[level] && perf[level].questions) ? perf[level].questions : [];
            if (!q || q.length === 0) return null;
            const order = { 'easy': 1, 'medium': 2, 'hard': 3 };
            // Normalisasi
            const norm = (d) => (typeof d === 'string') ? d.trim().toLowerCase() : '';
            // Cari tertinggi di yang benar
            let bestCorrect = null;
            q.forEach(item => {
                const d = norm(item.difficulty);
                if (item.isCorrect || item.is_correct) {
                    if (!bestCorrect || (order[d] || 0) > (order[norm(bestCorrect)] || 0)) bestCorrect = d;
                }
            });
            if (bestCorrect) return bestCorrect;
            // Jika tidak ada yang benar, ambil tertinggi dari yang dicoba
            let bestTried = null;
            q.forEach(item => {
                const d = norm(item.difficulty);
                if (!bestTried || (order[d] || 0) > (order[norm(bestTried)] || 0)) bestTried = d;
            });
            return bestTried;
        }

        const taxonomyDescriptions = {
            1: 'Mulai mengenali konsep dasar teknologi.',
            2: 'Mampu menjelaskan fungsi dasar dan cara kerja.',
            3: 'Mampu menggunakan teknologi untuk tugas rutin.',
            4: 'Mampu merancang solusi sederhana menggunakan teknologi.',
            5: 'Mampu mengevaluasi dampak dan efektivitas teknologi.'
        };

        const diffBadge = (d) => {
            if (!d) return '';
            const map = {
                'easy': ['bg-success-subtle','text-success-emphasis','Easy'],
                'medium': ['bg-warning-subtle','text-warning-emphasis','Medium'],
                'hard': ['bg-danger-subtle','text-danger-emphasis','Hard']
            };
            const conf = map[d] || ['bg-secondary','text-light', d];
            const cls = ['badge','rounded-pill','px-3','py-2', ...conf.slice(0,2)].join(' ');
            const label = conf[2] || d;
            return `<span class="${cls}">${label}</span>`;
        };

        const tiles = levels.map(level => {
            const badgeCls = ['badge','rounded-pill','px-3','py-2', ...(badgeClasses[level] || ['bg-light','text-dark'])].join(' ');
            const title = `L${level} - ${taxonomyNames[level] || 'Level ' + level}`;
            const desc = taxonomyDescriptions[level] || '';
            const diff = pickLevelDifficulty(level); // easy/medium/hard
            const diffHtml = diffBadge(diff);
            return `
              <div class="col-12 col-sm-6 col-lg-4">
                <div class="level-tile l${level}">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="d-flex align-items-center">
                      <span class="${badgeCls}">L${level}</span>
                      <div class="level-title ms-2">${escapeHtml(title)}</div>
                    </div>
                    ${diffHtml ? `<div class="small">${diffHtml}</div>` : ''}
                  </div>
                  <div class="level-desc">${escapeHtml(desc)}</div>
                </div>
              </div>`;
        }).join('');

        return `<div class="row g-3">${tiles}</div>`;
    }


    // Fungsi untuk mendapatkan analisis jawaban yang detail
    function getDetailedAnswerAnalysis() {
      const analysis = { correctLevels:[], incorrectLevels:[], totalQuestions:0, correctAnswers:0, accuracyRate:0, levelPerformance:{}, topicPerformance:{}, collectionFocus:'', subjectAreas:[], difficultyDistribution:{}, strengthAreas:[], challengeAreas:[], learningPattern:'', cognitiveProfile:'' };
      if (!allAnswers || allAnswers.length === 0) {
           console.warn("getDetailedAnswerAnalysis: No answers available.");
           return analysis;
      }

      // Use collectionInfo if available
      analysis.collectionFocus = collectionInfo.name || '';
      analysis.collectionDescription = collectionInfo.description || '';

      allAnswers.forEach(answer => {
        // --- GET LEVEL (STAGE) NUMBER ---
        let levelNum = 1; // Default
        if (answer.stage) {
            levelNum = parseInt(answer.stage);
        } else if (answer.level_name || answer.state) {
            levelNum = getLevelFromState(answer.level_name || answer.state);
        }
        levelNum = Math.max(1, Math.min(5, levelNum)); // Ensure 1-5
        // --- END GET LEVEL ---

        const isCorrect = answer.is_correct;
        const questionId = answer.question_id;

        analysis.totalQuestions++;
        if(isCorrect){ analysis.correctAnswers++; if(!analysis.correctLevels.includes(levelNum)) analysis.correctLevels.push(levelNum); }
        else { if(!analysis.incorrectLevels.includes(levelNum)) analysis.incorrectLevels.push(levelNum); }

        // Level Performance
        if(!analysis.levelPerformance[levelNum]) analysis.levelPerformance[levelNum] = {correct:0, total:0, questions:[], topics:[]}; // Initialize topics array
        analysis.levelPerformance[levelNum].total++;
        if(isCorrect) analysis.levelPerformance[levelNum].correct++;
        analysis.levelPerformance[levelNum].questions.push({ id: questionId, difficulty: answer.difficulty, isCorrect: isCorrect });


        // Topic/Subject analysis - Rely on potential data from backend
        const topic = answer.topic || 'Umum'; // Assume 'topic' might be in answer object
        if (topic !== 'Umum' && !analysis.levelPerformance[levelNum].topics.includes(topic)) {
             analysis.levelPerformance[levelNum].topics.push(topic);
        }
        if(!analysis.topicPerformance[topic]) analysis.topicPerformance[topic] = {correct:0, total:0, levels:[]};
        analysis.topicPerformance[topic].total++;
        if(isCorrect) analysis.topicPerformance[topic].correct++;
        if(!analysis.topicPerformance[topic].levels.includes(levelNum)) analysis.topicPerformance[topic].levels.push(levelNum);

        const subject = answer.subject;
        if (subject && !analysis.subjectAreas.includes(subject)) {
             analysis.subjectAreas.push(subject);
        }

        // Difficulty Distribution
        const difficulty = answer.difficulty || 'Medium';
        if (!analysis.difficultyDistribution[difficulty]) analysis.difficultyDistribution[difficulty] = {correct:0, total:0};
        analysis.difficultyDistribution[difficulty].total++;
        if(isCorrect) analysis.difficultyDistribution[difficulty].correct++;

      });

      analysis.accuracyRate = analysis.totalQuestions > 0 ? (analysis.correctAnswers / analysis.totalQuestions * 100).toFixed(1) : 0;
      analysis.correctLevels.sort((a, b) => a - b); analysis.incorrectLevels.sort((a, b) => a - b);

      // Strength/Challenge Areas based on level performance
       Object.entries(analysis.levelPerformance).forEach(([level, perf]) => {
           const accuracy = perf.total > 0 ? (perf.correct / perf.total * 100) : 0;
           if (accuracy >= 75) analysis.strengthAreas.push(`Level ${level}`);
           else if (accuracy < 50) analysis.challengeAreas.push(`Level ${level}`);
       });


      // Learning pattern analysis (simplified)
      const correctLevels = analysis.correctLevels; const incorrectLevels = analysis.incorrectLevels;
      if (correctLevels.some(l => l >= 4) && incorrectLevels.some(l => l <= 2)) analysis.learningPattern = 'Kesenjangan antara Dasar & Lanjutan';
      else if (correctLevels.length > 0 && incorrectLevels.length > 0 && Math.abs(Math.max(...correctLevels) - Math.min(...incorrectLevels)) >= 2) analysis.learningPattern = 'Performa Tidak Konsisten';
      else if (correctLevels.length >= 3 && correctLevels.every((l, i) => i === 0 || l >= correctLevels[i - 1])) analysis.learningPattern = 'Peningkatan Progresif';
      else if (incorrectLevels.length > 0 && correctLevels.length === 0) analysis.learningPattern = 'Fokus Penguatan Dasar';
      else analysis.learningPattern = 'Tahap Pengembangan';

      console.log("Detailed Analysis Result:", analysis);
      return analysis;
    }


    // Fungsi untuk membuat deskripsi naratif (sudah tidak digunakan, digantikan oleh generateStudentFriendlyAnalysisHTML)
    function generateNarrativeDescription(analysis, currentLevel, container) {
       console.warn("generateNarrativeDescription is deprecated. Use generateStudentFriendlyAnalysisHTML instead.");
       if (container) container.innerHTML = "<p><i>Analisis naratif sedang dalam pengembangan.</i></p>"; // Placeholder
    }




    // Function to export results to Excel (Dihapus)
    // function exportToExcel() { ... }
    // function performExcelExport() { ... }

    // Generate personalized recommendations dengan bahasa yang ramah siswa (Dihapus)
    // function generateRecommendations(correct, incorrect, currentLevel) { ... }


    // Fungsi untuk menghasilkan analisis pencapaian yang ramah siswa (PANGGIL HTML GENERATOR)
    function generateStudentFriendlyAnalysis(correct, incorrect, currentLevel) {
        const container = document.getElementById('achievement-analysis-container');
        if (!container) return;

        // Get detailed analysis first
        const analysisData = getDetailedAnswerAnalysis();

        // Generate the HTML based on analysisData and currentLevel
        const analysisHTML = generateStudentFriendlyAnalysisHTML(analysisData, currentLevel);
        container.innerHTML = analysisHTML;

        // Animate progress bars after inserting HTML
        setTimeout(() => {
            container.querySelectorAll('.progress-bar').forEach(bar => {
                const width = bar.getAttribute('data-progress-width');
                if (width) {
                    bar.style.width = width;
                }
            });
        }, 100);
    }


    // *** MODIFIKASI DIMULAI DI SINI ***

    // Fungsi untuk mendapatkan pesan pencapaian level - SESUAI MST 5 Stage Technology Assessment
    function getLevelAchievementMessage(level) {
        const messages = {
          1: `<span style="font-family:'Inter',sans-serif;font-weight:600;color:#2d3748;line-height:1.6;"><strong>L1 - Awareness</strong><br>Mulai mengenali konsep dasar teknologi.</span>`,
          2: `<span style="font-family:'Inter',sans-serif;font-weight:600;color:#2d3748;line-height:1.6;"><strong>L2 - Literacy</strong><br>Mampu menjelaskan fungsi dasar dan cara kerja.</span>`,
          3: `<span style="font-family:'Inter',sans-serif;font-weight:600;color:#2d3748;line-height:1.6;"><strong>L3 - Capability</strong><br>Mampu menggunakan teknologi untuk tugas rutin.</span>`,
          4: `<span style="font-family:'Inter',sans-serif;font-weight:600;color:#2d3748;line-height:1.6;"><strong>L4 - Creativity</strong><br>Mampu merancang solusi sederhana menggunakan teknologi.</span>`,
          5: `<span style="font-family:'Inter',sans-serif;font-weight:600;color:#2d3748;line-height:1.6;"><strong>L5 - Criticism</strong><br>Mampu mengevaluasi dampak dan efektivitas teknologi.</span>`
        };
        // Pastikan level antara 1 dan 5
        const validLevel = Math.max(1, Math.min(5, level));
        return messages[validLevel] || `<span style="font-family:'Inter',sans-serif;font-weight:600;color:#2d3748;line-height:1.6;">Selamat atas pencapaianmu! 🎉</span>`;
    }

    // Fungsi untuk analisis kekuatan berdasar MST 5 Stage Technology Assessment
    function getStrengthAnalysis(accuracy, correct, level) {
        const levelNames = {
          1: 'Awareness',
          2: 'Literacy',
          3: 'Capability',
          4: 'Creativity',
          5: 'Criticism'
        };
        // Pastikan level antara 1 dan 5
        const validLevel = Math.max(1, Math.min(5, level));
        const levelName = levelNames[validLevel] || `Level ${validLevel}`;

        if (accuracy >= 80) return `<p class="mb-2" style="color:#198754;"><strong>🎯 Penguasaan Baik!</strong></p><p>${accuracy.toFixed(1)}% tepat di ${levelName}:</p><ul class="small ps-3"><li>Konsep dasar solid</li><li>Penerapan praktis efektif</li><li>Analisis mulai terbentuk</li></ul>`;
        if (accuracy >= 60) return `<p class="mb-2" style="color:#198754;"><strong>👍 Berkembang!</strong></p><p>${accuracy.toFixed(1)}% tepat di ${levelName}:</p><ul class="small ps-3"><li>Pemahaman konsep cukup</li><li>Mulai bisa menerapkan</li><li>Pola pikir logis</li></ul>`;
        return `<p class="mb-2" style="color:#198754;"><strong>💪 Fondasi Terbangun!</strong></p><p>${correct} benar di ${levelName}:</p><ul class="small ps-3"><li>Mengenal istilah penting</li><li>Paham fungsi dasar</li><li>Potensi besar untuk berkembang</li></ul>`;
    }

    // Fungsi untuk analisis area pengembangan berdasar MST 5 Stage Technology Assessment
    function getImprovementAnalysis(accuracy, incorrect, level) {
        const levelNames = {
          1: 'Awareness',
          2: 'Literacy',
          3: 'Capability',
          4: 'Creativity',
          5: 'Criticism'
        };
        // Pastikan level antara 1 dan 5
        const validLevel = Math.max(1, Math.min(5, level));
        const levelName = levelNames[validLevel] || `Level ${validLevel}`;

        if (incorrect === 0) return `<p class="mb-2" style="color:#dc3545;"><strong>🌟 Luar Biasa!</strong></p><p>Tidak ada kesalahan di ${levelName}! Peluang lanjut:</p><ul class="small ps-3"><li>Eksplorasi topik lanjutan</li><li>Proyek mandiri</li><li>Evaluasi teknologi baru</li></ul>`;
        if (accuracy >= 70) return `<p class="mb-2" style="color:#dc3545;"><strong>📈 Sedikit Lagi!</strong></p><p>${incorrect} area di ${levelName} perlu diperkuat:</p><ul class="small ps-3"><li>Aplikasi lebih kompleks</li><li>Pemecahan masalah variatif</li><li>Analisis kritis</li></ul>`;
        return `<p class="mb-2" style="color:#dc3545;"><strong>🚀 Perlu Penguatan!</strong></p><p>${incorrect} area di ${levelName} perlu penguatan:</p><ul class="small ps-3"><li>Review konsep dasar</li><li>Latihan penerapan langsung</li><li>Diskusi cara kerja</li></ul>`;
    }

    // Fungsi untuk pesan langkah selanjutnya - MST 5 Stage Technology Assessment
    function getNextStepsMessage(accuracy, level, correct, incorrect) {
        const levelNames = {
          1: 'Awareness',
          2: 'Literacy',
          3: 'Capability',
          4: 'Creativity',
          5: 'Criticism'
        };
        // Pastikan level antara 1 dan 5
        const validLevel = Math.max(1, Math.min(5, level));
        const levelName = levelNames[validLevel] || `Level ${validLevel}`;
        let message = '';

        if (accuracy >= 85) message = `<div class="alert alert-success border-0 mb-3"><h6><i class="bi bi-trophy-fill me-2"></i>Penguasaan Tinggi!</h6><p class="mb-2">Level ${levelName} dikuasai! Tantangan berikutnya:</p></div><div class="row"><div class="col-md-6"><div class="card bg-light border-0 mb-2"><div class="card-body p-3"><h6 class="text-success">💡 Eksplorasi Lanjutan</h6><ul class="small mb-0 ps-3"><li>Cari kasus penggunaan baru</li><li>Bandingkan teknologi serupa</li><li>Buat proyek inovatif</li></ul></div></div></div><div class="col-md-6"><div class="card bg-light border-0 mb-2"><div class="card-body p-3"><h6 class="text-primary">🤝 Berbagi Pengetahuan</h6><ul class="small mb-0 ps-3"><li>Ajari teman</li><li>Buat tutorial singkat</li><li>Presentasi konsep</li></ul></div></div></div></div>`;
        else if (accuracy >= 60) message = `<div class="alert alert-info border-0 mb-3"><h6><i class="bi bi-graph-up-arrow me-2"></i>Perkembangan Baik!</h6><p class="mb-2">Level ${levelName} sudah cukup baik, tingkatkan:</p></div><div class="row"><div class="col-md-6"><div class="card bg-light border-0 mb-2"><div class="card-body p-3"><h6 class="text-info">📚 Perdalam Pemahaman</h6><ul class="small mb-0 ps-3"><li>Hubungkan antar konsep</li><li>Analisis contoh kompleks</li><li>Cari sumber belajar lain</li></ul></div></div></div><div class="col-md-6"><div class="card bg-light border-0 mb-2"><div class="card-body p-3"><h6 class="text-warning">🎯 Latihan Terfokus</h6><ul class="small mb-0 ps-3"><li>Kerjakan soal variatif</li><li>Coba simulasi/praktik</li><li>Identifikasi pola kesalahan</li></ul></div></div></div></div>`;
        else message = `<div class="alert alert-warning border-0 mb-3"><h6><i class="bi bi-tools me-2"></i>Perkuat Fondasi!</h6><p class="mb-2">Mari fokus pada dasar-dasar Level ${levelName}:</p></div><div class="row"><div class="col-md-6"><div class="card bg-light border-0 mb-2"><div class="card-body p-3"><h6 class="text-success">🌱 Review Konsep</h6><ul class="small mb-0 ps-3"><li>Ulangi definisi & istilah</li><li>Buat rangkuman visual</li><li>Jelaskan dengan kata sendiri</li></ul></div></div></div><div class="col-md-6"><div class="card bg-light border-0 mb-2"><div class="card-body p-3"><h6 class="text-danger">❤️ Minta Bantuan</h6><ul class="small mb-0 ps-3"><li>Tanya guru/teman</li><li>Cari video penjelasan</li><li>Jangan menyerah!</li></ul></div></div></div></div>`;

        // Pesan tambahan tentang alur MST 5 Stage
        message += `<div class="mt-4 p-3 bg-gradient" style="background:linear-gradient(45deg,#e8f5e8,#e3f2fd);border-radius:10px;"><div class="text-center"><h6 class="text-dark mb-2">Perjalanan MST 5 Tahap Anda:</h6><p class="mb-0 text-dark"><em>"Awareness → Literacy → Capability → Creativity → Criticism. Setiap tahap adalah pencapaian! Terus kembangkan kemampuan berpikir teknologimu!"</em></p></div></div>`;
        return message;
    }

    // *** AKHIR MODIFIKASI ***

    // Fungsi untuk setup tombol export (PDF dan Excel)
    function setupExportButtons() {
      // Setup export PDF button
      const exportPdfBtn = document.getElementById('exportPdfBtn');
      if (exportPdfBtn) {
        console.log("Menambahkan event listener untuk export PDF");
        exportPdfBtn.addEventListener('click', function() {
          try {
            exportToPdf();
          } catch (err) {
            console.error("Error dalam handler exportToPdf:", err);
            showLoading(false);
            Swal.fire('Error','Gagal export PDF.','error');
          }
        });
      } else { console.warn("Tombol export PDF tidak ditemukan"); }

      // Setup export Excel button (dihapus)
      // const exportExcelBtn = document.getElementById('exportExcelBtn');
      // if (exportExcelBtn) { ... }
    }

    // Function to export to PDF
    function exportToPdf() {
        if (!userId || !collectionId) { Swal.fire('Error','ID pengguna atau koleksi tidak valid.','error'); return; }
        showLoading(true);
        // Cek jika allAnswers sudah ada
        if (!allAnswers || allAnswers.length === 0) {
            console.warn("Data jawaban belum ada untuk export PDF. Fetching...");
            fetchAndCacheAnswerHistory().finally(() => {
                // Pastikan allAnswers terisi setelah fetch
                if (allAnswers && allAnswers.length > 0) {
                    performPdfExport();
                } else {
                    showLoading(false);
                    Swal.fire('Error', 'Gagal memuat data jawaban untuk export PDF.', 'error');
                }
            });
        } else {
            performPdfExport(); // Langsung export jika data sudah ada
        }
    }

    // Fungsi untuk melakukan export PDF setelah persiapan data
    function performPdfExport() {
      try {
        const exportUrl = `/api/export_result_pdf?user_id=${userId}&collection_id=${collectionId}`;
        const timestampedUrl = `${exportUrl}&t=${new Date().getTime()}`;
        console.log("Exporting PDF:", timestampedUrl);
        window.open(timestampedUrl, '_blank'); // Buka di tab baru
        // Sembunyikan loading setelah beberapa saat (asumsi download dimulai)
        setTimeout(() => {
            showLoading(false);
            Swal.fire({
                icon: 'success',
                title: 'Export Dimulai',
                text: 'File PDF sedang dibuat dan akan diunduh.',
                timer: 2500,
                timerProgressBar: true
             });
        }, 2000);
      } catch (error) {
        showLoading(false); Swal.fire('Error','Gagal export PDF: '+error.message,'error');
        console.error("performPdfExport error:", error);
       }
    }

    // Utility functions untuk safe DOM manipulation
    function safeSetText(elementId, text) {
      const element = document.getElementById(elementId);
      if (element) element.textContent = text;
      else console.warn(`Element ID '${elementId}' not found`);
    }

    function safeUpdateProgressBar(elementId, percent) {
      const element = document.getElementById(elementId);
      if (element) {
          element.style.width = '0%'; // Reset dulu
          // Trigger reflow/repaint
          element.offsetHeight;
          // Set width with transition
          setTimeout(() => { element.style.width = percent + '%'; }, 50); // Small delay before setting final width
       }
      else console.warn(`Progress bar ID '${elementId}' not found`);
    }

    // Utility function untuk escape HTML
    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Definisikan taxonomyNames di scope global (sudah dipindah ke atas)
    // Kumpulkan semua level yang tercapai (jawaban benar) sebagai array terurut unik
    function computeAchievedLevelsList() {
      if (!Array.isArray(allAnswers) || allAnswers.length === 0) return [];
      const levelSet = new Set();
      for (const ans of allAnswers) {
        if (ans && ans.is_correct) {
          let stageNum = null;
          if (ans.stage !== undefined && ans.stage !== null && ans.stage !== '') {
            stageNum = parseInt(ans.stage);
          } else {
            // Fallback dari nama state/level
            const stateName = ans.level_name || ans.state || ans.level || '';
            const derived = getLevelFromState(stateName);
            stageNum = derived || 0;
          }
          if (Number.isFinite(stageNum) && stageNum >= 1 && stageNum <= 5) {
            levelSet.add(stageNum);
          }
        }
      }
      return Array.from(levelSet).sort((a,b)=>a-b);
    }

    // Render badge berwarna untuk setiap level yang tercapai
    function renderAchievedLevelsBadges() {
      const container = document.getElementById('achieved-levels-container');
      if (!container) return;

      const levels = computeAchievedLevelsList();
      if (levels.length === 0) {
        container.textContent = '-';
        return;
      }

      const levelBadgeClasses = {
        1: ['bg-light','text-dark','border','border-secondary'],
        2: ['bg-warning-subtle','text-warning-emphasis'],
        3: ['bg-primary-subtle','text-primary-emphasis'],
        4: ['bg-info-subtle','text-info-emphasis'],
        5: ['bg-success-subtle','text-success-emphasis']
      };

      const html = levels.map(n => {
        const classes = levelBadgeClasses[n] || ['bg-light','text-dark'];
        const cls = ['badge','rounded-pill','me-1','mb-1','px-3','py-2', ...classes].join(' ');
        return `<span class="${cls}">L${n}</span>`;
      }).join('');
      container.innerHTML = html;
    }

    // (renderAchievedLevelsDetails dihapus; detail per level disajikan di bagian Analisis)
  </script>
  
  <!-- Footer -->
  <footer class="site-footer mt-5">
    <div class="container py-3">
      <div class="row align-items-center">
        <div class="col-md-6 small text-muted">
          © 2025 DIGIDAWS. Semua hak cipta.
        </div>
        <div class="col-md-6 text-md-end small">
          <span class="me-2">Contact Me</span>
          <a href="https://www.instagram.com/gunxame/" class="text-decoration-none" target="_blank" rel="noopener" aria-label="Instagram">
            <i class="bi bi-instagram"></i>
          </a>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>